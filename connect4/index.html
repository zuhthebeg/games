<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>?ºÏù∏ ?¨Î™© - Connect 4</title>
    <link rel="icon" href="icon.svg">
    <style>
        :root {
            --bg: #1e1e2e;
            --board: #1e40af;
            --board-dark: #1e3a8a;
            --text: #eee;
            --accent: #4ecca3;
            --red: #ef4444;
            --yellow: #eab308;
            --blue: #3b82f6;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        #app { min-height: 100vh; }

        .game-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px;
            min-height: 100vh;
        }

        .players-bar {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 16px;
            width: 100%;
            max-width: 500px;
        }

        .player-tag {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(255,255,255,0.05);
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .player-tag.active {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255,255,255,0.2);
        }

        .player-tag.red.active { background: var(--red); color: #fff; }
        .player-tag.yellow.active { background: var(--yellow); color: #000; }
        .player-tag.blue.active { background: var(--blue); color: #fff; }

        .player-tag .disc {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .disc.red { background: var(--red); }
        .disc.yellow { background: var(--yellow); }
        .disc.blue { background: var(--blue); }

        .board-container {
            position: relative;
            width: 100%;
            max-width: 420px;
        }

        .column-buttons {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 8px;
        }

        .col-btn {
            padding: 8px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: var(--text);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .col-btn:hover:not(:disabled) {
            background: var(--accent);
            color: #000;
            transform: translateY(-2px);
        }

        .col-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            background: linear-gradient(145deg, var(--board), var(--board-dark));
            padding: 12px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }

        .cell {
            aspect-ratio: 1;
            background: var(--bg);
            border-radius: 50%;
            position: relative;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.5);
        }

        .cell .piece {
            position: absolute;
            inset: 8%;
            border-radius: 50%;
            animation: drop 0.3s ease-out;
        }

        @keyframes drop {
            from { transform: translateY(-300%); }
            to { transform: translateY(0); }
        }

        .piece.red { 
            background: radial-gradient(circle at 30% 30%, #f87171, var(--red)); 
            box-shadow: 0 2px 8px rgba(239,68,68,0.5);
        }
        .piece.yellow { 
            background: radial-gradient(circle at 30% 30%, #fde047, var(--yellow)); 
            box-shadow: 0 2px 8px rgba(234,179,8,0.5);
        }
        .piece.blue { 
            background: radial-gradient(circle at 30% 30%, #60a5fa, var(--blue)); 
            box-shadow: 0 2px 8px rgba(59,130,246,0.5);
        }

        .piece.win {
            animation: pulse 0.5s ease-in-out infinite alternate;
        }

        @keyframes pulse {
            to { transform: scale(1.1); box-shadow: 0 0 20px currentColor; }
        }

        .game-status {
            text-align: center;
            padding: 16px;
            font-size: 1.1rem;
        }

        .game-actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            background: rgba(255,255,255,0.1);
            color: var(--text);
            transition: all 0.2s;
        }

        .btn:hover { background: rgba(255,255,255,0.2); }
        .btn.primary { background: var(--accent); color: #000; }

        .turn-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 20px;
            background: rgba(255,255,255,0.05);
            margin-bottom: 16px;
        }

        .turn-indicator .disc {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            animation: bounce 0.5s ease-in-out infinite alternate;
        }

        @keyframes bounce {
            to { transform: translateY(-4px); }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script src="/lib/multiplayer.js?v=202602100852"></script>
    <script src="/lib/multiplayer-ui.js?v=202602100852"></script>
    <script>
        // ===== Constants =====
        const COLS = 7;
        const ROWS = 6;
        const COLORS = ['red', 'yellow', 'blue'];

        // ===== State =====
        let board = [];
        let players = [];
        let currentPlayerIndex = 0;
        let gameOver = false;
        let winner = null;
        let winLine = null;
        let myColor = null;
        let isMultiplayer = false;
        let mpUI = null;

        // ===== Initialize =====
        function init() {
            mpUI = new MultiplayerUI({
                gameType: 'connect4',
                gameName: '?î¥?ü°?îµ ?ºÏù∏ ?¨Î™©',
                container: document.getElementById('app'),
                maxPlayers: 3,
                supportsLocal: false,  // Î©Ä?∞Ìîå?àÏù¥???ÑÏö©
                onGameStart: handleGameStart,
                onGameEvent: handleGameEvent,
                onLeave: () => { isMultiplayer = false; }
            });

            const roomCode = MultiplayerUI.checkUrlRoom();
            if (roomCode) {
                mpUI._renderLobby();
                setTimeout(() => {
                    document.getElementById('mp-room-code').value = roomCode;
                }, 100);
            } else {
                mpUI.show();
            }
        }

        // ===== Game Start =====
        function handleGameStart(state) {
            if (state.mode === 'local') {
                startLocalGame();
            } else {
                startMultiplayerGame(state);
            }
        }

        function startLocalGame() {
            isMultiplayer = false;
            players = [
                { id: '1', nickname: 'P1', color: 'red' },
                { id: '2', nickname: 'P2', color: 'yellow' },
                { id: '3', nickname: 'P3', color: 'blue' }
            ];
            initBoard();
            renderGame();
        }

        function startMultiplayerGame(state) {
            isMultiplayer = true;
            
            const gs = state.gameState;
            const myId = mpUI.getClient().getMyUserId();
            const me = gs.players.find(p => p.id === myId);
            
            myColor = me?.color;
            players = gs.players;
            currentPlayerIndex = gs.currentPlayerIndex;
            
            // Restore board
            board = gs.board.map(row => row.map(cell => {
                if (!cell) return null;
                const p = gs.players.find(pl => pl.id === cell);
                return p?.color || null;
            }));
            
            gameOver = !!gs.winner;
            winner = gs.winner;
            winLine = gs.winLine;
            
            renderGame(gs);
            
            mpUI.getClient().onStateChange = (newState) => {
                if (newState.status === 'playing') {
                    updateFromState(newState);
                }
            };
            
            showToast(`Í≤åÏûÑ ?úÏûë! ?πÏã†?Ä ${getColorName(myColor)}?ÖÎãà??);
        }

        function getColorName(color) {
            return { red: 'Îπ®Í∞ï?î¥', yellow: '?∏Îûë?ü°', blue: '?åÎûë?îµ' }[color] || color;
        }

        // ===== Board Logic =====
        function initBoard() {
            board = Array(ROWS).fill(null).map(() => Array(COLS).fill(null));
            currentPlayerIndex = 0;
            gameOver = false;
            winner = null;
            winLine = null;
        }

        function handleDrop(col) {
            if (gameOver) return;
            if (board[0][col] !== null) return; // Column full
            
            const currentPlayer = players[currentPlayerIndex];
            
            if (isMultiplayer) {
                const myId = mpUI.getClient().getMyUserId();
                if (currentPlayer.id !== myId) {
                    showToast('?πÏã†??Ï∞®Î?Í∞Ä ?ÑÎãô?àÎã§');
                    return;
                }
                sendDrop(col);
            } else {
                dropPiece(col, currentPlayer.color);
                checkGameEnd();
                if (!gameOver) {
                    currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
                }
                renderGame();
            }
        }

        function dropPiece(col, color) {
            for (let row = ROWS - 1; row >= 0; row--) {
                if (board[row][col] === null) {
                    board[row][col] = color;
                    return { row, col };
                }
            }
            return null;
        }

        async function sendDrop(col) {
            try {
                await mpUI.sendAction({ type: 'drop', payload: { col } });
            } catch (e) {
                showToast('?§Ìå®: ' + e.message);
            }
        }

        function updateFromState(state) {
            const gs = state.gameState;
            
            players = gs.players;
            currentPlayerIndex = gs.currentPlayerIndex;
            
            board = gs.board.map(row => row.map(cell => {
                if (!cell) return null;
                const p = gs.players.find(pl => pl.id === cell);
                return p?.color || null;
            }));
            
            gameOver = !!gs.winner;
            winner = gs.winner;
            winLine = gs.winLine;
            
            renderGame(gs);
            
            if (gameOver && winner && winner !== 'draw') {
                const winnerPlayer = players.find(p => p.id === winner);
                setTimeout(() => showResult(winnerPlayer), 300);
            }
        }

        function checkGameEnd() {
            // Check each cell that was just placed
            for (let row = 0; row < ROWS; row++) {
                for (let col = 0; col < COLS; col++) {
                    if (board[row][col]) {
                        const result = checkWin(row, col, board[row][col]);
                        if (result) {
                            gameOver = true;
                            winLine = result;
                            const winnerPlayer = players.find(p => p.color === board[row][col]);
                            setTimeout(() => showResult(winnerPlayer), 300);
                            return;
                        }
                    }
                }
            }
            
            // Check draw
            if (board[0].every(cell => cell !== null)) {
                gameOver = true;
                winner = 'draw';
            }
        }

        function checkWin(row, col, color) {
            const directions = [[0,1],[1,0],[1,1],[1,-1]];
            
            for (const [dr, dc] of directions) {
                const line = [{ row, col }];
                
                for (let i = 1; i < 4; i++) {
                    const r = row + dr*i, c = col + dc*i;
                    if (r >= 0 && r < ROWS && c >= 0 && c < COLS && board[r][c] === color) {
                        line.push({ row: r, col: c });
                    } else break;
                }
                
                for (let i = 1; i < 4; i++) {
                    const r = row - dr*i, c = col - dc*i;
                    if (r >= 0 && r < ROWS && c >= 0 && c < COLS && board[r][c] === color) {
                        line.push({ row: r, col: c });
                    } else break;
                }
                
                if (line.length >= 4) return line;
            }
            return null;
        }

        function showResult(winnerPlayer) {
            if (isMultiplayer) {
                const myId = mpUI.getClient().getMyUserId();
                const isWin = winnerPlayer?.id === myId;
                mpUI.showResult({
                    title: isWin ? '?éâ ?πÎ¶¨!' : '?ò¢ ?®Î∞∞',
                    detail: winnerPlayer ? `${getColorName(winnerPlayer.color)} ${winnerPlayer.nickname} ?πÎ¶¨` : 'Î¨¥ÏäπÎ∂Ä',
                    isWin,
                    showRematch: true
                });
            } else {
                mpUI.showResult({
                    title: winnerPlayer ? `${getColorName(winnerPlayer.color)} ?πÎ¶¨!` : 'Î¨¥ÏäπÎ∂Ä',
                    isWin: null,
                    showRematch: false
                });
            }
        }

        // ===== Events =====
        function handleGameEvent(type, data) {
            if (type === 'drop' && isMultiplayer) {
                // State will be updated via onStateChange
            }
        }

        // ===== Rendering =====
        function renderGame(gs = {}) {
            const myId = mpUI?.getClient()?.getMyUserId();
            const currentPlayer = players[currentPlayerIndex];
            const isMyTurn = isMultiplayer ? currentPlayer?.id === myId : true;
            
            document.getElementById('app').innerHTML = `
                <div class="game-screen">
                    <div class="players-bar">
                        ${players.map((p, i) => `
                            <div class="player-tag ${p.color} ${i === currentPlayerIndex && !gameOver ? 'active' : ''}">
                                <div class="disc ${p.color}"></div>
                                <span>${p.nickname}${p.id === myId ? ' (??' : ''}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="turn-indicator">
                        ${gameOver ? 'Í≤åÏûÑ Ï¢ÖÎ£å' : `
                            <div class="disc ${currentPlayer?.color}"></div>
                            <span>${isMultiplayer ? 
                                (isMyTurn ? '??Ï∞®Î?!' : `${currentPlayer?.nickname}??Ï∞®Î?`) : 
                                `${currentPlayer?.nickname}??Ï∞®Î?`}</span>
                        `}
                    </div>
                    
                    <div class="board-container">
                        <div class="column-buttons">
                            ${Array(COLS).fill(0).map((_, col) => `
                                <button class="col-btn" 
                                        onclick="handleDrop(${col})"
                                        ${gameOver || board[0][col] !== null || (isMultiplayer && !isMyTurn) ? 'disabled' : ''}>
                                    ??                                </button>
                            `).join('')}
                        </div>
                        
                        <div class="board">
                            ${renderBoard()}
                        </div>
                    </div>
                    
                    <div class="game-actions">
                        ${!isMultiplayer ? '<button class="btn" onclick="restartGame()">??Í≤åÏûÑ</button>' : ''}
                        <button class="btn" onclick="exitGame()">?òÍ?Í∏?/button>
                    </div>
                </div>
            `;
        }

        function renderBoard() {
            let html = '';
            for (let row = 0; row < ROWS; row++) {
                for (let col = 0; col < COLS; col++) {
                    const color = board[row][col];
                    const isWinCell = winLine?.some(p => p.row === row && p.col === col);
                    
                    html += `
                        <div class="cell">
                            ${color ? `<div class="piece ${color} ${isWinCell ? 'win' : ''}"></div>` : ''}
                        </div>
                    `;
                }
            }
            return html;
        }

        function restartGame() {
            initBoard();
            renderGame();
        }

        function exitGame() {
            if (isMultiplayer && mpUI.getClient()) {
                if (confirm('Í≤åÏûÑ???òÍ??úÍ≤†?µÎãàÍπ?')) {
                    mpUI.getClient().leaveRoom().catch(() => {});
                    MultiplayerClient.resetInstance();
                    isMultiplayer = false;
                    mpUI.show();
                }
            } else {
                mpUI.show();
            }
        }

        function showToast(msg) {
            const existing = document.querySelector('.mp-toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = 'mp-toast';
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        init();
    </script>
</body>
</html>
