<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>조커런 - 포커 로그라이크</title>
  <link rel="icon" href="icon.svg" type="image/svg+xml">
  <style>
    :root {
      color-scheme: dark;
      --felt-1: #062f27;
      --felt-2: #04211b;
      --felt-3: #0b3d31;
      --text: #e6f7f1;
      --muted: #9cc7bb;
      --panel: rgba(9, 30, 24, 0.58);
      --panel-strong: rgba(7, 23, 19, 0.74);
      --border: rgba(118, 255, 225, 0.24);
      --pink: #ff4fc5;
      --cyan: #45f5ff;
      --gold: #ffcf6d;
      --red-start: #ff416c;
      --red-end: #ff4b2b;
      --dark-start: #232526;
      --dark-end: #414345;
      --ok: #7af5b8;
      --danger: #ff7f91;
      --shadow: 0 14px 36px rgba(0, 0, 0, 0.48);
      --blur: blur(12px);
      --ease: 200ms ease;
      --phone-w: min(100vw, 460px);
      --header-h: 44px;
      --joker-h: 72px;
      --score-h: 34px;
      --status-h: 32px;
      --actions-h: 56px;
      --gap: 8px;
    }

    :root.light {
      color-scheme: light;
      --felt-1: #145844;
      --felt-2: #0f4536;
      --felt-3: #1f6c56;
      --text: #f7fffc;
      --muted: #d0f0e5;
      --panel: rgba(10, 39, 31, 0.56);
      --panel-strong: rgba(8, 29, 23, 0.66);
      --border: rgba(154, 255, 235, 0.34);
    }

    @media (prefers-color-scheme: light) {
      :root {
        color-scheme: light;
        --felt-1: #145844;
        --felt-2: #0f4536;
        --felt-3: #1f6c56;
        --text: #f7fffc;
        --muted: #d0f0e5;
        --panel: rgba(10, 39, 31, 0.56);
        --panel-strong: rgba(8, 29, 23, 0.66);
        --border: rgba(154, 255, 235, 0.34);
      }
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    html,
    body {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: "Pretendard", "SUIT", "Noto Sans KR", "Apple SD Gothic Neo", sans-serif;
      color: var(--text);
      background:
        radial-gradient(120% 140% at 0% 0%, rgba(69, 245, 255, 0.16), transparent 44%),
        radial-gradient(120% 140% at 100% 0%, rgba(255, 79, 197, 0.2), transparent 42%),
        radial-gradient(120% 140% at 50% 100%, rgba(255, 207, 109, 0.14), transparent 58%),
        repeating-linear-gradient(45deg, rgba(255, 255, 255, 0.015) 0 2px, transparent 2px 10px),
        linear-gradient(165deg, var(--felt-3), var(--felt-1) 45%, var(--felt-2));
      display: grid;
      place-items: center;
      padding: max(8px, env(safe-area-inset-top)) 8px max(8px, env(safe-area-inset-bottom));
    }

    .app {
      width: var(--phone-w);
      height: calc(100dvh - max(8px, env(safe-area-inset-top)) - max(8px, env(safe-area-inset-bottom)) - 8px);
      max-height: 100dvh;
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 20px;
      background: linear-gradient(180deg, rgba(4, 23, 18, 0.72), rgba(4, 21, 17, 0.82));
      box-shadow: var(--shadow);
      backdrop-filter: var(--blur);
      display: grid;
      grid-template-rows: var(--header-h) var(--joker-h) var(--score-h) minmax(180px, 1fr) var(--status-h) var(--actions-h);
      gap: var(--gap);
      padding: 10px;
      position: relative;
      overflow: hidden;
    }

    .glass {
      border: 1px solid var(--border);
      background: linear-gradient(160deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
      border-radius: 12px;
      backdrop-filter: var(--blur);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }

    .topbar {
      display: grid;
      grid-template-columns: 1fr auto auto;
      align-items: center;
      gap: 8px;
      padding: 0 10px;
    }

    .meta {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 800;
      letter-spacing: 0.01em;
      min-width: 0;
      font-size: 0.92rem;
      text-shadow: 0 0 14px rgba(69, 245, 255, 0.25);
    }

    .meta .sep {
      color: rgba(230, 247, 241, 0.35);
      font-weight: 500;
    }

    .target-pill {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      color: var(--gold);
      font-size: 0.82rem;
      white-space: nowrap;
      text-shadow: 0 0 10px rgba(255, 207, 109, 0.48);
    }

    .target-icon {
      width: 14px;
      height: 14px;
      display: inline-block;
      border-radius: 50%;
      border: 2px solid currentColor;
      position: relative;
    }

    .target-icon::before,
    .target-icon::after {
      content: "";
      position: absolute;
      inset: 2px;
      border-radius: 50%;
      border: 1px solid currentColor;
      opacity: 0.7;
    }

    .target-icon::after {
      inset: 5px;
      background: currentColor;
      border: 0;
    }

    button {
      border: 1px solid rgba(255, 255, 255, 0.16);
      border-radius: 10px;
      min-height: 44px;
      min-width: 44px;
      padding: 0 12px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.08));
      color: var(--text);
      font-weight: 800;
      font-size: 0.84rem;
      cursor: pointer;
      transition: transform var(--ease), box-shadow var(--ease), opacity var(--ease), border-color var(--ease);
    }

    button:hover:enabled,
    button:active:enabled {
      transform: translateY(-1px);
      box-shadow: 0 0 16px rgba(69, 245, 255, 0.28);
    }

    button:disabled {
      opacity: 0.46;
      cursor: not-allowed;
    }

    .ctrl-btn {
      width: 44px;
      padding: 0;
      font-size: 0;
      position: relative;
    }

    .ctrl-btn::before,
    .ctrl-btn::after {
      content: "";
      position: absolute;
      inset: 0;
      margin: auto;
      width: 16px;
      height: 16px;
    }

    #themeBtn::before {
      border-radius: 50%;
      box-shadow: inset -6px 0 0 0 var(--cyan);
      border: 1px solid rgba(69, 245, 255, 0.8);
    }

    #restartBtn::before {
      border: 2px solid var(--pink);
      border-right-color: transparent;
      border-radius: 50%;
    }

    #restartBtn::after {
      width: 0;
      height: 0;
      border-top: 4px solid transparent;
      border-bottom: 4px solid transparent;
      border-left: 7px solid var(--pink);
      transform: translate(5px, -3px);
    }

    .joker-strip {
      padding: 7px;
      overflow-x: auto;
      overflow-y: hidden;
      display: flex;
      gap: 8px;
      scrollbar-width: thin;
    }

    .joker-strip::-webkit-scrollbar {
      height: 5px;
    }

    .joker-strip::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.24);
      border-radius: 999px;
    }

    .joker {
      width: 50px;
      height: 70px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.35);
      flex: 0 0 auto;
      display: grid;
      place-items: center;
      position: relative;
      overflow: visible;
      transition: transform var(--ease), box-shadow var(--ease);
      cursor: pointer;
      padding: 4px;
      text-align: center;
    }

    .joker:hover,
    .joker.reveal {
      transform: translateY(-2px);
    }

    .joker::before {
      content: attr(data-icon);
      font-size: 1rem;
      font-weight: 900;
      color: #fff;
      text-shadow: 0 0 10px rgba(0, 0, 0, 0.7);
    }

    .joker.empty {
      cursor: default;
      border-style: dashed;
      border-color: rgba(255, 255, 255, 0.25);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.07), rgba(255, 255, 255, 0.02));
    }

    .joker.empty::before {
      content: "+";
      color: rgba(255, 255, 255, 0.5);
      font-size: 1.25rem;
    }

    .joker-tip {
      position: absolute;
      left: 50%;
      bottom: calc(100% + 6px);
      transform: translate(-50%, 6px);
      min-width: 126px;
      max-width: 170px;
      padding: 6px 7px;
      border-radius: 10px;
      background: rgba(5, 16, 14, 0.94);
      border: 1px solid rgba(255, 255, 255, 0.18);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--ease), transform var(--ease);
      z-index: 9;
      font-size: 0.64rem;
      line-height: 1.25;
      white-space: normal;
    }

    .joker:hover .joker-tip,
    .joker.reveal .joker-tip {
      opacity: 1;
      transform: translate(-50%, 0);
    }

    .joker-name {
      display: block;
      color: var(--gold);
      font-weight: 800;
      margin-bottom: 3px;
      font-size: 0.7rem;
    }

    .joker-flat50 { background: linear-gradient(155deg, #ff8a00, #ff5f1f); box-shadow: 0 0 14px rgba(255, 138, 0, 0.75); }
    .joker-flushx2 { background: linear-gradient(160deg, #00a3ff, #42e8ff 65%, #0076c0); box-shadow: 0 0 14px rgba(66, 232, 255, 0.72); }
    .joker-perCardMult { background: repeating-linear-gradient(0deg, #032f1f 0 6px, #07442c 6px 12px); box-shadow: 0 0 14px rgba(106, 255, 164, 0.62); }
    .joker-heartChip { background:
      radial-gradient(circle at 30% 28%, rgba(255, 255, 255, 0.22), transparent 44%),
      radial-gradient(circle at 70% 60%, rgba(255, 255, 255, 0.16), transparent 46%),
      linear-gradient(160deg, #92192f, #ff345e);
      box-shadow: 0 0 14px rgba(255, 58, 92, 0.72);
    }
    .joker-pairBoost { background: linear-gradient(165deg, #7f3dff, #c24cff); box-shadow: 0 0 14px rgba(194, 76, 255, 0.72); }

    .score-line {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 8px;
      padding: 0 10px;
      font-size: 0.88rem;
      position: relative;
    }

    .score-main {
      display: flex;
      gap: 10px;
      align-items: center;
      color: var(--muted);
      font-weight: 700;
      flex-wrap: wrap;
    }

    .score-main b {
      color: var(--text);
      font-size: 0.95rem;
      text-shadow: 0 0 10px rgba(69, 245, 255, 0.34);
      min-width: 44px;
    }

    .score-total {
      font-size: 0.86rem;
      color: var(--ok);
      font-weight: 800;
      white-space: nowrap;
      text-shadow: 0 0 10px rgba(122, 245, 184, 0.45);
      transition: transform var(--ease), color var(--ease);
    }

    .score-total.pulse {
      animation: neonPulse 500ms ease;
    }

    .table {
      position: relative;
      padding: 8px;
      display: grid;
      grid-template-rows: auto minmax(0, 1fr) auto;
      gap: 7px;
      overflow: hidden;
    }

    .info-line {
      min-height: 16px;
      font-size: 0.73rem;
      color: var(--muted);
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding: 0 4px;
    }

    .hand-tag {
      color: var(--gold);
      font-weight: 900;
    }

    .cards-wrap {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 6px;
      align-content: center;
      height: 100%;
      min-height: 0;
    }

    .card {
      border-radius: 8px;
      min-height: clamp(74px, 18vw, 112px);
      border: 2px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 7px 16px rgba(0, 0, 0, 0.35);
      color: #ffffff;
      display: flex;
      justify-content: space-between;
      flex-direction: column;
      padding: 8px;
      user-select: none;
      cursor: pointer;
      transition: transform var(--ease), box-shadow var(--ease), border-color var(--ease), filter var(--ease);
      animation: dealIn 240ms ease;
      position: relative;
      overflow: hidden;
    }

    .card::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(165deg, rgba(255, 255, 255, 0.24), rgba(255, 255, 255, 0));
      mix-blend-mode: screen;
      pointer-events: none;
    }

    .card.s-heart,
    .card.s-diamond {
      background: linear-gradient(150deg, var(--red-start), var(--red-end));
    }

    .card.s-club,
    .card.s-spade {
      background: linear-gradient(150deg, var(--dark-start), var(--dark-end));
    }

    .card:hover,
    .card:active {
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.48);
      filter: brightness(1.04);
    }

    .card.selected {
      border-color: #ffd76a;
      box-shadow: 0 0 0 1px rgba(255, 215, 106, 0.75), 0 14px 24px rgba(0, 0, 0, 0.46), 0 0 20px rgba(255, 207, 109, 0.48);
      transform: translateY(-8px);
      z-index: 2;
    }

    .rank {
      font-size: clamp(1rem, 4vw, 1.2rem);
      font-weight: 900;
      line-height: 1;
      text-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
    }

    .suit {
      align-self: flex-end;
      font-size: clamp(1.2rem, 5vw, 1.42rem);
      font-weight: 900;
      line-height: 1;
      text-shadow: 0 3px 8px rgba(0, 0, 0, 0.42);
    }

    .status-bar {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      align-items: center;
      padding: 0 10px;
      font-size: 0.83rem;
      color: var(--muted);
      font-weight: 700;
    }

    .status-bar b {
      color: var(--text);
      font-weight: 800;
      font-size: 0.92rem;
      text-shadow: 0 0 10px rgba(255, 79, 197, 0.3);
    }

    .actions {
      display: grid;
      grid-template-columns: 1fr 1fr 44px;
      gap: 8px;
      align-items: stretch;
    }

    .btn-main,
    .btn-warn {
      font-size: 0.83rem;
      letter-spacing: 0.02em;
      border: 0;
      color: #08130f;
      text-transform: uppercase;
    }

    .btn-main {
      background: linear-gradient(120deg, #45f5ff, #8bffe3 55%, #ffd76a);
      box-shadow: 0 0 16px rgba(69, 245, 255, 0.38);
    }

    .btn-warn {
      background: linear-gradient(120deg, #ff80cb, #ffc66f 85%);
      box-shadow: 0 0 16px rgba(255, 128, 203, 0.34);
    }

    #clearBtn {
      font-size: 0;
      padding: 0;
      position: relative;
    }

    #clearBtn::before,
    #clearBtn::after {
      content: "";
      position: absolute;
      width: 18px;
      height: 2px;
      background: #fff;
      inset: 0;
      margin: auto;
    }

    #clearBtn::before { transform: rotate(45deg); }
    #clearBtn::after { transform: rotate(-45deg); }

    .log {
      position: absolute;
      width: 1px;
      height: 1px;
      margin: -1px;
      border: 0;
      padding: 0;
      clip: rect(0 0 0 0);
      overflow: hidden;
    }

    .fx {
      position: absolute;
      left: 12px;
      top: 12px;
      padding: 6px 9px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.26);
      background: rgba(9, 35, 28, 0.78);
      color: var(--gold);
      font-weight: 900;
      font-size: 0.78rem;
      pointer-events: none;
      z-index: 7;
      text-shadow: 0 0 10px rgba(255, 207, 109, 0.48);
      animation: floatUp 900ms ease forwards;
    }

    .chip {
      position: fixed;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      pointer-events: none;
      z-index: 30;
      background: radial-gradient(circle at 35% 35%, #fff2cc 0 24%, #ffcf6d 25% 62%, #b77d1f 63%);
      box-shadow: 0 0 8px rgba(255, 207, 109, 0.56);
    }

    .chip.fly {
      animation: chipFly 720ms cubic-bezier(0.25, 0.6, 0.2, 1) forwards;
    }

    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
      background: rgba(2, 12, 10, 0.68);
      backdrop-filter: blur(8px);
      padding: 12px;
    }

    .modal.show {
      display: flex;
    }

    .shop {
      width: min(92vw, 460px);
      border-radius: 16px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(6, 26, 22, 0.86), rgba(5, 18, 15, 0.93));
      box-shadow: var(--shadow);
      padding: 12px;
      display: grid;
      gap: 10px;
      max-height: min(86dvh, 660px);
      overflow: auto;
    }

    .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .title {
      font-size: 1rem;
      font-weight: 900;
      text-shadow: 0 0 12px rgba(69, 245, 255, 0.33);
    }

    .subtitle,
    .tag {
      color: var(--muted);
      font-size: 0.78rem;
      font-weight: 700;
    }

    .shop-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .shop-item {
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.03));
      padding: 9px;
      display: grid;
      gap: 7px;
      transition: transform var(--ease), box-shadow var(--ease);
    }

    .shop-item:hover {
      transform: scale(1.02);
      box-shadow: 0 0 16px rgba(69, 245, 255, 0.22);
    }

    .shop-item .name {
      color: var(--gold);
      font-weight: 900;
      font-size: 0.86rem;
    }

    .shop-item .desc {
      color: var(--muted);
      font-size: 0.72rem;
      line-height: 1.24;
      min-height: 44px;
    }

    .price {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: #ffe5a8;
      font-weight: 800;
      font-size: 0.72rem;
    }

    .coin {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, #fff5d8 0 28%, #ffcf6d 29% 68%, #b77d1f 69%);
      box-shadow: 0 0 6px rgba(255, 207, 109, 0.65);
    }

    @keyframes dealIn {
      from { opacity: 0; transform: translateY(10px) scale(0.96); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    @keyframes neonPulse {
      0% { transform: scale(1); }
      40% { transform: scale(1.1); color: #90ffe4; text-shadow: 0 0 16px rgba(69, 245, 255, 0.9); }
      100% { transform: scale(1); }
    }

    @keyframes floatUp {
      0% { opacity: 0; transform: translateY(8px) scale(0.95); }
      20% { opacity: 1; }
      100% { opacity: 0; transform: translateY(-30px) scale(1.03); }
    }

    @keyframes chipFly {
      0% { transform: translate(0, 0) scale(0.7); opacity: 0; }
      18% { opacity: 1; }
      100% {
        transform: translate(var(--dx), var(--dy)) scale(0.25);
        opacity: 0;
      }
    }

    @media (min-width: 700px) {
      .app {
        width: min(100vw, 520px);
        border-radius: 24px;
      }
      .cards-wrap {
        gap: 8px;
      }
      .actions {
        grid-template-columns: 1fr 1fr 52px;
      }
    }
  </style>
</head>
<body>
  <div class="app" id="tablePanel">
    <header class="topbar glass">
      <div class="meta">
        <span id="roundLabel">-</span>
        <span class="sep">|</span>
        <span id="moneyLabel">$0</span>
      </div>
      <div class="target-pill"><span class="target-icon" aria-hidden="true"></span><span id="targetLabel">0</span></div>
      <div style="display:flex;gap:6px;">
        <button id="themeBtn" class="ctrl-btn" aria-label="?뚮쭏 ?꾪솚"></button>
        <button id="restartBtn" class="ctrl-btn" aria-label="?????쒖옉"></button>
      </div>
    </header>

    <section class="joker-strip glass" id="jokerArea" aria-label="議곗빱 ?щ’"></section>

    <section class="score-line glass">
      <div class="score-main">
        <span>移?<b id="chipsLabel">0</b></span>
        <span>諛곗닔 <b id="multLabel">x1</b></span>
      </div>
      <div class="score-total" id="scoreLabel">0</div>
    </section>

    <section class="table glass">
      <div class="info-line" id="handResult">?몃뱶瑜??좏깮???뚮젅?댄븯?몄슂.</div>
      <div class="cards-wrap" id="cardsWrap"></div>
      <div class="info-line" id="handGuide">?먰뙣 8??以?理쒕? 5?μ쓣 ?좏깮</div>
    </section>

    <section class="status-bar glass">
      <div>?⑥? ?몃뱶 <b id="handsLabel">0</b></div>
      <div style="text-align:right;">?⑥? 踰꾨━湲?<b id="discardsLabel">0</b></div>
    </section>

    <section class="actions">
      <button class="btn-main" id="playBtn">?몃뱶 ?뚮젅??/button>
      <button class="btn-warn" id="discardBtn">移대뱶 踰꾨━湲?/button>
      <button id="clearBtn" aria-label="?좏깮 ?댁젣"></button>
    </section>

    <div class="log" id="log" aria-hidden="true"></div>
  </div>

  <div class="modal" id="shopModal">
    <div class="shop">
      <div class="row">
        <div>
          <div class="title">?곸젏</div>
          <div class="subtitle">議곗빱瑜??ъ꽌 ?ㅼ쓬 釉붾씪?몃뱶瑜??鍮꾪븯?몄슂.</div>
        </div>
        <div class="tag" id="shopMoney">蹂댁쑀 ?먭툑: $0</div>
      </div>
      <div class="shop-grid" id="shopGrid"></div>
      <div class="row" style="justify-content:flex-end;">
        <button class="btn-main" id="nextRoundBtn" style="min-width:132px;">?ㅼ쓬 ?쇱슫??/button>
      </div>
    </div>
  </div>

  <script>
    const suits = ["heart", "diamond", "club", "spade"];
    const suitSymbol = { heart: "??, diamond: "??, club: "??, spade: "?? };
    const suitClass = { heart: "s-heart", diamond: "s-diamond", club: "s-club", spade: "s-spade" };
    const rankList = [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14];
    const rankLabel = { 11: "J", 12: "Q", 13: "K", 14: "A" };

    const handBase = {
      HIGH_CARD: { name: "?섏씠移대뱶", chips: 5, mult: 1 },
      PAIR: { name: "?먰럹??, chips: 10, mult: 2 },
      TWO_PAIR: { name: "?ы럹??, chips: 20, mult: 2 },
      THREE: { name: "?몃━??, chips: 30, mult: 3 },
      STRAIGHT: { name: "?ㅽ듃?덉씠??, chips: 30, mult: 4 },
      FLUSH: { name: "?뚮윭??, chips: 35, mult: 4 },
      FULL_HOUSE: { name: "??섏슦??, chips: 40, mult: 4 },
      FOUR: { name: "?ъ뭅??, chips: 60, mult: 7 },
      STRAIGHT_FLUSH: { name: "?ㅽ듃?덉씠???뚮윭??, chips: 100, mult: 8 }
    };

    const roundDefs = [
      { id: "small", label: "?ㅻぐ 釉붾씪?몃뱶", target: 300 },
      { id: "big", label: "鍮?釉붾씪?몃뱶", target: 700 },
      { id: "boss", label: "蹂댁뒪 釉붾씪?몃뱶", target: 1500 }
    ];

    const jokerPool = [
      {
        id: "flat50",
        name: "移???깂",
        cost: 6,
        desc: "?몃뱶 ?먯닔 怨꾩궛 ??移?+50",
        apply(ctx) { ctx.chips += 50; }
      },
      {
        id: "flushx2",
        name: "臾쇨껐 議곗빱",
        cost: 7,
        desc: "?뚮윭??怨꾩뿴?대㈃ 諛곗닔 x2",
        apply(ctx) {
          if (ctx.handType === "FLUSH" || ctx.handType === "STRAIGHT_FLUSH") ctx.mult *= 2;
        }
      },
      {
        id: "perCardMult",
        name: "怨꾩궛湲?議곗빱",
        cost: 5,
        desc: "?뚮젅?댄븳 移대뱶 1?λ떦 諛곗닔 +1",
        apply(ctx) { ctx.mult += ctx.cards.length; }
      },
      {
        id: "heartChip",
        name: "遺됱? ?몄옣",
        cost: 5,
        desc: "?섑듃 移대뱶 1?λ떦 移?+15",
        apply(ctx) {
          const hearts = ctx.cards.filter(c => c.suit === "heart").length;
          ctx.chips += hearts * 15;
        }
      },
      {
        id: "pairBoost",
        name: "???利앺룺湲?,
        cost: 8,
        desc: "?먰럹???댁긽?대㈃ 諛곗닔 +2",
        apply(ctx) {
          if (ctx.handType !== "HIGH_CARD") ctx.mult += 2;
        }
      }
    ];

    const jokerIcons = {
      flat50: "移?,
      flushx2: "??,
      perCardMult: "怨?,
      heartChip: "??,
      pairBoost: "?"
    };

    const state = {
      roundIndex: 0,
      score: 0,
      money: 10,
      handsLeft: 4,
      discardsLeft: 3,
      deck: [],
      hand: [],
      selected: new Set(),
      jokers: [],
      gameEnded: false
    };

    const $ = sel => document.querySelector(sel);
    const cardsWrap = $("#cardsWrap");
    const handResult = $("#handResult");
    const logEl = $("#log");
    const jokerArea = $("#jokerArea");
    const tablePanel = $("#tablePanel");

    function buildDeck() {
      let id = 0;
      const deck = [];
      for (const suit of suits) {
        for (const rank of rankList) deck.push({ id: id++, suit, rank });
      }
      for (let i = deck.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [deck[i], deck[j]] = [deck[j], deck[i]];
      }
      return deck;
    }

    function formatRank(rank) {
      return rankLabel[rank] || String(rank);
    }

    function drawToEight() {
      while (state.hand.length < 8 && state.deck.length > 0) {
        state.hand.push(state.deck.pop());
      }
    }

    function setInfo(msg) {
      handResult.innerHTML = msg;
    }

    function addLog(msg) {
      const el = document.createElement("div");
      el.textContent = msg;
      logEl.prepend(el);
      while (logEl.children.length > 40) logEl.removeChild(logEl.lastChild);
    }

    function renderCards() {
      cardsWrap.innerHTML = "";
      state.hand.forEach(card => {
        const d = document.createElement("div");
        d.className = `card ${suitClass[card.suit]} ${state.selected.has(card.id) ? "selected" : ""}`;
        d.innerHTML = `<div class="rank">${formatRank(card.rank)}</div><div class="suit">${suitSymbol[card.suit]}</div>`;
        d.addEventListener("click", () => {
          if (state.gameEnded) return;
          if (state.selected.has(card.id)) state.selected.delete(card.id);
          else {
            if (state.selected.size >= 5) {
              setInfo("理쒕? 5?κ퉴吏留??좏깮 媛?ν빀?덈떎.");
              return;
            }
            state.selected.add(card.id);
          }
          renderCards();
        });
        cardsWrap.appendChild(d);
      });
    }

    function renderJokers() {
      jokerArea.innerHTML = "";
      for (let i = 0; i < 5; i++) {
        const joker = state.jokers[i];
        const box = document.createElement("button");
        if (!joker) {
          box.className = "joker empty";
          box.type = "button";
          box.disabled = true;
          box.setAttribute("aria-label", "鍮??щ’");
        } else {
          box.className = `joker joker-${joker.id}`;
          box.type = "button";
          box.dataset.icon = jokerIcons[joker.id] || "議?;
          box.innerHTML = `<span class="joker-tip"><span class="joker-name">${joker.name}</span>${joker.desc}</span>`;
          box.setAttribute("aria-label", joker.name);
          box.addEventListener("click", () => {
            box.classList.toggle("reveal");
          });
        }
        jokerArea.appendChild(box);
      }
    }

    function renderHUD(chips = 0, mult = 1) {
      const round = roundDefs[state.roundIndex] || roundDefs[roundDefs.length - 1];
      $("#roundLabel").textContent = `?쇱슫??${state.roundIndex + 1}`;
      $("#targetLabel").textContent = round.target.toLocaleString();
      $("#scoreLabel").textContent = state.score.toLocaleString();
      $("#moneyLabel").textContent = `$${state.money}`;
      $("#handsLabel").textContent = String(state.handsLeft);
      $("#discardsLabel").textContent = String(state.discardsLeft);
      $("#chipsLabel").textContent = chips.toLocaleString();
      $("#multLabel").textContent = `x${mult}`;
      $("#playBtn").disabled = state.gameEnded;
      $("#discardBtn").disabled = state.gameEnded;
      renderJokers();
    }

    function selectedCards() {
      return state.hand.filter(c => state.selected.has(c.id));
    }

    function scoreHand(cards) {
      if (!cards.length) return { handType: "HIGH_CARD", ...handBase.HIGH_CARD };
      const ranks = cards.map(c => c.rank).sort((a, b) => a - b);
      const suitsOnly = cards.map(c => c.suit);
      const counts = Object.values(ranks.reduce((m, r) => ((m[r] = (m[r] || 0) + 1), m), {})).sort((a, b) => b - a);

      const isFive = cards.length === 5;
      const isFlush = isFive && new Set(suitsOnly).size === 1;
      let isStraight = false;
      if (isFive) {
        const uniq = [...new Set(ranks)];
        if (uniq.length === 5) {
          const normal = uniq[4] - uniq[0] === 4;
          const wheel = uniq.join(",") === "2,3,4,5,14";
          isStraight = normal || wheel;
        }
      }

      if (isStraight && isFlush) return { handType: "STRAIGHT_FLUSH", ...handBase.STRAIGHT_FLUSH };
      if (counts[0] === 4) return { handType: "FOUR", ...handBase.FOUR };
      if (counts[0] === 3 && counts[1] === 2) return { handType: "FULL_HOUSE", ...handBase.FULL_HOUSE };
      if (isFlush) return { handType: "FLUSH", ...handBase.FLUSH };
      if (isStraight) return { handType: "STRAIGHT", ...handBase.STRAIGHT };
      if (counts[0] === 3) return { handType: "THREE", ...handBase.THREE };
      if (counts[0] === 2 && counts[1] === 2) return { handType: "TWO_PAIR", ...handBase.TWO_PAIR };
      if (counts[0] === 2) return { handType: "PAIR", ...handBase.PAIR };
      return { handType: "HIGH_CARD", ...handBase.HIGH_CARD };
    }

    function spawnChipParticles(points) {
      const scoreEl = $("#scoreLabel");
      const source = tablePanel.getBoundingClientRect();
      const target = scoreEl.getBoundingClientRect();
      const startX = source.left + source.width * 0.5;
      const startY = source.top + source.height * 0.65;
      const endX = target.left + target.width * 0.5;
      const endY = target.top + target.height * 0.5;
      const count = Math.min(16, Math.max(8, Math.floor(points / 60)));

      for (let i = 0; i < count; i++) {
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.style.left = `${startX + (Math.random() * 34 - 17)}px`;
        chip.style.top = `${startY + (Math.random() * 16 - 8)}px`;
        chip.style.setProperty("--dx", `${endX - startX + (Math.random() * 14 - 7)}px`);
        chip.style.setProperty("--dy", `${endY - startY + (Math.random() * 14 - 7)}px`);
        chip.style.animationDelay = `${i * 24}ms`;
        chip.classList.add("fly");
        document.body.appendChild(chip);
        setTimeout(() => chip.remove(), 860 + i * 24);
      }
    }

    function animateScore(points, mult) {
      const fx = document.createElement("div");
      fx.className = "fx";
      fx.textContent = `+${points.toLocaleString()} ??;
      tablePanel.appendChild(fx);
      setTimeout(() => fx.remove(), 880);
      spawnChipParticles(points);

      const total = $("#scoreLabel");
      total.classList.remove("pulse");
      void total.offsetWidth;
      total.classList.add("pulse");
      $("#multLabel").textContent = `x${mult}`;
    }

    function consumeSelectedCards() {
      state.hand = state.hand.filter(c => !state.selected.has(c.id));
      state.selected.clear();
      drawToEight();
      renderCards();
    }

    function canContinue() {
      const target = roundDefs[state.roundIndex].target;
      if (state.score >= target) {
        winRound();
        return false;
      }
      if (state.handsLeft <= 0) {
        loseRun();
        return false;
      }
      return true;
    }

    function playSelected() {
      if (state.gameEnded) return;
      const cards = selectedCards();
      if (!cards.length) {
        setInfo("癒쇱? 移대뱶瑜?1???댁긽 ?좏깮?섏꽭??");
        return;
      }
      const hand = scoreHand(cards);
      let chips = hand.chips;
      let mult = hand.mult;
      const ctx = { cards, handType: hand.handType, chips, mult };

      for (const joker of state.jokers) {
        joker.apply(ctx);
      }

      chips = Math.max(0, Math.floor(ctx.chips));
      mult = Math.max(1, Math.floor(ctx.mult * 100) / 100);
      const points = Math.floor(chips * mult);

      state.score += points;
      state.handsLeft -= 1;

      animateScore(points, mult);
      setInfo(`<span class="hand-tag">${hand.name}</span> | ${chips}移?횞 ${mult}諛?= <b>${points.toLocaleString()}</b>??);
      addLog(`${hand.name} ?뚮젅?? +${points}??(?⑥? ?몃뱶 ${state.handsLeft})`);

      consumeSelectedCards();
      renderHUD(chips, mult);
      canContinue();
    }

    function discardSelected() {
      if (state.gameEnded) return;
      if (state.discardsLeft <= 0) {
        setInfo("踰꾨━湲??잛닔瑜?紐⑤몢 ?ъ슜?덉뒿?덈떎.");
        return;
      }
      const cards = selectedCards();
      if (!cards.length) {
        setInfo("踰꾨┫ 移대뱶瑜??좏깮?섏꽭??");
        return;
      }
      state.discardsLeft -= 1;
      consumeSelectedCards();
      setInfo(`${cards.length}??踰꾨┝ ?꾨즺. ?⑥? 踰꾨━湲?${state.discardsLeft}`);
      addLog(`${cards.length}??踰꾨┝. (?⑥? 踰꾨━湲?${state.discardsLeft})`);
      renderHUD();
    }

    function openShop() {
      const grid = $("#shopGrid");
      grid.innerHTML = "";
      $("#shopMoney").textContent = `蹂댁쑀 ?먭툑: $${state.money}`;

      jokerPool.forEach(joker => {
        const owned = state.jokers.some(j => j.id === joker.id);
        const full = state.jokers.length >= 5;
        const afford = state.money >= joker.cost;
        const disabled = owned || full || !afford;

        const card = document.createElement("div");
        card.className = "shop-item";
        card.innerHTML = `
          <div class="name">${joker.name}</div>
          <div class="desc">${joker.desc}</div>
          <div class="price"><span class="coin" aria-hidden="true"></span>$${joker.cost}</div>
        `;
        const btn = document.createElement("button");
        btn.textContent = owned ? "蹂댁쑀 以? : full ? "?щ’ 媛??李? : afford ? "援щℓ" : "?먭툑 遺議?;
        btn.disabled = disabled;
        btn.addEventListener("click", () => {
          state.money -= joker.cost;
          state.jokers.push(joker);
          addLog(`議곗빱 援щℓ: ${joker.name} (-$${joker.cost})`);
          renderHUD();
          openShop();
        });
        card.appendChild(btn);
        grid.appendChild(card);
      });

      $("#shopModal").classList.add("show");
    }

    function closeShop() {
      $("#shopModal").classList.remove("show");
    }

    function startRound(index) {
      state.roundIndex = index;
      state.score = 0;
      state.handsLeft = 4;
      state.discardsLeft = 3;
      state.deck = buildDeck();
      state.hand = [];
      state.selected.clear();
      state.gameEnded = false;
      drawToEight();
      renderCards();
      renderHUD();
      setInfo("?몃뱶瑜??좏깮???뚮젅?댄븯?몄슂.");
      addLog(`${roundDefs[index].label} ?쒖옉. 紐⑺몴 ${roundDefs[index].target}??);
    }

    function winRound() {
      const reward = 7 + state.handsLeft * 2 + state.discardsLeft;
      state.money += reward;
      addLog(`?쇱슫???대━?? 蹂댁긽 +$${reward}`);
      setInfo(`釉붾씪?몃뱶 ?뚰뙆 ?깃났! 蹂댁긽 +$${reward}`);
      state.gameEnded = true;
      renderHUD();

      if (state.roundIndex >= roundDefs.length - 1) {
        setInfo("蹂댁뒪 釉붾씪?몃뱶 寃⑺뙆! ???대━?? ???곗쓣 ?쒖옉?섏꽭??");
        addLog("???대━???꾨즺.");
        return;
      }
      openShop();
    }

    function loseRun() {
      state.gameEnded = true;
      renderHUD();
      setInfo("?몃뱶瑜?紐⑤몢 ?ъ슜?덉뒿?덈떎. 寃뚯엫 ?ㅻ쾭! ???곗쓣 ?쒖옉?섏꽭??");
      addLog("寃뚯엫 ?ㅻ쾭.");
    }

    function newRun() {
      state.money = 10;
      state.jokers = [];
      logEl.innerHTML = "";
      closeShop();
      startRound(0);
    }

    $("#playBtn").addEventListener("click", playSelected);
    $("#discardBtn").addEventListener("click", discardSelected);
    $("#clearBtn").addEventListener("click", () => {
      state.selected.clear();
      renderCards();
      setInfo("?좏깮???댁젣?덉뒿?덈떎.");
    });

    $("#nextRoundBtn").addEventListener("click", () => {
      closeShop();
      startRound(state.roundIndex + 1);
    });

    $("#restartBtn").addEventListener("click", newRun);

    $("#themeBtn").addEventListener("click", () => {
      document.documentElement.classList.toggle("light");
    });

    if (window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches) {
      document.documentElement.classList.add("light");
    }

    newRun();
  </script>
</body>
</html>
