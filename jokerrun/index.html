<!DOCTYPE html>
<html lang="ko">
<head>
  <script src="https://cdn.jsdelivr.net/npm/animejs@4.3.6/lib/anime.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/party-js@2.2.0/bundle/party.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/countup.js@2.9.0/dist/countUp.umd.js"></script>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({"gtm.start":new Date().getTime(),event:"gtm.js"});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!="dataLayer"?"&l="+l:"";j.async=true;j.src="https://www.googletagmanager.com/gtm.js?id="+i+dl;f.parentNode.insertBefore(j,f)})(window,document,"script","dataLayer","GTM-MV8KQGJF");</script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Ï°∞Ïª§Îü∞</title>
  <link rel="icon" href="icon.svg" type="image/svg+xml">
  <style>
    :root {
      color-scheme: dark;
      --felt-1: #062f27;
      --felt-2: #04211b;
      --felt-3: #0b3d31;
      --text: #e6f7f1;
      --muted: #9cc7bb;
      --panel: rgba(9, 30, 24, 0.58);
      --panel-strong: rgba(7, 23, 19, 0.74);
      --border: rgba(118, 255, 225, 0.24);
      --pink: #ff4fc5;
      --cyan: #45f5ff;
      --gold: #ffcf6d;
      --red-start: #ff416c;
      --red-end: #ff4b2b;
      --dark-start: #232526;
      --dark-end: #414345;
      --ok: #7af5b8;
      --danger: #ff7f91;
      --shadow: 0 14px 36px rgba(0, 0, 0, 0.48);
      --blur: blur(12px);
      --ease: 260ms cubic-bezier(0.22, 1, 0.36, 1);
      --phone-w: min(100vw, 460px);
      --header-h: 44px;
      --joker-h: 72px;
      --score-h: 34px;
      --status-h: 32px;
      --actions-h: 56px;
      --gap: 8px;
    }

    :root.light {
      color-scheme: light;
      --felt-1: #145844;
      --felt-2: #0f4536;
      --felt-3: #1f6c56;
      --text: #f7fffc;
      --muted: #d0f0e5;
      --panel: rgba(10, 39, 31, 0.56);
      --panel-strong: rgba(8, 29, 23, 0.66);
      --border: rgba(154, 255, 235, 0.34);
    }

    @media (prefers-color-scheme: light) {
      :root {
        color-scheme: light;
        --felt-1: #145844;
        --felt-2: #0f4536;
        --felt-3: #1f6c56;
        --text: #f7fffc;
        --muted: #d0f0e5;
        --panel: rgba(10, 39, 31, 0.56);
        --panel-strong: rgba(8, 29, 23, 0.66);
        --border: rgba(154, 255, 235, 0.34);
      }
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    html,
    body {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: "Pretendard", "SUIT", "Noto Sans KR", "Apple SD Gothic Neo", sans-serif;
      color: var(--text);
      background:
        radial-gradient(120% 140% at 0% 0%, rgba(69, 245, 255, 0.16), transparent 44%),
        radial-gradient(120% 140% at 100% 0%, rgba(255, 79, 197, 0.2), transparent 42%),
        radial-gradient(120% 140% at 50% 100%, rgba(255, 207, 109, 0.14), transparent 58%),
        repeating-linear-gradient(45deg, rgba(255, 255, 255, 0.015) 0 2px, transparent 2px 10px),
        linear-gradient(165deg, var(--felt-3), var(--felt-1) 45%, var(--felt-2));
      display: grid;
      place-items: center;
      padding: calc(48px + max(8px, env(safe-area-inset-top))) 8px max(8px, env(safe-area-inset-bottom)); /* 48px for SharedWallet bar */
      position: relative;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background:
        radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.045), transparent 22%),
        radial-gradient(circle at 80% 30%, rgba(255, 255, 255, 0.03), transparent 20%),
        repeating-linear-gradient(0deg, rgba(0, 0, 0, 0.06) 0 1px, transparent 1px 3px),
        repeating-linear-gradient(90deg, rgba(255, 255, 255, 0.015) 0 1px, transparent 1px 4px);
      mix-blend-mode: soft-light;
      opacity: 0.75;
      z-index: 0;
    }

    .app {
      width: var(--phone-w);
      height: calc(100dvh - 48px - max(8px, env(safe-area-inset-top)) - max(8px, env(safe-area-inset-bottom)) - 8px); /* 48px for SharedWallet bar */
      max-height: 100dvh;
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 20px;
      background: linear-gradient(180deg, rgba(4, 23, 18, 0.72), rgba(4, 21, 17, 0.82));
      box-shadow: var(--shadow);
      backdrop-filter: var(--blur);
      display: grid;
      grid-template-rows: var(--header-h) var(--joker-h) var(--score-h) minmax(160px, 1fr) var(--status-h) auto var(--actions-h);
      gap: var(--gap);
      padding: 10px;
      position: relative;
      overflow: hidden;
      z-index: 1;
    }

    .glass {
      border: 1px solid var(--border);
      background: linear-gradient(160deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
      border-radius: 12px;
      backdrop-filter: var(--blur);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }

    .topbar {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 10px;
      padding: 0 10px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .round-label {
      font-size: 0.65rem;
      font-weight: 700;
      color: var(--muted);
      letter-spacing: 0.05em;
    }
    .round-num {
      font-size: 0.95rem;
      font-weight: 800;
      color: var(--cyan);
      text-shadow: 0 0 10px rgba(69, 245, 255, 0.4);
    }

    .target-display {
      display: flex;
      flex-direction: column;
      align-items: center;
      line-height: 1.1;
    }
    .target-label {
      font-size: 0.6rem;
      font-weight: 600;
      color: var(--muted);
      letter-spacing: 0.03em;
    }
    .target-value {
      font-size: 1.15rem;
      font-weight: 900;
      color: var(--gold);
      text-shadow: 0 0 14px rgba(255, 207, 109, 0.6);
    }

    .header-right {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 6px;
    }
    .money-badge {
      font-size: 0.85rem;
      font-weight: 800;
      color: var(--ok);
      text-shadow: 0 0 10px rgba(122, 245, 184, 0.4);
      margin-right: 2px;
    }

    .gold-badge {
      font-size: 0.78rem;
      font-weight: 800;
      color: #ffe5a8;
      text-shadow: 0 0 10px rgba(255, 207, 109, 0.45);
      margin-right: 2px;
    }

    .target-icon::before,
    .target-icon::after {
      content: "";
      position: absolute;
      inset: 2px;
      border-radius: 50%;
      border: 1px solid currentColor;
      opacity: 0.7;
    }

    .target-icon::after {
      inset: 5px;
      background: currentColor;
      border: 0;
    }

    button {
      border: 1px solid rgba(255, 255, 255, 0.16);
      border-radius: 10px;
      min-height: 44px;
      min-width: 44px;
      padding: 0 12px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.08));
      color: var(--text);
      font-weight: 800;
      font-size: 0.84rem;
      cursor: pointer;
      transition: transform var(--ease), box-shadow var(--ease), opacity var(--ease), border-color var(--ease);
    }

    button:hover:enabled,
    button:active:enabled {
      transform: translateY(-1px);
      box-shadow: 0 0 16px rgba(69, 245, 255, 0.28);
    }

    button:active:enabled {
      transform: translateY(0) scale(0.97);
    }

    button:disabled {
      opacity: 0.46;
      cursor: not-allowed;
    }

    .ctrl-btn {
      width: 44px;
      padding: 0;
      font-size: 0;
      position: relative;
    }

    .ctrl-btn::before,
    .ctrl-btn::after {
      content: "";
      position: absolute;
      inset: 0;
      margin: auto;
      width: 16px;
      height: 16px;
    }

    #themeBtn::before {
      border-radius: 50%;
      box-shadow: inset -6px 0 0 0 var(--cyan);
      border: 1px solid rgba(69, 245, 255, 0.8);
    }

    #restartBtn::before {
      border: 2px solid var(--pink);
      border-right-color: transparent;
      border-radius: 50%;
    }

    #restartBtn::after {
      width: 0;
      height: 0;
      border-top: 4px solid transparent;
      border-bottom: 4px solid transparent;
      border-left: 7px solid var(--pink);
      transform: translate(5px, -3px);
    }

    .joker-strip {
      padding: 7px;
      overflow-x: auto;
      overflow-y: hidden;
      display: flex;
      gap: 8px;
      scrollbar-width: thin;
    }

    .joker-strip::-webkit-scrollbar {
      height: 5px;
    }

    .joker-strip::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.24);
      border-radius: 999px;
    }

    .joker {
      width: 50px;
      height: 70px;
      border-radius: 12px;
      border: 2px solid;
      border-image: linear-gradient(135deg, var(--gold), #ff6b6b, var(--gold)) 1;
      flex: 0 0 auto;
      display: grid;
      grid-template-rows: 24px auto auto;
      align-content: start;
      gap: 2px;
      position: relative;
      overflow: hidden;
      transition: transform var(--ease), box-shadow var(--ease), filter var(--ease);
      cursor: pointer;
      padding: 6px 4px 5px;
      text-align: center;
      color: #f5f8ff;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      box-shadow:
        0 0 20px rgba(255, 215, 0, 0.3),
        inset 0 0 30px rgba(255, 255, 255, 0.05);
    }

    .joker.has-sell {
      padding-bottom: 18px;
    }

    .joker-sell {
      position: absolute;
      left: 4px;
      right: 4px;
      bottom: 4px;
      min-height: 16px;
      border-radius: 8px;
      border: 0;
      font-size: 9px;
      font-weight: 800;
      color: #2c1205;
      background: linear-gradient(150deg, #ffd596, #ff9f6a);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.35);
      padding: 0 2px;
      z-index: 2;
    }

    .joker-sell:hover:enabled,
    .joker-sell:active:enabled {
      transform: none;
      box-shadow: 0 2px 10px rgba(255, 173, 93, 0.55);
    }

    .joker:hover,
    .joker.reveal {
      transform: translateY(-4px) scale(1.06);
      z-index: 6;
      filter: saturate(1.08);
    }

    .joker.active {
      animation: jokerPulse 620ms ease;
      box-shadow:
        0 0 28px rgba(255, 215, 0, 0.7),
        0 0 12px rgba(69, 245, 255, 0.5),
        inset 0 0 24px rgba(255, 255, 255, 0.14);
    }

    .joker.reveal {
      width: 84px;
      box-shadow:
        0 0 24px rgba(255, 215, 0, 0.42),
        0 10px 22px rgba(0, 0, 0, 0.44),
        inset 0 0 30px rgba(255, 255, 255, 0.08);
    }

    .joker.reveal .joker-desc-mini {
      -webkit-line-clamp: unset;
    }

    .joker:active {
      transform: translateY(-2px) scale(1.01);
    }

    .joker::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(
        105deg,
        transparent 40%,
        rgba(255, 255, 255, 0.2) 45%,
        rgba(255, 255, 255, 0.3) 50%,
        rgba(255, 255, 255, 0.2) 55%,
        transparent 60%
      );
      transform: translateX(-100%);
      animation: shimmer 3s infinite;
      pointer-events: none;
    }

    .joker::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 50% 0%, rgba(255, 255, 255, 0.22), transparent 62%);
      pointer-events: none;
    }

    .joker-name-mini {
      display: block;
      font-weight: 800;
      font-size: 10px;
      line-height: 1.15;
      text-shadow: 0 0 8px rgba(0, 0, 0, 0.55);
    }

    .joker-desc-mini {
      display: block;
      font-size: 8px;
      line-height: 1.2;
      color: rgba(239, 245, 255, 0.82);
      opacity: 0.88;
      white-space: normal;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .joker-icon {
      width: 24px;
      height: 24px;
      margin: 0 auto;
      position: relative;
      display: block;
      filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.32));
    }

    .joker-glyph {
      position: absolute;
      inset: 0;
      margin: auto;
    }

    .joker-bomb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #fff4d8 0 18%, #ffab3a 20% 58%, #c63711 60% 100%);
      bottom: 1px;
      box-shadow: 0 0 10px rgba(255, 126, 35, 0.8);
    }

    .joker-bomb::before {
      content: "";
      position: absolute;
      width: 8px;
      height: 8px;
      border: 2px solid #f5d799;
      border-left: 0;
      border-bottom: 0;
      border-radius: 0 8px 0 0;
      top: -6px;
      right: -4px;
      transform: rotate(10deg);
    }

    .joker-bomb::after {
      content: "";
      position: absolute;
      width: 5px;
      height: 5px;
      border-radius: 50%;
      top: -8px;
      right: -8px;
      background: #ffd26e;
      box-shadow: 0 0 8px #ff7429, 0 0 14px #ff7429;
      animation: bombSpark 1s ease-in-out infinite;
    }

    .joker-wave {
      width: 20px;
      height: 12px;
      top: 6px;
      background: linear-gradient(180deg, #b6f8ff, #37b8ff 65%, #0064c7);
      clip-path: polygon(0% 60%, 12% 42%, 24% 58%, 36% 40%, 48% 55%, 60% 35%, 72% 56%, 84% 44%, 100% 60%, 100% 100%, 0 100%);
      animation: waveMotion 2.2s ease-in-out infinite;
      box-shadow: 0 0 8px rgba(0, 206, 255, 0.7);
    }

    .joker-wave::after {
      content: "";
      position: absolute;
      inset: auto 0 2px;
      height: 3px;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.9), transparent);
      opacity: 0.7;
    }

    .joker-calc {
      width: 18px;
      height: 18px;
      top: 3px;
      border-radius: 3px;
      background:
        repeating-linear-gradient(90deg, rgba(0, 255, 115, 0.32) 0 2px, transparent 2px 6px),
        repeating-linear-gradient(0deg, rgba(0, 255, 115, 0.32) 0 2px, transparent 2px 6px),
        #052e18;
      border: 1px solid rgba(120, 255, 163, 0.65);
      box-shadow: 0 0 10px rgba(0, 255, 110, 0.68), inset 0 0 8px rgba(0, 255, 115, 0.3);
    }

    .joker-calc::after {
      content: "10110";
      position: absolute;
      left: 2px;
      right: 2px;
      top: -8px;
      font-size: 6px;
      letter-spacing: 1px;
      color: #69ff97;
      animation: matrixDrift 1.8s linear infinite;
      text-shadow: 0 0 6px rgba(0, 255, 98, 0.75);
    }

    .joker-heart {
      width: 14px;
      height: 12px;
      top: 6px;
      background: #ff476d;
      transform: rotate(-45deg);
      box-shadow: 0 0 8px rgba(255, 66, 92, 0.85);
      animation: heartBeat 1.2s ease-in-out infinite;
    }

    .joker-heart::before,
    .joker-heart::after {
      content: "";
      position: absolute;
      width: 14px;
      height: 12px;
      border-radius: 50%;
      background: #ff476d;
    }

    .joker-heart::before {
      top: -7px;
      left: 0;
    }

    .joker-heart::after {
      top: 0;
      left: 7px;
    }

    .joker-duo {
      width: 20px;
      height: 16px;
      top: 4px;
    }

    .joker-duo::before,
    .joker-duo::after {
      content: "";
      position: absolute;
      width: 8px;
      height: 14px;
      top: 1px;
      border-radius: 10px 10px 3px 3px;
      background: linear-gradient(180deg, #f8cdff, #cf65ff 60%, #7e2df5);
      box-shadow: 0 0 10px rgba(207, 101, 255, 0.75);
    }

    .joker-duo::before {
      left: 2px;
      transform: skewY(-6deg);
    }

    .joker-duo::after {
      right: 2px;
      transform: scaleX(-1) skewY(-6deg);
      opacity: 0.82;
      animation: mirrorShift 1.9s ease-in-out infinite;
    }

    .joker.empty {
      cursor: default;
      border-style: dashed;
      border-color: rgba(255, 255, 255, 0.25);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.07), rgba(255, 255, 255, 0.02));
      box-shadow: none;
      display: grid;
      place-items: center;
      padding: 0;
    }

    .joker.empty::before {
      content: "+";
      animation: none;
      transform: none;
      background: none;
      color: rgba(255, 255, 255, 0.5);
      font-size: 1.25rem;
    }

    .joker-tip {
      position: absolute;
      left: 50%;
      bottom: calc(100% + 6px);
      transform: translate(-50%, 6px);
      min-width: 126px;
      max-width: 170px;
      padding: 6px 7px;
      border-radius: 10px;
      background: rgba(5, 16, 14, 0.94);
      border: 1px solid rgba(255, 255, 255, 0.18);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--ease), transform var(--ease);
      z-index: 9;
      font-size: 0.64rem;
      line-height: 1.25;
      white-space: normal;
    }

    .joker:hover .joker-tip,
    .joker.reveal .joker-tip {
      opacity: 1;
      transform: translate(-50%, 0);
    }

    .joker-name {
      display: block;
      color: var(--gold);
      font-weight: 800;
      margin-bottom: 3px;
      font-size: 0.7rem;
    }

    .joker-flat50 {
      background:
        radial-gradient(circle at 50% 28%, rgba(255, 178, 62, 0.42), transparent 55%),
        linear-gradient(140deg, #2f1a12, #441b14 45%, #7f2a15 100%);
      box-shadow: 0 0 16px rgba(255, 132, 33, 0.56), inset 0 0 20px rgba(255, 194, 122, 0.1);
    }

    .joker-flat50 .joker-icon::after {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle, rgba(255, 174, 66, 0.9) 0 1px, transparent 2px) 1px 4px/8px 8px,
        radial-gradient(circle, rgba(255, 110, 44, 0.75) 0 1px, transparent 2px) 4px 2px/7px 7px;
      animation: emberFloat 2.2s linear infinite;
      opacity: 0.65;
    }

    .joker-flushx2 {
      background:
        radial-gradient(circle at 50% 10%, rgba(137, 240, 255, 0.35), transparent 50%),
        linear-gradient(155deg, #10273f, #0f3f66 45%, #0a608b);
      box-shadow: 0 0 16px rgba(41, 206, 255, 0.58), inset 0 0 20px rgba(178, 246, 255, 0.08);
    }

    .joker-perCardMult {
      background:
        linear-gradient(180deg, rgba(0, 255, 128, 0.08), transparent 32%),
        linear-gradient(155deg, #071f13, #06311e 45%, #09522f);
      box-shadow: 0 0 16px rgba(0, 255, 110, 0.48), inset 0 0 18px rgba(90, 255, 155, 0.1);
    }

    .joker-heartChip {
      background:
        radial-gradient(circle at 52% 24%, rgba(255, 148, 168, 0.3), transparent 48%),
        linear-gradient(155deg, #3e101d, #66182e 55%, #9f1c3f);
      box-shadow: 0 0 16px rgba(255, 73, 110, 0.52), inset 0 0 20px rgba(255, 172, 190, 0.1);
    }

    .joker-pairBoost {
      background:
        radial-gradient(circle at 40% 20%, rgba(232, 153, 255, 0.28), transparent 48%),
        linear-gradient(150deg, #28154f, #41208f 52%, #6f28d9);
      box-shadow: 0 0 16px rgba(203, 97, 255, 0.52), inset 0 0 18px rgba(233, 177, 255, 0.1);
    }

    .joker-goldDice { background: linear-gradient(150deg, #503503, #8b5e00 58%, #d79d28); }
    .joker-spadeAce { background: linear-gradient(150deg, #111d33, #1d355f 55%, #2467a2); }
    .joker-luckySeven { background: linear-gradient(150deg, #3c0f0f, #7c1818 55%, #b72f2f); }
    .joker-doubleDown { background: linear-gradient(150deg, #26162f, #4f2678 55%, #8f3fc4); }
    .joker-fullHouseFan { background: linear-gradient(150deg, #2b1911, #5b311d 55%, #a15d2d); }
    .joker-straightRunner { background: linear-gradient(150deg, #132b16, #225e2a 55%, #3ca94e); }
    .joker-diamondMiner { background: linear-gradient(150deg, #102b30, #1f5963 55%, #3db4b3); }
    .joker-clubKing { background: linear-gradient(150deg, #1b1d25, #2d3546 55%, #485f7a); }
    .joker-allInClown { background: linear-gradient(150deg, #3d112b, #7a2258 55%, #c93e81); }
    .joker-fourMaster { background: linear-gradient(150deg, #291a0f, #553311 58%, #a46b21); }
    .joker-acePower { background: linear-gradient(150deg, #0f1d2f, #203d69 55%, #2d6fb0); }
    .joker-faceCard { background: linear-gradient(150deg, #2c1931, #5d2e63 55%, #aa4fa1); }
    .joker-evenSteven { background: linear-gradient(150deg, #10291d, #1f5a3f 55%, #37a866); }
    .joker-oddOne { background: linear-gradient(150deg, #2b1b18, #5e2d24 55%, #b3553f); }
    .joker-fourFlush { background: linear-gradient(150deg, #13303b, #1f5d79 55%, #3cb8de); }
    .joker-streakBonus { background: linear-gradient(150deg, #1b2d14, #2f6231 55%, #56b85e); }
    .joker-chipRain { background: linear-gradient(150deg, #2f2210, #60421f 55%, #be8331); }
    .joker-royalFlush { background: linear-gradient(150deg, #2f1a35, #5e2f75 55%, #a259d4); }
    .joker-lowCard { background: linear-gradient(150deg, #1f2c3e, #2e4d75 55%, #4b8ccc); }
    .joker-highCard { background: linear-gradient(150deg, #3b161e, #7a2938 55%, #d0536c); }
    .joker-trioMult { background: linear-gradient(150deg, #2a1a40, #4e2d7c 55%, #8554cb); }

    .joker-dice,
    .joker-spade,
    .joker-seven,
    .joker-double,
    .joker-house,
    .joker-runner,
    .joker-diamond,
    .joker-crown,
    .joker-allin,
    .joker-four {
      width: 18px;
      height: 18px;
      top: 4px;
      border-radius: 4px;
      position: relative;
    }

    .joker-dice {
      background: linear-gradient(145deg, #fff6cc, #ffc947);
      box-shadow: 0 0 10px rgba(255, 201, 71, 0.72);
    }

    .joker-dice::before {
      content: "";
      position: absolute;
      inset: 4px;
      background:
        radial-gradient(circle, #8b5e00 0 1px, transparent 1px) 0 0/7px 7px,
        radial-gradient(circle, #8b5e00 0 1px, transparent 1px) 4px 4px/7px 7px;
    }

    .joker-spade::before {
      content: "‚ô†";
      position: absolute;
      inset: 0;
      text-align: center;
      font-size: 18px;
      color: #d9ecff;
      text-shadow: 0 0 10px rgba(78, 170, 255, 0.8);
    }

    .joker-seven::before {
      content: "7";
      position: absolute;
      inset: 0;
      text-align: center;
      font-size: 16px;
      font-weight: 900;
      color: #ffd6d6;
      text-shadow: 0 0 8px rgba(255, 87, 87, 0.8);
    }

    .joker-double::before {
      content: "x2";
      position: absolute;
      inset: 0;
      text-align: center;
      font-size: 11px;
      font-weight: 900;
      color: #f4ddff;
      text-shadow: 0 0 8px rgba(203, 97, 255, 0.78);
      line-height: 18px;
    }

    .joker-house::before {
      content: "üè†";
      position: absolute;
      inset: 0;
      text-align: center;
      font-size: 14px;
      line-height: 18px;
      filter: drop-shadow(0 0 6px rgba(255, 173, 102, 0.7));
    }

    .joker-runner::before {
      content: "‚û§";
      position: absolute;
      inset: 0;
      text-align: center;
      font-size: 15px;
      color: #c8ffd0;
      text-shadow: 0 0 8px rgba(90, 255, 120, 0.75);
      animation: runnerDash 0.9s ease-in-out infinite;
    }

    .joker-diamond::before {
      content: "‚ô¶";
      position: absolute;
      inset: 0;
      text-align: center;
      font-size: 17px;
      color: #b7fff7;
      text-shadow: 0 0 10px rgba(95, 255, 230, 0.72);
    }

    .joker-crown::before {
      content: "‚ô£";
      position: absolute;
      inset: 0;
      text-align: center;
      font-size: 17px;
      color: #d9f0ff;
      text-shadow: 0 0 10px rgba(141, 183, 255, 0.78);
    }

    .joker-allin::before {
      content: "A!";
      position: absolute;
      inset: 0;
      text-align: center;
      font-size: 12px;
      font-weight: 900;
      color: #ffd8ee;
      line-height: 18px;
      text-shadow: 0 0 9px rgba(255, 95, 168, 0.8);
    }

    .joker-four::before {
      content: "4";
      position: absolute;
      inset: 0;
      text-align: center;
      font-size: 16px;
      font-weight: 900;
      color: #ffe7b8;
      text-shadow: 0 0 8px rgba(255, 184, 81, 0.8);
    }

    .score-line {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 8px;
      padding: 0 10px;
      font-size: 0.88rem;
      position: relative;
    }

    .score-main {
      display: flex;
      gap: 10px;
      align-items: center;
      color: var(--muted);
      font-weight: 700;
      flex-wrap: wrap;
    }

    .chips-readout b {
      color: #ffd86d;
      text-shadow: 0 0 12px rgba(255, 207, 109, 0.7);
    }

    .mult-readout b {
      color: #ff69ce;
      text-shadow: 0 0 12px rgba(255, 79, 197, 0.72);
    }

    .score-main b {
      color: var(--text);
      font-size: 1.02rem;
      text-shadow: 0 0 10px rgba(69, 245, 255, 0.34);
      min-width: 44px;
      transition: transform var(--ease), text-shadow var(--ease);
    }

    .score-total {
      font-size: 1.2rem;
      color: #c6ffe8;
      font-weight: 800;
      white-space: nowrap;
      letter-spacing: 0.03em;
      text-shadow: 0 0 12px rgba(122, 245, 184, 0.55), 0 0 24px rgba(69, 245, 255, 0.28);
      transition: transform var(--ease), color var(--ease), text-shadow var(--ease);
    }

    .score-total.pulse {
      animation: neonPulse 500ms ease;
    }

    .hand-preview {
      min-height: 28px;
      padding: 7px 10px;
      border-radius: 12px;
      border: 1px solid rgba(69, 245, 255, 0.25);
      background: rgba(7, 18, 16, 0.58);
      color: rgba(230, 247, 241, 0.78);
      font-size: 0.78rem;
      font-weight: 700;
      letter-spacing: 0.01em;
      text-align: center;
      opacity: 0;
      transform: translateY(4px);
      transition: opacity 220ms ease, transform 220ms ease, color 220ms ease;
      pointer-events: none;
    }

    .hand-preview.show {
      opacity: 1;
      transform: translateY(0);
      color: var(--cyan);
      text-shadow: 0 0 10px rgba(69, 245, 255, 0.35);
    }

    .table {
      position: relative;
      padding: 8px;
      display: grid;
      grid-template-rows: auto minmax(0, 1fr) auto;
      gap: 7px;
      overflow: hidden;
    }

    .info-line {
      min-height: 16px;
      font-size: 0.73rem;
      color: var(--muted);
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding: 0 4px;
    }

    .hand-bottom {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      min-height: 16px;
      padding: 0 4px;
    }

    .hand-bottom .info-line {
      flex: 1;
      padding: 0;
    }

    .deck-btn {
      min-height: 28px;
      padding: 0 8px;
      border-radius: 8px;
      font-size: 0.7rem;
      font-weight: 800;
      color: #062b22;
      background: linear-gradient(120deg, #9af8ff, #c4ffd2 58%, #ffdd86);
      border: 0;
      box-shadow: 0 0 10px rgba(122, 245, 184, 0.28);
      white-space: nowrap;
    }

    .hand-tag {
      color: var(--gold);
      font-weight: 900;
    }

    .cards-wrap {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 6px;
      align-content: center;
      height: 100%;
      min-height: 0;
    }

    .card {
      border-radius: 10px;
      min-height: clamp(78px, 19vw, 116px);
      background: #fefefe;
      border: 1.5px solid #c8c8c8;
      box-shadow: 0 4px 14px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.9);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 5px 6px;
      user-select: none;
      cursor: pointer;
      transition: transform 0.18s cubic-bezier(0.22,1,0.36,1), box-shadow 0.18s;
      animation: cardDeal 0.38s cubic-bezier(0.2,0.8,0.2,1) both;
      position: relative;
      overflow: hidden;
      transform-style: preserve-3d;
      will-change: transform;
    }

    .card::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.55) 0%, transparent 50%);
      pointer-events: none;
      border-radius: 10px;
    }

    .card-corner {
      display: flex;
      flex-direction: column;
      align-items: center;
      line-height: 1;
      gap: 1px;
    }

    .card-tl { align-self: flex-start; }

    .card-br {
      align-self: flex-end;
      transform: rotate(180deg);
    }

    .ci-rank {
      font-size: clamp(13px, 3.6vw, 18px);
      font-weight: 900;
      line-height: 1;
      font-family: "Georgia", serif;
    }

    .ci-suit {
      font-size: clamp(9px, 2.4vw, 13px);
      line-height: 1;
    }

    .card-center-sym {
      font-size: clamp(26px, 7.5vw, 40px);
      text-align: center;
      line-height: 1;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.15));
    }

    /* Red suits */
    .card.s-heart .ci-rank,
    .card.s-heart .ci-suit,
    .card.s-heart .card-center-sym,
    .card.s-diamond .ci-rank,
    .card.s-diamond .ci-suit,
    .card.s-diamond .card-center-sym {
      color: #d32f2f;
    }

    /* Black suits */
    .card.s-club .ci-rank,
    .card.s-club .ci-suit,
    .card.s-club .card-center-sym,
    .card.s-spade .ci-rank,
    .card.s-spade .ci-suit,
    .card.s-spade .card-center-sym {
      color: #1a1a2e;
    }

    .card:hover {
      box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    }

    .card.selected {
      border-color: #ffd700;
      box-shadow:
        0 0 0 2px #ffd700,
        0 0 18px rgba(255,215,0,0.6),
        0 16px 32px rgba(0,0,0,0.5);
      transform: translateY(-12px) scale(1.04) !important;
      animation: selectedFloat 2s ease-in-out infinite !important;
      z-index: 2;
    }

    .card.pick-fx {
      animation: pickFlash 260ms ease !important;
    }

    /* Play-out animation */
    .card.playing-out {
      animation: cardPlayOut 320ms cubic-bezier(0.4,0,0.2,1) both !important;
    }

    /* Discard-out animation */
    .card.discarding-out {
      animation: cardDiscardOut 280ms cubic-bezier(0.4,0,0.2,1) both !important;
    }

    .rank { display: none; }
    .suit { display: none; }

    .status-bar {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      align-items: center;
      padding: 0 10px;
      font-size: 0.83rem;
      color: var(--muted);
      font-weight: 700;
    }

    .status-bar b {
      color: var(--text);
      font-weight: 800;
      font-size: 0.92rem;
      text-shadow: 0 0 10px rgba(255, 79, 197, 0.3);
    }

    .pvp-panel {
      display: none;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items: center;
      padding: 8px 10px;
      font-size: 0.77rem;
      color: var(--muted);
    }

    .pvp-panel.show {
      display: grid;
    }

    .pvp-score {
      color: var(--gold);
      font-weight: 800;
      text-shadow: 0 0 8px rgba(255, 207, 109, 0.4);
    }

    .actions {
      display: grid;
      grid-template-columns: 1fr 1fr 44px;
      gap: 8px;
      align-items: stretch;
    }

    .btn-main,
    .btn-warn {
      font-size: 0.83rem;
      letter-spacing: 0.02em;
      border: 0;
      color: #08130f;
      text-transform: uppercase;
    }

    .btn-main {
      background: linear-gradient(120deg, #45f5ff, #8bffe3 55%, #ffd76a);
      box-shadow: 0 0 16px rgba(69, 245, 255, 0.38);
    }

    .btn-warn {
      background: linear-gradient(120deg, #ff80cb, #ffc66f 85%);
      box-shadow: 0 0 16px rgba(255, 128, 203, 0.34);
    }

    #clearBtn {
      font-size: 0;
      padding: 0;
      position: relative;
    }

    #clearBtn::before,
    #clearBtn::after {
      content: "";
      position: absolute;
      width: 18px;
      height: 2px;
      background: #fff;
      inset: 0;
      margin: auto;
    }

    #clearBtn::before { transform: rotate(45deg); }
    #clearBtn::after { transform: rotate(-45deg); }

    .log {
      position: absolute;
      width: 1px;
      height: 1px;
      margin: -1px;
      border: 0;
      padding: 0;
      clip: rect(0 0 0 0);
      overflow: hidden;
    }

    .fx {
      position: absolute;
      left: 12px;
      top: 12px;
      padding: 6px 9px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.26);
      background: rgba(9, 35, 28, 0.78);
      color: var(--gold);
      font-weight: 900;
      font-size: 0.78rem;
      pointer-events: none;
      z-index: 7;
      text-shadow: 0 0 10px rgba(255, 207, 109, 0.48);
      animation: scoreCombine 900ms ease forwards;
    }

    .fx.chips-readout {
      color: #ffd86d;
      text-shadow: 0 0 10px rgba(255, 207, 109, 0.7);
    }

    .fx.mult-readout {
      color: #ff69ce;
      text-shadow: 0 0 10px rgba(255, 79, 197, 0.7);
    }

    .fx.score-total {
      color: #c6ffe8;
      text-shadow: 0 0 10px rgba(122, 245, 184, 0.68);
    }

    .chip {
      position: fixed;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      pointer-events: none;
      z-index: 30;
      background: radial-gradient(circle at 35% 35%, #fff2cc 0 24%, #ffcf6d 25% 62%, #b77d1f 63%);
      box-shadow: 0 0 8px rgba(255, 207, 109, 0.56);
    }

    .chip.fly {
      animation: chipFly 720ms cubic-bezier(0.25, 0.6, 0.2, 1) forwards;
    }

    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
      background: rgba(2, 12, 10, 0.68);
      backdrop-filter: blur(8px);
      padding: 12px;
    }

    .modal.show {
      display: flex;
    }

    .joker-popup {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 52;
      background: rgba(2, 12, 10, 0.75);
      backdrop-filter: blur(10px);
      padding: calc(60px + env(safe-area-inset-top)) 14px calc(14px + env(safe-area-inset-bottom));
    }

    .joker-popup.show {
      display: flex;
    }

    .joker-popup-content {
      width: min(92vw, 360px);
      max-height: calc(100dvh - 120px);
      overflow-y: auto;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(6, 26, 22, 0.9), rgba(5, 18, 15, 0.96));
      box-shadow: var(--shadow);
      padding: 18px;
      display: grid;
      gap: 12px;
      animation: popupOpen 220ms cubic-bezier(0.22, 1, 0.36, 1);
    }

    .joker-popup-icon {
      width: 72px;
      height: 72px;
      border-radius: 14px;
      margin: 0 auto;
      position: relative;
      display: grid;
      place-items: center;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.14), rgba(255, 255, 255, 0.04));
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.14), 0 0 20px rgba(255, 215, 0, 0.32);
    }

    .joker-popup-icon .joker-glyph {
      position: absolute;
      inset: 0;
      margin: auto;
      transform: scale(2.3);
    }

    .joker-popup h3 {
      font-size: 1.2rem;
      font-weight: 900;
      text-align: center;
      color: var(--gold);
    }

    .joker-popup p {
      color: var(--muted);
      font-size: 0.9rem;
      line-height: 1.4;
      text-align: center;
    }

    .joker-popup-cost {
      display: block;
      text-align: center;
      font-size: 0.84rem;
      color: #ffe5a8;
      font-weight: 800;
    }

    .confetti {
      position: fixed;
      width: 8px;
      height: 12px;
      border-radius: 2px;
      pointer-events: none;
      z-index: 50;
      transform: translate3d(0, 0, 0);
      animation: confettiFall 900ms linear forwards;
    }

    .shop {
      width: min(92vw, 460px);
      border-radius: 16px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(6, 26, 22, 0.86), rgba(5, 18, 15, 0.93));
      box-shadow: var(--shadow);
      padding: 12px;
      display: grid;
      gap: 10px;
      max-height: min(86dvh, 660px);
      overflow: auto;
    }

    .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .title {
      font-size: 1rem;
      font-weight: 900;
      text-shadow: 0 0 12px rgba(69, 245, 255, 0.33);
    }

    .subtitle,
    .tag {
      color: var(--muted);
      font-size: 0.78rem;
      font-weight: 700;
    }

    .shop-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .shop-owned {
      display: grid;
      gap: 7px;
    }

    .shop-owned-list {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 7px;
    }

    .shop-owned-item {
      border: 1px solid rgba(255, 255, 255, 0.14);
      border-radius: 11px;
      background: rgba(255, 255, 255, 0.06);
      padding: 8px;
      display: grid;
      gap: 5px;
    }

    .shop-owned-name {
      color: var(--gold);
      font-weight: 800;
      font-size: 0.77rem;
    }

    .shop-owned-refund {
      color: var(--muted);
      font-size: 0.69rem;
    }

    .shop-owned-empty {
      color: var(--muted);
      font-size: 0.72rem;
      padding: 2px 1px 0;
    }

    .sell-popup {
      position: fixed;
      z-index: 70;
      pointer-events: none;
      font-weight: 900;
      font-size: 0.86rem;
      color: #bfffd8;
      text-shadow: 0 0 12px rgba(122, 245, 184, 0.82);
      transform: translate(-50%, -50%);
    }

    .dramatic-layer {
      position: fixed;
      inset: 0;
      z-index: 60;
      pointer-events: none;
      display: grid;
      place-items: center;
    }

    .dramatic-card {
      padding: 10px 16px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(6, 16, 14, 0.84);
      backdrop-filter: blur(6px);
      text-align: center;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.45);
      color: #eafdf8;
    }

    .dramatic-hand {
      font-size: clamp(28px, 9vw, 48px);
      font-weight: 900;
      color: #ffd86d;
      text-shadow: 0 0 14px rgba(255, 207, 109, 0.9);
    }

    .dramatic-chip {
      font-size: clamp(20px, 6.2vw, 34px);
      font-weight: 900;
      color: #9fffe5;
      text-shadow: 0 0 12px rgba(90, 255, 220, 0.8);
    }

    .dramatic-mult {
      font-size: clamp(32px, 9.6vw, 56px);
      font-weight: 900;
      color: #ff8ad8;
      text-shadow: 0 0 16px rgba(255, 105, 206, 0.95);
    }

    .dramatic-final {
      font-size: clamp(28px, 8.5vw, 48px);
      font-weight: 900;
      color: #c9ffe9;
      text-shadow: 0 0 14px rgba(122, 245, 184, 0.86);
    }

    .shop-item {
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.03));
      padding: 9px;
      display: grid;
      gap: 7px;
      transition: transform var(--ease), box-shadow var(--ease);
    }

    .shop-item:hover {
      transform: scale(1.02);
      box-shadow: 0 0 16px rgba(69, 245, 255, 0.22);
    }

    .shop-item .name {
      color: var(--gold);
      font-weight: 900;
      font-size: 0.86rem;
    }

    .shop-item .desc {
      color: var(--muted);
      font-size: 0.72rem;
      line-height: 1.24;
      min-height: 44px;
    }

    .price {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: #ffe5a8;
      font-weight: 800;
      font-size: 0.72rem;
    }

    .coin {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, #fff5d8 0 28%, #ffcf6d 29% 68%, #b77d1f 69%);
      box-shadow: 0 0 6px rgba(255, 207, 109, 0.65);
    }

    .deck-modal {
      width: min(92vw, 460px);
      border-radius: 16px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(6, 26, 22, 0.9), rgba(5, 18, 15, 0.95));
      box-shadow: var(--shadow);
      padding: 14px;
      display: grid;
      gap: 10px;
      max-height: min(86dvh, 660px);
      overflow: auto;
    }

    .deck-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .deck-grid {
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 6px;
    }

    .deck-card {
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      min-height: 40px;
      padding: 5px 4px;
      display: grid;
      place-items: center;
      font-weight: 900;
      font-size: 0.84rem;
      letter-spacing: 0.01em;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.35);
    }

    .deck-card.heart,
    .deck-card.diamond {
      background: linear-gradient(150deg, var(--red-start), var(--red-end));
      color: #ffe8ef;
    }

    .deck-card.club,
    .deck-card.spade {
      background: linear-gradient(150deg, var(--dark-start), var(--dark-end));
      color: #f2f7ff;
    }

    .suit-counts {
      color: var(--muted);
      font-size: 0.82rem;
      font-weight: 800;
      letter-spacing: 0.02em;
    }

    @keyframes dealIn {
      from { opacity: 0; transform: translateY(10px) scale(0.96); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    @keyframes shimmer {
      100% { transform: translateX(100%); }
    }

    @keyframes neonPulse {
      0% { transform: scale(1); }
      40% { transform: scale(1.1); color: #90ffe4; text-shadow: 0 0 16px rgba(69, 245, 255, 0.9); }
      100% { transform: scale(1); }
    }

    @keyframes floatUp {
      0% { opacity: 0; transform: translateY(8px) scale(0.95); }
      20% { opacity: 1; }
      100% { opacity: 0; transform: translateY(-30px) scale(1.03); }
    }

    @keyframes scoreCombine {
      0% { opacity: 0; transform: translateY(10px) scale(0.72); }
      24% { opacity: 1; transform: translateY(-4px) scale(1.18); }
      64% { opacity: 1; transform: translateY(-10px) scale(1.02); }
      100% { opacity: 0; transform: translate(150px, -68px) scale(0.68); }
    }

    @keyframes chipFly {
      0% { transform: translate(0, 0) scale(0.7); opacity: 0; }
      18% { opacity: 1; }
      100% {
        transform: translate(var(--dx), var(--dy)) scale(0.25);
        opacity: 0;
      }
    }

    @keyframes cardFlipIn {
      0% { opacity: 0; transform: perspective(460px) rotateY(-82deg) translateY(8px); }
      100% { opacity: 1; transform: perspective(460px) rotateY(0) translateY(0); }
    }

    @keyframes cardDeal {
      from {
        opacity: 0;
        transform: translateX(60px) translateY(-20px) rotate(8deg) scale(0.82);
      }
      to {
        opacity: 1;
        transform: translateX(0) translateY(0) rotate(0deg) scale(1);
      }
    }

    @keyframes cardPlayOut {
      0%   { transform: translateY(0) scale(1); opacity: 1; }
      40%  { transform: translateY(-40px) scale(1.12) rotate(3deg); opacity: 0.9; }
      100% { transform: translateY(-120px) scale(0.6) rotate(-8deg); opacity: 0; }
    }

    @keyframes cardDiscardOut {
      0%   { transform: translateY(0) scale(1) rotate(0deg); opacity: 1; }
      100% { transform: translateY(80px) scale(0.7) rotate(12deg); opacity: 0; }
    }

    @keyframes selectedFloat {
      0% { transform: translateY(-8px); }
      50% { transform: translateY(-11px); }
      100% { transform: translateY(-8px); }
    }

    @keyframes bombSpark {
      0%, 100% { transform: scale(0.9); opacity: 0.8; }
      50% { transform: scale(1.3); opacity: 1; }
    }

    @keyframes waveMotion {
      0%, 100% { transform: translateX(0) translateY(0); }
      50% { transform: translateX(1px) translateY(-2px); }
    }

    @keyframes matrixDrift {
      0% { transform: translateY(0); opacity: 0; }
      25% { opacity: 1; }
      100% { transform: translateY(12px); opacity: 0; }
    }

    @keyframes heartBeat {
      0%, 40%, 80%, 100% { transform: rotate(-45deg) scale(1); }
      20%, 60% { transform: rotate(-45deg) scale(1.16); }
    }

    @keyframes mirrorShift {
      0%, 100% { transform: scaleX(-1) skewY(-6deg) translateX(0); opacity: 0.82; }
      50% { transform: scaleX(-1) skewY(-6deg) translateX(-1px); opacity: 1; }
    }

    @keyframes emberFloat {
      0% { transform: translateY(0); opacity: 0.3; }
      50% { transform: translateY(-2px); opacity: 0.72; }
      100% { transform: translateY(-4px); opacity: 0.2; }
    }

    @keyframes pickFlash {
      0% { filter: brightness(1); transform: translateY(0) scale(1); }
      45% { filter: brightness(1.28); transform: translateY(-4px) scale(1.03); }
      100% { filter: brightness(1); transform: translateY(0) scale(1); }
    }

    @keyframes jokerPulse {
      0% { transform: translateY(-2px) scale(1); }
      40% { transform: translateY(-6px) scale(1.08); }
      100% { transform: translateY(-2px) scale(1); }
    }

    @keyframes popupOpen {
      0% { opacity: 0; transform: scale(0.92); }
      100% { opacity: 1; transform: scale(1); }
    }

    @keyframes confettiFall {
      0% { opacity: 0; transform: translate3d(0, -10px, 0) rotate(0deg) scale(0.9); }
      15% { opacity: 1; }
      100% { opacity: 0; transform: translate3d(var(--dx), var(--dy), 0) rotate(var(--rot)) scale(0.6); }
    }

    @keyframes runnerDash {
      0%, 100% { transform: translateX(-1px); }
      50% { transform: translateX(1px); }
    }

    @media (min-width: 700px) {
      .app {
        width: min(100vw, 520px);
        border-radius: 24px;
      }
      .cards-wrap {
        gap: 8px;
      }
      .actions {
        grid-template-columns: 1fr 1fr 52px;
      }
      .deck-grid {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }

    .mode-sheet {
      width: min(92vw, 420px);
      border-radius: 16px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(6, 26, 22, 0.9), rgba(5, 18, 15, 0.95));
      box-shadow: var(--shadow);
      padding: 14px;
      display: grid;
      gap: 10px;
    }

    .mode-grid {
      display: grid;
      gap: 8px;
    }

    .mode-card {
      border: 1px solid rgba(255, 255, 255, 0.14);
      border-radius: 12px;
      padding: 10px;
      display: grid;
      gap: 8px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
    }

    .mode-card h4 {
      font-size: 0.9rem;
      color: var(--gold);
    }

    .mode-card p {
      font-size: 0.74rem;
      color: var(--muted);
      line-height: 1.3;
    }

    .input {
      width: 100%;
      min-height: 40px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(255, 255, 255, 0.08);
      color: var(--text);
      padding: 0 10px;
      font-size: 0.86rem;
      font-weight: 700;
    }
  </style>
</head>
<body>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MV8KQGJF" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <div class="app" id="tablePanel">
    <header class="topbar glass">
      <div class="header-left">
        <span class="round-label" id="anteBlindLabel">Ante 1 | Blind 1/3</span>
        <span class="round-num" id="roundLabel">1-1</span>
      </div>
      <div class="target-display">
        <span class="target-label">Î™©Ìëú</span>
        <span class="target-value" id="targetLabel">0</span>
      </div>
      <div class="header-right">
        <span class="gold-badge" id="goldLabel">G 0</span>
        <span class="money-badge" id="moneyLabel">$0</span>
        <button id="themeBtn" class="ctrl-btn" aria-label="ÌÖåÎßà Ï†ÑÌôò"></button>
        <button id="restartBtn" class="ctrl-btn" aria-label="ÏÉà Îü∞ ÏãúÏûë"></button>
      </div>
    </header>

    <section class="joker-strip glass" id="jokerArea" aria-label="Ï°∞Ïª§ Ïä¨Î°Ø"></section>

    <section class="score-line glass">
      <div class="score-main">
        <span class="chips-readout">Ïπ© <b id="chipsLabel">0</b></span>
        <span class="mult-readout">Î∞∞Ïàò <b id="multLabel">x1</b></span>
      </div>
      <div class="score-total" id="scoreLabel">0</div>
    </section>

    <section class="table glass">
      <div class="hand-preview" id="handPreview">Ï°±Î≥¥Î™Ö | ÏòàÏÉÅ: 0Ï†ê</div>
      <div class="info-line" id="handResult">Ìï∏ÎìúÎ•º ÏÑ†ÌÉùÌï¥ ÌîåÎ†àÏù¥ÌïòÏÑ∏Ïöî.</div>
      <div class="cards-wrap" id="cardsWrap"></div>
      <div class="hand-bottom">
        <div class="info-line" id="handGuide">ÏÜêÌå® 8Ïû• Ï§ë ÏµúÎåÄ 5Ïû•ÏùÑ ÏÑ†ÌÉù</div>
        <button id="deckBtn" class="deck-btn" type="button">üÉè Îç± (0Ïû•)</button>
      </div>
    </section>

    <section class="status-bar glass">
      <div>ÎÇ®ÏùÄ Ìï∏Îìú <b id="handsLabel">0</b></div>
      <div style="text-align:right;">ÎÇ®ÏùÄ Î≤ÑÎ¶¨Í∏∞ <b id="discardsLabel">0</b></div>
    </section>

    <section class="pvp-panel glass" id="pvpPanel">
      <div id="opponentStatus">ÏÉÅÎåÄ Ï†ïÎ≥¥ ÏóÜÏùå</div>
      <div class="pvp-score" id="opponentScore">ÏÉÅÎåÄ Ï†êÏàò 0</div>
    </section>

    <section class="actions">
      <button class="btn-main" id="playBtn">Ìï∏Îìú ÌîåÎ†àÏù¥</button>
      <button class="btn-warn" id="discardBtn">Ïπ¥Îìú Î≤ÑÎ¶¨Í∏∞</button>
      <button id="clearBtn" aria-label="ÏÑ†ÌÉù Ìï¥Ï†ú"></button>
    </section>

    <div class="log" id="log" aria-hidden="true"></div>
  </div>

  <div class="modal" id="shopModal">
    <div class="shop">
      <div class="row">
        <div>
          <div class="title">ÏÉÅÏ†ê</div>
          <div class="subtitle">Ï°∞Ïª§Î•º ÏÇ¨ÏÑú Îã§Ïùå Î∏îÎùºÏù∏ÎìúÎ•º ÎåÄÎπÑÌïòÏÑ∏Ïöî.</div>
        </div>
        <div class="tag" id="shopMoney">Î≥¥Ïú† ÏûêÍ∏à: $0</div>
      </div>
      <div class="shop-owned" id="shopOwnedJokers"></div>
      <div class="shop-grid" id="shopGrid"></div>
      <button id="shopContinueBtn" class="btn-main" style="width:100%;margin-top:12px;padding:12px;font-size:15px;font-weight:700;border-radius:12px;background:linear-gradient(150deg,var(--ok),#3af5a0);color:#062f27;border:none;cursor:pointer;">Îã§Ïùå Î∏îÎùºÏù∏ÎìúÎ°ú ‚Üí</button>
    </div>
  </div>

  <div class="modal" id="deckModal">
    <div class="deck-modal">
      <div class="deck-title">
        <div class="title" id="deckModalTitle">ÎÇ®ÏùÄ Ïπ¥Îìú (0Ïû•)</div>
      </div>
      <div class="deck-grid" id="deckGrid"></div>
      <div class="suit-counts" id="deckSuitCounts">‚ô•0 ‚ô¶0 ‚ô£0 ‚ô†0</div>
      <div class="row" style="justify-content:flex-end;">
        <button class="btn-main" id="closeDeckBtn">Îã´Í∏∞</button>
      </div>
    </div>
  </div>

  <div class="modal" id="victoryModal">
    <div class="mode-sheet">
      <div>
        <div class="title">Îü∞ ÌÅ¥Î¶¨Ïñ¥</div>
        <div class="subtitle" id="victoryText">Î≥¥Ïä§ Î∏îÎùºÏù∏ÎìúÎ•º ÎèåÌååÌñàÏäµÎãàÎã§.</div>
        <div class="subtitle" id="victoryHighScore" style="margin-top:8px;color:var(--gold);">ÏµúÍ≥† Í∏∞Î°ù: 0Ï†ê</div>
      </div>
      <button class="btn-main" id="victoryConfirmBtn">ÏÉà Îü∞ ÏãúÏûë</button>
    </div>
  </div>

  <div id="gameOverModal" class="modal">
    <div style="background:linear-gradient(150deg,#1a0a0a,#2d1010);border:1px solid rgba(255,100,100,0.3);border-radius:20px;padding:28px 24px;max-width:320px;width:90%;text-align:center;">
      <div style="font-size:48px;margin-bottom:8px;">üíÄ</div>
      <h2 style="color:#ff7f91;font-size:22px;margin-bottom:4px;">Í≤åÏûÑ Ïò§Î≤Ñ</h2>
      <p id="gameOverAnteText" style="color:var(--muted);font-size:13px;margin-bottom:16px;"></p>
      <p id="gameOverHighScore" style="color:var(--gold);font-size:13px;margin-bottom:20px;"></p>
      <button onclick="newRun()" style="width:100%;padding:12px;background:linear-gradient(150deg,var(--red-start),var(--red-end));color:#fff;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;">Îã§Ïãú ÏãúÏûë</button>
    </div>
  </div>

  <div class="modal show" id="modeModal">
    <div class="mode-sheet">
      <div>
        <div class="title">Î™®Îìú ÏÑ†ÌÉù</div>
        <div class="subtitle">Ïã±Í∏Ä ÌîåÎ†àÏù¥ ÎòêÎäî ÎåÄÏ†Ñ Î™®ÎìúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.</div>
      </div>
      <div class="mode-grid">
        <div class="mode-card">
          <h4>Ïã±Í∏Ä ÌîåÎ†àÏù¥</h4>
          <p>ÌòÑÏû¨ Î™®Îìú Í∑∏ÎåÄÎ°ú ÎùºÏö¥ÎìúÏôÄ ÏÉÅÏ†êÏùÑ ÏßÑÌñâÌï©ÎãàÎã§.</p>
          <button class="btn-main" id="singleModeBtn">Ïã±Í∏Ä ÌîåÎ†àÏù¥ ÏãúÏûë</button>
        </div>
        <div class="mode-card">
          <h4>ÎåÄÏ†Ñ Î™®Îìú (PvP)</h4>
          <p>Î∞∞ÌåÖ Í∏àÏï°ÏùÑ Í±∏Í≥† 2Ïù∏ ÎåÄÏ†ÑÏùÑ ÏßÑÌñâÌï©ÎãàÎã§.</p>
          <div class="row">
            <select id="betSelect" class="input" style="max-width:130px;">
              <option value="100">100G</option>
              <option value="500">500G</option>
              <option value="1000">1000G</option>
            </select>
            <button class="btn-main" id="createRoomBtn">Î∞© ÎßåÎì§Í∏∞</button>
          </div>
          <div class="row">
            <input id="roomCodeInput" class="input" placeholder="Î∞© ÏΩîÎìú ÏûÖÎ†•">
            <button class="btn-warn" id="joinRoomBtn">Î∞© Ï∞∏Í∞Ä</button>
          </div>
          <div class="subtitle" id="roomHint">Î©ÄÌã∞ÌîåÎ†àÏù¥ Ïó∞Í≤∞ ÎåÄÍ∏∞ Ï§ë...</div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="pvpResultModal">
    <div class="mode-sheet">
      <div>
        <div class="title">ÎåÄÏ†Ñ Í≤∞Í≥º</div>
        <div class="subtitle" id="pvpFinalText">Í≤∞Í≥º Ï†ïÏÇ∞ Ï§ë...</div>
      </div>
      <button class="btn-main" id="pvpConfirmBtn">ÌôïÏù∏</button>
    </div>
  </div>

  <div class="joker-popup" id="jokerPopup">
    <div class="joker-popup-content">
      <div class="joker-popup-icon" id="jokerPopupIcon"></div>
      <h3 id="jokerPopupName"></h3>
      <p id="jokerPopupDesc"></p>
      <span class="joker-popup-cost" id="jokerPopupCost"></span>
      <button onclick="closeJokerPopup()">Îã´Í∏∞</button>
    </div>
  </div>

  <script src="/lib/multiplayer.js"></script>
  <script src="/lib/shared-wallet.js?v=20260214"></script>
  <script>
    const suits = ["heart", "diamond", "club", "spade"];
    const suitSymbol = { heart: "‚ô•", diamond: "‚ô¶", club: "‚ô£", spade: "‚ô†" };
    const suitClass = { heart: "s-heart", diamond: "s-diamond", club: "s-club", spade: "s-spade" };
    const rankList = [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14];
    const rankLabel = { 11: "J", 12: "Q", 13: "K", 14: "A" };
    const RANK_CHIPS = { 2: 2, 3: 3, 4: 4, 5: 5, 6: 6, 7: 7, 8: 8, 9: 9, 10: 10, 11: 10, 12: 10, 13: 10, 14: 11 };

    const handBase = {
      HIGH_CARD: { name: "ÌïòÏù¥Ïπ¥Îìú", chips: 5, mult: 1 },
      PAIR: { name: "ÏõêÌéòÏñ¥", chips: 10, mult: 2 },
      TWO_PAIR: { name: "Ìà¨ÌéòÏñ¥", chips: 20, mult: 2 },
      THREE: { name: "Ìä∏Î¶¨Ìîå", chips: 30, mult: 3 },
      STRAIGHT: { name: "Ïä§Ìä∏Î†àÏù¥Ìä∏", chips: 30, mult: 4 },
      FLUSH: { name: "ÌîåÎü¨Ïãú", chips: 35, mult: 4 },
      FULL_HOUSE: { name: "ÌíÄÌïòÏö∞Ïä§", chips: 40, mult: 4 },
      FOUR: { name: "Ìè¨Ïπ¥Îìú", chips: 60, mult: 7 },
      STRAIGHT_FLUSH: { name: "Ïä§Ìä∏Î†àÏù¥Ìä∏ ÌîåÎü¨Ïãú", chips: 100, mult: 8 }
    };

    const bossModifiers = [
      null,
      { id: "no_discard", label: "Î≤ÑÎ¶¨Í∏∞ Î∂àÍ∞Ä", desc: "Ïù¥Î≤à Î∏îÎùºÏù∏ÎìúÎäî Î≤ÑÎ¶¨Í∏∞Î•º ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§." },
      { id: "min4cards", label: "ÏµúÏÜå 4Ïû• ÌîåÎ†àÏù¥", desc: "Îß§ Ìï∏ÎìúÎßàÎã§ ÏµúÏÜå 4Ïû•ÏùÑ ÏÑ†ÌÉùÌï¥Ïïº Ìï©ÎãàÎã§." },
      { id: "no_hearts", label: "ÌïòÌä∏ Î¥âÏù∏", desc: "ÌïòÌä∏ Ïπ¥ÎìúÎäî Ïù¥Î≤à Î∏îÎùºÏù∏ÎìúÏóêÏÑú Ï†êÏàòÏóê Í∏∞Ïó¨ÌïòÏßÄ ÏïäÏäµÎãàÎã§." },
      { id: "only2hands", label: "Ìï∏Îìú Ï†úÌïú", desc: "Ïù¥Î≤à Î∏îÎùºÏù∏ÎìúÎäî Ìï∏Îìú 2Î≤àÎßå ÏÇ¨Ïö© Í∞ÄÎä•Ìï©ÎãàÎã§." },
      { id: "no_discard", label: "Î≤ÑÎ¶¨Í∏∞ Î∂àÍ∞Ä", desc: "Ïù¥Î≤à Î∏îÎùºÏù∏ÎìúÎäî Î≤ÑÎ¶¨Í∏∞Î•º ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§." },
      { id: "max3cards", label: "ÏµúÎåÄ 3Ïû• ÏÑ†ÌÉù", desc: "Ïù¥Î≤à Î∏îÎùºÏù∏ÎìúÎäî 3Ïû• Ïù¥ÌïòÎ°úÎßå ÌîåÎ†àÏù¥Ìï† Ïàò ÏûàÏäµÎãàÎã§." },
      { id: "min4cards", label: "ÏµúÏÜå 4Ïû• + Î≤ÑÎ¶¨Í∏∞ Î∂àÍ∞Ä", desc: "ÏµúÏÜå 4Ïû• ÌïÑÏàò, Î≤ÑÎ¶¨Í∏∞ Î∂àÍ∞Ä. ÏµúÌõÑÏùò Î∏îÎùºÏù∏Îìú!" }
    ];

    function getBossModifier(ante) {
      return bossModifiers[ante - 1] || null;
    }

    function getBlindTargets(ante) {
      // Ïπ¥Îìú Ïπ©Í∞í Î∞òÏòÅÏúºÎ°ú Ïä§ÏºÄÏùº ÏôÑÌôî: √ó1.6/ante, ÏãúÏûë ÌÉÄÍ≤ü ÎÇÆÏ∂§ (ÏõêÏûë Balatro Ï∞∏Í≥†)
      const base = [300, 450, 600];
      const scale = Math.pow(1.6, ante - 1);
      return [
        { id: "small", label: "Ïä§Î™∞ Î∏îÎùºÏù∏Îìú", target: Math.round(base[0] * scale) },
        { id: "big", label: "ÎπÖ Î∏îÎùºÏù∏Îìú", target: Math.round(base[1] * scale) },
        { id: "boss", label: "Î≥¥Ïä§ Î∏îÎùºÏù∏Îìú", target: Math.round(base[2] * scale), modifier: getBossModifier(ante) }
      ];
    }

    const jokerPool = [
      { id: "flat50", name: "Ïπ© Ìè≠ÌÉÑ", cost: 6, desc: "Ïπ© +50", detail: "Ìï∏Îìú Ï†êÏàò Í≥ÑÏÇ∞ Ïãú Í≥†Ï†ïÏúºÎ°ú Ïπ© +50.", apply(ctx) { ctx.chips += 50; ctx.activate("flat50"); } },
      { id: "flushx2", name: "Î¨ºÍ≤∞ Ï°∞Ïª§", cost: 7, desc: "ÌîåÎü¨ÏãúÎ©¥ Î∞∞Ïàò x2", detail: "ÌîåÎü¨Ïãú ÎòêÎäî Ïä§Ìä∏Î†àÏù¥Ìä∏ ÌîåÎü¨ÏãúÎ•º ÎßåÎì§Î©¥ Î∞∞ÏàòÎ•º Îëê Î∞∞Î°ú ÎßåÎì≠ÎãàÎã§.", apply(ctx) { if (ctx.handType === "FLUSH" || ctx.handType === "STRAIGHT_FLUSH") { ctx.mult *= 2; ctx.activate("flushx2"); } } },
      { id: "perCardMult", name: "Í≥ÑÏÇ∞Í∏∞ Ï°∞Ïª§", cost: 5, desc: "Ïπ¥ÎìúÎãπ Î∞∞Ïàò +1", detail: "ÌîåÎ†àÏù¥Ìïú Ïπ¥Îìú 1Ïû•ÎßàÎã§ Î∞∞Ïàò +1Ïù¥ Ï∂îÍ∞ÄÎê©ÎãàÎã§.", apply(ctx) { const add = ctx.cards.length; if (add > 0) { ctx.mult += add; ctx.activate("perCardMult"); } } },
      { id: "heartChip", name: "Î∂âÏùÄ Ïù∏Ïû•", cost: 5, desc: "ÌïòÌä∏Îãπ Ïπ© +15", detail: "ÏÑ†ÌÉùÌïú Ïπ¥Îìú Ï§ë ÌïòÌä∏ 1Ïû•Îãπ Ïπ© +15.", apply(ctx) { const hearts = ctx.cards.filter(c => c.suit === "heart").length; if (hearts > 0) { ctx.chips += hearts * 15; ctx.activate("heartChip"); } } },
      { id: "pairBoost", name: "ÎìÄÏò§ Ï¶ùÌè≠Í∏∞", cost: 8, desc: "ÏõêÌéòÏñ¥ Ïù¥ÏÉÅ Î∞∞Ïàò +2", detail: "ÏõêÌéòÏñ¥ Ïù¥ÏÉÅ Ï°±Î≥¥ÏóêÏÑú Î∞∞Ïàò +2.", apply(ctx) { if (ctx.handType !== "HIGH_CARD") { ctx.mult += 2; ctx.activate("pairBoost"); } } },
      { id: "goldDice", name: "Ìô©Í∏à Ï£ºÏÇ¨ÏúÑ", cost: 6, desc: "Ìï∏ÎìúÎßàÎã§ Ïπ© +1~50", detail: "Îß§ Ìï∏Îìú Ï†êÏàò Í≥ÑÏÇ∞ Ïãú Ïπ©Ïóê +1~50 ÎûúÎç§ Ï∂îÍ∞Ä.", apply(ctx) { ctx.chips += Math.floor(Math.random() * 50) + 1; ctx.activate("goldDice"); } },
      { id: "spadeAce", name: "Ïä§ÌéòÏù¥Îìú ÏóêÏù¥Ïä§", cost: 7, desc: "Ïä§ÌéòÏù¥ÎìúÎãπ Î∞∞Ïàò +0.5", detail: "ÏÑ†ÌÉùÌïú Ïπ¥ÎìúÏùò Ïä§ÌéòÏù¥Îìú 1Ïû•ÎßàÎã§ Î∞∞Ïàò +0.5.", apply(ctx) { const count = ctx.cards.filter(c => c.suit === "spade").length; if (count > 0) { ctx.mult += count * 0.5; ctx.activate("spadeAce"); } } },
      { id: "luckySeven", name: "Îü≠ÌÇ§ ÏÑ∏Î∏ê", cost: 8, desc: "7 Ïπ¥ÎìúÎãπ Ïπ© +77", detail: "ÏÑ†ÌÉùÌïú Ïπ¥Îìú Ï§ë Ïà´Ïûê 7Ïù¥ Ìè¨Ìï®Îê† ÎïåÎßàÎã§ Ïπ© +77.", apply(ctx) { const count = ctx.cards.filter(c => c.rank === 7).length; if (count > 0) { ctx.chips += count * 77; ctx.activate("luckySeven"); } } },
      { id: "doubleDown", name: "ÎçîÎ∏î Îã§Ïö¥", cost: 10, desc: "Ìà¨ÌéòÏñ¥Î©¥ Î∞∞Ïàò x2", detail: "Ï°±Î≥¥Í∞Ä Ìà¨ÌéòÏñ¥(TWO_PAIR)Ïùº Îïå Î∞∞Ïàò x2.", apply(ctx) { if (ctx.handType === "TWO_PAIR") { ctx.mult *= 2; ctx.activate("doubleDown"); } } },
      { id: "fullHouseFan", name: "ÌíÄÌïòÏö∞Ïä§ Ìå¨", cost: 9, desc: "ÌíÄÌïòÏö∞Ïä§Î©¥ Ïπ© +100", detail: "Ï°±Î≥¥Í∞Ä ÌíÄÌïòÏö∞Ïä§(FULL_HOUSE)Î©¥ Ïπ© +100.", apply(ctx) { if (ctx.handType === "FULL_HOUSE") { ctx.chips += 100; ctx.activate("fullHouseFan"); } } },
      { id: "straightRunner", name: "Ïä§Ìä∏Î†àÏù¥Ìä∏ Îü¨ÎÑà", cost: 8, desc: "Ïä§Ìä∏Î†àÏù¥Ìä∏Î©¥ Î∞∞Ïàò +3", detail: "Ï°±Î≥¥Í∞Ä Ïä§Ìä∏Î†àÏù¥Ìä∏(STRAIGHT)Ïùº Îïå Î∞∞Ïàò +3.", apply(ctx) { if (ctx.handType === "STRAIGHT") { ctx.mult += 3; ctx.activate("straightRunner"); } } },
      { id: "diamondMiner", name: "Îã§Ïù¥ÏïÑÎ™¨Îìú Í¥ëÎ∂Ä", cost: 6, desc: "Îã§Ïù¥ÏïÑÎãπ Ïπ© +12", detail: "ÏÑ†ÌÉùÌïú Ïπ¥Îìú Ï§ë Îã§Ïù¥ÏïÑÎ™¨Îìú 1Ïû•Îãπ Ïπ© +12.", apply(ctx) { const count = ctx.cards.filter(c => c.suit === "diamond").length; if (count > 0) { ctx.chips += count * 12; ctx.activate("diamondMiner"); } } },
      { id: "clubKing", name: "ÌÅ¥ÎüΩ ÌÇπ", cost: 7, desc: "ÌÅ¥ÎüΩ ÌéòÏù¥Ïä§Îãπ Î∞∞Ïàò +1", detail: "ÌÅ¥ÎüΩ Î¨∏ÏñëÏùò J/Q/K 1Ïû•ÎßàÎã§ Î∞∞Ïàò +1.", apply(ctx) { const count = ctx.cards.filter(c => c.suit === "club" && c.rank >= 11 && c.rank <= 13).length; if (count > 0) { ctx.mult += count; ctx.activate("clubKing"); } } },
      { id: "allInClown", name: "Ïò¨Ïù∏ Í¥ëÎåÄ", cost: 12, desc: "5Ïû• ÌîåÎ†àÏù¥ Ïãú Î∞∞Ïàò x1.5", detail: "Ï†ïÌôïÌûà 5Ïû•ÏùÑ ÏÑ†ÌÉùÌï¥ ÌîåÎ†àÏù¥ÌïòÎ©¥ Î∞∞Ïàò x1.5.", apply(ctx) { if (ctx.cards.length === 5) { ctx.mult *= 1.5; ctx.activate("allInClown"); } } },
      { id: "fourMaster", name: "Ìè¨Ïπ¥Îìú ÎßàÏä§ÌÑ∞", cost: 15, desc: "Ìè¨Ïπ¥ÎìúÎ©¥ Î∞∞Ïàò x3", detail: "Ï°±Î≥¥Í∞Ä Ìè¨Ïπ¥Îìú(FOUR)Î©¥ Î∞∞Ïàò x3.", apply(ctx) { if (ctx.handType === "FOUR") { ctx.mult *= 3; ctx.activate("fourMaster"); } } },
      { id: "acePower", name: "ÏóêÏù¥Ïä§ ÌååÏõå", cost: 9, desc: "ÏóêÏù¥Ïä§Îãπ Ïπ© +30", detail: "ÏÑ†ÌÉùÌïú Ïπ¥ÎìúÏùò ÏóêÏù¥Ïä§(14) 1Ïû•Îãπ Ïπ© +30.", apply(ctx) { ctx.chips += ctx.cards.filter(c => c.rank === 14).length * 30; ctx.activate("acePower"); } },
      { id: "faceCard", name: "ÌéòÏù¥Ïä§ Ïπ¥Îìú", cost: 7, desc: "J/Q/KÎãπ Î∞∞Ïàò +0.75", detail: "J/Q/K 1Ïû•Îãπ Î∞∞Ïàò +0.75.", apply(ctx) { const n = ctx.cards.filter(c => c.rank >= 11 && c.rank <= 13).length; ctx.mult += n * 0.75; ctx.activate("faceCard"); } },
      { id: "evenSteven", name: "ÏßùÏàò ÎßàÎ≤ïÏÇ¨", cost: 6, desc: "ÏßùÏàò Ïπ¥ÎìúÎãπ Ïπ© +8", detail: "2~10 ÏßùÏàò Ïπ¥Îìú 1Ïû•Îãπ Ïπ© +8.", apply(ctx) { const n = ctx.cards.filter(c => c.rank % 2 === 0 && c.rank <= 10).length; ctx.chips += n * 8; ctx.activate("evenSteven"); } },
      { id: "oddOne", name: "ÌôÄÏàò ÏïÖÎãπ", cost: 6, desc: "ÌôÄÏàò Ïπ¥ÎìúÎãπ Î∞∞Ïàò +0.5", detail: "3~9 ÌôÄÏàò Ïπ¥Îìú 1Ïû•Îãπ Î∞∞Ïàò +0.5.", apply(ctx) { const n = ctx.cards.filter(c => c.rank % 2 === 1 && c.rank <= 9).length; ctx.mult += n * 0.5; ctx.activate("oddOne"); } },
      { id: "fourFlush", name: "4ÏÉâ Ï°∞Ïª§", cost: 8, desc: "4Í∞ÄÏßÄ Î¨¥Îä¨ ÏÇ¨Ïö© Ïãú Î∞∞Ïàò x2", detail: "ÏÑ†ÌÉùÌïú Ïπ¥ÎìúÏùò Î¨¥Îä¨Í∞Ä 4Ï¢Ö Ïù¥ÏÉÅÏù¥Î©¥ Î∞∞Ïàò x2.", apply(ctx) { if (new Set(ctx.cards.map(c => c.suit)).size >= 4) { ctx.mult *= 2; ctx.activate("fourFlush"); } } },
      { id: "streakBonus", name: "Ïó∞ÏÜç Î≥¥ÎÑàÏä§", cost: 10, desc: "Ïä§Ìä∏Î†àÏù¥Ìä∏Î©¥ Ïπ©+Î∞∞Ïàò Î™®Îëê +5", detail: "Ïä§Ìä∏Î†àÏù¥Ìä∏/Ïä§Ìä∏Î†àÏù¥Ìä∏ ÌîåÎü¨ÏãúÏùº Îïå Ïπ©+5, Î∞∞Ïàò+5.", apply(ctx) { if (ctx.handType === "STRAIGHT" || ctx.handType === "STRAIGHT_FLUSH") { ctx.chips += 5; ctx.mult += 5; ctx.activate("streakBonus"); } } },
      { id: "chipRain", name: "Ïπ© ÎπÑ", cost: 11, desc: "Ìï∏ÎìúÎãπ ÎûúÎç§ Ïπ© +10~100", detail: "Îß§ Ìï∏Îìú Ï†êÏàò Í≥ÑÏÇ∞ Ïãú Ïπ© +10~100 ÎûúÎç§ Ï∂îÍ∞Ä.", apply(ctx) { ctx.chips += Math.floor(Math.random() * 91) + 10; ctx.activate("chipRain"); } },
      { id: "royalFlush", name: "Î°úÏó¥ Ï°∞Ïª§", cost: 14, desc: "Ïä§Ìä∏Î†àÏù¥Ìä∏ ÌîåÎü¨ÏãúÎ©¥ Î∞∞Ïàò x3", detail: "Ï°±Î≥¥Í∞Ä Ïä§Ìä∏Î†àÏù¥Ìä∏ ÌîåÎü¨ÏãúÏù¥Î©¥ Î∞∞Ïàò x3.", apply(ctx) { if (ctx.handType === "STRAIGHT_FLUSH") { ctx.mult *= 3; ctx.activate("royalFlush"); } } },
      { id: "lowCard", name: "Î°úÏö∞ Ïπ¥Îìú", cost: 5, desc: "2~5 Ïπ¥ÎìúÎãπ Ïπ© +10", detail: "2~5 Ïπ¥Îìú 1Ïû•Îãπ Ïπ© +10.", apply(ctx) { const n = ctx.cards.filter(c => c.rank <= 5).length; ctx.chips += n * 10; ctx.activate("lowCard"); } },
      { id: "highCard", name: "ÌïòÏù¥ Ïπ¥Îìú", cost: 5, desc: "10 Ïù¥ÏÉÅ Ïπ¥ÎìúÎãπ Î∞∞Ïàò +0.5", detail: "10 Ïù¥ÏÉÅ Ïπ¥Îìú 1Ïû•Îãπ Î∞∞Ïàò +0.5.", apply(ctx) { const n = ctx.cards.filter(c => c.rank >= 10).length; ctx.mult += n * 0.5; ctx.activate("highCard"); } },
      { id: "trioMult", name: "Ìä∏Î¶¨Ïò§ Ï¶ùÌè≠", cost: 9, desc: "Ìä∏Î¶¨Ìîå Ïù¥ÏÉÅÏù¥Î©¥ Î∞∞Ïàò x1.5", detail: "Ìä∏Î¶¨Ìîå/ÌíÄÌïòÏö∞Ïä§/Ìè¨Ïπ¥ÎìúÎ©¥ Î∞∞Ïàò x1.5.", apply(ctx) { if (["THREE", "FULL_HOUSE", "FOUR"].includes(ctx.handType)) { ctx.mult *= 1.5; ctx.activate("trioMult"); } } }
    ];

    const jokerGlyphClass = {
      flat50: "joker-bomb",
      flushx2: "joker-wave",
      perCardMult: "joker-calc",
      heartChip: "joker-heart",
      pairBoost: "joker-duo",
      goldDice: "joker-dice",
      spadeAce: "joker-spade",
      luckySeven: "joker-seven",
      doubleDown: "joker-double",
      fullHouseFan: "joker-house",
      straightRunner: "joker-runner",
      diamondMiner: "joker-diamond",
      clubKing: "joker-crown",
      allInClown: "joker-allin",
      fourMaster: "joker-four",
      acePower: "joker-spade",
      faceCard: "joker-crown",
      evenSteven: "joker-calc",
      oddOne: "joker-duo",
      fourFlush: "joker-wave",
      streakBonus: "joker-runner",
      chipRain: "joker-bomb",
      royalFlush: "joker-house",
      lowCard: "joker-diamond",
      highCard: "joker-seven",
      trioMult: "joker-double"
    };

    const state = {
      mode: "single",
      roundIndex: 0,
      ante: 1,
      score: 0,
      money: 10,
      handsLeft: 4,
      discardsLeft: 3,
      deck: [],
      hand: [],
      selected: new Set(),
      jokers: [],
      bossModifier: null,
      gameEnded: false,
      lastToggledCardId: null
    };

    const pvp = {
      active: false,
      mp: null,
      isHost: false,
      roomId: "",
      bet: 100,
      roundTarget: 700,
      currentRound: 0,
      maxRounds: 3,
      myRoundsWon: 0,
      oppRoundsWon: 0,
      myRoundEnded: false,
      oppRoundEnded: false,
      oppRoundScore: 0,
      stakePaid: false,
      opponentNickname: "",
      finalized: false,
      initialized: false
    };

    const AudioFX = {
      ctx: null,
      init() {
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
      },
      play(type) {
        if (!this.ctx) this.init();
        if (this.ctx.state === "suspended") this.ctx.resume();
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        switch (type) {
          case "select":
            osc.frequency.value = 600;
            gain.gain.value = 0.1;
            osc.start();
            osc.stop(this.ctx.currentTime + 0.05);
            break;
          case "play":
            osc.frequency.value = 800;
            gain.gain.value = 0.15;
            osc.start();
            osc.stop(this.ctx.currentTime + 0.1);
            break;
          case "score":
            osc.type = "triangle";
            osc.frequency.setValueAtTime(400, this.ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(800, this.ctx.currentTime + 0.2);
            gain.gain.value = 0.12;
            osc.start();
            osc.stop(this.ctx.currentTime + 0.2);
            break;
          case "win":
            [523, 659, 784, 1047].forEach((f, i) => {
              const o = this.ctx.createOscillator();
              const g = this.ctx.createGain();
              o.connect(g);
              g.connect(this.ctx.destination);
              o.frequency.value = f;
              g.gain.value = 0.1;
              o.start(this.ctx.currentTime + i * 0.1);
              o.stop(this.ctx.currentTime + i * 0.1 + 0.15);
            });
            break;
          case "lose":
            osc.type = "sawtooth";
            osc.frequency.setValueAtTime(300, this.ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(100, this.ctx.currentTime + 0.3);
            gain.gain.value = 0.1;
            osc.start();
            osc.stop(this.ctx.currentTime + 0.3);
            break;
          default:
            break;
        }
      }
    };

    const $ = sel => document.querySelector(sel);
    const cardsWrap = $("#cardsWrap");
    const handPreview = $("#handPreview");
    const handResult = $("#handResult");
    const logEl = $("#log");
    const jokerArea = $("#jokerArea");
    const tablePanel = $("#tablePanel");
    const jokerPopup = $("#jokerPopup");
    const deckOrder = { heart: 0, diamond: 1, club: 2, spade: 3 };

    window.closeJokerPopup = function closeJokerPopup() {
      jokerPopup.classList.remove("show");
    };

    jokerPopup.addEventListener("click", (event) => {
      if (event.target === jokerPopup) closeJokerPopup();
    });

    function hashSeed(seedText) {
      let h = 2166136261;
      for (let i = 0; i < seedText.length; i++) {
        h ^= seedText.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return h >>> 0;
    }

    function mulberry32(seed) {
      return function () {
        let t = (seed += 0x6D2B79F5);
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    }

    function buildDeck(seedText = "") {
      let id = 0;
      const deck = [];
      for (const suit of suits) {
        for (const rank of rankList) deck.push({ id: id++, suit, rank });
      }
      const rng = seedText ? mulberry32(hashSeed(seedText)) : Math.random;
      for (let i = deck.length - 1; i > 0; i--) {
        const j = Math.floor(rng() * (i + 1));
        [deck[i], deck[j]] = [deck[j], deck[i]];
      }
      return deck;
    }

    function formatRank(rank) {
      return rankLabel[rank] || String(rank);
    }

    function activeRoundLabel() {
      if (state.mode === "pvp") return `${pvp.currentRound}/${pvp.maxRounds}`;
      return `${state.ante}-${state.roundIndex + 1}`;
    }

    function activeTarget() {
      if (state.mode === "pvp") return pvp.roundTarget;
      const blindDefs = getBlindTargets(state.ante);
      const round = blindDefs[state.roundIndex] || blindDefs[blindDefs.length - 1];
      return round.target;
    }

    function drawToEight() {
      while (state.hand.length < 8 && state.deck.length > 0) state.hand.push(state.deck.pop());
    }

    function setInfo(msg) {
      handResult.innerHTML = msg;
    }

    function addLog(msg) {
      const el = document.createElement("div");
      el.textContent = msg;
      logEl.prepend(el);
      while (logEl.children.length > 40) logEl.removeChild(logEl.lastChild);
    }

    function updateGoldLabel() {
      const label = $("#goldLabel");
      if (!label) return;
      const gold = window.SharedWallet ? Number(SharedWallet.gold || 0) : 0;
      label.textContent = `G ${gold.toLocaleString()}`;
    }

    function setOpponentStatus(text) {
      $("#opponentStatus").textContent = text;
    }

    function renderCards() {
      cardsWrap.innerHTML = "";
      state.hand.forEach(card => {
        const d = document.createElement("div");
        d.className = `card ${suitClass[card.suit]} ${state.selected.has(card.id) ? "selected" : ""}`;
        d.dataset.id = String(card.id);
        d.innerHTML = `
  <div class="card-corner card-tl">
    <span class="ci-rank">${formatRank(card.rank)}</span>
    <span class="ci-suit">${suitSymbol[card.suit]}</span>
  </div>
  <div class="card-center-sym">${suitSymbol[card.suit]}</div>
  <div class="card-corner card-br">
    <span class="ci-rank">${formatRank(card.rank)}</span>
    <span class="ci-suit">${suitSymbol[card.suit]}</span>
  </div>`;
        d.addEventListener("click", () => {
          if (state.gameEnded) return;
          if (state.selected.has(card.id)) state.selected.delete(card.id);
          else {
            const maxSelectable = state.bossModifier?.id === "max3cards" ? 3 : 5;
            if (state.selected.size >= maxSelectable) return setInfo(`ÏµúÎåÄ ${maxSelectable}Ïû•ÍπåÏßÄÎßå ÏÑ†ÌÉù Í∞ÄÎä•Ìï©ÎãàÎã§.`);
            state.selected.add(card.id);
          }
          AudioFX.play("select");
          state.lastToggledCardId = card.id;
          renderCards();
          updateHandPreview();
        });
        d.addEventListener('mousemove', (e) => {
          if (state.selected.has(card.id)) return;
          const r = d.getBoundingClientRect();
          const x = ((e.clientX - r.left) / r.width - 0.5) * 18;
          const y = ((e.clientY - r.top) / r.height - 0.5) * -18;
          d.style.transform = `perspective(500px) rotateY(${x}deg) rotateX(${y}deg) translateY(-6px)`;
          d.style.boxShadow = `${-x * 0.5}px ${Math.abs(y)}px 28px rgba(0,0,0,0.45)`;
        });
        d.addEventListener('mouseleave', () => {
          if (!state.selected.has(card.id)) {
            d.style.transform = '';
            d.style.boxShadow = '';
          }
        });
        if (state.lastToggledCardId === card.id) {
          d.classList.add("pick-fx");
          setTimeout(() => d.classList.remove("pick-fx"), 280);
        }
        d.style.animationDelay = `${Array.from(cardsWrap.children).length * 35}ms`;
        cardsWrap.appendChild(d);
      });
      state.lastToggledCardId = null;
    }

    function wait(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function getCountUpCtor() {
      if (window.countUp && window.countUp.CountUp) return window.countUp.CountUp;
      if (window.CountUp) return window.CountUp;
      return null;
    }

    async function runCountUp(target, endVal, options = {}) {
      const CountCtor = getCountUpCtor();
      if (!target) return;
      if (!CountCtor) {
        target.textContent = Number(endVal).toLocaleString();
        return;
      }
      const instance = new CountCtor(target, endVal, { duration: 0.6, separator: ",", ...options });
      if (!instance.error) instance.start();
      await wait((options.duration || 0.6) * 1000 + 40);
    }

    function updateHandPreview() {
      if (!handPreview) return;
      const cards = selectedCards();
      if (!cards.length) {
        handPreview.classList.remove("show");
        handPreview.textContent = "Ï°±Î≥¥Î™Ö | ÏòàÏÉÅ: 0Ï†ê";
        return;
      }
      const hand = scoreHand(cards);
      const cardChips = cards.reduce((sum, c) => sum + (RANK_CHIPS[c.rank] || 0), 0);
      const estimated = Math.floor((hand.chips + cardChips) * hand.mult);
      handPreview.textContent = `${hand.name} | ÏòàÏÉÅ: ${estimated.toLocaleString()}Ï†ê`;
      handPreview.classList.add("show");
    }

    function showSellPopup(amount, anchorEl) {
      const rect = anchorEl.getBoundingClientRect();
      const popup = document.createElement("div");
      popup.className = "sell-popup";
      popup.textContent = `+${amount}Í≥®Îìú`;
      popup.style.left = `${rect.left + rect.width * 0.5}px`;
      popup.style.top = `${rect.top - 6}px`;
      document.body.appendChild(popup);
      if (window.anime) {
        anime({
          targets: popup,
          translateY: [-2, -40],
          opacity: [0, 1, 1, 0],
          scale: [0.82, 1.06, 0.96],
          easing: "easeOutExpo",
          duration: 700,
          complete: () => popup.remove()
        });
      } else {
        popup.style.animation = "floatUp 700ms ease forwards";
        setTimeout(() => popup.remove(), 720);
      }
    }

    function sellJoker(index, anchorEl) {
      const joker = state.jokers[index];
      if (!joker) return;
      const refund = Math.floor(joker.cost / 2);
      state.jokers.splice(index, 1);
      state.money += refund;
      addLog(`Ï°∞Ïª§ ÌåêÎß§: ${joker.name} (+${refund}Í≥®Îìú)`);
      if (anchorEl) showSellPopup(refund, anchorEl);
      renderHUD();
      if ($("#shopModal").classList.contains("show")) openShop(_shopIsAnteClear);
    }

    function renderOwnedJokersInShop() {
      const box = $("#shopOwnedJokers");
      if (!box) return;
      box.innerHTML = "";
      const title = document.createElement("div");
      title.className = "subtitle";
      title.textContent = "Î≥¥Ïú† Ï°∞Ïª§ (ÌåêÎß§: Î∞òÍ∞í)";
      box.appendChild(title);
      if (!state.jokers.length) {
        const empty = document.createElement("div");
        empty.className = "shop-owned-empty";
        empty.textContent = "Î≥¥Ïú† Ï§ëÏù∏ Ï°∞Ïª§Í∞Ä ÏóÜÏäµÎãàÎã§.";
        box.appendChild(empty);
        return;
      }
      const list = document.createElement("div");
      list.className = "shop-owned-list";
      state.jokers.forEach((joker, index) => {
        const item = document.createElement("div");
        item.className = "shop-owned-item";
        item.innerHTML = `
          <div class="shop-owned-name">${joker.name}</div>
          <div class="shop-owned-refund">ÌôòÍ∏â ${Math.floor(joker.cost / 2)}Í≥®Îìú</div>
        `;
        const btn = document.createElement("button");
        btn.textContent = "ÌåîÍ∏∞ [Î∞òÍ∞í]";
        btn.addEventListener("click", (event) => {
          event.stopPropagation();
          sellJoker(index, btn);
        });
        item.appendChild(btn);
        list.appendChild(item);
      });
      box.appendChild(list);
    }

    function openJokerPopup(joker) {
      const glyph = jokerGlyphClass[joker.id] || "joker-duo";
      $("#jokerPopupIcon").innerHTML = `<span class="joker-glyph ${glyph}"></span>`;
      $("#jokerPopupName").textContent = joker.name;
      $("#jokerPopupDesc").textContent = joker.detail || joker.desc;
      $("#jokerPopupCost").textContent = `ÌöçÎìù ÎπÑÏö©: $${joker.cost}`;
      jokerPopup.classList.add("show");
      AudioFX.play("select");
    }

    function pulseJokers(ids) {
      ids.forEach(id => {
        const el = jokerArea.querySelector(`.joker[data-joker-id="${id}"]`);
        if (!el) return;
        el.classList.remove("active");
        void el.offsetWidth;
        el.classList.add("active");
        setTimeout(() => el.classList.remove("active"), 700);
      });
    }

    function spawnWinConfetti() {
      const palette = ["#45f5ff", "#ffcf6d", "#ff69ce", "#7af5b8", "#ff8a66"];
      for (let i = 0; i < 36; i++) {
        const bit = document.createElement("div");
        bit.className = "confetti";
        bit.style.left = `${Math.random() * window.innerWidth}px`;
        bit.style.top = `${Math.max(0, window.innerHeight * 0.15)}px`;
        bit.style.background = palette[i % palette.length];
        bit.style.setProperty("--dx", `${Math.random() * 120 - 60}px`);
        bit.style.setProperty("--dy", `${Math.random() * 260 + 220}px`);
        bit.style.setProperty("--rot", `${Math.random() * 560 - 280}deg`);
        bit.style.animationDelay = `${i * 8}ms`;
        document.body.appendChild(bit);
        setTimeout(() => bit.remove(), 1300);
      }
    }

    function renderJokers() {
      jokerArea.innerHTML = "";
      for (let i = 0; i < 5; i++) {
        const joker = state.jokers[i];
        const box = document.createElement("div");
        if (!joker) {
          box.className = "joker empty";
          box.setAttribute("aria-label", "Îπà Ïä¨Î°Ø");
        } else {
          box.className = `joker joker-${joker.id} has-sell`;
          box.dataset.jokerId = joker.id;
          box.innerHTML = `
            <span class="joker-icon" aria-hidden="true"><span class="joker-glyph ${jokerGlyphClass[joker.id] || "joker-duo"}"></span></span>
            <span class="joker-name-mini">${joker.name}</span>
            <span class="joker-desc-mini">${joker.desc}</span>
            <button class="joker-sell" type="button">ÌåîÍ∏∞</button>
          `;
          box.addEventListener("click", () => openJokerPopup(joker));
          const sellBtn = box.querySelector(".joker-sell");
          sellBtn.addEventListener("click", (event) => {
            event.stopPropagation();
            sellJoker(i, sellBtn);
          });
        }
        jokerArea.appendChild(box);
      }
    }

    function renderHUD(chips = 0, mult = 1) {
      $("#roundLabel").textContent = activeRoundLabel();
      if (state.mode === "pvp") $("#anteBlindLabel").textContent = `ROUND ${pvp.currentRound}/${pvp.maxRounds}`;
      else $("#anteBlindLabel").textContent = `Ante ${state.ante} | Blind ${state.roundIndex + 1}/3`;
      $("#targetLabel").textContent = activeTarget().toLocaleString();
      $("#scoreLabel").textContent = state.score.toLocaleString();
      $("#moneyLabel").textContent = `$${state.money}`;
      $("#handsLabel").textContent = String(state.handsLeft);
      $("#discardsLabel").textContent = String(state.discardsLeft);
      $("#chipsLabel").textContent = chips.toLocaleString();
      $("#multLabel").textContent = `x${mult}`;
      $("#playBtn").disabled = state.gameEnded;
      $("#discardBtn").disabled = state.gameEnded;
      $("#deckBtn").textContent = `üÉè Îç± (${state.deck.length}Ïû•)`;
      $("#handGuide").textContent = state.bossModifier?.id === "max3cards"
        ? "ÏÜêÌå® 8Ïû• Ï§ë ÏµúÎåÄ 3Ïû•ÏùÑ ÏÑ†ÌÉù"
        : "ÏÜêÌå® 8Ïû• Ï§ë ÏµúÎåÄ 5Ïû•ÏùÑ ÏÑ†ÌÉù";
      $("#pvpPanel").classList.toggle("show", state.mode === "pvp");
      renderJokers();
      updateHandPreview();
      updateGoldLabel();
    }

    function renderDeckModal() {
      const cards = [...state.deck].sort((a, b) => {
        const suitDiff = deckOrder[a.suit] - deckOrder[b.suit];
        if (suitDiff !== 0) return suitDiff;
        return a.rank - b.rank;
      });
      const grid = $("#deckGrid");
      grid.innerHTML = "";
      cards.forEach(card => {
        const el = document.createElement("div");
        el.className = `deck-card ${card.suit}`;
        el.textContent = `${suitSymbol[card.suit]}${formatRank(card.rank)}`;
        grid.appendChild(el);
      });
      $("#deckModalTitle").textContent = `ÎÇ®ÏùÄ Ïπ¥Îìú (${cards.length}Ïû•)`;
      const counts = { heart: 0, diamond: 0, club: 0, spade: 0 };
      cards.forEach(card => { counts[card.suit] += 1; });
      $("#deckSuitCounts").textContent = `‚ô•${counts.heart} ‚ô¶${counts.diamond} ‚ô£${counts.club} ‚ô†${counts.spade}`;
    }

    function openDeckModal() {
      renderDeckModal();
      $("#deckModal").classList.add("show");
    }

    function closeDeckModal() {
      $("#deckModal").classList.remove("show");
    }

    function openVictoryModal(message = "") {
      const totalScore = state.score;
      const prev = parseInt(localStorage.getItem("jokerrun_hs") || "0", 10);
      const isNew = totalScore > prev;
      if (isNew) localStorage.setItem("jokerrun_hs", String(totalScore));
      const best = Math.max(prev, totalScore);
      $("#victoryText").textContent = message || `Î≥¥Ïä§ Î∏îÎùºÏù∏Îìú Í≤©Ìåå! ÏµúÏ¢Ö Ï†êÏàò ${totalScore.toLocaleString()}Ï†ê`;
      $("#victoryHighScore").textContent = isNew ? `üèÜ Ïã†Í∏∞Î°ù: ${totalScore.toLocaleString()}Ï†ê` : `ÏµúÍ≥† Í∏∞Î°ù: ${best.toLocaleString()}Ï†ê`;
      $("#victoryModal").classList.add("show");
    }

    function closeVictoryModal() {
      $("#victoryModal").classList.remove("show");
    }

    function selectedCards() {
      return state.hand.filter(c => state.selected.has(c.id));
    }

    function scoreHand(cards) {
      if (!cards.length) return { handType: "HIGH_CARD", ...handBase.HIGH_CARD };
      const ranks = cards.map(c => c.rank).sort((a, b) => a - b);
      const suitsOnly = cards.map(c => c.suit);
      const counts = Object.values(ranks.reduce((m, r) => ((m[r] = (m[r] || 0) + 1), m), {})).sort((a, b) => b - a);
      const isFive = cards.length === 5;
      const isFlush = isFive && new Set(suitsOnly).size === 1;
      let isStraight = false;
      if (isFive) {
        const uniq = [...new Set(ranks)];
        if (uniq.length === 5) isStraight = uniq[4] - uniq[0] === 4 || uniq.join(",") === "2,3,4,5,14";
      }
      if (isStraight && isFlush) return { handType: "STRAIGHT_FLUSH", ...handBase.STRAIGHT_FLUSH };
      if (counts[0] === 4) return { handType: "FOUR", ...handBase.FOUR };
      if (counts[0] === 3 && counts[1] === 2) return { handType: "FULL_HOUSE", ...handBase.FULL_HOUSE };
      if (isFlush) return { handType: "FLUSH", ...handBase.FLUSH };
      if (isStraight) return { handType: "STRAIGHT", ...handBase.STRAIGHT };
      if (counts[0] === 3) return { handType: "THREE", ...handBase.THREE };
      if (counts[0] === 2 && counts[1] === 2) return { handType: "TWO_PAIR", ...handBase.TWO_PAIR };
      if (counts[0] === 2) return { handType: "PAIR", ...handBase.PAIR };
      return { handType: "HIGH_CARD", ...handBase.HIGH_CARD };
    }

    function spawnChipParticles(points) {
      const scoreEl = $("#scoreLabel");
      const source = tablePanel.getBoundingClientRect();
      const target = scoreEl.getBoundingClientRect();
      const startX = source.left + source.width * 0.5;
      const startY = source.top + source.height * 0.65;
      const endX = target.left + target.width * 0.5;
      const endY = target.top + target.height * 0.5;
      const count = Math.min(16, Math.max(8, Math.floor(points / 60)));
      for (let i = 0; i < count; i++) {
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.style.left = `${startX + (Math.random() * 34 - 17)}px`;
        chip.style.top = `${startY + (Math.random() * 16 - 8)}px`;
        chip.style.setProperty("--dx", `${endX - startX + (Math.random() * 14 - 7)}px`);
        chip.style.setProperty("--dy", `${endY - startY + (Math.random() * 14 - 7)}px`);
        chip.style.animationDelay = `${i * 24}ms`;
        chip.classList.add("fly");
        document.body.appendChild(chip);
        setTimeout(() => chip.remove(), 860 + i * 24);
      }
    }

    async function animateScore(handName, chips, points, mult, prevScore, nextScore) {
      const scoreEl = $("#scoreLabel");
      const chipsLabel = $("#chipsLabel");
      const multLabel = $("#multLabel");
      const layer = document.createElement("div");
      layer.className = "dramatic-layer";
      document.body.appendChild(layer);

      const runAnime = params => new Promise(resolve => {
        if (!window.anime) {
          setTimeout(resolve, params.duration || 280);
          return;
        }
        anime({ ...params, complete: resolve });
      });

      const burst = document.createElement("div");
      burst.className = "dramatic-hand";
      burst.textContent = handName;
      layer.appendChild(burst);
      await runAnime({
        targets: burst,
        scale: [0.4, 1.08, 1],
        opacity: [0, 1, 0],
        duration: 300,
        easing: "easeOutCubic"
      });
      burst.remove();

      const chipCard = document.createElement("div");
      chipCard.className = "dramatic-card dramatic-chip";
      chipCard.innerHTML = `Ïπ©: <span id="dramaticChipNum">0</span>`;
      layer.appendChild(chipCard);
      await runAnime({
        targets: chipCard,
        translateY: [10, 0],
        opacity: [0, 1],
        scale: [0.86, 1],
        duration: 180,
        easing: "easeOutQuad"
      });
      await runCountUp(chipCard.querySelector("#dramaticChipNum"), chips, { duration: 0.6 });
      chipsLabel.textContent = Number(chips).toLocaleString();
      await runAnime({ targets: chipCard, opacity: [1, 0], translateY: [0, -10], duration: 150, easing: "easeInQuad" });
      chipCard.remove();

      const multFx = document.createElement("div");
      multFx.className = "dramatic-mult";
      multFx.textContent = `√ó ${mult}Î∞∞`;
      layer.appendChild(multFx);
      await runAnime({
        targets: multFx,
        scale: [0.3, 1.2, 1],
        opacity: [0, 1, 0.95],
        duration: 360,
        easing: "easeOutBounce"
      });
      multLabel.textContent = `x${mult}`;

      const finalFx = document.createElement("div");
      finalFx.className = "dramatic-final";
      finalFx.innerHTML = `+<span id="dramaticScoreNum">0</span>Ï†ê`;
      layer.appendChild(finalFx);
      if (window.party && typeof window.party.confetti === "function") {
        try {
          window.party.confetti(scoreEl, { count: 90, spread: 60 });
        } catch (_) {}
      }
      spawnChipParticles(points);
      await runAnime({ targets: finalFx, opacity: [0, 1], scale: [0.82, 1], duration: 140, easing: "easeOutQuad" });
      await runCountUp(finalFx.querySelector("#dramaticScoreNum"), points, { duration: 0.6 });
      AudioFX.play("score");
      await runAnime({ targets: finalFx, opacity: [1, 0], translateY: [0, -14], duration: 180, easing: "easeInQuad" });

      await runCountUp(scoreEl, nextScore, { duration: 0.55, startVal: prevScore });
      const total = $("#scoreLabel");
      total.classList.remove("pulse");
      void total.offsetWidth;
      total.classList.add("pulse");

      layer.remove();
    }

    function consumeSelectedCards() {
      state.hand = state.hand.filter(c => !state.selected.has(c.id));
      state.selected.clear();
      drawToEight();
      renderCards();
      updateHandPreview();
    }

    async function sendPvpAction(data) {
      if (state.mode !== "pvp" || !pvp.mp) return;
      try { await pvp.mp.sendAction(data); } catch (e) { addLog(`ÎèôÍ∏∞Ìôî Ïã§Ìå®: ${e.message || e}`); }
    }

    function openPvpResult(text) {
      $("#pvpFinalText").textContent = text;
      $("#pvpResultModal").classList.add("show");
    }

    async function settlePvpGold(result) {
      if (!window.SharedWallet || !pvp.stakePaid) return;
      if (result === "win") SharedWallet.addGold(pvp.bet * 2);
      if (result === "draw") SharedWallet.addGold(pvp.bet);
      pvp.stakePaid = false;
      updateGoldLabel();
    }

    async function finalizePvpMatch() {
      if (pvp.finalized) return;
      pvp.finalized = true;
      let result = "draw";
      if (pvp.myRoundsWon > pvp.oppRoundsWon) result = "win";
      if (pvp.myRoundsWon < pvp.oppRoundsWon) result = "lose";
      if (result === "win") {
        AudioFX.play("win");
        spawnWinConfetti();
      }
      if (result === "lose") AudioFX.play("lose");
      await settlePvpGold(result);
      await sendPvpAction({ type: "GAME_OVER", finalScore: state.score, result });
      const gainText = result === "win" ? `ÏäπÎ¶¨! +${pvp.bet * 2}G` : result === "draw" ? `Î¨¥ÏäπÎ∂Ä! +${pvp.bet}G ÌôòÎ∂à` : "Ìå®Î∞∞...";
      openPvpResult(`${gainText} (ÎùºÏö¥Îìú ${pvp.myRoundsWon}:${pvp.oppRoundsWon})`);
      addLog(`ÎåÄÏ†Ñ Ï¢ÖÎ£å: ${gainText}`);
    }

    async function resolvePvpRound() {
      if (!pvp.myRoundEnded || !pvp.oppRoundEnded) return;
      if (state.score > pvp.oppRoundScore) {
        pvp.myRoundsWon += 1;
        setInfo(`ÎùºÏö¥Îìú ÏäπÎ¶¨! (${state.score} vs ${pvp.oppRoundScore})`);
      } else if (state.score < pvp.oppRoundScore) {
        pvp.oppRoundsWon += 1;
        setInfo(`ÎùºÏö¥Îìú Ìå®Î∞∞... (${state.score} vs ${pvp.oppRoundScore})`);
      } else {
        setInfo(`ÎùºÏö¥Îìú Î¨¥ÏäπÎ∂Ä (${state.score})`);
      }
      if (pvp.myRoundsWon >= 2 || pvp.oppRoundsWon >= 2 || pvp.currentRound >= pvp.maxRounds) return finalizePvpMatch();
      if (pvp.isHost) setTimeout(() => sendRoundStart(pvp.currentRound + 1), 900);
    }

    async function endLocalPvpRound() {
      if (pvp.myRoundEnded) return;
      state.gameEnded = true;
      pvp.myRoundEnded = true;
      renderHUD();
      setOpponentStatus("ÏÉÅÎåÄÎ∞© ÎåÄÍ∏∞ Ï§ë...");
      await sendPvpAction({ type: "ROUND_ENDED", roundScore: state.score, roundsWon: pvp.myRoundsWon });
      resolvePvpRound();
    }

    function canContinue() {
      if (state.gameEnded) return false;
      const target = activeTarget();
      console.log("[JokerRun][canContinue]", { score: state.score, target, handsLeft: state.handsLeft, mode: state.mode });
      if (state.score >= target) {
        if (state.mode === "pvp") endLocalPvpRound();
        else winRound();
        return false;
      }
      if (state.handsLeft <= 0) {
        if (state.mode === "pvp") endLocalPvpRound();
        else loseRun();
        return false;
      }
      return true;
    }

    async function playSelected() {
      if (state.gameEnded) return;
      if (state.handsLeft <= 0) {
        state.handsLeft = 0;
        renderHUD();
        canContinue();
        return;
      }
      const cards = selectedCards();
      if (!cards.length) return setInfo("Î®ºÏ†Ä Ïπ¥ÎìúÎ•º 1Ïû• Ïù¥ÏÉÅ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.");
      if (state.bossModifier?.id === "max3cards" && cards.length > 3) return setInfo("Ïù¥Î≤à Î∏îÎùºÏù∏ÎìúÎäî ÏµúÎåÄ 3Ïû•ÍπåÏßÄÎßå ÏÑ†ÌÉù Í∞ÄÎä•Ìï©ÎãàÎã§.");
      if (state.bossModifier?.id === "min4cards" && cards.length < 4) return setInfo("Ïù¥Î≤à Î∏îÎùºÏù∏ÎìúÎäî ÏµúÏÜå 4Ïû•ÏùÑ ÏÑ†ÌÉùÌï¥Ïïº Ìï©ÎãàÎã§.");
      // Animate selected cards flying out
      const selectedEls = Array.from(cardsWrap.querySelectorAll('.card.selected'));
      selectedEls.forEach(el => el.classList.add('playing-out'));
      await new Promise(r => setTimeout(r, 300));
      AudioFX.play("play");
      const hand = scoreHand(cards);
      const cardChips = cards.reduce((sum, c) => sum + (RANK_CHIPS[c.rank] || 0), 0);
      let chips = hand.chips + cardChips;
      let mult = hand.mult;
      const ctx = {
        cards,
        handType: hand.handType,
        chips,
        mult,
        activated: [],
        activate(id) { this.activated.push(id); }
      };
      if (state.bossModifier?.id === "no_hearts") {
        ctx.chips = Math.max(5, ctx.chips - cards.filter(c => c.suit === "heart").length * 5);
      }
      for (const joker of state.jokers) joker.apply(ctx);
      chips = Math.max(0, Math.floor(ctx.chips));
      mult = Math.max(1, Math.floor(ctx.mult * 100) / 100);
      pulseJokers(ctx.activated);
      const points = Math.floor(chips * mult);
      const prevScore = state.score;
      state.score += points;
      state.handsLeft = Math.max(0, state.handsLeft - 1);
      await animateScore(hand.name, chips, points, mult, prevScore, state.score);
      setInfo(`<span class="hand-tag">${hand.name}</span> | ${chips}Ïπ© √ó ${mult}Î∞∞ = <b>${points.toLocaleString()}</b>Ï†ê`);
      addLog(`${hand.name} ÌîåÎ†àÏù¥: +${points}Ï†ê (ÎÇ®ÏùÄ Ìï∏Îìú ${state.handsLeft})`);
      consumeSelectedCards();
      renderHUD(chips, mult);
      const shouldContinue = canContinue();
      if (!shouldContinue) return;
      if (state.mode === "pvp") {
        await sendPvpAction({ type: "HAND_PLAYED", handType: hand.handType, chips, mult, totalScore: state.score });
        setOpponentStatus("ÏÉÅÎåÄÎ∞© ÌîåÎ†àÏù¥ Ï§ë...");
      }
    }

    function discardSelected() {
      if (state.gameEnded) return;
      if (state.discardsLeft <= 0) {
        state.discardsLeft = 0;
        renderHUD();
        return setInfo("Î≤ÑÎ¶¨Í∏∞ ÌöüÏàòÎ•º Î™®Îëê ÏÇ¨Ïö©ÌñàÏäµÎãàÎã§.");
      }
      const cards = selectedCards();
      if (!cards.length) return setInfo("Î≤ÑÎ¶¥ Ïπ¥ÎìúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.");
      AudioFX.play("select");
      state.discardsLeft = Math.max(0, state.discardsLeft - 1);
      const discardEls = Array.from(cardsWrap.querySelectorAll('.card.selected'));
      discardEls.forEach(el => el.classList.add('discarding-out'));
      setTimeout(() => consumeSelectedCards(), 280);
      setInfo(`${cards.length}Ïû• Î≤ÑÎ¶º ÏôÑÎ£å. ÎÇ®ÏùÄ Î≤ÑÎ¶¨Í∏∞ ${state.discardsLeft}`);
      addLog(`${cards.length}Ïû• Î≤ÑÎ¶º. (ÎÇ®ÏùÄ Î≤ÑÎ¶¨Í∏∞ ${state.discardsLeft})`);
      renderHUD();
      updateHandPreview();
    }

    let _shopIsAnteClear = false;

    function openShop(anteClear = false) {
      _shopIsAnteClear = anteClear;
      const grid = $("#shopGrid");
      grid.innerHTML = "";
      $("#shopMoney").textContent = `Î≥¥Ïú† ÏûêÍ∏à: $${state.money}`;
      renderOwnedJokersInShop();
      jokerPool.forEach(joker => {
        const owned = state.jokers.some(j => j.id === joker.id);
        const full = state.jokers.length >= 5;
        const afford = state.money >= joker.cost;
        const card = document.createElement("div");
        card.className = "shop-item";
        card.innerHTML = `<div class="name">${joker.name}</div><div class="desc">${joker.desc}</div><div class="price"><span class="coin" aria-hidden="true"></span>$${joker.cost}</div>`;
        const btn = document.createElement("button");
        btn.textContent = owned ? "ÌåîÍ∏∞ [Î∞òÍ∞í]" : full ? "Ïä¨Î°Ø Í∞ÄÎìù Ï∞∏" : afford ? "Íµ¨Îß§" : "ÏûêÍ∏à Î∂ÄÏ°±";
        btn.disabled = (!owned && (full || !afford));
        btn.addEventListener("click", () => {
          if (owned) {
            const index = state.jokers.findIndex(j => j.id === joker.id);
            if (index >= 0) sellJoker(index, btn);
            return;
          }
          state.money -= joker.cost;
          state.jokers.push(joker);
          addLog(`Ï°∞Ïª§ Íµ¨Îß§: ${joker.name} (-$${joker.cost})`);
          renderHUD();
          openShop(_shopIsAnteClear);
        });
        card.appendChild(btn);
        grid.appendChild(card);
      });
      $("#shopContinueBtn").textContent = anteClear
        ? `Ante ${state.ante + 1} ÏãúÏûë ‚Üí`
        : `Î∏îÎùºÏù∏Îìú ${Math.min(3, state.roundIndex + 2)}/3 ÏãúÏûë ‚Üí`;
      $("#shopModal").classList.add("show");
    }

    function closeShop() {
      $("#shopModal").classList.remove("show");
    }

    function startRound(index, seedText = "") {
      state.roundIndex = index;
      state.score = 0;
      state.handsLeft = 4;
      state.discardsLeft = 3;
      state.bossModifier = null;
      state.deck = buildDeck(seedText);
      state.hand = [];
      state.selected.clear();
      state.gameEnded = false;
      const blindDefs = getBlindTargets(state.ante);
      const blind = blindDefs[index];
      state.bossModifier = (index === 2 && blind && blind.modifier) ? blind.modifier : null;
      if (state.bossModifier) {
        if (state.bossModifier.id === "no_discard") state.discardsLeft = 0;
        if (state.bossModifier.id === "only2hands") state.handsLeft = 2;
        if (state.ante === 8 && index === 2) state.discardsLeft = 0;
      }
      closeDeckModal();
      closeVictoryModal();
      drawToEight();
      renderCards();
      renderHUD();
      updateHandPreview();
      setInfo("Ìï∏ÎìúÎ•º ÏÑ†ÌÉùÌï¥ ÌîåÎ†àÏù¥ÌïòÏÑ∏Ïöî.");
      if (state.bossModifier) {
        setInfo(`<span style="color:var(--danger)">‚ö†Ô∏è ${state.bossModifier.label}</span> ‚Äî ${state.bossModifier.desc}`);
      }
      addLog(`${activeRoundLabel()} ÏãúÏûë. Î™©Ìëú ${activeTarget()}Ï†ê`);
    }

    function winRound() {
      if (state.gameEnded) return;
      const reward = 7 + state.handsLeft * 2 + state.discardsLeft + state.ante * 2;
      state.money += reward;
      addLog(`Î∏îÎùºÏù∏Îìú ÌÅ¥Î¶¨Ïñ¥! Î≥¥ÏÉÅ +$${reward}`);
      state.gameEnded = true;
      AudioFX.play("win");
      spawnWinConfetti();
      renderHUD();
      const isLastBlind = state.roundIndex >= 2;
      const isLastAnte = state.ante >= 8;
      if (isLastBlind && isLastAnte) {
        showRunClearModal();
        return;
      }
      if (isLastBlind) {
        setInfo(`Ante ${state.ante} ÌÅ¥Î¶¨Ïñ¥! Îã§Ïùå Ïï§Ìã∞Î°ú...`);
        openShop(true);
      } else {
        setInfo(`Î∏îÎùºÏù∏Îìú ÎèåÌåå! Î≥¥ÏÉÅ +$${reward}`);
        openShop(false);
      }
    }

    function loseRun() {
      if (state.gameEnded) return;
      state.gameEnded = true;
      AudioFX.play("lose");
      renderHUD();
      const anteText = `Ante ${state.ante} - ${["Ïä§Î™∞", "ÎπÖ", "Î≥¥Ïä§"][state.roundIndex]} Î∏îÎùºÏù∏ÎìúÏóêÏÑú ÌÉàÎùΩ`;
      const totalScore = state.score;
      const prev = parseInt(localStorage.getItem("jokerrun_hs") || "0", 10);
      const isNew = totalScore > prev;
      if (isNew) localStorage.setItem("jokerrun_hs", String(totalScore));
      const hsText = isNew ? `üèÜ Ïã†Í∏∞Î°ù! ${totalScore.toLocaleString()}Ï†ê` : `ÏµúÍ≥† Í∏∞Î°ù: ${prev.toLocaleString()}Ï†ê`;
      document.getElementById("gameOverAnteText").textContent = anteText;
      document.getElementById("gameOverHighScore").textContent = hsText;
      document.getElementById("gameOverModal").classList.add("show");
      addLog("Í≤åÏûÑ Ïò§Î≤Ñ.");
    }

    function newRun() {
      state.mode = "single";
      state.ante = 1;
      state.money = 10;
      state.jokers = [];
      state.bossModifier = null;
      logEl.innerHTML = "";
      closeShop();
      closeDeckModal();
      closeVictoryModal();
      document.getElementById("gameOverModal").classList.remove("show");
      startRound(0);
      $("#modeModal").classList.remove("show");
      $("#pvpPanel").classList.remove("show");
    }

    function showRunClearModal() {
      const totalScore = state.score;
      const prev = parseInt(localStorage.getItem("jokerrun_hs") || "0", 10);
      const isNew = totalScore > prev;
      if (isNew) localStorage.setItem("jokerrun_hs", String(totalScore));
      const message = `üèÜ Îü∞ ÌÅ¥Î¶¨Ïñ¥! 8Ïï§Ìã∞ ÏôÑÏ£º!\nÏµúÏ¢Ö Ï†êÏàò ${totalScore.toLocaleString()}Ï†ê${isNew ? " ‚Äî Ïã†Í∏∞Î°ù!" : ""}`;
      openVictoryModal(message);
      spawnWinConfetti();
      AudioFX.play("win");
    }

    window.continueFromShop = function continueFromShop() {
      if (_shopIsAnteClear) {
        state.ante = Math.min(8, state.ante + 1);
        startRound(0);
      } else {
        startRound(state.roundIndex + 1);
      }
      closeShop();
    };

    function startSingleMode() {
      $("#modeModal").classList.remove("show");
      state.mode = "single";
      pvp.active = false;
      startRound(0);
    }

    function applyRemoteAction(event) {
      if (!event || !event.data) return;
      const data = event.data;
      if (data.type === "ROUND_START") {
        pvp.currentRound = data.round;
        pvp.roundTarget = data.target || 700;
        pvp.myRoundEnded = false;
        pvp.oppRoundEnded = false;
        pvp.oppRoundScore = 0;
        pvp.finalized = false;
        state.mode = "pvp";
        state.jokers = [];
        $("#opponentScore").textContent = "ÏÉÅÎåÄ Ï†êÏàò 0";
        setOpponentStatus("ÏÉÅÎåÄÎ∞© ÌîåÎ†àÏù¥ Ï§ë...");
        startRound(pvp.currentRound - 1, data.seed || "");
      }
      if (data.type === "HAND_PLAYED") {
        $("#opponentScore").textContent = `ÏÉÅÎåÄ Ï†êÏàò ${Number(data.totalScore || 0).toLocaleString()}`;
        setOpponentStatus("ÏÉÅÎåÄÎ∞© ÌîåÎ†àÏù¥ Ï§ë...");
      }
      if (data.type === "ROUND_ENDED") {
        pvp.oppRoundEnded = true;
        pvp.oppRoundScore = Number(data.roundScore || 0);
        pvp.oppRoundsWon = Number(data.roundsWon || pvp.oppRoundsWon);
        setOpponentStatus("ÏÉÅÎåÄÎ∞© ÎåÄÍ∏∞ Ï§ë...");
        resolvePvpRound();
      }
      if (data.type === "GAME_OVER" && !pvp.finalized) {
        pvp.finalized = true;
        const text = data.result === "win" ? "Ìå®Î∞∞..." : data.result === "lose" ? `ÏäπÎ¶¨! +${pvp.bet * 2}G` : `Î¨¥ÏäπÎ∂Ä! +${pvp.bet}G ÌôòÎ∂à`;
        openPvpResult(`${text} (ÏÉÅÎåÄ Ï†ÑÏÜ° Í≤∞Í≥º)`);
      }
    }

    function sendRoundStart(roundNo) {
      if (!pvp.isHost || !pvp.mp) return;
      const seed = `${Date.now()}-${Math.random().toString(16).slice(2)}-${roundNo}`;
      const data = { type: "ROUND_START", round: roundNo, seed, target: pvp.roundTarget };
      applyRemoteAction({ data });
      sendPvpAction(data);
    }

    async function ensureStakePaid() {
      if (!window.SharedWallet || pvp.stakePaid) return true;
      const ok = SharedWallet.removeGold(pvp.bet);
      if (!ok) {
        setInfo(`Í≥®Îìú Î∂ÄÏ°±: ${pvp.bet}G ÌïÑÏöî`);
        updateGoldLabel();
        return false;
      }
      pvp.stakePaid = true;
      updateGoldLabel();
      return true;
    }

    async function initMultiplayer() {
      if (pvp.initialized) return true;
      if (!window.MultiplayerClient) return false;
      pvp.mp = MultiplayerClient.getInstance();
      await pvp.mp.ensureAuth();
      pvp.mp.onEvent = async (event) => {
        if (event.type === "player_joined") {
          pvp.opponentNickname = event.nickname || "ÏÉÅÎåÄ";
          setOpponentStatus(`${pvp.opponentNickname} Ï†ëÏÜç`);
        }
        if (event.type === "game_started") {
          const roomBet = Number(event.betting || (event.room && event.room.betting) || 0);
          if (roomBet > 0) pvp.bet = roomBet;
          const paid = await ensureStakePaid();
          if (!paid) return;
          $("#modeModal").classList.remove("show");
          state.mode = "pvp";
          pvp.active = true;
          pvp.myRoundsWon = 0;
          pvp.oppRoundsWon = 0;
          pvp.finalized = false;
          $("#opponentScore").textContent = "ÏÉÅÎåÄ Ï†êÏàò 0";
          setOpponentStatus("ÏÉÅÎåÄÎ∞© ÌîåÎ†àÏù¥ Ï§ë...");
          addLog(`ÎåÄÏ†Ñ ÏãúÏûë! Î∞∞ÌåÖ ${pvp.bet}G`);
          if (pvp.isHost) sendRoundStart(1);
        }
        if (event.type === "action") applyRemoteAction(event);
      };
      pvp.mp.startListening();
      pvp.initialized = true;
      $("#roomHint").textContent = `Î°úÍ∑∏Ïù∏ ÏôÑÎ£å: ${pvp.mp.nickname || "ÏùµÎ™Ö"}`;
      return true;
    }

    async function createPvpRoom() {
      const ok = await initMultiplayer();
      if (!ok) return setInfo("Î©ÄÌã∞ÌîåÎ†àÏù¥ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.");
      pvp.bet = Number($("#betSelect").value || 100);
      pvp.isHost = true;
      const room = await pvp.mp.createRoom("jokerrun", { maxPlayers: 2, betting: pvp.bet });
      pvp.roomId = room.id || room.roomId || room.code || room.roomCode || "";
      await pvp.mp.setReady(true);
      $("#roomHint").textContent = `Î∞© ÏÉùÏÑ± ÏôÑÎ£å. ÏΩîÎìú: ${pvp.roomId || "(ÏûêÎèô Îß§Ïπ≠)"}`;
      setOpponentStatus("ÏÉÅÎåÄÎ∞© Ï†ëÏÜç ÎåÄÍ∏∞ Ï§ë...");
      addLog(`Î∞© ÏÉùÏÑ±: Î∞∞ÌåÖ ${pvp.bet}G`);
    }

    async function joinPvpRoom() {
      const ok = await initMultiplayer();
      if (!ok) return setInfo("Î©ÄÌã∞ÌîåÎ†àÏù¥ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.");
      const code = $("#roomCodeInput").value.trim();
      if (!code) return setInfo("Ï∞∏Í∞ÄÌï† Î∞© ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
      pvp.bet = Number($("#betSelect").value || 100);
      pvp.isHost = false;
      await pvp.mp.joinRoom(code);
      pvp.roomId = code;
      await pvp.mp.setReady(true);
      $("#roomHint").textContent = `Î∞© Ï∞∏Í∞Ä ÏôÑÎ£å: ${code}`;
      setOpponentStatus("ÏÉÅÎåÄÎ∞© Ï§ÄÎπÑ Ï§ë...");
      addLog(`Î∞© Ï∞∏Í∞Ä: ${code}`);
    }

    async function resetFromPvp() {
      if (pvp.mp) {
        try { await pvp.mp.leaveRoom(); } catch (_) {}
      }
      pvp.active = false;
      pvp.stakePaid = false;
      pvp.finalized = false;
      $("#pvpResultModal").classList.remove("show");
      $("#modeModal").classList.add("show");
      setOpponentStatus("ÏÉÅÎåÄ Ï†ïÎ≥¥ ÏóÜÏùå");
      $("#opponentScore").textContent = "ÏÉÅÎåÄ Ï†êÏàò 0";
      state.mode = "single";
      startRound(0);
    }

    $("#playBtn").addEventListener("click", playSelected);
    $("#discardBtn").addEventListener("click", discardSelected);
    $("#deckBtn").addEventListener("click", openDeckModal);
    $("#closeDeckBtn").addEventListener("click", closeDeckModal);
    $("#deckModal").addEventListener("click", (event) => {
      if (event.target === $("#deckModal")) closeDeckModal();
    });
    $("#clearBtn").addEventListener("click", () => {
      if (state.selected.size > 0) AudioFX.play("select");
      state.selected.clear();
      renderCards();
      updateHandPreview();
      setInfo("ÏÑ†ÌÉùÏùÑ Ìï¥Ï†úÌñàÏäµÎãàÎã§.");
    });
    $("#shopContinueBtn").addEventListener("click", window.continueFromShop);
    $("#restartBtn").addEventListener("click", () => {
      if (state.mode === "pvp") resetFromPvp();
      else newRun();
    });
    $("#themeBtn").addEventListener("click", () => document.documentElement.classList.toggle("light"));
    $("#singleModeBtn").addEventListener("click", startSingleMode);
    $("#createRoomBtn").addEventListener("click", createPvpRoom);
    $("#joinRoomBtn").addEventListener("click", joinPvpRoom);
    $("#pvpConfirmBtn").addEventListener("click", resetFromPvp);
    $("#victoryConfirmBtn").addEventListener("click", newRun);

    if (window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches) document.documentElement.classList.add("light");

    (async () => {
      if (window.SharedWallet) {
        try { await SharedWallet.init(); } catch (_) {}
      }
      updateGoldLabel();
      startRound(0);
      $("#modeModal").classList.add("show");
    })();
  </script>
    <script src="/lib/site-meta.js"></script>
    <script>
      SiteMeta.init({
        title: 'Ï°∞Ïª§Îü∞ - game.cocy.io',
        description: 'Ïπ¥Îìú Í∏∞Î∞ò Îü∞ Í≤åÏûÑ',
        url: 'https://game.cocy.io/jokerrun/'
      });
    </script>
</body>
</html>
