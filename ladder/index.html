<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ÏÇ¨Îã§Î¶¨ Í≤åÏûÑ - ÏàúÏÑú Ï†ïÌïòÍ∏∞</title>
<script src="/lib/shared-wallet.js?v=20260214"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body {
  background: #0a0b1e;
  color: #e8e8ff;
  font-family: 'Trebuchet MS', sans-serif;
  min-height: 100dvh;
  padding-top: calc(48px + env(safe-area-inset-top));
  overflow-x: hidden;
}
.wrap { max-width: 600px; margin: 0 auto; padding: 12px 8px 20px; }
h1 { text-align: center; font-size: 22px; color: #ffd700; margin-bottom: 4px; }
.sub { text-align: center; font-size: 12px; color: #8888bb; margin-bottom: 10px; }
.toolbar {
  display: flex; gap: 6px; justify-content: center; margin-bottom: 10px; flex-wrap: wrap;
}
.btn {
  padding: 7px 14px; border: none; border-radius: 8px;
  font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.2s;
}
.btn:active { transform: scale(0.95); }
.btn-primary { background: #6f2fd1; color: #fff; }
.btn-warn { background: #ffd700; color: #222; }
.btn-secondary { background: rgba(255,255,255,0.12); color: #ccc; }

.names-row {
  display: flex; gap: 3px; overflow-x: auto; padding: 4px 0;
  -webkit-overflow-scrolling: touch;
}
.name-cell {
  min-width: 44px; text-align: center; cursor: pointer;
  padding: 6px 2px; border-radius: 6px;
  background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15);
  font-size: 11px; font-weight: 700; color: #fff; transition: all 0.2s;
  user-select: none;
}
.name-cell:hover { background: rgba(255,255,255,0.15); }
.name-cell.done { opacity: 0.5; cursor: default; }
.name-cell.active { border-color: #ffd700; background: rgba(255,215,0,0.15); }

canvas {
  display: block; width: 100%; border-radius: 8px;
  background: rgba(0,0,0,0.3); touch-action: none; margin: 6px 0;
}

.bottom-row {
  display: flex; gap: 3px; overflow-x: auto; padding: 4px 0;
}
.order-cell {
  min-width: 44px; text-align: center; padding: 6px 2px;
  border-radius: 6px; font-size: 13px; font-weight: 800;
  background: rgba(255,215,0,0.08); border: 1px solid rgba(255,215,0,0.2);
  color: #ffd700; transition: all 0.3s;
}
.order-cell.hidden { color: transparent; background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); }
.order-cell.hidden::after { content: '?'; color: #555; }

.edit-row {
  display: flex; gap: 3px; overflow-x: auto; padding: 4px 0; margin-top: 8px;
}
.edit-input {
  width: 44px; min-width: 44px; padding: 5px 2px; text-align: center;
  background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12);
  border-radius: 6px; color: #aaa; font-size: 10px;
}
.edit-input:focus { border-color: #ffd700; outline: none; color: #fff; }
.edit-bar {
  display: flex; gap: 6px; align-items: center; justify-content: center;
  margin-top: 6px; font-size: 11px; color: #666;
}
.edit-bar button { font-size: 11px; padding: 4px 10px; }

.result-banner {
  position: fixed; top: 50%; left: 50%;
  transform: translate(-50%, -50%) scale(0);
  background: rgba(10,11,30,0.96); border: 2px solid #ffd700;
  border-radius: 16px; padding: 20px 28px; text-align: center;
  z-index: 999; transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
  pointer-events: none; min-width: 180px;
}
.result-banner.show { transform: translate(-50%, -50%) scale(1); pointer-events: auto; }
.result-banner .rname { font-size: 24px; font-weight: 800; color: #fff; }
.result-banner .rarrow { font-size: 20px; color: #ffd700; margin: 6px 0; }
.result-banner .rorder { font-size: 48px; font-weight: 900; color: #ffd700; }
.result-banner .rlabel { font-size: 13px; color: #aaa; margin-top: 2px; }

.scoreboard {
  margin-top: 14px; background: rgba(255,255,255,0.04);
  border-radius: 10px; padding: 10px 12px;
  display: none;
}
.scoreboard.show { display: block; }
.scoreboard h3 { font-size: 14px; color: #ffd700; margin-bottom: 6px; text-align: center; }
.sb-row { display: flex; justify-content: space-between; padding: 3px 0; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.05); }
.sb-row .sbn { color: #ccc; }
.sb-row .sbo { color: #ffd700; font-weight: 700; }
</style>
</head>
<body>
<div class="wrap">
  <h1>ü™ú ÏÇ¨Îã§Î¶¨ Í≤åÏûÑ</h1>
  <div class="sub">Ïù¥Î¶ÑÏùÑ ÌÑ∞ÏπòÌïòÎ©¥ ÏàúÏÑúÍ∞Ä Ï†ïÌï¥ÏßëÎãàÎã§</div>
  <div class="toolbar">
    <button class="btn btn-primary" onclick="shuffle()">üîÄ Îã§Ïãú ÏÑûÍ∏∞</button>
    <button class="btn btn-warn" onclick="revealAll()">üëÄ Ï†ÑÏ≤¥ Í≥µÍ∞ú</button>
  </div>
  <div class="names-row" id="namesRow"></div>
  <canvas id="cv"></canvas>
  <div class="bottom-row" id="bottomRow"></div>
  <div class="scoreboard" id="scoreboard"><h3>üìã ÏàúÏÑú Í≤∞Í≥º</h3><div id="sbBody"></div></div>
  <div class="edit-bar">
    <span>Ïù¥Î¶Ñ Ìé∏Ïßë:</span>
    <button class="btn btn-secondary" onclick="toggleEdit()">‚úèÔ∏è ÏàòÏ†ï</button>
    <button class="btn btn-secondary" onclick="addPerson()">+</button>
    <button class="btn btn-secondary" onclick="removeLast()">‚àí</button>
  </div>
  <div class="edit-row" id="editRow" style="display:none"></div>
</div>
<div class="result-banner" id="banner">
  <div class="rname" id="bName"></div>
  <div class="rarrow">‚ñº</div>
  <div class="rorder" id="bOrder"></div>
  <div class="rlabel">Î≤àÏß∏ ÏàúÏÑú</div>
</div>

<script>
const DEFAULT_NAMES = ['Î™ÖÌõà','ÏßÄÏú§','Ïö©Ìõà','Ï£ºÌù¨','ÎØ∏ÎÇò','Ïú§Ïö∞','Ïú§ÏïÑ','Ïû•ÎØ∏','ÏÑ±ÎØº','ÏùµÏôÑ','ÎØ∏Í≤Ω','ÌòïÏ∞¨','Í∑úÏãù','Ìù¨Ïàô'];
const COLORS = [
  '#ff4444','#44aaff','#44ff88','#ffaa00','#ff44cc','#44ffff','#aa88ff',
  '#ff8844','#88ff44','#ff4488','#44ccaa','#ffff44','#cc88ff','#ff6688',
  '#88ddff','#ffcc44','#66ffaa','#dd66ff','#ff8866','#66aaff'
];

let names = [...DEFAULT_NAMES];
let orders = []; // shuffled 1~N at bottom
let rungs = [];
let revealed = new Set(); // which top columns have been clicked
let revealedResults = {}; // topCol -> { endCol, order }
let animating = false;
let editMode = false;

const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');
const banner = document.getElementById('banner');

function resize() {
  const w = cv.parentElement.clientWidth;
  const h = Math.max(350, Math.min(550, window.innerHeight * 0.45));
  cv.width = w * 2; cv.height = h * 2;
  cv.style.height = h + 'px';
  ctx.scale(2, 2);
  draw();
  // redraw revealed paths
  for (const col of revealed) drawFullPath(col);
}

function buildUI() {
  const nr = document.getElementById('namesRow');
  nr.innerHTML = names.map((n, i) => {
    const cls = revealed.has(i) ? 'name-cell done' : 'name-cell';
    const color = revealed.has(i) ? COLORS[i % COLORS.length] : '';
    const style = color ? `border-color:${color};color:${color}` : '';
    return `<div class="${cls}" style="${style}" onclick="pickName(${i})">${n}</div>`;
  }).join('');

  const br = document.getElementById('bottomRow');
  br.innerHTML = orders.map((o, i) => {
    // Check if this bottom column has been revealed
    const revCol = Object.entries(revealedResults).find(([_, v]) => v.endCol === i);
    if (revCol) {
      const topCol = parseInt(revCol[0]);
      const color = COLORS[topCol % COLORS.length];
      return `<div class="order-cell" style="border-color:${color};color:${color}">${o}</div>`;
    }
    return `<div class="order-cell hidden"></div>`;
  }).join('');

  updateScoreboard();
}

function buildEditRow() {
  const er = document.getElementById('editRow');
  er.innerHTML = names.map((n, i) =>
    `<input class="edit-input" value="${n}" onchange="names[${i}]=this.value;buildUI()">`
  ).join('');
}

function shuffleArray(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function generateRungs() {
  const n = names.length;
  rungs = [];
  const rows = 14 + Math.floor(Math.random() * 6);
  for (let r = 0; r < rows; r++) {
    const y = (r + 1) / (rows + 1);
    const used = new Set();
    for (let c = 0; c < n - 1; c++) {
      if (used.has(c) || used.has(c - 1)) continue;
      if (Math.random() < 0.45) { rungs.push({ col: c, y }); used.add(c); }
    }
  }
}

function getX(col) {
  const n = names.length;
  const w = cv.width / 2;
  const pad = 24;
  return pad + col * ((w - pad * 2) / Math.max(1, n - 1));
}
function getY(frac) {
  const h = cv.height / 2;
  return 10 + frac * (h - 20);
}

function draw() {
  const w = cv.width / 2, h = cv.height / 2, n = names.length;
  ctx.clearRect(0, 0, w, h);
  ctx.strokeStyle = 'rgba(255,255,255,0.12)';
  ctx.lineWidth = 1.5;
  for (let i = 0; i < n; i++) {
    const x = getX(i);
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, h); ctx.stroke();
  }
  ctx.strokeStyle = 'rgba(255,255,255,0.2)';
  ctx.lineWidth = 1.5;
  for (const rung of rungs) {
    const x1 = getX(rung.col), x2 = getX(rung.col + 1), y = getY(rung.y);
    ctx.beginPath(); ctx.moveTo(x1, y); ctx.lineTo(x2, y); ctx.stroke();
  }
}

function tracePath(startCol) {
  let col = startCol;
  const path = [{ x: getX(col), y: 0 }];
  const sorted = [...rungs].sort((a, b) => a.y - b.y);
  for (const rung of sorted) {
    const y = getY(rung.y);
    if (rung.col === col) {
      path.push({ x: getX(col), y }); col++;
      path.push({ x: getX(col), y });
    } else if (rung.col + 1 === col) {
      path.push({ x: getX(col), y }); col--;
      path.push({ x: getX(col), y });
    }
  }
  path.push({ x: getX(col), y: cv.height / 2 });
  return { path, endCol: col };
}

function drawFullPath(startCol) {
  const { path } = tracePath(startCol);
  const color = COLORS[startCol % COLORS.length];
  ctx.strokeStyle = color; ctx.lineWidth = 3; ctx.lineCap = 'round';
  ctx.beginPath(); ctx.moveTo(path[0].x, path[0].y);
  for (let i = 1; i < path.length; i++) ctx.lineTo(path[i].x, path[i].y);
  ctx.stroke();
}

function animatePath(startCol, color, cb) {
  const { path, endCol } = tracePath(startCol);
  let totalLen = 0;
  const segs = [];
  for (let i = 1; i < path.length; i++) {
    const len = Math.hypot(path[i].x - path[i-1].x, path[i].y - path[i-1].y);
    segs.push({ from: path[i-1], to: path[i], len }); totalLen += len;
  }
  const duration = 1000;
  const start = performance.now();
  function step(now) {
    const t = Math.min(1, (now - start) / duration);
    const dist = t * totalLen;
    draw();
    for (const idx of revealed) drawFullPath(idx);
    ctx.strokeStyle = color; ctx.lineWidth = 3.5; ctx.lineCap = 'round';
    ctx.beginPath();
    let rem = dist, started = false;
    for (const seg of segs) {
      if (rem <= 0) break;
      const frac = Math.min(1, rem / seg.len);
      const ex = seg.from.x + (seg.to.x - seg.from.x) * frac;
      const ey = seg.from.y + (seg.to.y - seg.from.y) * frac;
      if (!started) { ctx.moveTo(seg.from.x, seg.from.y); started = true; }
      else ctx.lineTo(seg.from.x, seg.from.y);
      ctx.lineTo(ex, ey); rem -= seg.len;
    }
    ctx.stroke();
    if (t < 1) requestAnimationFrame(step);
    else cb(endCol);
  }
  requestAnimationFrame(step);
}

function pickName(i) {
  if (animating || revealed.has(i)) return;
  animating = true;
  revealed.add(i);
  const color = COLORS[i % COLORS.length];
  animatePath(i, color, (endCol) => {
    revealedResults[i] = { endCol, order: orders[endCol] };
    animating = false;
    buildUI();
    showBanner(names[i], orders[endCol]);
  });
}

function showBanner(name, order) {
  document.getElementById('bName').textContent = name;
  document.getElementById('bOrder').textContent = order;
  banner.classList.add('show');
  setTimeout(() => banner.classList.remove('show'), 2000);
}

function revealAll() {
  if (animating) return;
  const n = names.length;
  for (let i = 0; i < n; i++) {
    revealed.add(i);
    const { endCol } = tracePath(i);
    revealedResults[i] = { endCol, order: orders[endCol] };
  }
  draw();
  for (let i = 0; i < n; i++) drawFullPath(i);
  buildUI();
}

function shuffle() {
  orders = shuffleArray(names.map((_, i) => i + 1));
  revealed.clear();
  revealedResults = {};
  generateRungs();
  buildUI();
  draw();
  document.getElementById('scoreboard').classList.remove('show');
}

function updateScoreboard() {
  const sb = document.getElementById('scoreboard');
  const body = document.getElementById('sbBody');
  if (Object.keys(revealedResults).length === 0) { sb.classList.remove('show'); return; }
  sb.classList.add('show');
  const sorted = Object.entries(revealedResults).sort((a, b) => a[1].order - b[1].order);
  body.innerHTML = sorted.map(([col, v]) =>
    `<div class="sb-row"><span class="sbo">${v.order}Î≤à</span><span class="sbn">${names[col]}</span></div>`
  ).join('');
}

function addPerson() { names.push('Ï∞∏Í∞ÄÏûê'); shuffle(); buildEditRow(); }
function removeLast() { if (names.length <= 2) return; names.pop(); shuffle(); buildEditRow(); }
function toggleEdit() {
  editMode = !editMode;
  document.getElementById('editRow').style.display = editMode ? 'flex' : 'none';
  if (editMode) buildEditRow();
}

shuffle();
window.addEventListener('resize', resize);
resize();
</script>
</body>
</html>
