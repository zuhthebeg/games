<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ë¬´ê¸° ê°•í™” & ë°°í‹€</title>
    <link rel="icon" href="icon.svg">
    <script src="/lib/multiplayer.js?v=20260210v5"></script>
    <script src="/lib/multiplayer-ui.js?v=20260210v5"></script>
    <style>
        :root {
            --bg: #0d0d0d;
            --card: #1a1a1a;
            --card-border: #2a2a2a;
            --accent: #e94560;
            --success: #4ecca3;
            --fail: #ff6b6b;
            --gold: #ffd700;
            --text: #eee;
            --muted: #777;
            
            /* Rarity colors */
            --common: #9d9d9d;
            --magic: #5555ff;
            --rare: #ffcc00;
            --legendary: #ff8000;
            --unique: #00ff80;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Segoe UI', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            background-image: 
                radial-gradient(ellipse at top, rgba(233,69,96,0.1) 0%, transparent 50%),
                radial-gradient(ellipse at bottom, rgba(78,204,163,0.05) 0%, transparent 50%);
        }

        #app { min-height: 100vh; }

        .container {
            max-width: 440px;
            width: 100%;
            margin: 0 auto;
            padding: 16px;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            padding-top: 8px;
        }

        h1 {
            font-size: 1.6rem;
            margin-bottom: 4px;
            background: linear-gradient(135deg, var(--accent), var(--gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle { color: var(--muted); font-size: 0.85rem; }

        /* Gold Display */
        .gold-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: linear-gradient(135deg, rgba(255,215,0,0.15), rgba(255,215,0,0.05));
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 20px;
            padding: 8px 20px;
            margin: 0 auto 16px;
            width: fit-content;
        }

        .gold-icon { font-size: 1.2rem; }
        .gold-amount { font-size: 1.1rem; font-weight: 700; color: var(--gold); }

        /* Weapon Card */
        .weapon-card {
            background: var(--card);
            border: 2px solid var(--card-border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }

        .weapon-card.common { border-color: var(--common); }
        .weapon-card.magic { border-color: var(--magic); box-shadow: 0 0 20px rgba(85,85,255,0.2); }
        .weapon-card.rare { border-color: var(--rare); box-shadow: 0 0 25px rgba(255,204,0,0.2); }
        .weapon-card.legendary { border-color: var(--legendary); box-shadow: 0 0 30px rgba(255,128,0,0.3); }
        .weapon-card.unique { border-color: var(--unique); box-shadow: 0 0 35px rgba(0,255,128,0.3); }

        .weapon-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .weapon-info { flex: 1; }

        .weapon-grade {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .weapon-grade.common { color: var(--common); }
        .weapon-grade.magic { color: var(--magic); }
        .weapon-grade.rare { color: var(--rare); }
        .weapon-grade.legendary { color: var(--legendary); }
        .weapon-grade.unique { color: var(--unique); }

        .weapon-name {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .weapon-type { color: var(--muted); font-size: 0.85rem; }

        .weapon-level {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 8px 14px;
            text-align: center;
        }

        .weapon-level-number {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .weapon-level-label { font-size: 0.7rem; color: var(--muted); }

        .weapon-icon-area {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
        }

        .weapon-icon {
            font-size: 72px;
            filter: drop-shadow(0 0 20px currentColor);
            transition: all 0.3s;
        }

        .weapon-icon.shake { animation: shake 0.5s ease-in-out; }
        .weapon-icon.glow-success { filter: drop-shadow(0 0 40px var(--success)); }
        .weapon-icon.glow-fail { filter: drop-shadow(0 0 40px var(--fail)); }

        @keyframes shake {
            0%, 100% { transform: translateX(0) rotate(0); }
            20% { transform: translateX(-10px) rotate(-5deg); }
            40% { transform: translateX(10px) rotate(5deg); }
            60% { transform: translateX(-10px) rotate(-5deg); }
            80% { transform: translateX(10px) rotate(5deg); }
        }

        /* Stats */
        .weapon-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .stat-item {
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-icon { font-size: 1.3rem; }
        .stat-info { flex: 1; }
        .stat-value { font-size: 1rem; font-weight: 600; }
        .stat-label { font-size: 0.7rem; color: var(--muted); }

        .stat-value.damage { color: #ff6b6b; }
        .stat-value.crit { color: var(--gold); }
        .stat-value.hp { color: var(--success); }
        .stat-value.special { color: var(--unique); }

        /* Mode Selection */
        .mode-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .mode-btn {
            padding: 20px 12px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .mode-btn:hover { transform: translateY(-2px); }

        .mode-btn.enhance {
            background: linear-gradient(135deg, #e94560, #ff8a80);
            color: white;
        }

        .mode-btn.battle {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .mode-btn.shop {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .mode-btn.inventory {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }

        .mode-icon { font-size: 1.8rem; }
        .mode-label { font-size: 0.85rem; }

        /* Enhance Panel */
        .enhance-panel {
            background: var(--card);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .enhance-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .enhance-row:last-child { border-bottom: none; }

        .enhance-label { color: var(--muted); }
        .enhance-value { font-weight: 600; }
        .enhance-value.danger { color: var(--fail); font-weight: 700; }
        .enhance-value.warning { color: #ff8800; }
        .enhance-value.safe { color: var(--success); }
        .enhance-value.gold { color: var(--gold); }

        /* Buttons */
        .btn-row { display: flex; gap: 10px; }

        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-enhance {
            background: linear-gradient(135deg, var(--accent), #ff8a80);
            color: white;
        }

        .btn-enhance:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(233, 69, 96, 0.4);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.08);
            color: var(--text);
            flex: 0 0 50px;
        }

        .btn-back {
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            font-size: 0.9rem;
            padding: 8px 0;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Protection Toggle */
        .protection-toggle {
            background: rgba(255,215,0,0.1);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 10px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .toggle-btn {
            padding: 6px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-btn.on {
            background: var(--gold);
            color: #000;
        }

        .toggle-btn.off {
            background: rgba(255,255,255,0.1);
            color: var(--muted);
        }

        /* Result Popup */
        .overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 99;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .overlay.show { opacity: 1; pointer-events: auto; }

        .result-popup {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: var(--card);
            border-radius: 20px;
            padding: 32px;
            text-align: center;
            z-index: 100;
            transition: transform 0.3s ease-out;
            min-width: 300px;
            max-width: 90%;
        }

        .result-popup.show { transform: translate(-50%, -50%) scale(1); }
        .result-popup.success { border: 2px solid var(--success); }
        .result-popup.fail { border: 2px solid var(--fail); }
        .result-popup.destroy { border: 2px solid var(--legendary); }

        .result-icon { font-size: 4rem; margin-bottom: 12px; }
        .result-text { font-size: 1.4rem; font-weight: 700; margin-bottom: 8px; }
        .result-detail { color: var(--muted); margin-bottom: 16px; font-size: 0.95rem; }

        .new-weapon-preview {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .new-weapon-title {
            font-size: 0.8rem;
            color: var(--muted);
            margin-bottom: 8px;
        }

        .new-weapon-name {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .result-btn {
            padding: 12px 32px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            background: var(--accent);
            color: white;
        }

        /* Battle Screen */
        .battle-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .battle-header {
            text-align: center;
            padding: 12px;
            background: var(--card);
            border-bottom: 1px solid var(--card-border);
        }

        .battle-title { font-size: 1.1rem; font-weight: 600; }
        .battle-round { color: var(--muted); font-size: 0.85rem; }

        .battle-arena {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 16px;
            gap: 16px;
        }

        .fighter {
            background: var(--card);
            border-radius: 14px;
            padding: 14px;
            border: 2px solid var(--card-border);
        }

        .fighter.me { border-color: var(--accent); }
        .fighter.enemy { border-color: #667eea; }

        .fighter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .fighter-name { font-weight: 600; font-size: 0.95rem; }
        .fighter-weapon { color: var(--muted); font-size: 0.8rem; }

        .hp-bar-container {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            height: 22px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .hp-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--success), #2ecc71);
            border-radius: 8px;
            transition: width 0.5s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            min-width: 50px;
        }

        .hp-bar.low { background: linear-gradient(90deg, var(--fail), #ff8a80); }

        .fighter-stats {
            display: flex;
            gap: 14px;
            font-size: 0.8rem;
            color: var(--muted);
        }

        .battle-log {
            background: var(--card);
            border-radius: 10px;
            padding: 12px;
            max-height: 140px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.8rem;
        }

        .log-entry:last-child { border-bottom: none; }
        .log-entry.crit { color: var(--gold); }
        .log-entry.damage { color: var(--fail); }
        .log-entry.heal { color: var(--success); }

        .battle-actions {
            padding: 14px 16px;
            background: var(--card);
            border-top: 1px solid var(--card-border);
        }

        .action-btns {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .action-btn {
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .action-btn.attack { background: var(--fail); color: white; }
        .action-btn.attack.counter { 
            background: linear-gradient(135deg, #ff8000, #ffd700);
            animation: pulse 0.5s infinite alternate;
        }
        .action-btn.defend { background: #3498db; color: white; }

        @keyframes pulse {
            from { transform: scale(1); box-shadow: 0 0 10px rgba(255,128,0,0.5); }
            to { transform: scale(1.02); box-shadow: 0 0 20px rgba(255,128,0,0.8); }
        }

        .fighter.defending { border-color: #3498db; background: rgba(52,152,219,0.1); }
        .fighter.counter-ready { border-color: var(--legendary); background: rgba(255,128,0,0.1); }

        /* Stats Panel in Main */
        .stats-summary {
            background: var(--card);
            border: 1px solid var(--card-border);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .summary-item span {
            display: block;
        }

        .summary-value { font-size: 1.1rem; font-weight: 600; }
        .summary-label { font-size: 0.7rem; color: var(--muted); }

        /* Confetti */
        .confetti {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        footer {
            text-align: center;
            padding: 16px;
            color: var(--muted);
            font-size: 0.75rem;
        }

        footer a { color: var(--accent); text-decoration: none; }
    </style>
</head>
<body>
    <div id="app"></div>
    <div class="overlay" id="overlay"></div>
    <div class="result-popup" id="resultPopup">
        <div class="result-icon" id="resultIcon">âœ¨</div>
        <div class="result-text" id="resultText">ê°•í™” ì„±ê³µ!</div>
        <div class="result-detail" id="resultDetail"></div>
        <div class="new-weapon-preview" id="newWeaponPreview" style="display:none;">
            <div class="new-weapon-title">ìƒˆë¡œìš´ ë¬´ê¸° íšë“!</div>
            <div class="new-weapon-name" id="newWeaponName"></div>
        </div>
        <button class="result-btn" id="resultBtn" onclick="closeResult()">í™•ì¸</button>
    </div>
    <canvas class="confetti" id="confetti"></canvas>

    <script>
        // ===== WEAPON DATABASE =====
        const WEAPON_TYPES = {
            sword: { name: 'ê²€', icon: 'ğŸ—¡ï¸', bonus: { damage: 1.0, crit: 1.0 } },
            axe: { name: 'ë„ë¼', icon: 'ğŸª“', bonus: { damage: 1.15, crit: 0.9 } },
            spear: { name: 'ì°½', icon: 'ğŸ”±', bonus: { damage: 0.95, crit: 1.1 } },
            hammer: { name: 'ë§ì¹˜', icon: 'ğŸ”¨', bonus: { damage: 1.2, crit: 0.85 } },
            dagger: { name: 'ë‹¨ê²€', icon: 'ğŸ”ª', bonus: { damage: 0.85, crit: 1.25 } },
            staff: { name: 'ì§€íŒ¡ì´', icon: 'ğŸª„', bonus: { damage: 0.9, crit: 1.0, special: true } },
            katana: { name: 'íƒœë„', icon: 'âš”ï¸', bonus: { damage: 1.05, crit: 1.15 } },
            scythe: { name: 'ë‚«', icon: 'ğŸŒ™', bonus: { damage: 1.1, crit: 1.05 } }
        };

        const GRADES = {
            common: { 
                name: 'ì¼ë°˜', 
                color: '#9d9d9d', 
                multiplier: 1.0,
                dropRate: 50,
                prefixes: ['ë‚¡ì€', 'í‰ë²”í•œ', 'ê¸°ë³¸', 'ë‹¨ìˆœí•œ']
            },
            magic: { 
                name: 'ê³ ê¸‰', 
                color: '#5555ff', 
                multiplier: 1.3,
                dropRate: 30,
                prefixes: ['ê°•í™”ëœ', 'ë§ˆë ¥ì˜', 'ë¹›ë‚˜ëŠ”', 'ì •êµí•œ']
            },
            rare: { 
                name: 'í¬ê·€', 
                color: '#ffcc00', 
                multiplier: 1.7,
                dropRate: 14,
                prefixes: ['ì •ì˜ˆ', 'ëª…ì¸ì˜', 'ê³ ëŒ€ì˜', 'ì¶•ë³µë°›ì€']
            },
            legendary: { 
                name: 'ì „ì„¤', 
                color: '#ff8000', 
                multiplier: 2.2,
                dropRate: 5,
                prefixes: ['ì „ì„¤ì˜', 'ì˜ì›…ì˜', 'ì‹ ì„±í•œ', 'ë¶ˆë©¸ì˜']
            },
            unique: { 
                name: 'ìœ ë‹ˆí¬', 
                color: '#00ff80', 
                multiplier: 3.0,
                dropRate: 1,
                prefixes: [''],
                names: {
                    sword: 'ì—‘ìŠ¤ì¹¼ë¦¬ë²„',
                    axe: 'ë ˆë¹„ì•„íƒ„',
                    spear: 'ê²Œì´ë³¼ê·¸',
                    hammer: 'ë¬ ë‹ˆë¥´',
                    dagger: 'ì•”í‘ê²€ ì•„ì¦ˆë¼ì—˜',
                    staff: 'í˜„ìì˜ ì§€íŒ¡ì´',
                    katana: 'ë¬´ë¼ë§ˆì‚¬',
                    scythe: 'ì£½ìŒì˜ ë‚«'
                }
            }
        };

        // ë” ìŠ¤ë¦´ìˆëŠ” í™•ë¥ ! í•˜ë½ ì—†ìŒ, íŒŒê´´ ì¼ì° ì‹œì‘
        const ENHANCE_RATES = {
            0: { success: 100, destroy: 0, cost: 100 },      // +0â†’+1: 100%
            1: { success: 95, destroy: 0, cost: 200 },       // +1â†’+2: 95%
            2: { success: 90, destroy: 0, cost: 400 },       // +2â†’+3: 90%
            3: { success: 80, destroy: 0, cost: 800 },       // +3â†’+4: 80%
            4: { success: 70, destroy: 0, cost: 1500 },      // +4â†’+5: 70%
            5: { success: 60, destroy: 0, cost: 3000 },      // +5â†’+6: 60%
            6: { success: 50, destroy: 0, cost: 5000 },      // +6â†’+7: 50%
            7: { success: 45, destroy: 10, cost: 8000 },     // +7â†’+8: 45% (íŒŒê´´ ì‹œì‘!)
            8: { success: 40, destroy: 15, cost: 12000 },    // +8â†’+9: 40%
            9: { success: 35, destroy: 20, cost: 20000 },    // +9â†’+10: 35%
            10: { success: 30, destroy: 30, cost: 35000 },   // +10â†’+11: 30% ğŸ”¥
            11: { success: 25, destroy: 35, cost: 50000 },   // +11â†’+12: 25%
            12: { success: 20, destroy: 40, cost: 80000 },   // +12â†’+13: 20%
            13: { success: 15, destroy: 50, cost: 120000 },  // +13â†’+14: 15% â˜ ï¸
            14: { success: 10, destroy: 55, cost: 200000 },  // +14â†’+15: 10%
            15: { success: 7, destroy: 60, cost: 350000 },   // +15â†’+16: 7% ğŸ’€
            16: { success: 5, destroy: 65, cost: 500000 },   // +16â†’+17: 5%
            17: { success: 3, destroy: 70, cost: 750000 },   // +17â†’+18: 3%
            18: { success: 2, destroy: 75, cost: 1000000 },  // +18â†’+19: 2%
            19: { success: 1, destroy: 80, cost: 1500000 },  // +19â†’+20: 1% ğŸ°
            20: { success: 1, destroy: 85, cost: 2000000 }   // MAX
        };

        // ===== GAME STATE =====
        let state = {
            gold: 10000,
            weapon: null,
            protectionScrolls: 3,
            useProtection: false,
            stats: { attempts: 0, successes: 0, fails: 0, destroys: 0, wins: 0, losses: 0 }
        };

        let mpUI = null;
        let battleState = null;

        // ===== WEAPON GENERATION =====
        function generateWeapon(forceGrade = null) {
            // Pick grade
            let grade;
            if (forceGrade) {
                grade = forceGrade;
            } else {
                const roll = Math.random() * 100;
                let cumulative = 0;
                for (const [g, data] of Object.entries(GRADES)) {
                    cumulative += data.dropRate;
                    if (roll < cumulative) {
                        grade = g;
                        break;
                    }
                }
            }

            // Pick type
            const types = Object.keys(WEAPON_TYPES);
            const type = types[Math.floor(Math.random() * types.length)];
            const typeData = WEAPON_TYPES[type];
            const gradeData = GRADES[grade];

            // Generate name
            let name;
            if (grade === 'unique' && gradeData.names[type]) {
                name = gradeData.names[type];
            } else {
                const prefix = gradeData.prefixes[Math.floor(Math.random() * gradeData.prefixes.length)];
                name = prefix ? `${prefix} ${typeData.name}` : typeData.name;
            }

            return {
                type,
                grade,
                name,
                level: 0,
                icon: typeData.icon
            };
        }

        function getWeaponStats(weapon) {
            if (!weapon) return { damageMin: 0, damageMax: 0, critChance: 0, critDamage: 150, hp: 100 };

            const typeData = WEAPON_TYPES[weapon.type];
            const gradeData = GRADES[weapon.grade];
            const mult = gradeData.multiplier;
            const level = weapon.level;

            const baseDmgMin = 10;
            const baseDmgMax = 15;
            const dmgPerLevel = 5;

            const damageMin = Math.floor((baseDmgMin + level * dmgPerLevel) * mult * typeData.bonus.damage);
            const damageMax = Math.floor((baseDmgMax + level * dmgPerLevel) * mult * typeData.bonus.damage);
            const critChance = Math.min(60, Math.floor((5 + level * 2) * typeData.bonus.crit));
            const critDamage = 150 + level * 5;
            const hp = Math.floor((100 + level * 20) * mult);

            return { damageMin, damageMax, critChance, critDamage, hp };
        }

        function getWeaponValue(weapon) {
            if (!weapon) return 0;
            const gradeData = GRADES[weapon.grade];
            const baseValue = gradeData.multiplier * 1000;
            let levelBonus = 0;
            for (let i = 0; i < weapon.level; i++) {
                levelBonus += ENHANCE_RATES[i].cost;
            }
            return Math.floor(baseValue + levelBonus * 0.5);
        }

        // ===== STORAGE =====
        function loadState() {
            const saved = localStorage.getItem('enhance_game_v3');
            if (saved) {
                const parsed = JSON.parse(saved);
                state = { ...state, ...parsed };
            }
            if (!state.weapon) {
                state.weapon = generateWeapon('common');
            }
        }

        function saveState() {
            localStorage.setItem('enhance_game_v3', JSON.stringify(state));
        }

        // ===== MAIN SCREEN =====
        function showMain() {
            const weapon = state.weapon;
            const stats = getWeaponStats(weapon);
            const gradeData = GRADES[weapon.grade];

            document.getElementById('app').innerHTML = `
                <div class="container">
                    <header>
                        <h1>âš”ï¸ ë¬´ê¸° ê°•í™” & ë°°í‹€</h1>
                        <p class="subtitle">ê°•í™”í•˜ê³  ì‹¸ì›Œì„œ ëˆì„ ë²Œì–´ë¼!</p>
                    </header>

                    <div class="gold-display">
                        <span class="gold-icon">ğŸ’°</span>
                        <span class="gold-amount">${state.gold.toLocaleString()} G</span>
                    </div>

                    <div class="weapon-card ${weapon.grade}">
                        <div class="weapon-header">
                            <div class="weapon-info">
                                <div class="weapon-grade ${weapon.grade}">${gradeData.name}</div>
                                <div class="weapon-name">${weapon.name}</div>
                                <div class="weapon-type">${WEAPON_TYPES[weapon.type].name}</div>
                            </div>
                            <div class="weapon-level">
                                <div class="weapon-level-number">+${weapon.level}</div>
                                <div class="weapon-level-label">ê°•í™”</div>
                            </div>
                        </div>

                        <div class="weapon-icon-area">
                            <div class="weapon-icon" style="color: ${gradeData.color}">${weapon.icon}</div>
                        </div>

                        <div class="weapon-stats">
                            <div class="stat-item">
                                <span class="stat-icon">âš”ï¸</span>
                                <div class="stat-info">
                                    <div class="stat-value damage">${stats.damageMin}-${stats.damageMax}</div>
                                    <div class="stat-label">ê³µê²©ë ¥</div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <span class="stat-icon">ğŸ’¥</span>
                                <div class="stat-info">
                                    <div class="stat-value crit">${stats.critChance}%</div>
                                    <div class="stat-label">í¬ë¦¬í‹°ì»¬</div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <span class="stat-icon">â¤ï¸</span>
                                <div class="stat-info">
                                    <div class="stat-value hp">${stats.hp}</div>
                                    <div class="stat-label">ì²´ë ¥</div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <span class="stat-icon">ğŸ’</span>
                                <div class="stat-info">
                                    <div class="stat-value special">${getWeaponValue(weapon).toLocaleString()}</div>
                                    <div class="stat-label">ê°€ì¹˜</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mode-grid">
                        <button class="mode-btn enhance" onclick="showEnhance()">
                            <span class="mode-icon">ğŸ”¨</span>
                            <span class="mode-label">ê°•í™”</span>
                        </button>
                        <button class="mode-btn battle" onclick="showBattleLobby()">
                            <span class="mode-icon">âš”ï¸</span>
                            <span class="mode-label">ë°°í‹€</span>
                        </button>
                    </div>

                    <div class="stats-summary">
                        <div class="summary-item">
                            <span class="summary-value">${state.stats.attempts}</span>
                            <span class="summary-label">ì‹œë„</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-value" style="color:var(--success)">${state.stats.successes}</span>
                            <span class="summary-label">ì„±ê³µ</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-value" style="color:var(--fail)">${state.stats.fails}</span>
                            <span class="summary-label">ì‹¤íŒ¨</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-value">${state.stats.wins}ìŠ¹ ${state.stats.losses}íŒ¨</span>
                            <span class="summary-label">ì „ì </span>
                        </div>
                    </div>

                    <footer>
                        Â© 2026 <a href="https://game.cocy.io">game.cocy.io</a>
                    </footer>
                </div>
            `;
        }

        // ===== ENHANCE SCREEN =====
        function showEnhance() {
            const weapon = state.weapon;
            const stats = getWeaponStats(weapon);
            const gradeData = GRADES[weapon.grade];
            const rates = ENHANCE_RATES[Math.min(weapon.level, 20)];
            const canEnhance = state.gold >= rates.cost && weapon.level < 21;
            const showProtection = rates.destroy > 0;

            document.getElementById('app').innerHTML = `
                <div class="container">
                    <button class="btn-back" onclick="showMain()">â† ë©”ì¸ìœ¼ë¡œ</button>

                    <div class="gold-display">
                        <span class="gold-icon">ğŸ’°</span>
                        <span class="gold-amount">${state.gold.toLocaleString()} G</span>
                    </div>

                    <div class="weapon-card ${weapon.grade}">
                        <div class="weapon-header">
                            <div class="weapon-info">
                                <div class="weapon-grade ${weapon.grade}">${gradeData.name}</div>
                                <div class="weapon-name">${weapon.name}</div>
                            </div>
                            <div class="weapon-level">
                                <div class="weapon-level-number">+${weapon.level}</div>
                                <div class="weapon-level-label">ê°•í™”</div>
                            </div>
                        </div>

                        <div class="weapon-icon-area">
                            <div class="weapon-icon" id="weaponIcon" style="color: ${gradeData.color}">${weapon.icon}</div>
                        </div>

                        <div class="weapon-stats">
                            <div class="stat-item">
                                <span class="stat-icon">âš”ï¸</span>
                                <div class="stat-info">
                                    <div class="stat-value damage">${stats.damageMin}-${stats.damageMax}</div>
                                    <div class="stat-label">ê³µê²©ë ¥</div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <span class="stat-icon">ğŸ’¥</span>
                                <div class="stat-info">
                                    <div class="stat-value crit">${stats.critChance}%</div>
                                    <div class="stat-label">í¬ë¦¬í‹°ì»¬</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="enhance-panel">
                        <div class="enhance-row">
                            <span class="enhance-label">ğŸ¯ ì„±ê³µ</span>
                            <span class="enhance-value ${rates.success >= 50 ? 'safe' : rates.success >= 20 ? '' : 'danger'}">${rates.success}%</span>
                        </div>
                        <div class="enhance-row">
                            <span class="enhance-label">${rates.destroy >= 50 ? 'ğŸ’€' : rates.destroy > 0 ? 'âš ï¸' : 'âœ…'} íŒŒê´´</span>
                            <span class="enhance-value ${rates.destroy >= 50 ? 'danger' : rates.destroy > 0 ? 'warning' : 'safe'}">${rates.destroy > 0 ? rates.destroy + '%' : 'ì—†ìŒ'}</span>
                        </div>
                        <div class="enhance-row">
                            <span class="enhance-label">ğŸ’° ë¹„ìš©</span>
                            <span class="enhance-value gold">${rates.cost.toLocaleString()} G</span>
                        </div>
                    </div>

                    ${showProtection ? `
                    <div class="protection-toggle">
                        <span>ğŸ›¡ï¸ íŒŒê´´ ë°©ì§€ (${state.protectionScrolls}ê°œ)</span>
                        <button class="toggle-btn ${state.useProtection ? 'on' : 'off'}" onclick="toggleProtection()" id="protectionBtn">
                            ${state.useProtection ? 'ON' : 'OFF'}
                        </button>
                    </div>
                    ` : ''}

                    <div class="btn-row">
                        <button class="btn btn-secondary" onclick="sellWeapon()">ğŸ’° íŒë§¤</button>
                        <button class="btn btn-enhance" onclick="enhance()" ${!canEnhance ? 'disabled' : ''}>
                            ${weapon.level >= 21 ? 'ğŸ† MAX' : `âš¡ ê°•í™” (${rates.cost.toLocaleString()}G)`}
                        </button>
                    </div>
                </div>
            `;
        }

        function toggleProtection() {
            if (state.protectionScrolls > 0) {
                state.useProtection = !state.useProtection;
                const btn = document.getElementById('protectionBtn');
                btn.textContent = state.useProtection ? 'ON' : 'OFF';
                btn.className = 'toggle-btn ' + (state.useProtection ? 'on' : 'off');
            }
        }

        function enhance() {
            const weapon = state.weapon;
            if (weapon.level >= 21) return;

            const rates = ENHANCE_RATES[weapon.level];
            if (state.gold < rates.cost) return;

            state.gold -= rates.cost;
            state.stats.attempts++;

            const weaponIcon = document.getElementById('weaponIcon');
            weaponIcon.classList.add('shake');
            setTimeout(() => weaponIcon.classList.remove('shake'), 500);

            const roll = Math.random() * 100;
            const fromLevel = weapon.level;
            let toLevel = fromLevel;
            let result = 'fail';
            let newWeapon = null;

            if (roll < rates.success) {
                // Success! ğŸ‰
                toLevel = fromLevel + 1;
                result = 'success';
                state.stats.successes++;
                weaponIcon.classList.add('glow-success');
                setTimeout(() => weaponIcon.classList.remove('glow-success'), 1000);
            } else if (rates.destroy > 0 && roll < rates.success + rates.destroy) {
                // Destroy! ğŸ’¥
                result = 'destroy';
                state.stats.destroys++;
                
                if (state.useProtection && state.protectionScrolls > 0) {
                    state.protectionScrolls--;
                    state.useProtection = false;
                    toLevel = fromLevel;
                } else {
                    // Generate new weapon (different from current)
                    newWeapon = generateWeapon();
                    while (newWeapon.type === weapon.type && newWeapon.grade === weapon.grade) {
                        newWeapon = generateWeapon();
                    }
                }
                
                weaponIcon.classList.add('glow-fail');
                setTimeout(() => weaponIcon.classList.remove('glow-fail'), 1000);
            } else {
                // Fail - just stays the same (no downgrade!)
                result = 'fail';
                state.stats.fails++;
                weaponIcon.classList.add('glow-fail');
                setTimeout(() => weaponIcon.classList.remove('glow-fail'), 1000);
            }

            if (newWeapon) {
                state.weapon = newWeapon;
            } else {
                state.weapon.level = toLevel;
            }
            
            saveState();

            setTimeout(() => {
                showEnhanceResult(result, fromLevel, state.weapon.level, newWeapon);
            }, 300);
        }

        function showEnhanceResult(type, from, to, newWeapon) {
            const popup = document.getElementById('resultPopup');
            const overlay = document.getElementById('overlay');
            const newWeaponPreview = document.getElementById('newWeaponPreview');

            let popupClass = 'result-popup';
            let icon = 'âœ¨';
            let text = '';
            let detail = '';
            let textColor = 'var(--text)';

            if (type === 'success') {
                popupClass += ' success';
                icon = 'âœ¨';
                text = 'ê°•í™” ì„±ê³µ!';
                detail = `+${from} â†’ +${to}`;
                textColor = 'var(--success)';
            } else if (type === 'destroy') {
                if (newWeapon) {
                    popupClass += ' destroy';
                    icon = 'ğŸ’¥';
                    text = 'ë¬´ê¸° íŒŒê´´!';
                    detail = 'ìƒˆë¡œìš´ ë¬´ê¸°ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤';
                    textColor = 'var(--legendary)';
                    
                    newWeaponPreview.style.display = 'block';
                    const gradeData = GRADES[newWeapon.grade];
                    document.getElementById('newWeaponName').innerHTML = 
                        `<span style="color:${gradeData.color}">[${gradeData.name}] ${newWeapon.name}</span>`;
                } else {
                    popupClass += ' success';
                    icon = 'ğŸ›¡ï¸';
                    text = 'íŒŒê´´ ë°©ì§€!';
                    detail = 'ë³´í˜¸ ì£¼ë¬¸ì„œê°€ ë¬´ê¸°ë¥¼ ì§€ì¼°ìŠµë‹ˆë‹¤';
                    textColor = 'var(--gold)';
                }
            } else {
                // Fail - level stays same
                popupClass += ' fail';
                icon = 'ğŸ˜¢';
                text = 'ê°•í™” ì‹¤íŒ¨...';
                detail = 'ë‹¤ìŒì—” ì„±ê³µí• ê±°ì•¼!';
                textColor = 'var(--fail)';
            }

            popup.className = popupClass + ' show';
            document.getElementById('resultIcon').textContent = icon;
            document.getElementById('resultText').textContent = text;
            document.getElementById('resultText').style.color = textColor;
            document.getElementById('resultDetail').textContent = detail;
            document.getElementById('resultBtn').onclick = () => { closeResult(); showEnhance(); };

            if (!newWeapon) {
                newWeaponPreview.style.display = 'none';
            }

            overlay.classList.add('show');

            // Confetti for big milestones
            if (type === 'success' && (to >= 10 || to === 7)) fireConfetti();
        }

        function closeResult() {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('resultPopup').classList.remove('show');
        }

        function sellWeapon() {
            const value = getWeaponValue(state.weapon);
            if (confirm(`${state.weapon.name}ì„(ë¥¼) ${value.toLocaleString()}Gì— íŒë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nìƒˆë¡œìš´ ë¬´ê¸°ë¥¼ ë°›ê²Œ ë©ë‹ˆë‹¤.`)) {
                state.gold += value;
                state.weapon = generateWeapon();
                saveState();
                showEnhance();
            }
        }

        // ===== BATTLE MODE =====
        function showBattleLobby() {
            mpUI = new MultiplayerUI({
                gameType: 'enhance',
                gameName: 'âš”ï¸ ë¬´ê¸° ë°°í‹€',
                container: document.getElementById('app'),
                maxPlayers: 2,
                supportsLocal: false,
                onGameStart: handleBattleStart,
                onGameEvent: handleBattleEvent,
                onLeave: () => { battleState = null; showMain(); },
                getPlayerData: () => ({
                    weapon: state.weapon,
                    gold: state.gold
                })
            });

            const roomCode = MultiplayerUI.checkUrlRoom();
            if (roomCode) {
                mpUI._renderLobby();
                setTimeout(() => {
                    document.getElementById('mp-room-code').value = roomCode;
                }, 100);
            } else {
                mpUI.show();
            }
        }

        function handleBattleStart(gameState) {
            battleState = gameState;
            renderBattle();
        }

        function handleBattleEvent(type, data) {
            if (type === 'state_update') {
                battleState = data;
                renderBattle();
            } else if (type === 'game_end') {
                showBattleResult(data);
            }
        }

        function renderBattle() {
            if (!battleState || !battleState.gameState) return;

            const gs = battleState.gameState;
            const myId = mpUI.getClient().getMyUserId();
            const me = gs.players.find(p => p.id === myId);
            const enemy = gs.players.find(p => p.id !== myId);
            const isMyTurn = gs.currentTurn === myId;

            const myGrade = me?.weaponGrade ? GRADES[me.weaponGrade] : GRADES.common;
            const enemyGrade = enemy?.weaponGrade ? GRADES[enemy.weaponGrade] : GRADES.common;

            // Status badges
            const enemyStatus = enemy?.isDefending ? 'ğŸ›¡ï¸ ë°©ì–´ì¤‘' : (enemy?.counterReady ? 'âš¡ ì¹´ìš´í„° ì¤€ë¹„' : '');
            const myStatus = me?.isDefending ? 'ğŸ›¡ï¸ ë°©ì–´ì¤‘' : (me?.counterReady ? 'âš¡ ì¹´ìš´í„° ì¤€ë¹„!' : '');

            document.getElementById('app').innerHTML = `
                <div class="battle-screen">
                    <div class="battle-header">
                        <div class="battle-title">âš”ï¸ ë¬´ê¸° ë°°í‹€!</div>
                        <div class="battle-round">ë¼ìš´ë“œ ${gs.round || 1} | ${isMyTurn ? 'ë‚´ í„´' : 'ìƒëŒ€ í„´'} | ğŸ’° ${(gs.totalPrize || 0).toLocaleString()}G</div>
                    </div>

                    <div class="battle-arena">
                        <div class="fighter enemy ${enemy?.isDefending ? 'defending' : ''}">
                            <div class="fighter-header">
                                <span class="fighter-name">ğŸ‘¤ ${enemy?.nickname || 'ìƒëŒ€'} ${enemyStatus}</span>
                                <span class="fighter-weapon" style="color:${enemyGrade.color}">
                                    [${enemyGrade.name}] +${enemy?.weaponLevel || 0} ${enemy?.weaponIcon || 'ğŸ—¡ï¸'}
                                </span>
                            </div>
                            <div class="hp-bar-container">
                                <div class="hp-bar ${(enemy?.hp || 0) < 30 ? 'low' : ''}" 
                                     style="width: ${((enemy?.hp || 0) / (enemy?.maxHp || 100)) * 100}%">
                                    ${enemy?.hp || 0} / ${enemy?.maxHp || 100}
                                </div>
                            </div>
                            <div class="fighter-stats">
                                <span>âš”ï¸ ${enemy?.damageMin || 0}-${enemy?.damageMax || 0}</span>
                                <span>ğŸ’¥ ${enemy?.critChance || 0}%</span>
                            </div>
                        </div>

                        <div class="fighter me ${me?.isDefending ? 'defending' : ''} ${me?.counterReady ? 'counter-ready' : ''}">
                            <div class="fighter-header">
                                <span class="fighter-name">ğŸ® ${me?.nickname || 'ë‚˜'} ${myStatus}</span>
                                <span class="fighter-weapon" style="color:${myGrade.color}">
                                    [${myGrade.name}] +${me?.weaponLevel || 0} ${me?.weaponIcon || 'ğŸ—¡ï¸'}
                                </span>
                            </div>
                            <div class="hp-bar-container">
                                <div class="hp-bar ${(me?.hp || 0) < 30 ? 'low' : ''}" 
                                     style="width: ${((me?.hp || 0) / (me?.maxHp || 100)) * 100}%">
                                    ${me?.hp || 0} / ${me?.maxHp || 100}
                                </div>
                            </div>
                            <div class="fighter-stats">
                                <span>âš”ï¸ ${me?.damageMin || 0}-${me?.damageMax || 0}</span>
                                <span>ğŸ’¥ ${me?.critChance || 0}%</span>
                            </div>
                        </div>

                        <div class="battle-log" id="battleLog">
                            ${(gs.log || []).slice(-6).map(entry => `
                                <div class="log-entry ${entry.type || ''}">${entry.text}</div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="battle-actions">
                        <div class="action-btns">
                            <button class="action-btn attack ${me?.counterReady ? 'counter' : ''}" onclick="battleAction('attack')" ${!isMyTurn ? 'disabled' : ''}>
                                ${me?.counterReady ? 'âš¡ ì¹´ìš´í„°!' : 'âš”ï¸ ê³µê²©'}
                            </button>
                            <button class="action-btn defend" onclick="battleAction('defend')" ${!isMyTurn ? 'disabled' : ''}>
                                ğŸ›¡ï¸ ë°©ì–´
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function battleAction(action) {
            if (!mpUI || !mpUI.getClient()) return;
            try {
                await mpUI.sendAction({ type: action });
            } catch (e) {
                console.error('Battle action error:', e);
            }
        }

        function showBattleResult(data) {
            const myId = mpUI.getClient().getMyUserId();
            const isWin = data.winnerId === myId;
            const prizeGold = data.prizeGold || 0;

            if (isWin) {
                state.gold += prizeGold;
                state.stats.wins++;
            } else {
                state.stats.losses++;
            }
            saveState();

            const detail = isWin 
                ? `ğŸ’° ${prizeGold.toLocaleString()}G íšë“!`
                : `ìƒëŒ€ì—ê²Œ ${prizeGold.toLocaleString()}Gë¥¼ ë¹¼ì•—ê²¼ìŠµë‹ˆë‹¤`;

            mpUI.showResult({
                title: isWin ? 'ğŸ† ìŠ¹ë¦¬!' : 'ğŸ’€ íŒ¨ë°°...',
                detail: detail,
                isWin: isWin,
                showRematch: true
            });

            if (isWin) fireConfetti();
        }

        // ===== CONFETTI =====
        function fireConfetti() {
            const canvas = document.getElementById('confetti');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const pieces = [];
            const colors = ['#e94560', '#ffd700', '#4ecca3', '#00d9ff', '#ff6b6b', '#ff8000', '#00ff80'];

            for (let i = 0; i < 100; i++) {
                pieces.push({
                    x: canvas.width / 2,
                    y: canvas.height / 2,
                    vx: (Math.random() - 0.5) * 20,
                    vy: (Math.random() - 0.5) * 20 - 10,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    size: Math.random() * 8 + 4,
                    rotation: Math.random() * 360
                });
            }

            let frame = 0;
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                pieces.forEach(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.5;
                    p.rotation += 5;
                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.rotation * Math.PI / 180);
                    ctx.fillStyle = p.color;
                    ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
                    ctx.restore();
                });
                frame++;
                if (frame < 100) requestAnimationFrame(animate);
                else ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            animate();
        }

        // ===== INIT =====
        loadState();
        showMain();
    </script>
</body>
</html>
