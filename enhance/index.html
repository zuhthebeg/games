<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Î¨¥Í∏∞ Í∞ïÌôî & Î∞∞ÌãÄ</title>
    <link rel="icon" href="icon.svg">
    <script src="/lib/multiplayer.js?v=20260210v8"></script>
    <script src="/lib/multiplayer-ui.js?v=20260210v8"></script>
    <style>
        :root {
            --bg: #0d0d0d;
            --card: #1a1a1a;
            --card-border: #2a2a2a;
            --accent: #e94560;
            --success: #4ecca3;
            --fail: #ff6b6b;
            --gold: #ffd700;
            --text: #eee;
            --muted: #777;
            
            /* Rarity colors */
            --common: #9d9d9d;
            --magic: #5555ff;
            --rare: #ffcc00;
            --legendary: #ff8000;
            --unique: #00ff80;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Segoe UI', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            background-image: 
                radial-gradient(ellipse at top, rgba(233,69,96,0.1) 0%, transparent 50%),
                radial-gradient(ellipse at bottom, rgba(78,204,163,0.05) 0%, transparent 50%);
        }

        #app { min-height: 100vh; }

        .container {
            max-width: 440px;
            width: 100%;
            margin: 0 auto;
            padding: 16px;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            padding-top: 8px;
        }

        h1 {
            font-size: 1.6rem;
            margin-bottom: 4px;
            background: linear-gradient(135deg, var(--accent), var(--gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle { color: var(--muted); font-size: 0.85rem; }

        /* Gold Display */
        .gold-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: linear-gradient(135deg, rgba(255,215,0,0.15), rgba(255,215,0,0.05));
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 20px;
            padding: 8px 20px;
            margin: 0 auto 16px;
            width: fit-content;
        }

        .gold-icon { font-size: 1.2rem; }
        .gold-amount { font-size: 1.1rem; font-weight: 700; color: var(--gold); }

        /* Weapon Card */
        .weapon-card {
            background: var(--card);
            border: 2px solid var(--card-border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }

        .weapon-card.common { border-color: var(--common); }
        .weapon-card.magic { border-color: var(--magic); box-shadow: 0 0 20px rgba(85,85,255,0.2); }
        .weapon-card.rare { border-color: var(--rare); box-shadow: 0 0 25px rgba(255,204,0,0.2); }
        .weapon-card.legendary { border-color: var(--legendary); box-shadow: 0 0 30px rgba(255,128,0,0.3); }
        .weapon-card.unique { border-color: var(--unique); box-shadow: 0 0 35px rgba(0,255,128,0.3); }

        .weapon-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .weapon-info { flex: 1; }

        .weapon-grade {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .weapon-grade.common { color: var(--common); }
        .weapon-grade.magic { color: var(--magic); }
        .weapon-grade.rare { color: var(--rare); }
        .weapon-grade.legendary { color: var(--legendary); }
        .weapon-grade.unique { color: var(--unique); }

        .weapon-name {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .weapon-type { color: var(--muted); font-size: 0.85rem; }

        .weapon-level {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 8px 14px;
            text-align: center;
        }

        .weapon-level-number {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .weapon-level-label { font-size: 0.7rem; color: var(--muted); }

        .weapon-icon-area {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
        }

        .weapon-icon {
            width: 80px;
            height: 80px;
            filter: drop-shadow(0 0 15px currentColor);
            transition: all 0.3s;
        }

        .weapon-icon.shake { animation: shake 0.5s ease-in-out; }
        .weapon-icon.glow-success { filter: drop-shadow(0 0 30px var(--success)) drop-shadow(0 0 60px var(--success)) brightness(1.3); }
        .weapon-icon.glow-fail { filter: drop-shadow(0 0 30px var(--fail)) drop-shadow(0 0 60px var(--fail)) brightness(0.8); }
        .weapon-icon.hit { animation: hitEffect 0.3s ease-out; }
        
        @keyframes hitEffect {
            0% { transform: scale(1) rotate(0); }
            25% { transform: scale(1.2) rotate(-10deg); }
            50% { transform: scale(0.9) rotate(5deg); }
            100% { transform: scale(1) rotate(0); }
        }
        
        /* Screen shake for attacks */
        .screen-shake { animation: screenShake 0.3s ease-out; }
        @keyframes screenShake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-5px); }
            40% { transform: translateX(5px); }
            60% { transform: translateX(-3px); }
            80% { transform: translateX(3px); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0) rotate(0); }
            20% { transform: translateX(-10px) rotate(-5deg); }
            40% { transform: translateX(10px) rotate(5deg); }
            60% { transform: translateX(-10px) rotate(-5deg); }
            80% { transform: translateX(10px) rotate(5deg); }
        }

        /* Stats */
        .weapon-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .stat-item {
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-icon { font-size: 1.3rem; }
        .stat-info { flex: 1; }
        .stat-value { font-size: 1rem; font-weight: 600; }
        .stat-label { font-size: 0.7rem; color: var(--muted); }

        .stat-value.damage { color: #ff6b6b; }
        .stat-value.crit { color: var(--gold); }
        .stat-value.hp { color: var(--success); }
        .stat-value.special { color: var(--unique); }

        /* Mode Selection */
        .mode-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .mode-btn {
            padding: 20px 12px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .mode-btn:hover { transform: translateY(-2px); }

        .mode-btn.enhance {
            background: linear-gradient(135deg, #e94560, #ff8a80);
            color: white;
        }

        .mode-btn.battle {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .mode-btn.hunt {
            background: linear-gradient(135deg, #e67e22, #d35400);
            color: white;
        }

        /* Hunt Mode Styles */
        .hunt-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .monster-card {
            background: var(--card);
            border: 2px solid var(--card-border);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            margin-bottom: 16px;
        }

        .monster-card.boss {
            border-color: #ff4444;
            box-shadow: 0 0 30px rgba(255,68,68,0.3);
            animation: bossGlow 2s ease-in-out infinite alternate;
        }

        @keyframes bossGlow {
            from { box-shadow: 0 0 20px rgba(255,68,68,0.3); }
            to { box-shadow: 0 0 40px rgba(255,68,68,0.5); }
        }

        .monster-img {
            width: 100px;
            height: 100px;
            margin: 16px auto;
            filter: drop-shadow(0 0 10px #ff6b6b);
        }

        .monster-name {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .monster-name.boss {
            color: #ff4444;
            text-shadow: 0 0 10px rgba(255,68,68,0.5);
        }

        .monster-tier {
            font-size: 0.8rem;
            color: var(--muted);
            margin-bottom: 12px;
        }

        .hunt-vs {
            font-size: 2rem;
            text-align: center;
            margin: 12px 0;
            color: var(--accent);
        }

        .player-mini {
            background: var(--card);
            border: 2px solid var(--accent);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .hunt-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .hunt-actions .btn {
            flex: 1;
        }

        .reward-popup {
            background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,215,0,0.05));
            border: 2px solid var(--gold);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            margin: 16px 0;
        }

        .reward-gold {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gold);
        }

        .mode-btn.shop {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .mode-btn.inventory {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }

        .mode-icon { font-size: 1.8rem; }
        .mode-label { font-size: 0.85rem; }

        /* Enhance Panel */
        .enhance-panel {
            background: var(--card);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .enhance-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .enhance-row:last-child { border-bottom: none; }

        .enhance-label { color: var(--muted); }
        .enhance-value { font-weight: 600; }
        .enhance-value.danger { color: var(--fail); font-weight: 700; }
        .enhance-value.warning { color: #ff8800; }
        .enhance-value.safe { color: var(--success); }
        .enhance-value.gold { color: var(--gold); }

        /* Buttons */
        .btn-row { display: flex; gap: 10px; }

        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-enhance {
            background: linear-gradient(135deg, var(--accent), #ff8a80);
            color: white;
        }

        .btn-enhance:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(233, 69, 96, 0.4);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.08);
            color: var(--text);
            flex: 0 0 50px;
        }

        .btn-back {
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            font-size: 0.9rem;
            padding: 8px 0;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Protection Toggle */
        .protection-toggle {
            background: rgba(255,215,0,0.1);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 10px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .toggle-btn {
            padding: 6px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-btn.on {
            background: var(--gold);
            color: #000;
        }

        .toggle-btn.off {
            background: rgba(255,255,255,0.1);
            color: var(--muted);
        }

        /* Result Popup */
        .overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 99;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .overlay.show { opacity: 1; pointer-events: auto; }

        .result-popup {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: var(--card);
            border-radius: 20px;
            padding: 32px;
            text-align: center;
            z-index: 100;
            transition: transform 0.3s ease-out;
            min-width: 300px;
            max-width: 90%;
        }

        .result-popup.show { transform: translate(-50%, -50%) scale(1); }
        .result-popup.success { border: 2px solid var(--success); }
        .result-popup.fail { border: 2px solid var(--fail); }
        .result-popup.destroy { border: 2px solid var(--legendary); }

        .result-icon { font-size: 4rem; margin-bottom: 12px; }
        .result-text { font-size: 1.4rem; font-weight: 700; margin-bottom: 8px; }
        .result-detail { color: var(--muted); margin-bottom: 16px; font-size: 0.95rem; }

        .new-weapon-preview {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .new-weapon-title {
            font-size: 0.8rem;
            color: var(--muted);
            margin-bottom: 8px;
        }

        .new-weapon-name {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .result-btn {
            padding: 12px 32px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            background: var(--accent);
            color: white;
        }

        /* Battle Screen */
        .battle-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .battle-header {
            text-align: center;
            padding: 12px;
            background: var(--card);
            border-bottom: 1px solid var(--card-border);
        }

        .battle-title { font-size: 1.1rem; font-weight: 600; }
        .battle-round { color: var(--muted); font-size: 0.85rem; }

        .battle-arena {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 16px;
            gap: 16px;
        }

        .fighter {
            background: var(--card);
            border-radius: 14px;
            padding: 14px;
            border: 2px solid var(--card-border);
        }

        .fighter.me { border-color: var(--accent); }
        .fighter.enemy { border-color: #667eea; }

        .fighter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .fighter-name { font-weight: 600; font-size: 0.95rem; }
        .fighter-weapon { color: var(--muted); font-size: 0.8rem; }

        .hp-bar-container {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            height: 22px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .hp-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--success), #2ecc71);
            border-radius: 8px;
            transition: width 0.5s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            min-width: 50px;
        }

        .hp-bar.low { background: linear-gradient(90deg, var(--fail), #ff8a80); }

        .fighter-stats {
            display: flex;
            gap: 14px;
            font-size: 0.8rem;
            color: var(--muted);
        }

        .battle-log {
            background: var(--card);
            border-radius: 10px;
            padding: 12px;
            max-height: 140px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.8rem;
        }

        .log-entry:last-child { border-bottom: none; }
        .log-entry.crit { color: var(--gold); }
        .log-entry.damage { color: var(--fail); }
        .log-entry.heal { color: var(--success); }

        .battle-actions {
            padding: 14px 16px;
            background: var(--card);
            border-top: 1px solid var(--card-border);
        }

        .action-btns {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .action-btn {
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .action-btn.attack { background: var(--fail); color: white; }
        .action-btn.attack.counter { 
            background: linear-gradient(135deg, #ff8000, #ffd700);
            animation: pulse 0.5s infinite alternate;
        }
        .action-btn.defend { background: #3498db; color: white; }

        @keyframes pulse {
            from { transform: scale(1); box-shadow: 0 0 10px rgba(255,128,0,0.5); }
            to { transform: scale(1.02); box-shadow: 0 0 20px rgba(255,128,0,0.8); }
        }

        .fighter.defending { border-color: #3498db; background: rgba(52,152,219,0.1); }
        .fighter.counter-ready { border-color: var(--legendary); background: rgba(255,128,0,0.1); }

        /* Stats Panel in Main */
        .stats-summary {
            background: var(--card);
            border: 1px solid var(--card-border);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .summary-item span {
            display: block;
        }

        .summary-value { font-size: 1.1rem; font-weight: 600; }
        .summary-label { font-size: 0.7rem; color: var(--muted); }

        /* Confetti */
        .confetti {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        footer {
            text-align: center;
            padding: 16px;
            color: var(--muted);
            font-size: 0.75rem;
        }

        footer a { color: var(--accent); text-decoration: none; }
    </style>
</head>
<body>
    <div id="app"></div>
    <div class="overlay" id="overlay"></div>
    <div class="result-popup" id="resultPopup">
        <div class="result-icon" id="resultIcon">‚ú®</div>
        <div class="result-text" id="resultText">Í∞ïÌôî ÏÑ±Í≥µ!</div>
        <div class="result-detail" id="resultDetail"></div>
        <div class="new-weapon-preview" id="newWeaponPreview" style="display:none;">
            <div class="new-weapon-title">ÏÉàÎ°úÏö¥ Î¨¥Í∏∞ ÌöçÎìù!</div>
            <div class="new-weapon-name" id="newWeaponName"></div>
        </div>
        <button class="result-btn" id="resultBtn" onclick="closeResult()">ÌôïÏù∏</button>
    </div>
    <canvas class="confetti" id="confetti"></canvas>

    <script>
        // ===== SOUND EFFECTS (Web Audio API) =====
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;
        
        function ensureAudio() {
            if (!audioCtx) audioCtx = new AudioCtx();
            return audioCtx;
        }
        
        function playSound(type) {
            try {
                const ctx = ensureAudio();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                switch(type) {
                    case 'enhance':
                        osc.frequency.setValueAtTime(300, ctx.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(600, ctx.currentTime + 0.1);
                        gain.gain.setValueAtTime(0.3, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                        osc.start(); osc.stop(ctx.currentTime + 0.2);
                        break;
                    case 'success':
                        osc.frequency.setValueAtTime(523, ctx.currentTime); // C5
                        osc.frequency.setValueAtTime(659, ctx.currentTime + 0.1); // E5
                        osc.frequency.setValueAtTime(784, ctx.currentTime + 0.2); // G5
                        gain.gain.setValueAtTime(0.3, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
                        osc.start(); osc.stop(ctx.currentTime + 0.4);
                        break;
                    case 'fail':
                        osc.type = 'sawtooth';
                        osc.frequency.setValueAtTime(200, ctx.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 0.3);
                        gain.gain.setValueAtTime(0.2, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                        osc.start(); osc.stop(ctx.currentTime + 0.3);
                        break;
                    case 'destroy':
                        osc.type = 'sawtooth';
                        osc.frequency.setValueAtTime(150, ctx.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(50, ctx.currentTime + 0.5);
                        gain.gain.setValueAtTime(0.4, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                        osc.start(); osc.stop(ctx.currentTime + 0.5);
                        // Add explosion noise
                        const noise = ctx.createBufferSource();
                        const buffer = ctx.createBuffer(1, ctx.sampleRate * 0.3, ctx.sampleRate);
                        const data = buffer.getChannelData(0);
                        for (let i = 0; i < data.length; i++) data[i] = (Math.random() * 2 - 1) * Math.exp(-i / 3000);
                        noise.buffer = buffer;
                        const noiseGain = ctx.createGain();
                        noiseGain.gain.setValueAtTime(0.3, ctx.currentTime);
                        noiseGain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                        noise.connect(noiseGain);
                        noiseGain.connect(ctx.destination);
                        noise.start();
                        break;
                    case 'attack':
                        osc.type = 'sawtooth';
                        osc.frequency.setValueAtTime(150, ctx.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(80, ctx.currentTime + 0.15);
                        gain.gain.setValueAtTime(0.25, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
                        osc.start(); osc.stop(ctx.currentTime + 0.15);
                        break;
                    case 'crit':
                        osc.frequency.setValueAtTime(800, ctx.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.1);
                        gain.gain.setValueAtTime(0.3, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                        osc.start(); osc.stop(ctx.currentTime + 0.2);
                        break;
                }
            } catch(e) { console.log('Audio error:', e); }
        }
        
        function vibrate(pattern) {
            if (navigator.vibrate) navigator.vibrate(pattern);
        }

        // ===== WEAPON DATABASE =====
        // Icons from game-icons.net (CC0 license)
        const ICON_BASE = 'https://game-icons.net/icons/ffffff/000000/1x1';
        const WEAPON_TYPES = {
            sword:  { name: 'Í≤Ä',     img: `${ICON_BASE}/lorc/broadsword.svg`,       bonus: { damage: 1.0, crit: 1.0 } },
            axe:    { name: 'ÎèÑÎÅº',   img: `${ICON_BASE}/lorc/battle-axe.svg`,       bonus: { damage: 1.15, crit: 0.9 } },
            spear:  { name: 'Ï∞Ω',     img: `${ICON_BASE}/lorc/spear-hook.svg`,       bonus: { damage: 0.95, crit: 1.1 } },
            hammer: { name: 'ÎßùÏπò',   img: `${ICON_BASE}/lorc/claw-hammer.svg`,      bonus: { damage: 1.2, crit: 0.85 } },
            dagger: { name: 'Îã®Í≤Ä',   img: `${ICON_BASE}/lorc/plain-dagger.svg`,     bonus: { damage: 0.85, crit: 1.25 } },
            staff:  { name: 'ÏßÄÌå°Ïù¥', img: `${ICON_BASE}/lorc/wizard-staff.svg`,     bonus: { damage: 0.9, crit: 1.0, special: true } },
            katana: { name: 'ÌÉúÎèÑ',   img: `${ICON_BASE}/lorc/crossed-swords.svg`,   bonus: { damage: 1.05, crit: 1.15 } },
            scythe: { name: 'ÎÇ´',     img: `${ICON_BASE}/lorc/scythe.svg`,           bonus: { damage: 1.1, crit: 1.05 } }
        };
        
        // ===== MONSTER DATABASE =====
        const MONSTERS = {
            // ÏùºÎ∞ò Î™π (Ïâ¨ÏõÄ)
            slime:    { name: 'Ïä¨ÎùºÏûÑ',     img: `${ICON_BASE}/lorc/slime.svg`,           tier: 1, hp: 50,  damage: [5, 10],   crit: 5,  gold: [100, 200] },
            bat:      { name: 'Î∞ïÏ•ê',       img: `${ICON_BASE}/lorc/bat.svg`,             tier: 1, hp: 40,  damage: [8, 12],   crit: 10, gold: [120, 180] },
            rat:      { name: 'Ï•ê',         img: `${ICON_BASE}/lorc/rat.svg`,             tier: 1, hp: 35,  damage: [6, 10],   crit: 8,  gold: [80, 150] },
            
            // ÏùºÎ∞ò Î™π (Ï§ëÍ∞Ñ)
            goblin:   { name: 'Í≥†Î∏îÎ¶∞',     img: `${ICON_BASE}/lorc/goblin-head.svg`,     tier: 2, hp: 80,  damage: [12, 20],  crit: 12, gold: [200, 400] },
            wolf:     { name: 'ÎäëÎåÄ',       img: `${ICON_BASE}/lorc/wolf-head.svg`,       tier: 2, hp: 100, damage: [15, 25],  crit: 15, gold: [250, 450] },
            skeleton: { name: 'Ïä§ÏºàÎ†àÌÜ§',   img: `${ICON_BASE}/lorc/skeleton.svg`,        tier: 2, hp: 90,  damage: [18, 28],  crit: 10, gold: [300, 500] },
            
            // ÏùºÎ∞ò Î™π (Ïñ¥Î†§ÏõÄ)
            orc:      { name: 'Ïò§ÌÅ¨',       img: `${ICON_BASE}/lorc/orc-head.svg`,        tier: 3, hp: 150, damage: [25, 40],  crit: 12, gold: [500, 800] },
            troll:    { name: 'Ìä∏Î°§',       img: `${ICON_BASE}/lorc/troll.svg`,           tier: 3, hp: 200, damage: [30, 45],  crit: 8,  gold: [600, 1000] },
            ogre:     { name: 'Ïò§Í±∞',       img: `${ICON_BASE}/lorc/ogre.svg`,            tier: 3, hp: 180, damage: [35, 50],  crit: 10, gold: [700, 1100] },
            
            // Î≥¥Ïä§ Î™π
            dragon:   { name: 'üî• ÎìúÎûòÍ≥§',   img: `${ICON_BASE}/lorc/dragon-head.svg`,     tier: 4, hp: 400, damage: [50, 80],  crit: 20, gold: [3000, 5000], isBoss: true },
            demon:    { name: 'üëπ Îç∞Î™¨',     img: `${ICON_BASE}/lorc/daemon-skull.svg`,    tier: 4, hp: 350, damage: [60, 90],  crit: 25, gold: [4000, 6000], isBoss: true },
            reaper:   { name: 'üíÄ ÏÇ¨Ïã†',     img: `${ICON_BASE}/lorc/grim-reaper.svg`,     tier: 4, hp: 300, damage: [70, 100], crit: 30, gold: [5000, 8000], isBoss: true }
        };

        // Î™¨Ïä§ÌÑ∞ Ìã∞Ïñ¥Î≥Ñ Ï∂îÏ≤ú Î†àÎ≤®
        // Tier 1: +0 ~ +3
        // Tier 2: +3 ~ +6  
        // Tier 3: +6 ~ +10
        // Tier 4 (Boss): +8 ~ +15 (Ïñ¥Î†µÍ≤å Ïù¥Í∏∏ Ïàò ÏûàÏùå)

        /*
        ===== Î¨¥Í∏∞ ÏÑ±Îä•Ìëú =====
        | Î¨¥Í∏∞     | Îç∞ÎØ∏ÏßÄ | ÌÅ¨Î¶¨Ìã∞Ïª¨ | ÌäπÏßï                    |
        |----------|--------|----------|-------------------------|
        | Í≤Ä       | 1.0x   | 1.0x     | Í∑†ÌòïÏû°Ìûå Í∏∞Î≥∏ Î¨¥Í∏∞      |
        | ÎèÑÎÅº     | 1.15x  | 0.9x     | ÎÜíÏùÄ Îç∞ÎØ∏ÏßÄ, ÎÇÆÏùÄ ÌÅ¨Î¶¨  |
        | Ï∞Ω       | 0.95x  | 1.1x     | ÏïΩÍ∞Ñ ÎÇÆÏùÄ ÎéÄ, ÎÜíÏùÄ ÌÅ¨Î¶¨ |
        | ÎßùÏπò     | 1.2x   | 0.85x    | ÏµúÍ≥† Îç∞ÎØ∏ÏßÄ, ÏµúÏ†Ä ÌÅ¨Î¶¨  |
        | Îã®Í≤Ä     | 0.85x  | 1.25x    | ÎÇÆÏùÄ ÎéÄ, ÏµúÍ≥† ÌÅ¨Î¶¨Ìã∞Ïª¨  |
        | ÏßÄÌå°Ïù¥   | 0.9x   | 1.0x     | ÎßàÎ≤ï ÌäπÏàòÌö®Í≥º           |
        | ÌÉúÎèÑ     | 1.05x  | 1.15x    | ÎÜíÏùÄ Í∑†Ìòï               |
        | ÎÇ´       | 1.1x   | 1.05x    | Ï¢ãÏùÄ Ïò¨ÎùºÏö¥Îçî           |
        */

        const GRADES = {
            common: { 
                name: 'ÏùºÎ∞ò', 
                color: '#9d9d9d', 
                multiplier: 1.0,
                dropRate: 50,
                prefixes: ['ÎÇ°ÏùÄ', 'ÌèâÎ≤îÌïú', 'Í∏∞Î≥∏', 'Îã®ÏàúÌïú']
            },
            magic: { 
                name: 'Í≥†Í∏â', 
                color: '#5555ff', 
                multiplier: 1.3,
                dropRate: 30,
                prefixes: ['Í∞ïÌôîÎêú', 'ÎßàÎ†•Ïùò', 'ÎπõÎÇòÎäî', 'Ï†ïÍµêÌïú']
            },
            rare: { 
                name: 'Ìù¨Í∑Ä', 
                color: '#ffcc00', 
                multiplier: 1.7,
                dropRate: 14,
                prefixes: ['Ï†ïÏòà', 'Î™ÖÏù∏Ïùò', 'Í≥†ÎåÄÏùò', 'Ï∂ïÎ≥µÎ∞õÏùÄ']
            },
            legendary: { 
                name: 'Ï†ÑÏÑ§', 
                color: '#ff8000', 
                multiplier: 2.2,
                dropRate: 5,
                prefixes: ['Ï†ÑÏÑ§Ïùò', 'ÏòÅÏõÖÏùò', 'Ïã†ÏÑ±Ìïú', 'Î∂àÎ©∏Ïùò']
            },
            unique: { 
                name: 'Ïú†ÎãàÌÅ¨', 
                color: '#00ff80', 
                multiplier: 3.0,
                dropRate: 1,
                prefixes: [''],
                names: {
                    sword: 'ÏóëÏä§ÏπºÎ¶¨Î≤Ñ',
                    axe: 'Î†àÎπÑÏïÑÌÉÑ',
                    spear: 'Í≤åÏù¥Î≥ºÍ∑∏',
                    hammer: 'Î¨†ÎãàÎ•¥',
                    dagger: 'ÏïîÌùëÍ≤Ä ÏïÑÏ¶àÎùºÏóò',
                    staff: 'ÌòÑÏûêÏùò ÏßÄÌå°Ïù¥',
                    katana: 'Î¨¥ÎùºÎßàÏÇ¨',
                    scythe: 'Ï£ΩÏùåÏùò ÎÇ´'
                }
            }
        };

        // Îçî Ïä§Î¶¥ÏûàÎäî ÌôïÎ•†! ÌïòÎùΩ ÏóÜÏùå, ÌååÍ¥¥ ÏùºÏ∞ç ÏãúÏûë
        const ENHANCE_RATES = {
            0: { success: 100, destroy: 0, cost: 100 },      // +0‚Üí+1: 100%
            1: { success: 95, destroy: 0, cost: 200 },       // +1‚Üí+2: 95%
            2: { success: 90, destroy: 0, cost: 400 },       // +2‚Üí+3: 90%
            3: { success: 80, destroy: 0, cost: 800 },       // +3‚Üí+4: 80%
            4: { success: 70, destroy: 0, cost: 1500 },      // +4‚Üí+5: 70%
            5: { success: 60, destroy: 0, cost: 3000 },      // +5‚Üí+6: 60%
            6: { success: 50, destroy: 0, cost: 5000 },      // +6‚Üí+7: 50%
            7: { success: 45, destroy: 10, cost: 8000 },     // +7‚Üí+8: 45% (ÌååÍ¥¥ ÏãúÏûë!)
            8: { success: 40, destroy: 15, cost: 12000 },    // +8‚Üí+9: 40%
            9: { success: 35, destroy: 20, cost: 20000 },    // +9‚Üí+10: 35%
            10: { success: 30, destroy: 30, cost: 35000 },   // +10‚Üí+11: 30% üî•
            11: { success: 25, destroy: 35, cost: 50000 },   // +11‚Üí+12: 25%
            12: { success: 20, destroy: 40, cost: 80000 },   // +12‚Üí+13: 20%
            13: { success: 15, destroy: 50, cost: 120000 },  // +13‚Üí+14: 15% ‚ò†Ô∏è
            14: { success: 10, destroy: 55, cost: 200000 },  // +14‚Üí+15: 10%
            15: { success: 7, destroy: 60, cost: 350000 },   // +15‚Üí+16: 7% üíÄ
            16: { success: 5, destroy: 65, cost: 500000 },   // +16‚Üí+17: 5%
            17: { success: 3, destroy: 70, cost: 750000 },   // +17‚Üí+18: 3%
            18: { success: 2, destroy: 75, cost: 1000000 },  // +18‚Üí+19: 2%
            19: { success: 1, destroy: 80, cost: 1500000 },  // +19‚Üí+20: 1% üé∞
            20: { success: 1, destroy: 85, cost: 2000000 }   // MAX
        };

        // ===== GAME STATE =====
        let state = {
            gold: 10000,
            weapon: null,
            protectionScrolls: 3,
            useProtection: false,
            stats: { attempts: 0, successes: 0, fails: 0, destroys: 0, wins: 0, losses: 0 }
        };

        let mpUI = null;
        let battleState = null;

        // ===== WEAPON GENERATION =====
        function generateWeapon(forceGrade = null) {
            // Pick grade
            let grade;
            if (forceGrade) {
                grade = forceGrade;
            } else {
                const roll = Math.random() * 100;
                let cumulative = 0;
                for (const [g, data] of Object.entries(GRADES)) {
                    cumulative += data.dropRate;
                    if (roll < cumulative) {
                        grade = g;
                        break;
                    }
                }
            }

            // Pick type
            const types = Object.keys(WEAPON_TYPES);
            const type = types[Math.floor(Math.random() * types.length)];
            const typeData = WEAPON_TYPES[type];
            const gradeData = GRADES[grade];

            // Generate name
            let name;
            if (grade === 'unique' && gradeData.names[type]) {
                name = gradeData.names[type];
            } else {
                const prefix = gradeData.prefixes[Math.floor(Math.random() * gradeData.prefixes.length)];
                name = prefix ? `${prefix} ${typeData.name}` : typeData.name;
            }

            return {
                type,
                grade,
                name,
                level: 0,
                img: typeData.img  // Image URL from game-icons.net
            };
        }
        
        // Get weapon image HTML with proper coloring
        function getWeaponImgHtml(weapon, size = 80) {
            const gradeData = GRADES[weapon.grade];
            // Use CSS filter to colorize the white SVG icon
            return `<img src="${WEAPON_TYPES[weapon.type].img}" 
                         class="weapon-icon" 
                         style="width:${size}px;height:${size}px;filter:drop-shadow(0 0 15px ${gradeData.color}) brightness(0) invert(1);" 
                         alt="${weapon.name}">`;
        }

        function getWeaponStats(weapon) {
            if (!weapon) return { damageMin: 0, damageMax: 0, critChance: 0, critDamage: 150, hp: 100 };

            const typeData = WEAPON_TYPES[weapon.type];
            const gradeData = GRADES[weapon.grade];
            const mult = gradeData.multiplier;
            const level = weapon.level;

            const baseDmgMin = 10;
            const baseDmgMax = 15;
            const dmgPerLevel = 5;

            const damageMin = Math.floor((baseDmgMin + level * dmgPerLevel) * mult * typeData.bonus.damage);
            const damageMax = Math.floor((baseDmgMax + level * dmgPerLevel) * mult * typeData.bonus.damage);
            const critChance = Math.min(60, Math.floor((5 + level * 2) * typeData.bonus.crit));
            const critDamage = 150 + level * 5;
            const hp = Math.floor((100 + level * 20) * mult);

            return { damageMin, damageMax, critChance, critDamage, hp };
        }

        function getWeaponValue(weapon) {
            if (!weapon) return 0;
            const gradeData = GRADES[weapon.grade];
            const baseValue = gradeData.multiplier * 1000;
            let levelBonus = 0;
            for (let i = 0; i < weapon.level; i++) {
                levelBonus += ENHANCE_RATES[i].cost;
            }
            return Math.floor(baseValue + levelBonus * 0.5);
        }

        // ===== STORAGE =====
        function loadState() {
            const saved = localStorage.getItem('enhance_game_v3');
            if (saved) {
                const parsed = JSON.parse(saved);
                state = { ...state, ...parsed };
            }
            if (!state.weapon) {
                state.weapon = generateWeapon('common');
            }
        }

        function saveState() {
            localStorage.setItem('enhance_game_v3', JSON.stringify(state));
        }

        // ===== MAIN SCREEN =====
        function showMain() {
            const weapon = state.weapon;
            const stats = getWeaponStats(weapon);
            const gradeData = GRADES[weapon.grade];

            document.getElementById('app').innerHTML = `
                <div class="container">
                    <header>
                        <h1>‚öîÔ∏è Î¨¥Í∏∞ Í∞ïÌôî & Î∞∞ÌãÄ</h1>
                        <p class="subtitle">Í∞ïÌôîÌïòÍ≥† Ïã∏ÏõåÏÑú ÎèàÏùÑ Î≤åÏñ¥Îùº!</p>
                    </header>

                    <div class="gold-display">
                        <span class="gold-icon">üí∞</span>
                        <span class="gold-amount">${state.gold.toLocaleString()} G</span>
                    </div>

                    <div class="weapon-card ${weapon.grade}">
                        <div class="weapon-header">
                            <div class="weapon-info">
                                <div class="weapon-grade ${weapon.grade}">${gradeData.name}</div>
                                <div class="weapon-name">${weapon.name}</div>
                                <div class="weapon-type">${WEAPON_TYPES[weapon.type].name}</div>
                            </div>
                            <div class="weapon-level">
                                <div class="weapon-level-number">+${weapon.level}</div>
                                <div class="weapon-level-label">Í∞ïÌôî</div>
                            </div>
                        </div>

                        <div class="weapon-icon-area">
                            <img src="${WEAPON_TYPES[weapon.type].img}" 
                                 class="weapon-icon" 
                                 style="filter:drop-shadow(0 0 20px ${gradeData.color});"
                                 alt="${weapon.name}">
                        </div>

                        <div class="weapon-stats">
                            <div class="stat-item">
                                <span class="stat-icon">‚öîÔ∏è</span>
                                <div class="stat-info">
                                    <div class="stat-value damage">${stats.damageMin}-${stats.damageMax}</div>
                                    <div class="stat-label">Í≥µÍ≤©Î†•</div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <span class="stat-icon">üí•</span>
                                <div class="stat-info">
                                    <div class="stat-value crit">${stats.critChance}%</div>
                                    <div class="stat-label">ÌÅ¨Î¶¨Ìã∞Ïª¨</div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <span class="stat-icon">‚ù§Ô∏è</span>
                                <div class="stat-info">
                                    <div class="stat-value hp">${stats.hp}</div>
                                    <div class="stat-label">Ï≤¥Î†•</div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <span class="stat-icon">üíé</span>
                                <div class="stat-info">
                                    <div class="stat-value special">${getWeaponValue(weapon).toLocaleString()}</div>
                                    <div class="stat-label">Í∞ÄÏπò</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mode-grid" style="grid-template-columns: repeat(3, 1fr);">
                        <button class="mode-btn enhance" onclick="showEnhance()">
                            <span class="mode-icon">üî®</span>
                            <span class="mode-label">Í∞ïÌôî</span>
                        </button>
                        <button class="mode-btn hunt" onclick="showHunt()">
                            <span class="mode-icon">üêâ</span>
                            <span class="mode-label">ÏÇ¨ÎÉ•</span>
                        </button>
                        <button class="mode-btn battle" onclick="showBattleLobby()">
                            <span class="mode-icon">‚öîÔ∏è</span>
                            <span class="mode-label">PvP</span>
                        </button>
                    </div>

                    <div class="stats-summary">
                        <div class="summary-item">
                            <span class="summary-value">${state.stats.attempts}</span>
                            <span class="summary-label">ÏãúÎèÑ</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-value" style="color:var(--success)">${state.stats.successes}</span>
                            <span class="summary-label">ÏÑ±Í≥µ</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-value" style="color:var(--fail)">${state.stats.fails}</span>
                            <span class="summary-label">Ïã§Ìå®</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-value">${state.stats.wins}Ïäπ ${state.stats.losses}Ìå®</span>
                            <span class="summary-label">Ï†ÑÏ†Å</span>
                        </div>
                    </div>

                    <footer>
                        ¬© 2026 <a href="https://game.cocy.io">game.cocy.io</a>
                    </footer>
                </div>
            `;
        }

        // ===== ENHANCE SCREEN =====
        function showEnhance() {
            const weapon = state.weapon;
            const stats = getWeaponStats(weapon);
            const gradeData = GRADES[weapon.grade];
            const rates = ENHANCE_RATES[Math.min(weapon.level, 20)];
            const canEnhance = state.gold >= rates.cost && weapon.level < 21;
            const showProtection = rates.destroy > 0;

            document.getElementById('app').innerHTML = `
                <div class="container">
                    <button class="btn-back" onclick="showMain()">‚Üê Î©îÏù∏ÏúºÎ°ú</button>

                    <div class="gold-display">
                        <span class="gold-icon">üí∞</span>
                        <span class="gold-amount">${state.gold.toLocaleString()} G</span>
                    </div>

                    <div class="weapon-card ${weapon.grade}">
                        <div class="weapon-header">
                            <div class="weapon-info">
                                <div class="weapon-grade ${weapon.grade}">${gradeData.name}</div>
                                <div class="weapon-name">${weapon.name}</div>
                            </div>
                            <div class="weapon-level">
                                <div class="weapon-level-number">+${weapon.level}</div>
                                <div class="weapon-level-label">Í∞ïÌôî</div>
                            </div>
                        </div>

                        <div class="weapon-icon-area">
                            <img src="${WEAPON_TYPES[weapon.type].img}" 
                                 class="weapon-icon" 
                                 id="weaponIcon"
                                 style="filter:drop-shadow(0 0 20px ${gradeData.color});"
                                 alt="${weapon.name}">
                        </div>

                        <div class="weapon-stats">
                            <div class="stat-item">
                                <span class="stat-icon">‚öîÔ∏è</span>
                                <div class="stat-info">
                                    <div class="stat-value damage">${stats.damageMin}-${stats.damageMax}</div>
                                    <div class="stat-label">Í≥µÍ≤©Î†•</div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <span class="stat-icon">üí•</span>
                                <div class="stat-info">
                                    <div class="stat-value crit">${stats.critChance}%</div>
                                    <div class="stat-label">ÌÅ¨Î¶¨Ìã∞Ïª¨</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="enhance-panel">
                        <div class="enhance-row">
                            <span class="enhance-label">üéØ ÏÑ±Í≥µ</span>
                            <span class="enhance-value ${rates.success >= 50 ? 'safe' : rates.success >= 20 ? '' : 'danger'}">${rates.success}%</span>
                        </div>
                        <div class="enhance-row">
                            <span class="enhance-label">${rates.destroy >= 50 ? 'üíÄ' : rates.destroy > 0 ? '‚ö†Ô∏è' : '‚úÖ'} ÌååÍ¥¥</span>
                            <span class="enhance-value ${rates.destroy >= 50 ? 'danger' : rates.destroy > 0 ? 'warning' : 'safe'}">${rates.destroy > 0 ? rates.destroy + '%' : 'ÏóÜÏùå'}</span>
                        </div>
                        <div class="enhance-row">
                            <span class="enhance-label">üí∞ ÎπÑÏö©</span>
                            <span class="enhance-value gold">${rates.cost.toLocaleString()} G</span>
                        </div>
                    </div>

                    ${showProtection ? `
                    <div class="protection-toggle">
                        <span>üõ°Ô∏è ÌååÍ¥¥ Î∞©ÏßÄ (${state.protectionScrolls}Í∞ú)</span>
                        <button class="toggle-btn ${state.useProtection ? 'on' : 'off'}" onclick="toggleProtection()" id="protectionBtn">
                            ${state.useProtection ? 'ON' : 'OFF'}
                        </button>
                    </div>
                    ` : ''}

                    <div class="btn-row">
                        <button class="btn btn-secondary" onclick="sellWeapon()">üí∞ ÌåêÎß§</button>
                        <button class="btn btn-enhance" onclick="enhance()" ${!canEnhance ? 'disabled' : ''}>
                            ${weapon.level >= 21 ? 'üèÜ MAX' : `‚ö° Í∞ïÌôî (${rates.cost.toLocaleString()}G)`}
                        </button>
                    </div>
                </div>
            `;
        }

        function toggleProtection() {
            if (state.protectionScrolls > 0) {
                state.useProtection = !state.useProtection;
                const btn = document.getElementById('protectionBtn');
                btn.textContent = state.useProtection ? 'ON' : 'OFF';
                btn.className = 'toggle-btn ' + (state.useProtection ? 'on' : 'off');
            }
        }

        function enhance() {
            const weapon = state.weapon;
            if (weapon.level >= 21) return;

            const rates = ENHANCE_RATES[weapon.level];
            if (state.gold < rates.cost) return;

            state.gold -= rates.cost;
            state.stats.attempts++;

            const weaponIcon = document.getElementById('weaponIcon');
            weaponIcon.classList.add('shake');
            playSound('enhance');
            vibrate(50);
            setTimeout(() => weaponIcon.classList.remove('shake'), 500);

            const roll = Math.random() * 100;
            const fromLevel = weapon.level;
            let toLevel = fromLevel;
            let result = 'fail';
            let newWeapon = null;

            if (roll < rates.success) {
                // Success! üéâ
                toLevel = fromLevel + 1;
                result = 'success';
                state.stats.successes++;
                setTimeout(() => {
                    playSound('success');
                    vibrate([50, 50, 100]);
                    weaponIcon.classList.add('glow-success');
                }, 300);
                setTimeout(() => weaponIcon.classList.remove('glow-success'), 1300);
            } else if (rates.destroy > 0 && roll < rates.success + rates.destroy) {
                // Destroy! üí•
                result = 'destroy';
                state.stats.destroys++;
                
                if (state.useProtection && state.protectionScrolls > 0) {
                    state.protectionScrolls--;
                    state.useProtection = false;
                    toLevel = fromLevel;
                } else {
                    // Generate new weapon (different from current)
                    newWeapon = generateWeapon();
                    while (newWeapon.type === weapon.type && newWeapon.grade === weapon.grade) {
                        newWeapon = generateWeapon();
                    }
                }
                
                setTimeout(() => {
                    playSound('destroy');
                    vibrate([100, 50, 100, 50, 200]);
                    weaponIcon.classList.add('glow-fail');
                    document.body.classList.add('screen-shake');
                }, 300);
                setTimeout(() => {
                    weaponIcon.classList.remove('glow-fail');
                    document.body.classList.remove('screen-shake');
                }, 1300);
            } else {
                // Fail - just stays the same (no downgrade!)
                result = 'fail';
                state.stats.fails++;
                setTimeout(() => {
                    playSound('fail');
                    vibrate(100);
                    weaponIcon.classList.add('glow-fail');
                }, 300);
                setTimeout(() => weaponIcon.classList.remove('glow-fail'), 1300);
            }

            if (newWeapon) {
                state.weapon = newWeapon;
            } else {
                state.weapon.level = toLevel;
            }
            
            saveState();

            setTimeout(() => {
                showEnhanceResult(result, fromLevel, state.weapon.level, newWeapon);
            }, 300);
        }

        function showEnhanceResult(type, from, to, newWeapon) {
            const popup = document.getElementById('resultPopup');
            const overlay = document.getElementById('overlay');
            const newWeaponPreview = document.getElementById('newWeaponPreview');

            let popupClass = 'result-popup';
            let icon = '‚ú®';
            let text = '';
            let detail = '';
            let textColor = 'var(--text)';

            if (type === 'success') {
                popupClass += ' success';
                icon = '‚ú®';
                text = 'Í∞ïÌôî ÏÑ±Í≥µ!';
                detail = `+${from} ‚Üí +${to}`;
                textColor = 'var(--success)';
            } else if (type === 'destroy') {
                if (newWeapon) {
                    popupClass += ' destroy';
                    icon = 'üí•';
                    text = 'Î¨¥Í∏∞ ÌååÍ¥¥!';
                    detail = 'ÏÉàÎ°úÏö¥ Î¨¥Í∏∞Î•º ÌöçÎìùÌñàÏäµÎãàÎã§';
                    textColor = 'var(--legendary)';
                    
                    newWeaponPreview.style.display = 'block';
                    const gradeData = GRADES[newWeapon.grade];
                    document.getElementById('newWeaponName').innerHTML = 
                        `<span style="color:${gradeData.color}">[${gradeData.name}] ${newWeapon.name}</span>`;
                } else {
                    popupClass += ' success';
                    icon = 'üõ°Ô∏è';
                    text = 'ÌååÍ¥¥ Î∞©ÏßÄ!';
                    detail = 'Î≥¥Ìò∏ Ï£ºÎ¨∏ÏÑúÍ∞Ä Î¨¥Í∏∞Î•º ÏßÄÏº∞ÏäµÎãàÎã§';
                    textColor = 'var(--gold)';
                }
            } else {
                // Fail - level stays same
                popupClass += ' fail';
                icon = 'üò¢';
                text = 'Í∞ïÌôî Ïã§Ìå®...';
                detail = 'Îã§ÏùåÏóî ÏÑ±Í≥µÌï†Í±∞Ïïº!';
                textColor = 'var(--fail)';
            }

            popup.className = popupClass + ' show';
            document.getElementById('resultIcon').textContent = icon;
            document.getElementById('resultText').textContent = text;
            document.getElementById('resultText').style.color = textColor;
            document.getElementById('resultDetail').textContent = detail;
            document.getElementById('resultBtn').onclick = () => { closeResult(); showEnhance(); };

            if (!newWeapon) {
                newWeaponPreview.style.display = 'none';
            }

            overlay.classList.add('show');

            // Confetti for big milestones
            if (type === 'success' && (to >= 10 || to === 7)) fireConfetti();
        }

        function closeResult() {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('resultPopup').classList.remove('show');
        }

        function sellWeapon() {
            const value = getWeaponValue(state.weapon);
            if (confirm(`${state.weapon.name}ÏùÑ(Î•º) ${value.toLocaleString()}GÏóê ÌåêÎß§ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÏÉàÎ°úÏö¥ Î¨¥Í∏∞Î•º Î∞õÍ≤å Îê©ÎãàÎã§.`)) {
                state.gold += value;
                state.weapon = generateWeapon();
                saveState();
                showEnhance();
            }
        }

        // ===== BATTLE MODE =====
        function showBattleLobby() {
            mpUI = new MultiplayerUI({
                gameType: 'enhance',
                gameName: '‚öîÔ∏è Î¨¥Í∏∞ Î∞∞ÌãÄ',
                container: document.getElementById('app'),
                maxPlayers: 2,
                supportsLocal: false,
                onGameStart: handleBattleStart,
                onGameEvent: handleBattleEvent,
                onLeave: () => { battleState = null; showMain(); },
                getPlayerData: () => ({
                    weapon: state.weapon,
                    gold: state.gold
                })
            });

            const roomCode = MultiplayerUI.checkUrlRoom();
            if (roomCode) {
                mpUI._renderLobby();
                setTimeout(() => {
                    document.getElementById('mp-room-code').value = roomCode;
                }, 100);
            } else {
                mpUI.show();
            }
        }

        function handleBattleStart(gameState) {
            battleState = gameState;
            renderBattle();
        }

        function handleBattleEvent(type, data) {
            if (type === 'state_update') {
                // Check log for attack events to play sounds
                const gs = data.gameState || data;
                const lastLog = gs.log?.[gs.log.length - 1];
                if (lastLog) {
                    if (lastLog.type === 'crit') {
                        playSound('crit');
                        vibrate([50, 30, 100]);
                        document.body.classList.add('screen-shake');
                        setTimeout(() => document.body.classList.remove('screen-shake'), 300);
                    } else if (lastLog.type === 'damage') {
                        playSound('attack');
                        vibrate(50);
                    }
                }
                battleState = data;
                renderBattle();
            } else if (type === 'game_end') {
                if (data.winnerId === mpUI.getClient().getMyUserId()) {
                    playSound('success');
                    vibrate([100, 50, 100, 50, 200]);
                } else {
                    playSound('destroy');
                    vibrate([200, 100, 200]);
                }
                showBattleResult(data);
            }
        }

        function renderBattle() {
            if (!battleState || !battleState.gameState) return;

            const gs = battleState.gameState;
            const myId = mpUI.getClient().getMyUserId();
            const me = gs.players.find(p => p.id === myId);
            const enemy = gs.players.find(p => p.id !== myId);
            const isMyTurn = gs.currentTurn === myId;

            const myGrade = me?.weaponGrade ? GRADES[me.weaponGrade] : GRADES.common;
            const enemyGrade = enemy?.weaponGrade ? GRADES[enemy.weaponGrade] : GRADES.common;
            
            // Get weapon images from type
            const myWeaponImg = WEAPON_TYPES[me?.weaponType]?.img || WEAPON_TYPES.sword.img;
            const enemyWeaponImg = WEAPON_TYPES[enemy?.weaponType]?.img || WEAPON_TYPES.sword.img;

            // Status badges
            const enemyStatus = enemy?.isDefending ? 'üõ°Ô∏è Î∞©Ïñ¥Ï§ë' : (enemy?.counterReady ? '‚ö° Ïπ¥Ïö¥ÌÑ∞' : '');
            const myStatus = me?.isDefending ? 'üõ°Ô∏è Î∞©Ïñ¥Ï§ë' : (me?.counterReady ? '‚ö° Ïπ¥Ïö¥ÌÑ∞!' : '');

            document.getElementById('app').innerHTML = `
                <div class="battle-screen">
                    <div class="battle-header">
                        <div class="battle-title">‚öîÔ∏è Î¨¥Í∏∞ Î∞∞ÌãÄ!</div>
                        <div class="battle-round">ÎùºÏö¥Îìú ${gs.round || 1} | ${isMyTurn ? 'ÎÇ¥ ÌÑ¥' : 'ÏÉÅÎåÄ ÌÑ¥'} | üí∞ ${(gs.totalPrize || 0).toLocaleString()}G</div>
                    </div>

                    <div class="battle-arena">
                        <div class="fighter enemy ${enemy?.isDefending ? 'defending' : ''}">
                            <div class="fighter-header">
                                <span class="fighter-name">üë§ ${enemy?.nickname || 'ÏÉÅÎåÄ'} ${enemyStatus}</span>
                                <span class="fighter-weapon" style="color:${enemyGrade.color}">
                                    <img src="${enemyWeaponImg}" style="width:20px;height:20px;vertical-align:middle;filter:drop-shadow(0 0 3px ${enemyGrade.color});">
                                    [${enemyGrade.name}] +${enemy?.weaponLevel || 0}
                                </span>
                            </div>
                            <div class="hp-bar-container">
                                <div class="hp-bar ${(enemy?.hp || 0) < 30 ? 'low' : ''}" 
                                     style="width: ${((enemy?.hp || 0) / (enemy?.maxHp || 100)) * 100}%">
                                    ${enemy?.hp || 0} / ${enemy?.maxHp || 100}
                                </div>
                            </div>
                            <div class="fighter-stats">
                                <span>‚öîÔ∏è ${enemy?.damageMin || 0}-${enemy?.damageMax || 0}</span>
                                <span>üí• ${enemy?.critChance || 0}%</span>
                            </div>
                        </div>

                        <div class="fighter me ${me?.isDefending ? 'defending' : ''} ${me?.counterReady ? 'counter-ready' : ''}">
                            <div class="fighter-header">
                                <span class="fighter-name">üéÆ ${me?.nickname || 'ÎÇò'} ${myStatus}</span>
                                <span class="fighter-weapon" style="color:${myGrade.color}">
                                    <img src="${myWeaponImg}" style="width:20px;height:20px;vertical-align:middle;filter:drop-shadow(0 0 3px ${myGrade.color});">
                                    [${myGrade.name}] +${me?.weaponLevel || 0}
                                </span>
                            </div>
                            <div class="hp-bar-container">
                                <div class="hp-bar ${(me?.hp || 0) < 30 ? 'low' : ''}" 
                                     style="width: ${((me?.hp || 0) / (me?.maxHp || 100)) * 100}%">
                                    ${me?.hp || 0} / ${me?.maxHp || 100}
                                </div>
                            </div>
                            <div class="fighter-stats">
                                <span>‚öîÔ∏è ${me?.damageMin || 0}-${me?.damageMax || 0}</span>
                                <span>üí• ${me?.critChance || 0}%</span>
                            </div>
                        </div>

                        <div class="battle-log" id="battleLog">
                            ${(gs.log || []).slice(-6).map(entry => `
                                <div class="log-entry ${entry.type || ''}">${entry.text}</div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="battle-actions">
                        <div class="action-btns">
                            <button class="action-btn attack ${me?.counterReady ? 'counter' : ''}" onclick="battleAction('attack')" ${!isMyTurn ? 'disabled' : ''}>
                                ${me?.counterReady ? '‚ö° Ïπ¥Ïö¥ÌÑ∞!' : '‚öîÔ∏è Í≥µÍ≤©'}
                            </button>
                            <button class="action-btn defend" onclick="battleAction('defend')" ${!isMyTurn ? 'disabled' : ''}>
                                üõ°Ô∏è Î∞©Ïñ¥
                            </button>
                        </div>
                        <button class="btn btn-secondary" onclick="battleSurrender()" style="margin-top:10px;background:rgba(255,100,100,0.15);">
                            üè≥Ô∏è Ìï≠Î≥µÌïòÍ∏∞
                        </button>
                    </div>
                </div>
            `;
        }

        function battleSurrender() {
            if (!confirm('Ìï≠Î≥µÌïòÎ©¥ Ìå®Î∞∞ Ï≤òÎ¶¨Îê©ÎãàÎã§.\nÏ†ïÎßê Ìï≠Î≥µÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            
            // Leave room (counts as loss)
            if (mpUI && mpUI.getClient()) {
                mpUI.getClient().leaveRoom().catch(() => {});
                mpUI.getClient()._clearRoom();
                MultiplayerClient.resetInstance();
            }
            
            state.stats.losses++;
            saveState();
            
            playSound('fail');
            
            mpUI = null;
            battleState = null;
            showMain();
        }

        async function battleAction(action) {
            if (!mpUI || !mpUI.getClient()) return;
            try {
                await mpUI.sendAction({ type: action });
            } catch (e) {
                console.error('Battle action error:', e);
            }
        }

        function showBattleResult(data) {
            const myId = mpUI.getClient().getMyUserId();
            const isWin = data.winnerId === myId;
            const prizeGold = data.prizeGold || 0;

            if (isWin) {
                state.gold += prizeGold;
                state.stats.wins++;
            } else {
                state.stats.losses++;
            }
            saveState();

            const detail = isWin 
                ? `üí∞ ${prizeGold.toLocaleString()}G ÌöçÎìù!`
                : `ÏÉÅÎåÄÏóêÍ≤å ${prizeGold.toLocaleString()}GÎ•º ÎπºÏïóÍ≤ºÏäµÎãàÎã§`;

            mpUI.showResult({
                title: isWin ? 'üèÜ ÏäπÎ¶¨!' : 'üíÄ Ìå®Î∞∞...',
                detail: detail,
                isWin: isWin,
                showRematch: true
            });

            if (isWin) fireConfetti();
        }

        // ===== HUNT MODE (Single Player) =====
        let huntState = null;

        function getRecommendedTier(weaponLevel) {
            if (weaponLevel <= 3) return 1;
            if (weaponLevel <= 6) return 2;
            if (weaponLevel <= 10) return 3;
            return 4;
        }

        function spawnMonster(forceType = null) {
            if (forceType && MONSTERS[forceType]) {
                const m = MONSTERS[forceType];
                return {
                    type: forceType,
                    ...m,
                    currentHp: m.hp,
                    maxHp: m.hp
                };
            }

            const weaponLevel = state.weapon.level;
            const recommendedTier = getRecommendedTier(weaponLevel);
            
            // 10% chance for boss if weapon level >= 8
            if (weaponLevel >= 8 && Math.random() < 0.1) {
                const bosses = Object.entries(MONSTERS).filter(([k, v]) => v.isBoss);
                const [type, m] = bosses[Math.floor(Math.random() * bosses.length)];
                return { type, ...m, currentHp: m.hp, maxHp: m.hp };
            }
            
            // Otherwise spawn appropriate tier monster
            // Allow ¬±1 tier for variety
            const minTier = Math.max(1, recommendedTier - 1);
            const maxTier = Math.min(3, recommendedTier + 1);
            
            const eligibleMonsters = Object.entries(MONSTERS)
                .filter(([k, v]) => v.tier >= minTier && v.tier <= maxTier && !v.isBoss);
            
            const [type, m] = eligibleMonsters[Math.floor(Math.random() * eligibleMonsters.length)];
            return { type, ...m, currentHp: m.hp, maxHp: m.hp };
        }

        function showHunt() {
            // Initialize hunt state
            const playerStats = getWeaponStats(state.weapon);
            huntState = {
                monster: spawnMonster(),
                player: {
                    hp: playerStats.hp,
                    maxHp: playerStats.hp,
                    ...playerStats
                },
                log: [],
                monstersKilled: 0,
                totalGoldEarned: 0
            };
            renderHunt();
        }

        function renderHunt() {
            if (!huntState) return;
            
            const monster = huntState.monster;
            const player = huntState.player;
            const weapon = state.weapon;
            const gradeData = GRADES[weapon.grade];

            document.getElementById('app').innerHTML = `
                <div class="container hunt-screen">
                    <button class="btn-back" onclick="exitHunt()">‚Üê ÎèÑÎßùÏπòÍ∏∞</button>
                    
                    <div class="gold-display">
                        <span class="gold-icon">üí∞</span>
                        <span class="gold-amount">${state.gold.toLocaleString()} G</span>
                        <span style="margin-left:10px;color:var(--muted)">| Ï≤òÏπò: ${huntState.monstersKilled}</span>
                    </div>

                    <div class="monster-card ${monster.isBoss ? 'boss' : ''}">
                        <div class="monster-tier">${monster.isBoss ? '‚ö†Ô∏è BOSS' : `Tier ${monster.tier}`}</div>
                        <img src="${monster.img}" class="monster-img" alt="${monster.name}">
                        <div class="monster-name ${monster.isBoss ? 'boss' : ''}">${monster.name}</div>
                        
                        <div class="hp-bar-container" style="margin-top:12px;">
                            <div class="hp-bar ${monster.currentHp < monster.maxHp * 0.3 ? 'low' : ''}" 
                                 style="width: ${(monster.currentHp / monster.maxHp) * 100}%">
                                ${monster.currentHp} / ${monster.maxHp}
                            </div>
                        </div>
                        <div class="fighter-stats" style="justify-content:center;margin-top:8px;">
                            <span>‚öîÔ∏è ${monster.damage[0]}-${monster.damage[1]}</span>
                            <span>üí• ${monster.crit}%</span>
                            <span>üí∞ ${monster.gold[0]}-${monster.gold[1]}</span>
                        </div>
                    </div>

                    <div class="hunt-vs">‚öîÔ∏è VS ‚öîÔ∏è</div>

                    <div class="player-mini">
                        <div class="fighter-header">
                            <span class="fighter-name" style="color:${gradeData.color}">
                                <img src="${WEAPON_TYPES[weapon.type].img}" style="width:24px;height:24px;vertical-align:middle;">
                                ${weapon.name} +${weapon.level}
                            </span>
                        </div>
                        <div class="hp-bar-container" style="margin-top:8px;">
                            <div class="hp-bar ${player.hp < player.maxHp * 0.3 ? 'low' : ''}" 
                                 style="width: ${(player.hp / player.maxHp) * 100}%">
                                ${player.hp} / ${player.maxHp}
                            </div>
                        </div>
                        <div class="fighter-stats" style="margin-top:8px;">
                            <span>‚öîÔ∏è ${player.damageMin}-${player.damageMax}</span>
                            <span>üí• ${player.critChance}%</span>
                        </div>
                    </div>

                    <div class="battle-log" id="huntLog" style="max-height:100px;">
                        ${huntState.log.slice(-5).map(entry => `
                            <div class="log-entry ${entry.type}">${entry.text}</div>
                        `).join('')}
                    </div>

                    <div class="hunt-actions">
                        <button class="btn btn-enhance" onclick="huntAttack()">‚öîÔ∏è Í≥µÍ≤©!</button>
                        <button class="btn btn-secondary" onclick="huntRunAway()" style="background:rgba(255,100,100,0.2);border:1px solid var(--fail);">
                            üèÉ ÎèÑÎßù (-${getRunPenaltyPercent(monster.tier)}%)
                        </button>
                    </div>
                </div>
            `;
        }

        function getRunPenaltyPercent(tier) {
            // Boss: 10%, Tier 3: 7%, Tier 2: 4%, Tier 1: 2%
            const penalties = { 1: 2, 2: 4, 3: 7, 4: 10 };
            return penalties[tier] || 5;
        }

        function huntRunAway() {
            if (!huntState) return;
            
            const monster = huntState.monster;
            const penaltyPercent = getRunPenaltyPercent(monster.tier);
            const goldLoss = Math.floor(state.gold * penaltyPercent / 100);
            
            const warningMsg = monster.isBoss 
                ? `‚ö†Ô∏è Î≥¥Ïä§ÏóêÍ≤åÏÑú ÎèÑÎßùÏπòÎ©¥ Í≥®ÎìúÏùò ${penaltyPercent}%Î•º ÏûÉÏäµÎãàÎã§!\n\nüí∞ ÏòàÏÉÅ ÏÜêÏã§: ${goldLoss.toLocaleString()}G\n\nÏ†ïÎßê ÎèÑÎßùÏπòÏãúÍ≤†ÏäµÎãàÍπå?`
                : `ÎèÑÎßùÏπòÎ©¥ Í≥®ÎìúÏùò ${penaltyPercent}%Î•º ÏûÉÏäµÎãàÎã§.\n\nüí∞ ÏòàÏÉÅ ÏÜêÏã§: ${goldLoss.toLocaleString()}G\n\nÏ†ïÎßê ÎèÑÎßùÏπòÏãúÍ≤†ÏäµÎãàÍπå?`;
            
            if (!confirm(warningMsg)) return;
            
            // Apply penalty
            state.gold = Math.max(0, state.gold - goldLoss);
            saveState();
            
            playSound('fail');
            vibrate(100);
            
            // Show result and exit
            const popup = document.getElementById('resultPopup');
            const overlay = document.getElementById('overlay');
            
            popup.className = 'result-popup fail show';
            document.getElementById('resultIcon').textContent = 'üèÉ';
            document.getElementById('resultText').textContent = 'ÎèÑÎßù ÏÑ±Í≥µ!';
            document.getElementById('resultText').style.color = 'var(--muted)';
            document.getElementById('resultDetail').innerHTML = `
                üí∏ -${goldLoss.toLocaleString()}G ÏÜêÏã§<br>
                <span style="color:var(--muted);font-size:0.9em">
                    Ï≤òÏπò: ${huntState.monstersKilled}ÎßàÎ¶¨ | Ï¥ù ÌöçÎìù: ${huntState.totalGoldEarned.toLocaleString()}G
                </span>
            `;
            document.getElementById('newWeaponPreview').style.display = 'none';
            document.getElementById('resultBtn').textContent = 'Î©îÏù∏ÏúºÎ°ú';
            document.getElementById('resultBtn').onclick = () => {
                closeResult();
                huntState = null;
                showMain();
            };
            
            overlay.classList.add('show');
        }

        function huntAttack() {
            if (!huntState) return;
            
            const player = huntState.player;
            const monster = huntState.monster;
            
            // Player attacks first
            const playerDamage = Math.floor(Math.random() * (player.damageMax - player.damageMin + 1)) + player.damageMin;
            const playerCrit = Math.random() * 100 < player.critChance;
            const finalPlayerDamage = playerCrit ? Math.floor(playerDamage * player.critDamage / 100) : playerDamage;
            
            monster.currentHp = Math.max(0, monster.currentHp - finalPlayerDamage);
            
            playSound(playerCrit ? 'crit' : 'attack');
            vibrate(playerCrit ? [50, 30, 100] : 50);
            
            if (playerCrit) {
                huntState.log.push({ type: 'crit', text: `üí• ÌÅ¨Î¶¨Ìã∞Ïª¨! ${finalPlayerDamage} Îç∞ÎØ∏ÏßÄ!` });
            } else {
                huntState.log.push({ type: 'damage', text: `‚öîÔ∏è ${finalPlayerDamage} Îç∞ÎØ∏ÏßÄ!` });
            }
            
            // Check if monster is dead
            if (monster.currentHp <= 0) {
                huntMonsterKilled();
                return;
            }
            
            // Monster attacks back
            setTimeout(() => {
                const monsterDamage = Math.floor(Math.random() * (monster.damage[1] - monster.damage[0] + 1)) + monster.damage[0];
                const monsterCrit = Math.random() * 100 < monster.crit;
                const finalMonsterDamage = monsterCrit ? Math.floor(monsterDamage * 1.5) : monsterDamage;
                
                player.hp = Math.max(0, player.hp - finalMonsterDamage);
                
                playSound(monsterCrit ? 'crit' : 'attack');
                vibrate(monsterCrit ? [100, 50, 100] : 100);
                document.body.classList.add('screen-shake');
                setTimeout(() => document.body.classList.remove('screen-shake'), 300);
                
                if (monsterCrit) {
                    huntState.log.push({ type: 'crit', text: `üí• ${monster.name}Ïùò ÌÅ¨Î¶¨Ìã∞Ïª¨! ${finalMonsterDamage} Îç∞ÎØ∏ÏßÄ!` });
                } else {
                    huntState.log.push({ type: 'damage', text: `üî• ${monster.name}Ïùò Î∞òÍ≤©! ${finalMonsterDamage} Îç∞ÎØ∏ÏßÄ!` });
                }
                
                // Check if player is dead
                if (player.hp <= 0) {
                    huntPlayerDied();
                    return;
                }
                
                renderHunt();
            }, 300);
            
            renderHunt();
        }

        function huntMonsterKilled() {
            const monster = huntState.monster;
            const goldReward = Math.floor(Math.random() * (monster.gold[1] - monster.gold[0] + 1)) + monster.gold[0];
            
            state.gold += goldReward;
            huntState.monstersKilled++;
            huntState.totalGoldEarned += goldReward;
            
            playSound('success');
            vibrate([50, 50, 100]);
            if (monster.isBoss) fireConfetti();
            
            saveState();
            
            // Show victory and spawn next monster
            const popup = document.getElementById('resultPopup');
            const overlay = document.getElementById('overlay');
            
            popup.className = 'result-popup success show';
            document.getElementById('resultIcon').textContent = monster.isBoss ? 'üèÜ' : '‚ú®';
            document.getElementById('resultText').textContent = `${monster.name} Ï≤òÏπò!`;
            document.getElementById('resultText').style.color = 'var(--success)';
            document.getElementById('resultDetail').innerHTML = `üí∞ +${goldReward.toLocaleString()}G`;
            document.getElementById('newWeaponPreview').style.display = 'none';
            document.getElementById('resultBtn').textContent = 'Îã§Ïùå Î™¨Ïä§ÌÑ∞';
            document.getElementById('resultBtn').onclick = () => {
                closeResult();
                // Spawn next monster, heal a bit
                huntState.monster = spawnMonster();
                huntState.player.hp = Math.min(huntState.player.maxHp, huntState.player.hp + Math.floor(huntState.player.maxHp * 0.3));
                huntState.log = [{ type: 'info', text: `‚ù§Ô∏è HP 30% ÌöåÎ≥µ!` }];
                renderHunt();
            };
            
            overlay.classList.add('show');
        }

        function huntPlayerDied() {
            playSound('destroy');
            vibrate([200, 100, 200, 100, 300]);
            
            // Lose weapon!
            const lostWeapon = state.weapon;
            state.weapon = generateWeapon('common'); // Reset to random common weapon
            state.stats.losses++;
            saveState();
            
            const popup = document.getElementById('resultPopup');
            const overlay = document.getElementById('overlay');
            
            popup.className = 'result-popup fail show';
            document.getElementById('resultIcon').textContent = 'üíÄ';
            document.getElementById('resultText').textContent = 'ÏÇ¨Îßù...';
            document.getElementById('resultText').style.color = 'var(--fail)';
            document.getElementById('resultDetail').innerHTML = `
                Î¨¥Í∏∞Î•º ÏûÉÏóàÏäµÎãàÎã§!<br>
                <span style="color:var(--muted);font-size:0.9em">
                    Ï≤òÏπò: ${huntState.monstersKilled}ÎßàÎ¶¨ | ÌöçÎìù: ${huntState.totalGoldEarned.toLocaleString()}G
                </span>
            `;
            
            document.getElementById('newWeaponPreview').style.display = 'block';
            const newGradeData = GRADES[state.weapon.grade];
            document.getElementById('newWeaponName').innerHTML = 
                `<span style="color:${newGradeData.color}">[${newGradeData.name}] ${state.weapon.name}</span>`;
            
            document.getElementById('resultBtn').textContent = 'Î©îÏù∏ÏúºÎ°ú';
            document.getElementById('resultBtn').onclick = () => {
                closeResult();
                huntState = null;
                showMain();
            };
            
            overlay.classList.add('show');
        }

        function exitHunt() {
            // Use the same run away logic
            if (huntState && huntState.monster) {
                huntRunAway();
            } else {
                huntState = null;
                showMain();
            }
        }

        // ===== CONFETTI =====
        function fireConfetti() {
            const canvas = document.getElementById('confetti');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const pieces = [];
            const colors = ['#e94560', '#ffd700', '#4ecca3', '#00d9ff', '#ff6b6b', '#ff8000', '#00ff80'];

            for (let i = 0; i < 100; i++) {
                pieces.push({
                    x: canvas.width / 2,
                    y: canvas.height / 2,
                    vx: (Math.random() - 0.5) * 20,
                    vy: (Math.random() - 0.5) * 20 - 10,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    size: Math.random() * 8 + 4,
                    rotation: Math.random() * 360
                });
            }

            let frame = 0;
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                pieces.forEach(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.5;
                    p.rotation += 5;
                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.rotation * Math.PI / 180);
                    ctx.fillStyle = p.color;
                    ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
                    ctx.restore();
                });
                frame++;
                if (frame < 100) requestAnimationFrame(animate);
                else ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            animate();
        }

        // ===== INIT =====
        loadState();
        showMain();
    </script>
</body>
</html>
