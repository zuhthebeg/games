<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Î¨¥Í∏∞ Í∞ïÌôî & Î∞∞ÌãÄ</title>
    <link rel="icon" href="icon.svg">
    <script src="/lib/multiplayer.js?v=20260210v3"></script>
    <script src="/lib/multiplayer-ui.js?v=20260210v3"></script>
    <style>
        :root {
            --bg: #1a1a2e;
            --card: #16213e;
            --accent: #e94560;
            --success: #4ecca3;
            --fail: #ff6b6b;
            --gold: #ffd700;
            --text: #eee;
            --muted: #888;
            --hp: #4ecca3;
            --damage: #ff6b6b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        #app { min-height: 100vh; }

        .container {
            max-width: 420px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 24px;
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 4px;
            background: linear-gradient(135deg, var(--accent), var(--gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle { color: var(--muted); font-size: 0.9rem; }

        /* Mode Selection */
        .mode-select {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-top: 40px;
        }

        .mode-btn {
            padding: 24px;
            border: none;
            border-radius: 16px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .mode-btn:hover { transform: translateY(-2px); }

        .mode-btn.enhance {
            background: linear-gradient(135deg, #e94560, #ff8a80);
            color: white;
        }

        .mode-btn.battle {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .mode-icon { font-size: 2rem; }
        .mode-info { text-align: left; }
        .mode-title { font-size: 1.1rem; }
        .mode-desc { font-size: 0.8rem; opacity: 0.8; font-weight: normal; }

        /* Weapon Display */
        .weapon-display {
            background: var(--card);
            border-radius: 20px;
            padding: 24px;
            text-align: center;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .weapon-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--accent) 0%, transparent 70%);
            opacity: 0.3;
            pointer-events: none;
        }

        .weapon-icon {
            font-size: 64px;
            margin-bottom: 12px;
            position: relative;
            z-index: 1;
            filter: drop-shadow(0 0 20px var(--accent));
            transition: all 0.3s;
        }

        .weapon-icon.shake { animation: shake 0.5s ease-in-out; }
        .weapon-icon.glow-success { filter: drop-shadow(0 0 30px var(--success)) drop-shadow(0 0 60px var(--success)); }
        .weapon-icon.glow-fail { filter: drop-shadow(0 0 30px var(--fail)) drop-shadow(0 0 60px var(--fail)); }

        @keyframes shake {
            0%, 100% { transform: translateX(0) rotate(0); }
            20% { transform: translateX(-8px) rotate(-5deg); }
            40% { transform: translateX(8px) rotate(5deg); }
            60% { transform: translateX(-8px) rotate(-5deg); }
            80% { transform: translateX(8px) rotate(5deg); }
        }

        .weapon-level {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 4px;
            position: relative;
            z-index: 1;
        }

        .weapon-level.legendary {
            background: linear-gradient(135deg, #ff6b6b, #ffd700, #4ecca3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .weapon-name { color: var(--muted); font-size: 0.95rem; }

        /* Stats Display */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: var(--card);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
        }

        .stat-icon { font-size: 1.2rem; margin-bottom: 4px; }
        .stat-value { font-size: 1.1rem; font-weight: 600; }
        .stat-value.damage { color: var(--damage); }
        .stat-value.crit { color: var(--gold); }
        .stat-label { font-size: 0.7rem; color: var(--muted); }

        /* Enhance Info */
        .enhance-card {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .info-row:last-child { margin-bottom: 0; }
        .info-label { color: var(--muted); }
        .info-value { font-weight: 600; }
        .info-value.danger { color: var(--fail); }
        .info-value.safe { color: var(--success); }

        /* Buttons */
        .btn-group { display: flex; gap: 12px; }

        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-enhance {
            background: linear-gradient(135deg, var(--accent), #ff8a80);
            color: white;
        }

        .btn-enhance:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(233, 69, 96, 0.4);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: var(--text);
            flex: 0.3;
        }

        .btn-battle {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-back {
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            font-size: 0.9rem;
            padding: 8px 0;
            margin-bottom: 16px;
        }

        /* Battle Screen */
        .battle-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .battle-header {
            text-align: center;
            padding: 16px;
            background: var(--card);
        }

        .battle-title { font-size: 1.2rem; font-weight: 600; }
        .battle-round { color: var(--muted); font-size: 0.9rem; }

        .battle-arena {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 20px;
        }

        .fighter {
            background: var(--card);
            border-radius: 16px;
            padding: 16px;
        }

        .fighter.me { border: 2px solid var(--accent); }
        .fighter.enemy { border: 2px solid #667eea; }

        .fighter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .fighter-name { font-weight: 600; }
        .fighter-weapon { color: var(--muted); font-size: 0.85rem; }

        .hp-bar-container {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            height: 24px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .hp-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--hp), #2ecc71);
            border-radius: 10px;
            transition: width 0.5s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
            min-width: 60px;
        }

        .hp-bar.low { background: linear-gradient(90deg, var(--fail), #ff8a80); }

        .fighter-stats {
            display: flex;
            gap: 16px;
            font-size: 0.85rem;
            color: var(--muted);
        }

        .battle-log {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            max-height: 150px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.85rem;
        }

        .log-entry:last-child { border-bottom: none; }
        .log-entry.crit { color: var(--gold); }
        .log-entry.damage { color: var(--damage); }
        .log-entry.heal { color: var(--success); }

        .battle-actions {
            padding: 16px 20px;
            background: var(--card);
        }

        .action-btns {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .action-btn {
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .action-btn.attack {
            background: var(--damage);
            color: white;
        }

        .action-btn.defend {
            background: #3498db;
            color: white;
        }

        /* Result Popup */
        .overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 99;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .overlay.show { opacity: 1; pointer-events: auto; }

        .result-popup {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: var(--card);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            z-index: 100;
            transition: transform 0.3s ease-out;
            min-width: 280px;
        }

        .result-popup.show { transform: translate(-50%, -50%) scale(1); }
        .result-popup.success { border: 3px solid var(--success); }
        .result-popup.fail { border: 3px solid var(--fail); }

        .result-icon { font-size: 4rem; margin-bottom: 16px; }
        .result-text { font-size: 1.5rem; font-weight: 700; margin-bottom: 8px; }
        .result-detail { color: var(--muted); margin-bottom: 20px; }

        .result-btn {
            padding: 12px 32px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            background: var(--accent);
            color: white;
        }

        /* Confetti */
        .confetti {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: var(--muted);
            font-size: 0.8rem;
        }

        footer a { color: var(--accent); }
    </style>
</head>
<body>
    <div id="app"></div>
    <div class="overlay" id="overlay"></div>
    <div class="result-popup" id="resultPopup">
        <div class="result-icon" id="resultIcon">‚ú®</div>
        <div class="result-text" id="resultText">Í∞ïÌôî ÏÑ±Í≥µ!</div>
        <div class="result-detail" id="resultDetail"></div>
        <button class="result-btn" id="resultBtn" onclick="closeResult()">ÌôïÏù∏</button>
    </div>
    <canvas class="confetti" id="confetti"></canvas>

    <script>
        // ===== Game State =====
        let state = {
            level: 0,
            attempts: 0,
            successes: 0,
            fails: 0,
            destroys: 0,
            protectionScrolls: 3,
            useProtection: false
        };

        let mpUI = null;
        let battleState = null;

        // ===== Enhancement Rates =====
        const RATES = {
            0: { success: 95, destroy: 0, downgrade: 0 },
            1: { success: 90, destroy: 0, downgrade: 0 },
            2: { success: 85, destroy: 0, downgrade: 0 },
            3: { success: 80, destroy: 0, downgrade: 0 },
            4: { success: 75, destroy: 0, downgrade: 0 },
            5: { success: 70, destroy: 0, downgrade: 0 },
            6: { success: 65, destroy: 0, downgrade: 5 },
            7: { success: 60, destroy: 0, downgrade: 10 },
            8: { success: 55, destroy: 0, downgrade: 15 },
            9: { success: 50, destroy: 0, downgrade: 20 },
            10: { success: 45, destroy: 5, downgrade: 20 },
            11: { success: 40, destroy: 10, downgrade: 20 },
            12: { success: 35, destroy: 15, downgrade: 20 },
            13: { success: 30, destroy: 20, downgrade: 20 },
            14: { success: 25, destroy: 25, downgrade: 20 },
            15: { success: 20, destroy: 30, downgrade: 20 },
            16: { success: 15, destroy: 35, downgrade: 20 },
            17: { success: 10, destroy: 40, downgrade: 20 },
            18: { success: 7, destroy: 45, downgrade: 20 },
            19: { success: 5, destroy: 50, downgrade: 20 },
            20: { success: 3, destroy: 55, downgrade: 20 }
        };

        const WEAPON_NAMES = {
            0: 'Ï¥àÎ≥¥ÏûêÏùò Í≤Ä', 5: 'ÏàôÎ†®ÏûêÏùò Í≤Ä', 10: 'Ï†ÑÏÇ¨Ïùò Í≤Ä',
            13: 'ÏòÅÏõÖÏùò Í≤Ä', 15: 'Ï†ÑÏÑ§Ïùò Í≤Ä', 18: 'Ïã†ÌôîÏùò Í≤Ä', 20: 'Ïã†Ïùò Í≤Ä'
        };

        const WEAPON_ICONS = {
            0: 'üó°Ô∏è', 10: '‚öîÔ∏è', 15: 'üî±', 18: '‚ú®', 20: 'üíé'
        };

        // ===== Weapon Stats =====
        function getWeaponStats(level) {
            const baseDamageMin = 10;
            const baseDamageMax = 15;
            const damagePerLevel = 5;
            const baseCritChance = 5;
            const critPerLevel = 2;
            const baseCritDamage = 150;
            const critDamagePerLevel = 5;

            return {
                damageMin: baseDamageMin + (level * damagePerLevel),
                damageMax: baseDamageMax + (level * damagePerLevel),
                critChance: Math.min(50, baseCritChance + (level * critPerLevel)),
                critDamage: baseCritDamage + (level * critDamagePerLevel),
                hp: 100 + (level * 20)
            };
        }

        function getWeaponName(level) {
            let name = WEAPON_NAMES[0];
            for (const [lvl, n] of Object.entries(WEAPON_NAMES)) {
                if (level >= parseInt(lvl)) name = n;
            }
            return name;
        }

        function getWeaponIcon(level) {
            let icon = WEAPON_ICONS[0];
            for (const [lvl, i] of Object.entries(WEAPON_ICONS)) {
                if (level >= parseInt(lvl)) icon = i;
            }
            return icon;
        }

        // ===== Local Storage =====
        function loadState() {
            const saved = localStorage.getItem('enhance_state_v2');
            if (saved) state = { ...state, ...JSON.parse(saved) };
        }

        function saveState() {
            localStorage.setItem('enhance_state_v2', JSON.stringify(state));
        }

        // ===== Mode Selection =====
        function showModeSelect() {
            const stats = getWeaponStats(state.level);
            document.getElementById('app').innerHTML = `
                <div class="container">
                    <header>
                        <h1>‚öîÔ∏è Î¨¥Í∏∞ Í∞ïÌôî & Î∞∞ÌãÄ</h1>
                        <p class="subtitle">Í∞ïÌôîÌïòÍ≥† Ïã∏ÏõåÎùº!</p>
                    </header>

                    <div class="weapon-display">
                        <div class="weapon-glow"></div>
                        <div class="weapon-icon">${getWeaponIcon(state.level)}</div>
                        <div class="weapon-level ${state.level >= 15 ? 'legendary' : ''}">+${state.level}</div>
                        <div class="weapon-name">${getWeaponName(state.level)}</div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-icon">‚öîÔ∏è</div>
                            <div class="stat-value damage">${stats.damageMin}-${stats.damageMax}</div>
                            <div class="stat-label">Îç∞ÎØ∏ÏßÄ</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-icon">üí•</div>
                            <div class="stat-value crit">${stats.critChance}%</div>
                            <div class="stat-label">ÌÅ¨Î¶¨Ìã∞Ïª¨</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-icon">‚ù§Ô∏è</div>
                            <div class="stat-value">${stats.hp}</div>
                            <div class="stat-label">HP</div>
                        </div>
                    </div>

                    <div class="mode-select">
                        <button class="mode-btn enhance" onclick="showEnhance()">
                            <span class="mode-icon">üî®</span>
                            <div class="mode-info">
                                <div class="mode-title">Í∞ïÌôîÌïòÍ∏∞</div>
                                <div class="mode-desc">Î¨¥Í∏∞Î•º Îçî Í∞ïÌïòÍ≤å!</div>
                            </div>
                        </button>
                        <button class="mode-btn battle" onclick="showBattleLobby()">
                            <span class="mode-icon">‚öîÔ∏è</span>
                            <div class="mode-info">
                                <div class="mode-title">Î∞∞ÌãÄ</div>
                                <div class="mode-desc">Îã§Î•∏ ÌîåÎ†àÏù¥Ïñ¥ÏôÄ ÎåÄÍ≤∞!</div>
                            </div>
                        </button>
                    </div>

                    <footer>
                        ¬© 2026 <a href="https://game.cocy.io">game.cocy.io</a>
                    </footer>
                </div>
            `;
        }

        // ===== Enhance Mode =====
        function showEnhance() {
            const stats = getWeaponStats(state.level);
            const rates = RATES[Math.min(state.level, 20)];
            const showProtection = rates.destroy > 0;

            document.getElementById('app').innerHTML = `
                <div class="container">
                    <button class="btn-back" onclick="showModeSelect()">‚Üê Îí§Î°ú</button>

                    <div class="weapon-display">
                        <div class="weapon-glow"></div>
                        <div class="weapon-icon" id="weaponIcon">${getWeaponIcon(state.level)}</div>
                        <div class="weapon-level ${state.level >= 15 ? 'legendary' : ''}" id="weaponLevel">+${state.level}</div>
                        <div class="weapon-name" id="weaponName">${getWeaponName(state.level)}</div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-icon">‚öîÔ∏è</div>
                            <div class="stat-value damage" id="statDamage">${stats.damageMin}-${stats.damageMax}</div>
                            <div class="stat-label">Îç∞ÎØ∏ÏßÄ</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-icon">üí•</div>
                            <div class="stat-value crit" id="statCrit">${stats.critChance}%</div>
                            <div class="stat-label">ÌÅ¨Î¶¨Ìã∞Ïª¨</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-icon">‚ù§Ô∏è</div>
                            <div class="stat-value" id="statHp">${stats.hp}</div>
                            <div class="stat-label">HP</div>
                        </div>
                    </div>

                    <div class="enhance-card">
                        <div class="info-row">
                            <span class="info-label">ÏÑ±Í≥µ ÌôïÎ•†</span>
                            <span class="info-value" id="successRate">${rates.success}%</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ÌååÍ¥¥ ÌôïÎ•†</span>
                            <span class="info-value ${rates.destroy > 0 ? 'danger' : 'safe'}" id="destroyRate">${rates.destroy}%</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ÌïòÎùΩ ÌôïÎ•†</span>
                            <span class="info-value ${rates.downgrade > 0 ? 'danger' : ''}" id="downgradeRate">${rates.downgrade}%</span>
                        </div>
                    </div>

                    ${showProtection ? `
                    <div class="enhance-card" style="border: 1px solid var(--gold);">
                        <div class="info-row">
                            <span>üõ°Ô∏è ÌååÍ¥¥ Î∞©ÏßÄ (${state.protectionScrolls}Í∞ú)</span>
                            <button class="btn-secondary" style="flex:0;padding:8px 16px;" onclick="toggleProtection()" id="protectionBtn">
                                ${state.useProtection ? 'ON' : 'OFF'}
                            </button>
                        </div>
                    </div>
                    ` : ''}

                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="resetWeapon()">üîÑ</button>
                        <button class="btn btn-enhance" id="enhanceBtn" onclick="enhance()" ${state.level >= 20 ? 'disabled' : ''}>
                            ${state.level >= 20 ? 'üèÜ MAX' : '‚ö° Í∞ïÌôîÌïòÍ∏∞'}
                        </button>
                    </div>

                    <div class="enhance-card" style="margin-top:16px;">
                        <div class="info-row">
                            <span class="info-label">ÏãúÎèÑ</span>
                            <span>${state.attempts}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ÏÑ±Í≥µ/Ïã§Ìå®/ÌååÍ¥¥</span>
                            <span style="color:var(--success)">${state.successes}</span> / 
                            <span style="color:var(--fail)">${state.fails}</span> / 
                            <span>${state.destroys}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleProtection() {
            if (state.protectionScrolls > 0) {
                state.useProtection = !state.useProtection;
                document.getElementById('protectionBtn').textContent = state.useProtection ? 'ON' : 'OFF';
            }
        }

        function enhance() {
            if (state.level >= 20) return;

            const weaponIcon = document.getElementById('weaponIcon');
            weaponIcon.classList.add('shake');
            setTimeout(() => weaponIcon.classList.remove('shake'), 500);

            const rates = RATES[state.level];
            const roll = Math.random() * 100;
            const from = state.level;
            let to = from;
            let result = 'fail';

            state.attempts++;

            if (roll < rates.success) {
                to = from + 1;
                result = 'success';
                state.successes++;
                weaponIcon.classList.add('glow-success');
                setTimeout(() => weaponIcon.classList.remove('glow-success'), 1000);
            } else if (roll < rates.success + rates.destroy) {
                result = 'destroy';
                state.destroys++;
                if (state.useProtection && state.protectionScrolls > 0) {
                    state.protectionScrolls--;
                    state.useProtection = false;
                    to = from;
                } else {
                    to = 0;
                }
                weaponIcon.classList.add('glow-fail');
                setTimeout(() => weaponIcon.classList.remove('glow-fail'), 1000);
            } else if (roll < rates.success + rates.destroy + rates.downgrade) {
                to = Math.max(0, from - 1);
                result = 'fail';
                state.fails++;
                weaponIcon.classList.add('glow-fail');
                setTimeout(() => weaponIcon.classList.remove('glow-fail'), 1000);
            } else {
                to = from;
                result = 'fail';
                state.fails++;
            }

            state.level = to;
            saveState();

            setTimeout(() => {
                showEnhanceResult(result, from, to);
            }, 300);
        }

        function showEnhanceResult(type, from, to) {
            const popup = document.getElementById('resultPopup');
            const overlay = document.getElementById('overlay');

            popup.className = 'result-popup ' + (type === 'success' ? 'success' : 'fail');
            document.getElementById('resultIcon').textContent = type === 'success' ? '‚ú®' : (type === 'destroy' ? 'üí•' : 'üíî');
            document.getElementById('resultText').textContent = type === 'success' ? 'Í∞ïÌôî ÏÑ±Í≥µ!' : (type === 'destroy' ? 'Î¨¥Í∏∞ ÌååÍ¥¥!' : 'Í∞ïÌôî Ïã§Ìå®...');
            document.getElementById('resultText').style.color = type === 'success' ? 'var(--success)' : 'var(--fail)';
            document.getElementById('resultDetail').textContent = `+${from} ‚Üí +${to}`;
            document.getElementById('resultBtn').textContent = 'ÌôïÏù∏';
            document.getElementById('resultBtn').onclick = () => { closeResult(); showEnhance(); };

            overlay.classList.add('show');
            popup.classList.add('show');

            if (type === 'success' && to >= 15) fireConfetti();
        }

        function closeResult() {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('resultPopup').classList.remove('show');
        }

        function resetWeapon() {
            if (state.level === 0 || confirm('Ï†ïÎßê Î¨¥Í∏∞Î•º Ï¥àÍ∏∞ÌôîÌï†ÍπåÏöî?')) {
                state.level = 0;
                state.useProtection = false;
                saveState();
                showEnhance();
            }
        }

        // ===== Battle Mode =====
        function showBattleLobby() {
            mpUI = new MultiplayerUI({
                gameType: 'enhance',
                gameName: '‚öîÔ∏è Î¨¥Í∏∞ Î∞∞ÌãÄ',
                container: document.getElementById('app'),
                maxPlayers: 2,
                supportsLocal: false,
                onGameStart: handleBattleStart,
                onGameEvent: handleBattleEvent,
                onLeave: () => { battleState = null; showModeSelect(); }
            });

            const roomCode = MultiplayerUI.checkUrlRoom();
            if (roomCode) {
                mpUI._renderLobby();
                setTimeout(() => {
                    document.getElementById('mp-room-code').value = roomCode;
                }, 100);
            } else {
                mpUI.show();
            }
        }

        function handleBattleStart(gameState) {
            battleState = gameState;
            renderBattle();
        }

        function handleBattleEvent(type, data) {
            if (type === 'state_update') {
                battleState = data;
                renderBattle();
            } else if (type === 'game_end') {
                showBattleResult(data);
            }
        }

        function renderBattle() {
            if (!battleState || !battleState.gameState) return;

            const gs = battleState.gameState;
            const myId = mpUI.getClient().getMyUserId();
            const me = gs.players.find(p => p.id === myId);
            const enemy = gs.players.find(p => p.id !== myId);
            const isMyTurn = gs.currentTurn === myId;

            document.getElementById('app').innerHTML = `
                <div class="battle-screen">
                    <div class="battle-header">
                        <div class="battle-title">‚öîÔ∏è Î∞∞ÌãÄ!</div>
                        <div class="battle-round">ÎùºÏö¥Îìú ${gs.round} | ${isMyTurn ? 'ÎÇ¥ ÌÑ¥' : 'ÏÉÅÎåÄ ÌÑ¥'}</div>
                    </div>

                    <div class="battle-arena">
                        <div class="fighter enemy">
                            <div class="fighter-header">
                                <span class="fighter-name">üë§ ${enemy?.nickname || 'ÏÉÅÎåÄ'}</span>
                                <span class="fighter-weapon">+${enemy?.weaponLevel || 0} ${getWeaponIcon(enemy?.weaponLevel || 0)}</span>
                            </div>
                            <div class="hp-bar-container">
                                <div class="hp-bar ${enemy?.hp < 30 ? 'low' : ''}" style="width: ${(enemy?.hp / enemy?.maxHp) * 100}%">
                                    ${enemy?.hp} / ${enemy?.maxHp}
                                </div>
                            </div>
                            <div class="fighter-stats">
                                <span>‚öîÔ∏è ${enemy?.damageMin}-${enemy?.damageMax}</span>
                                <span>üí• ${enemy?.critChance}%</span>
                            </div>
                        </div>

                        <div class="fighter me">
                            <div class="fighter-header">
                                <span class="fighter-name">üéÆ ${me?.nickname || 'ÎÇò'}</span>
                                <span class="fighter-weapon">+${me?.weaponLevel || 0} ${getWeaponIcon(me?.weaponLevel || 0)}</span>
                            </div>
                            <div class="hp-bar-container">
                                <div class="hp-bar ${me?.hp < 30 ? 'low' : ''}" style="width: ${(me?.hp / me?.maxHp) * 100}%">
                                    ${me?.hp} / ${me?.maxHp}
                                </div>
                            </div>
                            <div class="fighter-stats">
                                <span>‚öîÔ∏è ${me?.damageMin}-${me?.damageMax}</span>
                                <span>üí• ${me?.critChance}%</span>
                            </div>
                        </div>

                        <div class="battle-log" id="battleLog">
                            ${(gs.log || []).slice(-5).map(entry => `
                                <div class="log-entry ${entry.type}">${entry.text}</div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="battle-actions">
                        <div class="action-btns">
                            <button class="action-btn attack" onclick="battleAction('attack')" ${!isMyTurn ? 'disabled' : ''}>
                                ‚öîÔ∏è Í≥µÍ≤©
                            </button>
                            <button class="action-btn defend" onclick="battleAction('defend')" ${!isMyTurn ? 'disabled' : ''}>
                                üõ°Ô∏è Î∞©Ïñ¥
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function battleAction(action) {
            if (!mpUI || !mpUI.getClient()) return;
            try {
                await mpUI.sendAction({ type: action });
            } catch (e) {
                console.error('Battle action error:', e);
            }
        }

        function showBattleResult(data) {
            const myId = mpUI.getClient().getMyUserId();
            const isWin = data.winnerId === myId;

            mpUI.showResult({
                title: isWin ? 'üèÜ ÏäπÎ¶¨!' : 'üíÄ Ìå®Î∞∞...',
                detail: `${data.winnerNickname}Ïùò ÏäπÎ¶¨!`,
                isWin: isWin,
                showRematch: true
            });
        }

        // ===== Confetti =====
        function fireConfetti() {
            const canvas = document.getElementById('confetti');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const pieces = [];
            const colors = ['#e94560', '#ffd700', '#4ecca3', '#00d9ff', '#ff6b6b'];

            for (let i = 0; i < 100; i++) {
                pieces.push({
                    x: canvas.width / 2,
                    y: canvas.height / 2,
                    vx: (Math.random() - 0.5) * 20,
                    vy: (Math.random() - 0.5) * 20 - 10,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    size: Math.random() * 8 + 4,
                    rotation: Math.random() * 360
                });
            }

            let frame = 0;
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                pieces.forEach(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.5;
                    p.rotation += 5;
                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.rotation * Math.PI / 180);
                    ctx.fillStyle = p.color;
                    ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
                    ctx.restore();
                });
                frame++;
                if (frame < 100) requestAnimationFrame(animate);
                else ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            animate();
        }

        // ===== Init =====
        loadState();
        showModeSelect();
    </script>
</body>
</html>
