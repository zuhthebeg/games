<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f)})(window,document,'script','dataLayer','GTM-MV8KQGJF');</script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6634731722045607" crossorigin="anonymous"></script>
    <link rel="canonical" href="https://game.cocy.io/enhance/">
    <meta property="og:url" content="https://game.cocy.io/enhance/">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="ko_KR">
    <title>Î¨¥Í∏∞ Í∞ïÌôî & Î∞∞ÌãÄ</title>
    <link rel="icon" href="icon.svg">
    <script>if(location.search.includes('debug=1')){var s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/eruda';s.onload=function(){eruda.init()};document.head.appendChild(s)}</script>
    <script src="/lib/multiplayer.js?v=20260213v1"></script>
    <script src="/lib/multiplayer-ui.js?v=20260210v9"></script>
    <script src="/lib/shared-wallet.js?v=20260220"></script>
    <style>
        :root {
            --bg: #0d0d0d;
            --card: #1a1a1a;
            --card-border: #2a2a2a;
            --accent: #e94560;
            --success: #4ecca3;
            --fail: #ff6b6b;
            --gold: #ffd700;
            --text: #eee;
            --muted: #777;
            
            /* Rarity colors */
            --common: #9d9d9d;
            --magic: #5555ff;
            --rare: #ffcc00;
            --legendary: #ff8000;
            --unique: #00ff80;
            --mythic: #ff00ff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Segoe UI', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding-top: calc(48px + env(safe-area-inset-top)); /* SharedWallet bar */
            background-image: 
                radial-gradient(ellipse at top, rgba(233,69,96,0.1) 0%, transparent 50%),
                radial-gradient(ellipse at bottom, rgba(78,204,163,0.05) 0%, transparent 50%);
        }

        #app { min-height: 100vh; }

        .container {
            max-width: 440px;
            width: 100%;
            margin: 0 auto;
            padding: 10px;
            position: relative;
        }

        header {
            text-align: center;
            margin-bottom: 4px;
            padding-top: 2px;
        }

        h1 {
            font-size: 1.2rem;
            margin-bottom: 2px;
            background: linear-gradient(135deg, var(--accent), var(--gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle { color: var(--muted); font-size: 0.75rem; }

        /* Gold Display - hidden, using global SharedWallet bar */
        .gold-display {
            display: none !important;
        }
        
        /* Home button - bottom action area (smaller than enhance) */
        .btn-home {
            background: linear-gradient(135deg, #555, #333);
            color: white;
            flex: 0 0 44px;
            font-size: 1rem;
            padding: 10px;
            min-height: auto;
        }
        .btn-home:hover:not(:disabled) {
            background: linear-gradient(135deg, #666, #444);
        }
        
        .gold-display-legacy {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            background: linear-gradient(135deg, rgba(255,215,0,0.15), rgba(255,215,0,0.05));
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 16px;
            padding: 6px 14px;
            margin: 0 auto 10px;
            width: fit-content;
            font-size: 0.9rem;
        }

        .gold-icon { font-size: 1.2rem; }
        .gold-amount { font-size: 1.1rem; font-weight: 700; color: var(--gold); }

        /* Weapon Card */
        .weapon-card {
            background: var(--card);
            border: 2px solid var(--card-border);
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 6px;
            position: relative;
            overflow: hidden;
        }

        .weapon-card.common { border-color: var(--common); }
        .weapon-card.magic { border-color: var(--magic); box-shadow: 0 0 20px rgba(85,85,255,0.2); }
        .weapon-card.rare { border-color: var(--rare); box-shadow: 0 0 25px rgba(255,204,0,0.2); }
        .weapon-card.legendary { border-color: var(--legendary); box-shadow: 0 0 30px rgba(255,128,0,0.3); }
        .weapon-card.unique { border-color: var(--unique); box-shadow: 0 0 35px rgba(0,255,128,0.3); }
        .weapon-card.mythic { 
            border-color: var(--mythic); 
            box-shadow: 0 0 40px rgba(255,0,255,0.4), 0 0 80px rgba(255,0,255,0.2);
            animation: mythicGlow 2s ease-in-out infinite;
        }
        @keyframes mythicGlow {
            0%, 100% { box-shadow: 0 0 40px rgba(255,0,255,0.4), 0 0 80px rgba(255,0,255,0.2); }
            50% { box-shadow: 0 0 60px rgba(255,0,255,0.6), 0 0 100px rgba(255,0,255,0.3), 0 0 120px rgba(0,255,255,0.2); }
        }

        .weapon-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .weapon-info { flex: 1; }

        .weapon-grade {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .weapon-grade.common { color: var(--common); }
        .weapon-grade.magic { color: var(--magic); }
        .weapon-grade.rare { color: var(--rare); }
        .weapon-grade.legendary { color: var(--legendary); }
        .weapon-grade.unique { color: var(--unique); }
        .weapon-grade.mythic { 
            color: var(--mythic); 
            text-shadow: 0 0 10px rgba(255,0,255,0.8);
            animation: mythicText 1.5s ease-in-out infinite;
        }
        @keyframes mythicText {
            0%, 100% { text-shadow: 0 0 10px rgba(255,0,255,0.8); }
            50% { text-shadow: 0 0 20px rgba(255,0,255,1), 0 0 30px rgba(0,255,255,0.5); }
        }

        .weapon-name {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .weapon-type { color: var(--muted); font-size: 0.85rem; }

        .weapon-level {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 8px 14px;
            text-align: center;
        }

        .weapon-level-number {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .weapon-level-label { font-size: 0.7rem; color: var(--muted); }

        .weapon-icon-area {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 12px;
            position: relative;
        }

        .weapon-icon {
            width: 80px;
            height: 80px;
            filter: drop-shadow(0 0 15px currentColor);
            transition: all 0.3s;
        }

        /* Ï†ÑÏÑ§ PNG Ïù¥ÎØ∏ÏßÄ */
        .weapon-icon.legendary-img {
            border-radius: 0;
        }
        
        /* üëø Ï†ÄÏ£ºÎ∞õÏùÄ Î¨¥Í∏∞ */
        .weapon-icon.cursed-weapon {
            animation: cursedPulse 2s ease-in-out infinite;
        }
        @keyframes cursedPulse {
            0%, 100% { filter: drop-shadow(0 0 15px #8b00ff) drop-shadow(0 0 30px #5500aa) hue-rotate(270deg) saturate(2); }
            50% { filter: drop-shadow(0 0 25px #bb00ff) drop-shadow(0 0 50px #8800dd) hue-rotate(270deg) saturate(3); }
        }

        .weapon-icon.shake { animation: shake 0.5s ease-in-out; }
        .weapon-icon.glow-success { filter: drop-shadow(0 0 30px var(--success)) drop-shadow(0 0 60px var(--success)) brightness(1.3); }
        .weapon-icon.glow-fail { filter: drop-shadow(0 0 30px var(--fail)) drop-shadow(0 0 60px var(--fail)) brightness(0.8); }
        .weapon-icon.hit { animation: hitEffect 0.3s ease-out; }
        
        /* Enhancement Level Backgrounds */
        .weapon-card.level-0-3 { background: linear-gradient(135deg, #1a1a1a 0%, #252525 100%); }
        .weapon-card.level-4-7 { background: linear-gradient(135deg, #1a1a2a 0%, #252540 100%); }
        
        /* +8~9: ÌååÎûÄ Ïò§Îùº + ÌùîÎì§Î¶º */
        .weapon-card.level-8-9 { 
            background: linear-gradient(135deg, #0a1525 0%, #1a3050 100%);
            animation: auraPulse8 2s ease-in-out infinite, auraShake 4s ease-in-out infinite;
            position: relative;
        }
        .weapon-card.level-8-9::before {
            content: '';
            position: absolute;
            inset: -3px;
            background: linear-gradient(45deg, #00f, #0ff, #00f);
            border-radius: 14px;
            z-index: -1;
            animation: borderRotate 3s linear infinite;
            filter: blur(8px);
            opacity: 0.6;
        }
        
        /* +10~12: Î≥¥Îùº Ïò§Îùº + Îñ†Îã§ÎãàÎäî ÏûÖÏûê */
        .weapon-card.level-10-12 { 
            background: linear-gradient(135deg, #150a25 0%, #351a55 100%);
            animation: auraPulse10 1.8s ease-in-out infinite;
            position: relative;
        }
        .weapon-card.level-10-12::before {
            content: '';
            position: absolute;
            inset: -4px;
            background: linear-gradient(45deg, #8000ff, #ff00ff, #8000ff, #00ffff);
            background-size: 300% 300%;
            border-radius: 14px;
            z-index: -1;
            animation: borderRotate 2s linear infinite, rainbowBg 3s ease infinite;
            filter: blur(10px);
            opacity: 0.7;
        }
        .weapon-card.level-10-12::after {
            content: '‚ú®';
            position: absolute;
            font-size: 1.5rem;
            animation: floatParticle 2s ease-in-out infinite;
            top: 10px; right: 10px;
        }
        
        /* +13~15: Î∂âÏùÄ ÌôîÏóº Ïò§Îùº */
        .weapon-card.level-13-15 { 
            background: linear-gradient(135deg, #200a0a 0%, #401515 100%);
            animation: auraPulse13 1.5s ease-in-out infinite, fireFlicker 0.1s linear infinite;
            position: relative;
        }
        .weapon-card.level-13-15::before {
            content: '';
            position: absolute;
            inset: -5px;
            background: linear-gradient(45deg, #ff0000, #ff6600, #ff0000, #ffff00);
            background-size: 400% 400%;
            border-radius: 15px;
            z-index: -1;
            animation: borderRotate 1.5s linear infinite, rainbowBg 2s ease infinite;
            filter: blur(12px);
            opacity: 0.8;
        }
        .weapon-card.level-13-15::after {
            content: 'üî•';
            position: absolute;
            font-size: 1.2rem;
            animation: floatParticle 1.5s ease-in-out infinite;
            top: 5px; right: 15px;
        }
        
        /* +16~18: Ìô©Í∏à Ï†ÑÏÑ§ Ïò§Îùº */
        .weapon-card.level-16-18 { 
            background: linear-gradient(135deg, #1a1505 0%, #3a2a0a 100%);
            animation: auraPulse16 1.2s ease-in-out infinite;
            position: relative;
        }
        .weapon-card.level-16-18::before {
            content: '';
            position: absolute;
            inset: -6px;
            background: linear-gradient(45deg, #ffd700, #ff8c00, #ffd700, #fff);
            background-size: 400% 400%;
            border-radius: 16px;
            z-index: -1;
            animation: borderRotate 1s linear infinite, rainbowBg 1.5s ease infinite;
            filter: blur(15px);
            opacity: 0.9;
        }
        .weapon-card.level-16-18::after {
            content: '‚≠êüí´';
            position: absolute;
            font-size: 1rem;
            animation: floatParticle 1s ease-in-out infinite, sparkle 0.5s ease infinite;
            top: 3px; right: 10px;
        }
        
        /* +19~20: Ïö∞Ï£º Ïò§Îùº */
        .weapon-card.level-19-20 { 
            background: linear-gradient(45deg, #0a0020, #200040, #002040, #100030);
            background-size: 400% 400%;
            animation: rainbowBg 4s ease infinite, auraPulse20 1s ease-in-out infinite;
            position: relative;
        }
        .weapon-card.level-19-20::before {
            content: '';
            position: absolute;
            inset: -8px;
            background: conic-gradient(from 0deg, #ff0080, #ff8c00, #40e0d0, #00ff00, #0080ff, #8000ff, #ff0080);
            border-radius: 18px;
            z-index: -1;
            animation: borderRotate 2s linear infinite;
            filter: blur(20px);
            opacity: 1;
        }
        .weapon-card.level-19-20::after {
            content: 'üåü‚ú®üíé';
            position: absolute;
            font-size: 1rem;
            animation: floatParticle 0.8s ease-in-out infinite;
            top: 0; right: 5px;
        }
        
        /* +21: Ïã†Í∏â Î¨¥Í∏∞ - ÏµúÍ≥† Ìö®Í≥º */
        .weapon-card.level-21 { 
            background: linear-gradient(45deg, #000, #100010, #001010, #101000, #000);
            background-size: 600% 600%;
            animation: rainbowBg 2s ease infinite;
            position: relative;
        }
        .weapon-card.level-21::before {
            content: '';
            position: absolute;
            inset: -10px;
            background: conic-gradient(from 0deg, #ff0000, #ff8000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000);
            border-radius: 20px;
            z-index: -1;
            animation: borderRotate 1s linear infinite;
            filter: blur(25px);
            opacity: 1;
        }
        .weapon-card.level-21::after {
            content: 'üëëüåà‚ö°üíé‚ú®';
            position: absolute;
            font-size: 0.9rem;
            animation: floatParticle 0.5s ease-in-out infinite, sparkle 0.3s ease infinite;
            top: -5px; right: 0;
        }
        
        @keyframes auraPulse8 {
            0%, 100% { box-shadow: 0 0 20px rgba(0,150,255,0.3), inset 0 0 20px rgba(0,150,255,0.1); }
            50% { box-shadow: 0 0 40px rgba(0,150,255,0.5), inset 0 0 30px rgba(0,150,255,0.2); }
        }
        @keyframes auraPulse10 {
            0%, 100% { box-shadow: 0 0 25px rgba(150,0,255,0.4), inset 0 0 25px rgba(150,0,255,0.15); }
            50% { box-shadow: 0 0 50px rgba(150,0,255,0.7), inset 0 0 40px rgba(150,0,255,0.3); }
        }
        @keyframes auraPulse13 {
            0%, 100% { box-shadow: 0 0 30px rgba(255,50,0,0.5), inset 0 0 30px rgba(255,50,0,0.2); }
            50% { box-shadow: 0 0 60px rgba(255,100,0,0.8), inset 0 0 50px rgba(255,50,0,0.35); }
        }
        @keyframes auraPulse16 {
            0%, 100% { box-shadow: 0 0 40px rgba(255,200,0,0.6), inset 0 0 35px rgba(255,200,0,0.25); }
            50% { box-shadow: 0 0 80px rgba(255,220,0,1), inset 0 0 60px rgba(255,200,0,0.4); }
        }
        @keyframes auraPulse20 {
            0%, 100% { box-shadow: 0 0 50px rgba(255,0,255,0.6), 0 0 100px rgba(0,255,255,0.4); }
            50% { box-shadow: 0 0 100px rgba(255,0,255,1), 0 0 150px rgba(0,255,255,0.7); }
        }
        @keyframes borderRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes rainbowBg {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes auraShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }
        @keyframes floatParticle {
            0%, 100% { transform: translateY(0) scale(1); opacity: 1; }
            50% { transform: translateY(-8px) scale(1.2); opacity: 0.7; }
        }
        @keyframes sparkle {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.5); }
        }
        @keyframes fireFlicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.95; }
        }
        
        /* Í≥†Í∞ïÌôî ÏÑ±Í≥µ Ïù¥ÌéôÌä∏ */
        @keyframes particleExplode {
            0% { 
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% { 
                transform: translate(var(--tx), var(--ty)) scale(0);
                opacity: 0;
            }
        }
        @keyframes waveExpand {
            0% { 
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% { 
                transform: translate(-50%, -50%) scale(10);
                opacity: 0;
            }
        }
        @keyframes flashEffect {
            0% { opacity: 0.8; }
            100% { opacity: 0; }
        }
        @keyframes emojiExplode {
            0% { transform: translate(0,0) scale(0.3) rotate(0deg); opacity: 1; }
            20% { transform: translate(calc(var(--tx)*0.3), calc(var(--ty)*0.3)) scale(1.2) rotate(90deg); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0.5) rotate(360deg); opacity: 0; }
        }
        @keyframes glowPulse {
            0% { opacity: 0; transform: scale(0.5); }
            30% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(1.5); }
        }
        @keyframes ringExpand {
            0% { transform: translate(-50%,-50%) scale(1); opacity: 0.9; }
            100% { transform: translate(-50%,-50%) scale(8); opacity: 0; }
        }
        @keyframes enhanceShake {
            0%,100% { transform: translate(0,0); }
            10% { transform: translate(calc(var(--shake-str)*-1), calc(var(--shake-str)*0.5)); }
            20% { transform: translate(var(--shake-str), calc(var(--shake-str)*-0.8)); }
            30% { transform: translate(calc(var(--shake-str)*-0.8), var(--shake-str)); }
            40% { transform: translate(calc(var(--shake-str)*0.6), calc(var(--shake-str)*-0.4)); }
            50% { transform: translate(calc(var(--shake-str)*-0.4), calc(var(--shake-str)*0.6)); }
            60% { transform: translate(calc(var(--shake-str)*0.3), calc(var(--shake-str)*-0.3)); }
            80% { transform: translate(calc(var(--shake-str)*-0.1), calc(var(--shake-str)*0.1)); }
        }
        @keyframes rainbowBorder {
            0% { opacity: 1; border-width: 4px; }
            50% { opacity: 0.8; border-width: 6px; }
            100% { opacity: 0; border-width: 2px; }
        }
        @keyframes lightningFlash {
            0% { opacity: 0.9; transform: scaleX(1); }
            50% { opacity: 1; transform: scaleX(2); }
            100% { opacity: 0; transform: scaleX(0.5); }
        }
        @keyframes sparkFall {
            0% { transform: translateY(0) scaleY(1); opacity: 0.9; }
            100% { transform: translateY(100vh) scaleY(0.3); opacity: 0; }
        }
        @keyframes bossDialogueIn {
            0% { opacity: 0; transform: translateX(-50%) translateY(-20px) scale(0.9); }
            100% { opacity: 1; transform: translateX(-50%) translateY(0) scale(1); }
        }
        @keyframes bossDialogueOut {
            0% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-15px); }
        }
        @keyframes screenShake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }
        
        /* Îü≠ÌÇ§ÎìúÎ°úÏö∞ Ìö®Í≥º */
        .lucky-flash {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(255,215,0,0.8) 0%, rgba(255,215,0,0) 70%);
            animation: luckyFlash 0.5s ease-out forwards;
            pointer-events: none;
            z-index: 999;
        }
        @keyframes luckyFlash {
            0% { opacity: 1; transform: scale(0); }
            50% { opacity: 0.8; transform: scale(1.5); }
            100% { opacity: 0; transform: scale(2); }
        }
        
        .gold-shower {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 1001;
            overflow: hidden;
        }
        
        .gold-coin {
            position: absolute;
            font-size: 2rem;
            animation: coinFall 2s ease-out forwards;
        }
        
        @keyframes coinFall {
            0% { transform: translateY(-50px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        
        .lucky-text-big {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 4rem;
            font-weight: 900;
            color: #ffd700;
            text-shadow: 0 0 30px #ff6b00, 0 0 60px #ff6b00, 3px 3px 0 #000;
            animation: luckyTextPop 1s ease-out forwards;
            z-index: 1002;
            pointer-events: none;
            white-space: nowrap;
        }
        
        @keyframes luckyTextPop {
            0% { transform: translateX(-50%) scale(0) rotate(-10deg); opacity: 0; }
            30% { transform: translateX(-50%) scale(1.3) rotate(5deg); opacity: 1; }
            50% { transform: translateX(-50%) scale(0.9) rotate(-3deg); }
            70% { transform: translateX(-50%) scale(1.1) rotate(2deg); }
            100% { transform: translateX(-50%) scale(1) rotate(0deg); opacity: 1; }
        }
        
        .lucky-gold-amount {
            position: fixed;
            top: 35%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 3rem;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 0 20px #ffd700, 0 0 40px #ffd700;
            animation: goldAmountPop 1s ease-out 0.3s both;
            z-index: 1002;
            pointer-events: none;
        }
        
        @keyframes goldAmountPop {
            0% { transform: translateX(-50%) translateY(30px); opacity: 0; }
            100% { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        
        /* Î¨¥Í∏∞ ÌöçÎìù Ïù¥ÌéôÌä∏ */
        .weapon-acquire-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .weapon-acquire-title {
            font-size: 1.5rem;
            color: var(--muted);
            margin-bottom: 20px;
            animation: slideDown 0.5s ease-out;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .weapon-acquire-card {
            background: var(--card);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            animation: weaponReveal 0.8s ease-out;
            max-width: 320px;
        }
        
        .weapon-acquire-card.common { border: 3px solid var(--common); }
        .weapon-acquire-card.magic { border: 3px solid var(--magic); box-shadow: 0 0 40px rgba(85,85,255,0.5); }
        .weapon-acquire-card.rare { border: 3px solid var(--rare); box-shadow: 0 0 50px rgba(255,204,0,0.5); }
        .weapon-acquire-card.legendary { border: 3px solid var(--legendary); box-shadow: 0 0 60px rgba(255,128,0,0.6); animation: weaponReveal 0.8s ease-out, legendaryGlow 1.5s ease-in-out infinite alternate; }
        .weapon-acquire-card.unique { border: 3px solid var(--unique); box-shadow: 0 0 80px rgba(0,255,128,0.6); animation: weaponReveal 0.8s ease-out, uniqueGlow 1s ease-in-out infinite alternate; }
        
        @keyframes weaponReveal {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            60% { transform: scale(1.1) rotate(10deg); }
            100% { transform: scale(1) rotate(0); opacity: 1; }
        }
        
        @keyframes legendaryGlow {
            from { box-shadow: 0 0 40px rgba(255,128,0,0.4); }
            to { box-shadow: 0 0 80px rgba(255,128,0,0.8); }
        }
        
        @keyframes uniqueGlow {
            from { box-shadow: 0 0 50px rgba(0,255,128,0.4); }
            to { box-shadow: 0 0 100px rgba(0,255,128,0.8); }
        }
        
        .weapon-acquire-reason {
            font-size: 0.9rem;
            color: var(--muted);
            margin-top: 20px;
            animation: slideUp 0.5s ease-out 0.5s both;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .weapon-acquire-btn {
            margin-top: 25px;
            padding: 12px 40px;
            background: var(--accent);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            animation: slideUp 0.5s ease-out 0.8s both;
        }
        
        @keyframes hitEffect {
            0% { transform: scale(1) rotate(0); }
            25% { transform: scale(1.2) rotate(-10deg); }
            50% { transform: scale(0.9) rotate(5deg); }
            100% { transform: scale(1) rotate(0); }
        }
        
        /* Screen shake for attacks */
        .screen-shake { animation: screenShake 0.3s ease-out; }
        @keyframes screenShake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-5px); }
            40% { transform: translateX(5px); }
            60% { transform: translateX(-3px); }
            80% { transform: translateX(3px); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0) rotate(0); }
            20% { transform: translateX(-10px) rotate(-5deg); }
            40% { transform: translateX(10px) rotate(5deg); }
            60% { transform: translateX(-10px) rotate(-5deg); }
            80% { transform: translateX(10px) rotate(5deg); }
        }
        
        /* üí∞ Gold explosion animation */
        @keyframes goldExplode {
            0% { 
                transform: translate(0, 0) scale(0.5) rotate(0deg); 
                opacity: 1; 
            }
            100% { 
                transform: translate(var(--endX), var(--endY)) scale(1.5) rotate(360deg); 
                opacity: 0; 
            }
        }
        @keyframes goldAmount {
            0% { 
                transform: translate(-50%, -50%) scale(0.5); 
                opacity: 0; 
            }
            20% { 
                transform: translate(-50%, -50%) scale(1.3); 
                opacity: 1; 
            }
            80% { 
                transform: translate(-50%, -50%) scale(1); 
                opacity: 1; 
            }
            100% { 
                transform: translate(-50%, -100%) scale(0.8); 
                opacity: 0; 
            }
        }

        /* Battle effect popup animation */
        @keyframes effectPopup {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            40% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -70%) scale(0.8); opacity: 0; }
        }

        /* Hit flash effect */
        .hit-flash {
            animation: hitFlash 0.3s ease-out;
        }
        @keyframes hitFlash {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(2) sepia(1) saturate(3); }
        }

        /* Fighter defending state */
        .fighter.defending::after {
            content: 'üõ°Ô∏è';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            animation: defendPulse 0.5s ease-out;
        }
        @keyframes defendPulse {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.5); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0.5; }
        }

        /* Stats */
        .weapon-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }

        .stat-item {
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            padding: 6px 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-icon { font-size: 1.1rem; }
        .stat-info { flex: 1; }
        .stat-value { font-size: 0.9rem; font-weight: 600; }
        .stat-label { font-size: 0.65rem; color: var(--muted); }

        .stat-value.damage { color: #ff6b6b; }
        .stat-value.crit { color: var(--gold); }
        .stat-value.hp { color: var(--success); }
        .stat-value.special { color: var(--unique); }

        /* Mode Selection */
        .mode-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 8px;
        }

        .mode-btn {
            padding: 14px 10px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .mode-btn:hover { transform: translateY(-2px); }

        .mode-btn.enhance {
            background: linear-gradient(135deg, #e94560, #ff8a80);
            color: white;
        }

        .mode-btn.battle {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .mode-btn.hunt {
            background: linear-gradient(135deg, #e67e22, #d35400);
            color: white;
        }

        /* Hunt Mode Styles */
        .hunt-screen {
            display: flex;
            flex-direction: column;
            padding-top: 30px;
        }

        .monster-card {
            background: var(--card);
            border: 2px solid var(--card-border);
            border-radius: 16px;
            padding: 12px;
            text-align: center;
            margin-bottom: 10px;
            position: relative;
        }

        .monster-card.boss {
            border-color: #ff4444;
            box-shadow: 0 0 30px rgba(255,68,68,0.3);
            animation: bossGlow 2s ease-in-out infinite alternate;
        }
        
        .monster-card.weak {
            background: linear-gradient(135deg, rgba(78,204,163,0.2) 0%, rgba(78,204,163,0.05) 100%);
            border-color: var(--success);
        }
        
        .monster-card.weak::before {
            content: 'üí´ ÏïΩÏ†ê!';
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(78,204,163,0.8);
            color: #000;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 700;
        }

        @keyframes bossGlow {
            from { box-shadow: 0 0 20px rgba(255,68,68,0.3); }
            to { box-shadow: 0 0 40px rgba(255,68,68,0.5); }
        }

        .monster-img {
            width: 70px;
            height: 70px;
            margin: 8px auto;
            object-fit: contain;
            filter: drop-shadow(0 0 10px #ff6b6b);
        }

        .monster-card.boss .monster-img {
            width: 120px;
            height: 120px;
            margin: 10px auto;
            filter: drop-shadow(0 0 14px rgba(255, 107, 107, 0.9));
        }

        .monster-name {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .monster-name.boss {
            color: #ff4444;
            text-shadow: 0 0 10px rgba(255,68,68,0.5);
        }

        .monster-tier {
            font-size: 0.8rem;
            color: var(--muted);
            margin-bottom: 12px;
        }

        .hunt-vs {
            font-size: 1.2rem;
            text-align: center;
            margin: 6px 0;
            color: var(--accent);
        }

        .player-mini {
            background: var(--card);
            border: 2px solid var(--accent);
            border-radius: 10px;
            padding: 8px;
            margin-bottom: 8px;
        }

        .hunt-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .hunt-actions .btn {
            flex: 1;
        }

        .reward-popup {
            background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,215,0,0.05));
            border: 2px solid var(--gold);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            margin: 16px 0;
        }

        .reward-gold {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gold);
        }

        /* Critical Hit Effect */
        .crit-flash {
            animation: critFlash 0.5s ease-out;
        }
        
        @keyframes critFlash {
            0% { filter: brightness(1); }
            25% { filter: brightness(2) drop-shadow(0 0 30px #ffd700); }
            50% { filter: brightness(1.5) drop-shadow(0 0 20px #ff6b6b); }
            100% { filter: brightness(1); }
        }
        
        .crit-text {
            position: fixed;
            top: 30%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 3rem;
            font-weight: 900;
            color: #ffd700;
            text-shadow: 0 0 20px #ff6b6b, 0 0 40px #ff6b6b, 2px 2px 0 #000;
            animation: critText 0.8s ease-out forwards;
            z-index: 1000;
            pointer-events: none;
        }
        
        /* Í≥µÍ≤© Ïä¨ÎûòÏãú Ìö®Í≥º */
        .slash-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            pointer-events: none;
            z-index: 1000;
        }
        
        /* ÏùºÎ∞ò Í≥µÍ≤©: Îã®Ïùº Ïä¨ÎûòÏãú */
        .slash-single {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        .slash-single::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 10%;
            width: 80%;
            height: 8px;
            background: linear-gradient(90deg, transparent, #fff, #ffd700, #fff, transparent);
            transform: rotate(-45deg);
            animation: slashAppear 0.3s ease-out forwards;
            box-shadow: 0 0 20px #ffd700, 0 0 40px #ff6b6b;
            border-radius: 4px;
        }
        
        /* ÌÅ¨Î¶¨Ìã∞Ïª¨: X Ïä¨ÎûòÏãú */
        .slash-crit {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        .slash-crit::before, .slash-crit::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 10%;
            width: 80%;
            height: 10px;
            background: linear-gradient(90deg, transparent, #ff0, #f00, #ff0, transparent);
            border-radius: 5px;
            box-shadow: 0 0 30px #ff0, 0 0 60px #f00;
        }
        .slash-crit::before {
            transform: rotate(-45deg);
            animation: slashCrit1 0.4s ease-out forwards;
        }
        .slash-crit::after {
            transform: rotate(45deg);
            animation: slashCrit2 0.4s ease-out 0.1s forwards;
        }
        
        /* Î™¨Ïä§ÌÑ∞ ÌÅ¥Î°ú Í≥µÍ≤© */
        .slash-claw {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        .slash-claw::before {
            content: '';
            position: absolute;
            top: 20%;
            left: 30%;
            width: 6px;
            height: 60%;
            background: linear-gradient(180deg, transparent, #f55, #fff, #f55, transparent);
            border-radius: 3px;
            box-shadow: 
                30px 10px 0 0 currentColor,
                60px 5px 0 0 currentColor,
                0 0 20px #f55;
            animation: clawSlash 0.3s ease-out forwards;
            transform-origin: top center;
        }
        
        @keyframes slashAppear {
            0% { transform: rotate(-45deg) scaleX(0); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: rotate(-45deg) scaleX(1); opacity: 0; }
        }
        
        @keyframes slashCrit1 {
            0% { transform: rotate(-45deg) scaleX(0); opacity: 0; }
            30% { opacity: 1; }
            100% { transform: rotate(-45deg) scaleX(1.2); opacity: 0; }
        }
        
        @keyframes slashCrit2 {
            0% { transform: rotate(45deg) scaleX(0); opacity: 0; }
            30% { opacity: 1; }
            100% { transform: rotate(45deg) scaleX(1.2); opacity: 0; }
        }
        
        @keyframes clawSlash {
            0% { transform: translateY(-30px) scaleY(0); opacity: 0; }
            30% { opacity: 1; }
            100% { transform: translateY(30px) scaleY(1); opacity: 0; }
        }
        
        /* üëä ÎÑàÌÅ¥ ÎçîÎ∏îÌéÄÏπò */
        .slash-punch {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        .slash-punch::before, .slash-punch::after {
            content: 'üëä';
            position: absolute;
            font-size: 4rem;
            filter: drop-shadow(0 0 10px #ff6b6b);
        }
        .slash-punch::before {
            top: 30%;
            left: 25%;
            animation: punchLeft 0.25s ease-out forwards;
        }
        .slash-punch::after {
            top: 30%;
            right: 25%;
            animation: punchRight 0.25s ease-out 0.15s forwards;
        }
        
        @keyframes punchLeft {
            0% { transform: translateX(-50px) scale(0.5); opacity: 0; }
            50% { transform: translateX(20px) scale(1.3); opacity: 1; }
            100% { transform: translateX(0) scale(1); opacity: 0; }
        }
        @keyframes punchRight {
            0% { transform: translateX(50px) scale(0.5); opacity: 0; }
            50% { transform: translateX(-20px) scale(1.3); opacity: 1; }
            100% { transform: translateX(0) scale(1); opacity: 0; }
        }
        
        /* üèπ ÏõêÍ±∞Î¶¨ ÌôîÏÇ¥ (ÏïÑÎûò‚ÜíÏúÑ Î™¨Ïä§ÌÑ∞ Î∞©Ìñ•) */
        .slash-arrow {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
        }
        .slash-arrow::before {
            content: 'üèπ';
            position: absolute;
            bottom: -50px;
            font-size: 3rem;
            color: #7dd3fc;
            text-shadow: 0 0 20px #0ea5e9, 0 0 40px #0284c7;
            animation: arrowFly 0.3s ease-out forwards;
        }
        
        @keyframes arrowFly {
            0% { transform: translateY(0) scale(1); opacity: 0; }
            20% { opacity: 1; }
            100% { transform: translateY(-150px) scale(0.8); opacity: 0; }
        }
        
        /* üßô ÎßàÎ≤ï ÏÜçÏÑ± Ïù¥ÌéôÌä∏ */
        .magic-effect {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5rem;
            z-index: 9999;
            pointer-events: none;
        }
        .magic-effect.fire { animation: magicFire 0.6s ease-out forwards; }
        .magic-effect.ice { animation: magicIce 0.8s ease-out forwards; }
        .magic-effect.lightning { animation: magicLightning 0.5s ease-out forwards; }
        .magic-effect.water { animation: magicWater 0.7s ease-out forwards; }
        .magic-effect.poison { animation: magicPoison 0.6s ease-out forwards; }
        .magic-effect.holy { animation: magicHoly 0.8s ease-out forwards; }
        
        @keyframes magicFire {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            30% { transform: translate(-50%, -50%) scale(1.5); opacity: 1; }
            100% { transform: translate(-50%, -80%) scale(2); opacity: 0; }
        }
        @keyframes magicIce {
            0% { transform: translate(-50%, -50%) scale(0.3); opacity: 0; filter: blur(10px); }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; filter: blur(0); }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; filter: blur(5px); }
        }
        @keyframes magicLightning {
            0%, 100% { opacity: 0; }
            10%, 30%, 50% { opacity: 1; transform: translate(-50%, -50%) scale(1.3); }
            20%, 40% { opacity: 0.5; transform: translate(-48%, -52%) scale(1.1); }
            60% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }
        @keyframes magicWater {
            0% { transform: translate(-50%, -30%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -70%) scale(0.8); opacity: 0; }
        }
        @keyframes magicPoison {
            0% { transform: translate(-50%, -50%) scale(0.5) rotate(0deg); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.3) rotate(180deg); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1) rotate(360deg); opacity: 0; }
        }
        @keyframes magicHoly {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; filter: brightness(3); }
            50% { transform: translate(-50%, -50%) scale(1.5); opacity: 1; filter: brightness(2); }
            100% { transform: translate(-50%, -50%) scale(2); opacity: 0; filter: brightness(1); }
        }
        
        /* ÏÉÅÌÉúÏù¥ÏÉÅ ÌëúÏãú */
        .status-effect {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 4px;
            animation: statusPulse 1s ease-in-out infinite;
        }
        .status-effect.poison { background: rgba(153, 50, 204, 0.3); color: #9932cc; }
        .status-effect.frozen { background: rgba(0, 191, 255, 0.3); color: #00bfff; }
        .status-effect.shocked { background: rgba(255, 215, 0, 0.3); color: #ffd700; }
        
        @keyframes statusPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        /* üßô ÎßàÎ≤ï Í≥µÍ≤© Î™®ÏÖò */
        @keyframes magicAttack {
            0% { transform: scale(0.3) translateY(50px); opacity: 0; }
            30% { transform: scale(1.5) translateY(-20px); opacity: 1; }
            60% { transform: scale(1.2) translateY(-40px); opacity: 1; }
            100% { transform: scale(0.8) translateY(-80px); opacity: 0; }
        }
        
        @keyframes critText {
            0% { transform: translateX(-50%) scale(0.5); opacity: 0; }
            20% { transform: translateX(-50%) scale(1.3); opacity: 1; }
            100% { transform: translateX(-50%) scale(1) translateY(-50px); opacity: 0; }
        }
        
        /* Blacksmith */
        .blacksmith-card {
            background: var(--card);
            border: 2px solid #8b4513;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            color: #fff;
        }
        
        .blacksmith-card .enhance-panel,
        .blacksmith-card + .enhance-panel {
            color: #fff;
        }
        
        .blacksmith-card + .enhance-panel h3,
        .blacksmith-card + .enhance-panel p {
            color: #fff;
        }
        
        .durability-bar {
            height: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 12px 0;
        }
        
        .durability-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--fail), var(--gold), var(--success));
            transition: width 0.3s;
        }
        
        .durability-fill.low { background: var(--fail); }
        .durability-fill.mid { background: var(--gold); }
        .durability-fill.high { background: var(--success); }

        .mode-btn.shop {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .mode-btn.inventory {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }

        .mode-icon { font-size: 1.5rem; }
        .mode-label { font-size: 0.8rem; }

        /* Enhance Panel */
        .enhance-panel {
            background: var(--card);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .enhance-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .enhance-row:last-child { border-bottom: none; }

        .enhance-label { color: var(--muted); }
        .enhance-value { font-weight: 600; }
        .enhance-value.danger { color: var(--fail); font-weight: 700; }
        .enhance-value.warning { color: #ff8800; }
        .enhance-value.safe { color: var(--success); }
        .enhance-value.gold { color: var(--gold); }

        /* Buttons */
        .btn-row { display: flex; gap: 10px; }

        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-enhance {
            background: linear-gradient(135deg, var(--accent), #ff8a80);
            color: white;
        }

        .btn-enhance:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(233, 69, 96, 0.4);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.08);
            color: var(--text);
            flex: 0 0 50px;
        }

        .btn-back {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            color: var(--muted);
            cursor: pointer;
            font-size: 0.8rem;
            padding: 6px 10px;
            display: flex;
            align-items: center;
            gap: 4px;
            z-index: 10;
        }
        
        .btn-back:hover {
            background: rgba(0,0,0,0.7);
            color: var(--text);
        }

        /* Protection Toggle */
        .protection-toggle {
            background: rgba(255,215,0,0.1);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 8px;
            padding: 8px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .toggle-btn {
            padding: 6px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-btn.on {
            background: var(--gold);
            color: #000;
        }

        .toggle-btn.off {
            background: rgba(255,255,255,0.1);
            color: var(--muted);
        }

        /* Result Popup */
        .overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 99;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .overlay.show { opacity: 1; pointer-events: auto; }

        .result-popup {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: var(--card);
            border-radius: 20px;
            padding: 32px;
            text-align: center;
            z-index: 100;
            transition: transform 0.3s ease-out;
            min-width: 300px;
            max-width: 90%;
        }

        .result-popup.show { transform: translate(-50%, -50%) scale(1); }
        .result-popup.success { border: 2px solid var(--success); }
        .result-popup.fail { border: 2px solid var(--fail); }
        .result-popup.destroy { border: 2px solid var(--legendary); }

        .result-icon { font-size: 4rem; margin-bottom: 12px; }
        .result-text { font-size: 1.4rem; font-weight: 700; margin-bottom: 8px; }
        .result-detail { color: var(--muted); margin-bottom: 16px; font-size: 0.95rem; }

        .new-weapon-preview {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .new-weapon-title {
            font-size: 0.8rem;
            color: var(--muted);
            margin-bottom: 8px;
        }

        .new-weapon-name {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .result-btn {
            display: block;
            margin: 0 auto;
            padding: 12px 32px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            background: var(--accent);
            color: white;
            text-align: center;
        }

        #newWeaponPreview > div {
            width: 100%;
            justify-content: center;
            align-items: center;
        }

        /* Battle Screen - Redesigned */
        .battle-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
        }

        .battle-header {
            text-align: center;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .battle-title { font-size: 1.1rem; font-weight: 600; }
        .battle-round { color: var(--muted); font-size: 0.85rem; }

        .battle-arena {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 12px;
            gap: 12px;
            position: relative;
            overflow: hidden;
        }

        /* VS ÌëúÏãú */
        .battle-vs {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: bold;
            color: rgba(255,255,255,0.15);
            z-index: 0;
            text-shadow: 0 0 20px rgba(255,255,255,0.3);
        }

        .fighter {
            background: var(--card);
            border-radius: 16px;
            padding: 12px;
            border: 3px solid var(--card-border);
            position: relative;
            z-index: 1;
            transition: all 0.3s;
        }

        /* ÎÇò: Ï¥àÎ°ùÏÉâ ÌÖåÎëêÎ¶¨, ÏïÑÎûòÏ™Ω */
        .fighter.me { 
            border-color: #4ecca3; 
            background: linear-gradient(135deg, rgba(78,204,163,0.15), rgba(78,204,163,0.05));
            box-shadow: 0 0 20px rgba(78,204,163,0.3);
        }
        .fighter.me::before {
            content: 'üë§ ÎÇò';
            position: absolute;
            top: -12px;
            left: 12px;
            background: #4ecca3;
            color: #000;
            font-size: 0.7rem;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 8px;
        }

        /* ÏÉÅÎåÄ: Îπ®Í∞ÑÏÉâ ÌÖåÎëêÎ¶¨, ÏúÑÏ™Ω */
        .fighter.enemy { 
            border-color: #ff6b6b; 
            background: linear-gradient(135deg, rgba(255,107,107,0.15), rgba(255,107,107,0.05));
            box-shadow: 0 0 20px rgba(255,107,107,0.3);
        }
        .fighter.enemy::before {
            content: 'üëæ ÏÉÅÎåÄ';
            position: absolute;
            top: -12px;
            left: 12px;
            background: #ff6b6b;
            color: #fff;
            font-size: 0.7rem;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 8px;
        }

        .fighter.awakened {
            animation: awakenPulse 1s ease-in-out infinite;
        }
        @keyframes awakenPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(255,215,0,0.5); }
            50% { box-shadow: 0 0 40px rgba(255,215,0,0.8); }
        }

        .fighter-content {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        /* Î¨¥Í∏∞ Ïù¥ÎØ∏ÏßÄ ÏòÅÏó≠ */
        .fighter-weapon-icon {
            width: 60px;
            height: 60px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            flex-shrink: 0;
            position: relative;
            border: 2px solid rgba(255,255,255,0.1);
        }
        .fighter-weapon-icon .weapon-level {
            position: absolute;
            bottom: -4px;
            right: -4px;
            background: var(--accent);
            color: #000;
            font-size: 0.6rem;
            font-weight: bold;
            padding: 1px 4px;
            border-radius: 6px;
        }

        .fighter-info {
            flex: 1;
            min-width: 0;
        }

        .fighter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            padding: 0;
            background: none;
            border: none;
        }

        .fighter-name { 
            font-weight: 600; 
            font-size: 0.9rem; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .fighter-weapon-name { 
            color: var(--muted); 
            font-size: 0.75rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .hp-bar-container {
            background: rgba(0,0,0,0.4);
            border-radius: 8px;
            height: 20px;
            overflow: hidden;
            margin-bottom: 6px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .hp-bar {
            height: 100%;
            background: linear-gradient(90deg, #4ecca3, #2ecc71);
            border-radius: 7px;
            transition: width 0.5s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            min-width: 40px;
            padding: 0 6px;
            line-height: 1;
            white-space: nowrap;
            word-break: keep-all;
            overflow: hidden;
            text-overflow: clip;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .hp-bar.low { background: linear-gradient(90deg, #ff6b6b, #ee5a5a); }

        /* Î∂ÑÎÖ∏ Í≤åÏù¥ÏßÄ */
        .rage-bar-container {
            height: 8px;
            background: rgba(0,0,0,0.4);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 6px;
        }
        .rage-bar {
            height: 100%;
            background: linear-gradient(90deg, #e94560, #ff6b6b);
            transition: width 0.3s;
        }
        .rage-bar.full {
            background: linear-gradient(90deg, #ffd700, #ff8c00);
            animation: rageGlow 0.5s ease-in-out infinite alternate;
        }
        @keyframes rageGlow {
            from { box-shadow: 0 0 5px #ffd700; }
            to { box-shadow: 0 0 15px #ff8c00; }
        }

        .fighter-stats {
            display: flex;
            gap: 10px;
            font-size: 0.7rem;
            color: var(--muted);
            flex-wrap: wrap;
        }
        .fighter-stats span {
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* Î∞∞ÌãÄ Î°úÍ∑∏ */
        .battle-log {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 10px;
            max-height: 100px;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.75rem;
        }
        .log-entry:last-child { border-bottom: none; }
        .log-entry.crit { color: var(--gold); }
        .log-entry.success { color: var(--success); }
        .log-entry.info { color: var(--muted); }

        /* Ïï°ÏÖò Î≤ÑÌäº ÏòÅÏó≠ */
        .battle-actions {
            padding: 12px;
            background: rgba(0,0,0,0.4);
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .action-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }

        .action-btn {
            padding: 16px 8px;
            border: none;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .action-btn:active { transform: scale(0.95); }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .action-btn.attack { 
            background: linear-gradient(135deg, #e94560, #c73e54);
            color: white;
        }
        .action-btn.defense { 
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        .action-btn.skill { 
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
        }
        .action-btn .action-icon { font-size: 1.5rem; }
        .action-btn .action-hint { font-size: 0.6rem; opacity: 0.8; }

        /* Í∂ÅÍ∑πÍ∏∞ Î≤ÑÌäº */
        .ultimate-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-bottom: 10px;
            padding: 10px;
            background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,140,0,0.1));
            border: 2px solid var(--gold);
            border-radius: 12px;
            animation: ultimateReady 1s ease-in-out infinite alternate;
        }
        @keyframes ultimateReady {
            from { box-shadow: 0 0 10px rgba(255,215,0,0.3); }
            to { box-shadow: 0 0 20px rgba(255,215,0,0.6); }
        }
        .ultimate-btn {
            padding: 10px 6px;
            border: none;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            color: white;
        }
        .ultimate-btn.burst { background: linear-gradient(135deg, #ff4500, #ff6347); }
        .ultimate-btn.drain { background: linear-gradient(135deg, #32cd32, #228b22); }
        .ultimate-btn.shield { background: linear-gradient(135deg, #4169e1, #1e90ff); }

        /* Î∞∞ÌãÄ Ïï†ÎãàÎ©îÏù¥ÏÖò Ìö®Í≥º */
        .battle-effect {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Í≥µÍ≤© Ïä¨ÎûòÏãú Ïù¥ÌéôÌä∏ */
        .slash-effect {
            width: 200px;
            height: 200px;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M20 80 L80 20' stroke='%23ff6b6b' stroke-width='8' stroke-linecap='round' fill='none'/%3E%3Cpath d='M30 70 L70 30' stroke='%23ffaa00' stroke-width='4' stroke-linecap='round' fill='none'/%3E%3C/svg%3E") center/contain no-repeat;
            animation: slashAnim 0.4s ease-out forwards;
        }
        @keyframes slashAnim {
            0% { transform: scale(0.5) rotate(-45deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(0deg); opacity: 1; }
            100% { transform: scale(1.5) rotate(15deg); opacity: 0; }
        }

        /* Î∞©Ïñ¥ Ïâ¥Îìú Ïù¥ÌéôÌä∏ */
        .shield-effect {
            width: 150px;
            height: 150px;
            border: 8px solid #3498db;
            border-radius: 50%;
            animation: shieldAnim 0.5s ease-out forwards;
            box-shadow: 0 0 30px #3498db, inset 0 0 30px rgba(52,152,219,0.3);
        }
        @keyframes shieldAnim {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0; }
        }

        /* Ïä§ÌÇ¨ Ïù¥ÌéôÌä∏ */
        .skill-effect {
            font-size: 4rem;
            animation: skillAnim 0.6s ease-out forwards;
        }
        @keyframes skillAnim {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            50% { transform: scale(1.3) rotate(0deg); opacity: 1; }
            100% { transform: scale(1) rotate(20deg); opacity: 0; }
        }

        /* Îç∞ÎØ∏ÏßÄ Ïà´Ïûê ÌåùÏóÖ */
        .damage-popup {
            position: fixed;
            font-size: 3rem;
            font-weight: bold;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            animation: damagePopup 1s ease-out forwards;
            z-index: 10000;
        }
        @keyframes damagePopup {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            20% { transform: translateY(-20px) scale(1.2); opacity: 1; }
            100% { transform: translateY(-80px) scale(1); opacity: 0; }
        }

        /* ÌÑ¥ Í≤∞Í≥º Ïò§Î≤ÑÎ†àÏù¥ */
        .turn-result-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9998;
            animation: fadeIn 0.3s;
        }
        .turn-result-text {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
        }
        .turn-result-actions {
            display: flex;
            gap: 40px;
            font-size: 3rem;
        }
        .turn-result-vs { 
            color: var(--muted); 
            font-size: 1.5rem;
            display: flex;
            align-items: center;
        }

        .fighter.hit-flash {
            animation: hitFlash 0.3s;
        }
        @keyframes hitFlash {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(2) saturate(1.5); }
        }

        .fighter.defending { border-color: #3498db; background: rgba(52,152,219,0.2); }
        .fighter.counter-ready { border-color: var(--legendary); background: rgba(255,128,0,0.2); }

        /* Stats Panel in Main */
        .stats-summary {
            background: var(--card);
            border: 1px solid var(--card-border);
            border-radius: 10px;
            padding: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .summary-item span {
            display: block;
        }

        .summary-value { font-size: 0.95rem; font-weight: 600; }
        .summary-label { font-size: 0.65rem; color: var(--muted); }

        /* Confetti */
        .confetti {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        footer {
            text-align: center;
            padding: 6px;
            color: var(--muted);
            font-size: 0.7rem;
        }

        footer a { color: var(--accent); text-decoration: none; }
        
        /* Ranking Styles */
        .ranking-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        .ranking-tab {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            background: rgba(255,255,255,0.1);
            color: var(--text);
            transition: all 0.2s;
        }
        .ranking-tab.active {
            background: var(--accent);
            color: white;
        }
        .ranking-list {
            background: var(--card);
            border-radius: 12px;
            overflow: hidden;
        }
        .ranking-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .ranking-item:last-child { border-bottom: none; }
        .ranking-item.me { background: rgba(233,69,96,0.15); }
        .ranking-rank {
            font-size: 1.2rem;
            font-weight: 700;
            min-width: 40px;
            text-align: center;
        }
        .ranking-rank.gold { color: #ffd700; }
        .ranking-rank.silver { color: #c0c0c0; }
        .ranking-rank.bronze { color: #cd7f32; }
        .ranking-info { flex: 1; margin-left: 12px; }
        .ranking-name { font-weight: 600; }
        .ranking-detail { font-size: 0.8rem; color: var(--muted); margin-top: 2px; }
        .ranking-value { font-weight: 700; text-align: right; }
        .ranking-value.weapon { color: var(--accent); }
        .ranking-value.kills { color: var(--gold); }
        .ranking-value.pvp { color: var(--success); }
        .ranking-empty { text-align: center; padding: 40px; color: var(--muted); }
        .ranking-loading { text-align: center; padding: 40px; }
        .my-ranking-box {
            background: linear-gradient(135deg, rgba(233,69,96,0.2), rgba(233,69,96,0.05));
            border: 1px solid var(--accent);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            text-align: center;
        }
        .my-ranking-label { font-size: 0.8rem; color: var(--muted); }
        .my-ranking-value { font-size: 1.5rem; font-weight: 700; color: var(--accent); }
    </style>
</head>
<body>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MV8KQGJF" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <div id="app"></div>
    <div class="overlay" id="overlay"></div>
    <div class="result-popup" id="resultPopup">
        <div class="result-icon" id="resultIcon">‚ú®</div>
        <div class="result-text" id="resultText">Í∞ïÌôî ÏÑ±Í≥µ!</div>
        <div class="result-detail" id="resultDetail"></div>
        <div class="new-weapon-preview" id="newWeaponPreview" style="display:none;">
            <div class="new-weapon-title">ÏÉàÎ°úÏö¥ Î¨¥Í∏∞ ÌöçÎìù!</div>
            <div class="new-weapon-name" id="newWeaponName"></div>
        </div>
        <button class="result-btn" id="resultBtn" onclick="closeResult()">ÌôïÏù∏</button>
    </div>
    <canvas class="confetti" id="confetti"></canvas>

    <script>
        // ===== SOUND EFFECTS (Web Audio API) =====
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;
        
        function ensureAudio() {
            if (!audioCtx) audioCtx = new AudioCtx();
            return audioCtx;
        }
        
        function playSound(type) {
            try {
                const ctx = ensureAudio();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                switch(type) {
                    case 'enhance':
                        osc.frequency.setValueAtTime(300, ctx.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(600, ctx.currentTime + 0.1);
                        gain.gain.setValueAtTime(0.3, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                        osc.start(); osc.stop(ctx.currentTime + 0.2);
                        break;
                    case 'success':
                        osc.frequency.setValueAtTime(523, ctx.currentTime); // C5
                        osc.frequency.setValueAtTime(659, ctx.currentTime + 0.1); // E5
                        osc.frequency.setValueAtTime(784, ctx.currentTime + 0.2); // G5
                        gain.gain.setValueAtTime(0.3, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
                        osc.start(); osc.stop(ctx.currentTime + 0.4);
                        break;
                    case 'fail':
                        osc.type = 'sawtooth';
                        osc.frequency.setValueAtTime(200, ctx.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 0.3);
                        gain.gain.setValueAtTime(0.2, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                        osc.start(); osc.stop(ctx.currentTime + 0.3);
                        break;
                    case 'destroy':
                        osc.type = 'sawtooth';
                        osc.frequency.setValueAtTime(150, ctx.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(50, ctx.currentTime + 0.5);
                        gain.gain.setValueAtTime(0.4, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                        osc.start(); osc.stop(ctx.currentTime + 0.5);
                        // Add explosion noise
                        const noise = ctx.createBufferSource();
                        const buffer = ctx.createBuffer(1, ctx.sampleRate * 0.3, ctx.sampleRate);
                        const data = buffer.getChannelData(0);
                        for (let i = 0; i < data.length; i++) data[i] = (Math.random() * 2 - 1) * Math.exp(-i / 3000);
                        noise.buffer = buffer;
                        const noiseGain = ctx.createGain();
                        noiseGain.gain.setValueAtTime(0.3, ctx.currentTime);
                        noiseGain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                        noise.connect(noiseGain);
                        noiseGain.connect(ctx.destination);
                        noise.start();
                        break;
                    case 'attack':
                        osc.type = 'sawtooth';
                        osc.frequency.setValueAtTime(150, ctx.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(80, ctx.currentTime + 0.15);
                        gain.gain.setValueAtTime(0.25, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
                        osc.start(); osc.stop(ctx.currentTime + 0.15);
                        break;
                    case 'crit':
                        osc.frequency.setValueAtTime(800, ctx.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.1);
                        gain.gain.setValueAtTime(0.3, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                        osc.start(); osc.stop(ctx.currentTime + 0.2);
                        break;
                    case 'defend':
                        // Shield sound - metallic clang
                        osc.type = 'triangle';
                        osc.frequency.setValueAtTime(400, ctx.currentTime);
                        osc.frequency.setValueAtTime(600, ctx.currentTime + 0.05);
                        osc.frequency.exponentialRampToValueAtTime(200, ctx.currentTime + 0.2);
                        gain.gain.setValueAtTime(0.25, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                        osc.start(); osc.stop(ctx.currentTime + 0.3);
                        break;
                }
            } catch(e) { console.log('Audio error:', e); }
        }
        
        function vibrate(pattern) {
            if (navigator.vibrate) navigator.vibrate(pattern);
        }

        // ===== WEAPON DATABASE =====
        // Icons from game-icons.net (CC0 license)
        const ICON_BASE = 'https://game-icons.net/icons/ffffff/000000/1x1';
        /*
         * Î¨¥Í∏∞ ÌÉÄÏûÖÎ≥Ñ ÌäπÏÑ±:
         * - sword(Í≤Ä): Î∞∏Îü∞Ïä§Ìòï, ÏïàÏ†ïÏ†ÅÏù∏ Îç∞ÎØ∏ÏßÄ
         * - axe(ÎèÑÎÅº): ÎÑìÏùÄ Îç∞ÎØ∏ÏßÄ Î≤îÏúÑ, ÌïúÎ∞© Î°úÎòê
         * - spear(Ï∞Ω): ÏïàÏ†ïÏ†Å + ÌÅ¨Î¶¨ Î≥¥ÎÑàÏä§
         * - hammer(ÎßùÏπò): ÎÜíÍ≥† Ï¢ÅÏùÄ Îç∞ÎØ∏ÏßÄ, ÌÅ¨Î¶¨ ÏïΩÌï®
         * - dagger(Îã®Í≤Ä): ÎÇÆÏùÄ Îç∞ÎØ∏ÏßÄ, ÌÅ¨Î¶¨ Îç∞ÎØ∏ÏßÄ Ìè≠Î∞ú
         * - staff(ÏßÄÌå°Ïù¥): ÎßàÎ≤ï ÌäπÌôî, Î∞∏Îü∞Ïä§
         * - katana(ÌÉúÎèÑ): ÎÇ†Ïπ¥Î°úÏõÄ, ÌÅ¨Î¶¨ Í∞ïÌôî
         * - scythe(ÎÇ´): ÎÑìÏùÄ Î≤îÏúÑ, Ï£ΩÏùåÏùò ÏùºÍ≤©
         * - bow(Ìôú): ÏõêÍ±∞Î¶¨, ÏµúÏÜå0 / ÎÑìÏùÄÎ≤îÏúÑ / ÌÅ¨Î¶¨300%
         * - crossbow(ÏÑùÍ∂Å): ÏõêÍ±∞Î¶¨, ÏµúÏÜå0 / Îçî ÎÑìÏùÄÎ≤îÏúÑ / ÌÅ¨Î¶¨300%
         * - knuckle(ÎÑàÌÅ¥): 2Ìöå Í≥µÍ≤©, ÏïàÏ†ïÏ†Å Îç∞ÎØ∏ÏßÄ, 5% ÌöåÎ≥µ
         */
        const WEAPON_TYPES = {
            sword:  { name: 'Í≤Ä',     img: `${ICON_BASE}/lorc/broadsword.svg`,       bonus: { damage: 1.0, crit: 1.0 },   baseMin: 6, baseMax: 10, critDmgBonus: 0 },
            axe:    { name: 'ÎèÑÎÅº',   img: `${ICON_BASE}/lorc/battle-axe.svg`,       bonus: { damage: 1.15, crit: 0.8 },  baseMin: 3, baseMax: 16, critDmgBonus: -30 },
            spear:  { name: 'Ï∞Ω',     img: `${ICON_BASE}/lorc/spear-hook.svg`,       bonus: { damage: 0.95, crit: 1.15 }, baseMin: 5, baseMax: 9, critDmgBonus: 30 },
            hammer: { name: 'ÎßùÏπò',   img: `${ICON_BASE}/lorc/claw-hammer.svg`,      bonus: { damage: 1.3, crit: 0.7 },   baseMin: 10, baseMax: 14, critDmgBonus: -40 },
            dagger: { name: 'Îã®Í≤Ä',   img: `${ICON_BASE}/lorc/plain-dagger.svg`,     bonus: { damage: 0.8, crit: 1.4 },   baseMin: 3, baseMax: 6, critDmgBonus: 80 },
            staff:  { name: 'ÏßÄÌå°Ïù¥', img: `${ICON_BASE}/lorc/wizard-staff.svg`,     bonus: { damage: 0.9, crit: 1.0 }, isMagic: true, baseMin: 5, baseMax: 8, critDmgBonus: 20 },
            wand:   { name: 'ÏôÑÎìú',   img: `${ICON_BASE}/lorc/crystal-wand.svg`,     bonus: { damage: 0.85, crit: 1.1 }, isMagic: true, baseMin: 4, baseMax: 10, critDmgBonus: 30 },
            katana: { name: 'ÌÉúÎèÑ',   img: `${ICON_BASE}/lorc/crossed-swords.svg`,   bonus: { damage: 1.0, crit: 1.25 },  baseMin: 5, baseMax: 11, critDmgBonus: 50 },
            scythe: { name: 'ÎÇ´',     img: `${ICON_BASE}/lorc/scythe.svg`,           bonus: { damage: 1.1, crit: 1.1 },   baseMin: 4, baseMax: 15, critDmgBonus: 40 },
            bow:    { name: 'Ìôú',     img: `${ICON_BASE}/lorc/pocket-bow.svg`,       bonus: { damage: 0.8, crit: 1.25 },  baseMin: 0, baseMax: 12, critDmgBonus: 150 },
            crossbow: { name: 'ÏÑùÍ∂Å', img: `${ICON_BASE}/carl-olsen/crossbow.svg`,   bonus: { damage: 0.85, crit: 1.1 },   baseMin: 0, baseMax: 12, critDmgBonus: 150 },
            knuckle: { name: 'ÎÑàÌÅ¥',  img: `${ICON_BASE}/lorc/punch.svg`,            bonus: { damage: 0.5, crit: 1.0 },   baseMin: 5, baseMax: 6, critDmgBonus: 0 }
        };
        
        // ÎßàÎ≤ï Î¨¥Í∏∞ Ï≤¥ÌÅ¨
        function isMagicWeapon(weapon) {
            return weapon && WEAPON_TYPES[weapon.type]?.isMagic === true;
        }
        
        // ===== ÏÜçÏÑ± ÏãúÏä§ÌÖú =====
        const ELEMENTS = {
            none:      { name: 'Î¨¥ÏÜçÏÑ±', icon: '‚ö™', color: '#aaa' },
            fire:      { name: 'Î∂à', icon: 'üî•', color: '#ff4500', magicEffect: 'explosion' },
            ice:       { name: 'ÏñºÏùå', icon: '‚ùÑÔ∏è', color: '#00bfff', magicEffect: 'freeze' },
            lightning: { name: 'Î≤àÍ∞ú', icon: '‚ö°', color: '#ffd700', magicEffect: 'shock' },
            water:     { name: 'Î¨º', icon: 'üíß', color: '#1e90ff', magicEffect: 'heal' },
            poison:    { name: 'ÎèÖ', icon: '‚ò†Ô∏è', color: '#9932cc', magicEffect: 'dot' },
            holy:      { name: 'Ïã†ÏÑ±', icon: '‚ú®', color: '#fff8dc', magicEffect: 'smite' },
            silver:    { name: 'ÏùÄ', icon: 'üåô', color: '#c0c0c0' },
            lifesteal: { name: 'Ìù°Ìòà', icon: 'ü©∏', color: '#8b0000' }
        };
        
        // ÎßàÎ≤ï Î¨¥Í∏∞Ïö© ÏÜçÏÑ± (silver, lifesteal Ï†úÏô∏)
        const MAGIC_ELEMENTS = ['fire', 'ice', 'lightning', 'water', 'poison', 'holy'];
        
        // Ìù°Ìòà Î™¨Ïä§ÌÑ∞ Î™©Î°ù (Ïù¥ Î™¨Ïä§ÌÑ∞ Ï≤òÏπò Ïãú Ìù°Ìòà Î¨¥Í∏∞ ÎìúÎûç ÌôïÎ•†)
        const LIFESTEAL_MONSTERS = ['vampire', 'ghoul', 'spectre', 'lich'];
        
        const MONSTER_TYPES = {
            beast:     { name: 'ÏïºÏàò', icon: 'üê∫', weakness: ['fire'], resist: ['poison'] },
            undead:    { name: 'Ïñ∏Îç∞Îìú', icon: 'üíÄ', weakness: ['silver', 'holy', 'fire'], resist: ['poison', 'ice'] },
            demon:     { name: 'ÏïÖÎßà', icon: 'üëπ', weakness: ['holy', 'lightning'], resist: ['fire', 'poison'] },
            elemental: { name: 'Ï†ïÎ†π', icon: 'üåÄ', weakness: ['lightning'], resist: [] },
            humanoid:  { name: 'Ïù∏Í∞ÑÌòï', icon: 'üë§', weakness: ['poison'], resist: [] },
            dragon:    { name: 'Ïö©Ï°±', icon: 'üêâ', weakness: ['ice'], resist: ['fire'] },
            insect:    { name: 'Í≥§Ï∂©', icon: 'ü¶Ç', weakness: ['fire', 'ice'], resist: ['poison'] }
        };
        
        // ÏÜçÏÑ± ÏÉÅÏÑ± Î∞∞Ïàò Í≥ÑÏÇ∞
        function getElementMultiplier(weaponElement, monsterType) {
            if (!weaponElement || weaponElement === 'none' || !monsterType) return 1.0;
            const typeData = MONSTER_TYPES[monsterType];
            if (!typeData) return 1.0;
            
            if (typeData.weakness.includes(weaponElement)) return 2.0;  // ÏïΩÏ†ê 2Î∞∞!
            if (typeData.resist.includes(weaponElement)) return 0.5;   // Ï†ÄÌï≠ 0.5Î∞∞
            return 1.0;
        }
        
        // ===== MONSTER DATABASE =====
        // ÏïÑÏù¥ÏΩò: lorc, delapouite, caro-asercion Îì± ÏûëÍ∞ÄÎ≥Ñ Í≤ΩÎ°ú Íµ¨Î∂Ñ
        const MONSTERS = {
            // Tier 1 (Ïâ¨ÏõÄ)
            slime:    { name: 'Ïä¨ÎùºÏûÑ',     img: `${ICON_BASE}/delapouite/slime.svg`,        tier: 1, hp: 50,  damage: [5, 10],   crit: 5,  gold: [100, 200], type: 'elemental' },
            bat:      { name: 'Î∞ïÏ•ê',       img: `${ICON_BASE}/lorc/evil-bat.svg`,           tier: 1, hp: 40,  damage: [8, 12],   crit: 10, gold: [120, 180], type: 'beast' },
            worm:     { name: 'Î≤åÎ†à',       img: `${ICON_BASE}/lorc/fleshy-mass.svg`,        tier: 1, hp: 35,  damage: [6, 10],   crit: 8,  gold: [80, 150], type: 'insect' },
            rat:      { name: 'Ï•êÎñº',       img: `${ICON_BASE}/lorc/evil-minion.svg`,        tier: 1, hp: 30,  damage: [4, 8],    crit: 12, gold: [60, 120], type: 'beast' },
            spider:   { name: 'Í±∞ÎØ∏',       img: `${ICON_BASE}/delapouite/spider-eye.svg`,   tier: 1, hp: 45,  damage: [7, 11],   crit: 8,  gold: [90, 160], type: 'insect' },
            skeleton: { name: 'Ìï¥Í≥®Î≥ëÏÇ¨',   img: `${ICON_BASE}/lorc/diablo-skull.svg`,       tier: 1, hp: 55,  damage: [8, 14],   crit: 5,  gold: [110, 190], type: 'undead' },
            mushroom: { name: 'ÎèÖÎ≤ÑÏÑØ',     img: `${ICON_BASE}/lorc/spotted-mushroom.svg`,   tier: 1, hp: 38,  damage: [6, 12],   crit: 6,  gold: [85, 170], type: 'elemental' },
            wisp:     { name: 'ÎèÑÍπ®ÎπÑÎ∂à',   img: `${ICON_BASE}/lorc/spark-spirit.svg`,       tier: 1, hp: 32,  damage: [9, 13],   crit: 15, gold: [95, 175], type: 'elemental' },
            
            // Tier 2 (Ï§ëÍ∞Ñ)
            imp:      { name: 'ÏûÑÌîÑ',       img: `${ICON_BASE}/lorc/imp.svg`,                tier: 2, hp: 80,  damage: [12, 20],  crit: 12, gold: [200, 400], type: 'demon' },
            wolf:     { name: 'ÎäëÎåÄ',       img: `${ICON_BASE}/lorc/werewolf.svg`,           tier: 2, hp: 100, damage: [15, 25],  crit: 15, gold: [250, 450], type: 'beast' },
            spectre:  { name: 'ÎßùÎ†π',       img: `${ICON_BASE}/lorc/spectre.svg`,            tier: 2, hp: 90,  damage: [18, 28],  crit: 10, gold: [300, 500], type: 'undead' },
            goblin:   { name: 'Í≥†Î∏îÎ¶∞',     img: `${ICON_BASE}/delapouite/goblin-head.svg`,  tier: 2, hp: 70,  damage: [14, 22],  crit: 18, gold: [220, 380], type: 'humanoid' },
            zombie:   { name: 'Ï¢ÄÎπÑ',       img: `${ICON_BASE}/delapouite/shambling-zombie.svg`, tier: 2, hp: 120, damage: [10, 18], crit: 5, gold: [180, 350], type: 'undead' },
            harpy:    { name: 'ÌïòÌîº',       img: `${ICON_BASE}/lorc/harpy.svg`,              tier: 2, hp: 75,  damage: [16, 26],  crit: 20, gold: [280, 480], type: 'beast' },
            elemental_fire: { name: 'ÌôîÏóºÏ†ïÎ†π', img: `${ICON_BASE}/lorc/ifrit.svg`,          tier: 2, hp: 85,  damage: [20, 30],  crit: 8,  gold: [320, 520], type: 'elemental' },
            elemental_ice: { name: 'ÏñºÏùåÏ†ïÎ†π', img: `${ICON_BASE}/lorc/frozen-orb.svg`,       tier: 2, hp: 80,  damage: [18, 28],  crit: 10, gold: [300, 500], type: 'elemental' },
            bandit:   { name: 'ÏÇ∞Ï†Å',       img: `${ICON_BASE}/lorc/cowled.svg`,             tier: 2, hp: 95,  damage: [16, 24],  crit: 22, gold: [280, 480], type: 'humanoid' },
            lizardman: { name: 'Î¶¨ÏûêÎìúÎß®',  img: `${ICON_BASE}/lorc/lizardman.svg`,          tier: 2, hp: 110, damage: [14, 22], crit: 12, gold: [260, 440], type: 'beast' },
            
            // Tier 3 (Ïñ¥Î†§ÏõÄ) - Í∞ïÌôîÎêú Ïä§ÌÉØ
            beast:    { name: 'ÎßàÏàò',       img: `${ICON_BASE}/lorc/beast-eye.svg`,          tier: 3, hp: 220, damage: [35, 55],  crit: 15, gold: [600, 1000], type: 'beast' },
            minotaur: { name: 'ÎØ∏ÎÖ∏ÌÉÄÏö∞Î°úÏä§', img: `${ICON_BASE}/lorc/minotaur.svg`,          tier: 3, hp: 300, damage: [40, 60],  crit: 12, gold: [750, 1200], type: 'beast' },
            ghoul:    { name: 'Íµ¨Ïö∏',       img: `${ICON_BASE}/lorc/gooey-daemon.svg`,       tier: 3, hp: 260, damage: [45, 65],  crit: 15, gold: [850, 1350], type: 'undead' },
            orc:      { name: 'Ïò§ÌÅ¨ Ï†ÑÏÇ¨',   img: `${ICON_BASE}/delapouite/orc-head.svg`,     tier: 3, hp: 250, damage: [38, 58],  crit: 12, gold: [700, 1100], type: 'humanoid' },
            vampire:  { name: 'Î±ÄÌååÏù¥Ïñ¥',   img: `${ICON_BASE}/delapouite/vampire-dracula.svg`, tier: 3, hp: 230, damage: [42, 65], crit: 22, gold: [800, 1300], type: 'undead' },
            golem:    { name: 'Í≥®Î†ò',       img: `${ICON_BASE}/delapouite/rock-golem.svg`,   tier: 3, hp: 380, damage: [30, 50],  crit: 5,  gold: [720, 1150], type: 'elemental' },
            wyvern:   { name: 'ÏôÄÏù¥Î≤à',     img: `${ICON_BASE}/lorc/wyvern.svg`,             tier: 3, hp: 280, damage: [40, 65],  crit: 18, gold: [900, 1450], type: 'dragon' },
            dark_knight: { name: 'ÏïîÌùëÍ∏∞ÏÇ¨', img: `${ICON_BASE}/lorc/visored-helm.svg`,    tier: 3, hp: 320, damage: [45, 70],  crit: 15, gold: [950, 1500], type: 'humanoid' },
            succubus: { name: 'ÏÑúÌÅêÎ≤ÑÏä§',   img: `${ICON_BASE}/lorc/angel-wings.svg`,        tier: 3, hp: 200, damage: [55, 80],  crit: 28, gold: [850, 1400], type: 'demon' },
            troll:    { name: 'Ìä∏Î°§',       img: `${ICON_BASE}/lorc/muscle-up.svg`,          tier: 3, hp: 400, damage: [35, 55],  crit: 8,  gold: [800, 1250], type: 'beast' },
            gargoyle: { name: 'Í∞ÄÍ≥†Ïùº',     img: `${ICON_BASE}/lorc/bat-wing.svg`,           tier: 3, hp: 300, damage: [38, 60],  crit: 12, gold: [780, 1200], type: 'elemental' },
            chimera:  { name: 'ÌÇ§Î©îÎùº',     img: `${ICON_BASE}/lorc/double-face-mask.svg`,   tier: 3, hp: 340, damage: [45, 72],  crit: 18, gold: [1000, 1600], type: 'beast' },
            wraith:   { name: 'Î†àÏù¥Ïä§',     img: `${ICON_BASE}/lorc/spectre.svg`,            tier: 3, hp: 240, damage: [50, 75],  crit: 25, gold: [880, 1420], type: 'undead' },
            ogre:     { name: 'Ïò§Ïö∞Í±∞',     img: `${ICON_BASE}/lorc/muscle-up.svg`,          tier: 3, hp: 450, damage: [32, 52],  crit: 6,  gold: [760, 1180], type: 'beast' },
            cerberus: { name: 'ÏºÄÎ•¥Î≤†Î°úÏä§', img: `${ICON_BASE}/lorc/werewolf.svg`,           tier: 3, hp: 310, damage: [48, 70],  crit: 20, gold: [920, 1480], type: 'beast' },
            medusa:   { name: 'Î©îÎëêÏÇ¨',     img: `${ICON_BASE}/lorc/spectre.svg`,            tier: 3, hp: 220, damage: [52, 78],  crit: 30, gold: [950, 1550], type: 'demon' },
            giant_spider: { name: 'ÎåÄÏôïÍ±∞ÎØ∏', img: `${ICON_BASE}/delapouite/spider-eye.svg`, tier: 3, hp: 280, damage: [40, 62],  crit: 15, gold: [820, 1280], type: 'insect' },
            
            // Tier 4 (Î≥¥Ïä§) - Í∞ïÌôîÎêú Ïä§ÌÉØ
            dragon:   { name: 'üî• ÎìúÎûòÍ≥§',   img: './img/monsters/dragon.png',      tier: 4, hp: 600, damage: [70, 110],  crit: 22, gold: [4000, 6500], isBoss: true, type: 'dragon' },
            demon:    { name: 'üëπ Îç∞Î™¨',     img: './img/monsters/demon.png',       tier: 4, hp: 550, damage: [80, 120],  crit: 28, gold: [5000, 7500], isBoss: true, type: 'demon' },
            reaper:   { name: 'üíÄ ÏÇ¨Ïã†',     img: './img/monsters/reaper.png',       tier: 4, hp: 480, damage: [90, 135], crit: 35, gold: [6500, 10000], isBoss: true, type: 'undead' },
            lich:     { name: 'üëª Î¶¨Ïπò',     img: './img/monsters/lich.png',        tier: 4, hp: 450, damage: [75, 125],  crit: 25, gold: [5800, 9000], isBoss: true, type: 'undead' },
            hydra:    { name: 'üêç ÌûàÎìúÎùº',   img: './img/monsters/hydra.png',              tier: 4, hp: 700, damage: [60, 100],  crit: 18, gold: [4500, 7000], isBoss: true, type: 'dragon' },
            frost_giant: { name: '‚ùÑÔ∏è ÏÑúÎ¶¨Í±∞Ïù∏', img: './img/monsters/frost_giant.png', tier: 4, hp: 750, damage: [75, 115], crit: 15, gold: [5500, 8500], isBoss: true, type: 'elemental' },
            balrog:   { name: 'üî• Î∞úÎ°ù',     img: './img/monsters/balrog.png',              tier: 4, hp: 650, damage: [85, 130],  crit: 22, gold: [6200, 9500], isBoss: true, type: 'demon' },
            phoenix:  { name: 'ü¶Ö Î∂àÏÇ¨Ï°∞',   img: './img/monsters/phoenix.png',              tier: 4, hp: 500, damage: [80, 130], crit: 32, gold: [6800, 11000], isBoss: true, type: 'elemental' },
            succubus_boss: { name: 'üíã ÏÑúÌÅêÎ≤ÑÏä§', img: './img/monsters/succubus_boss.png', tier: 4, hp: 520, damage: [78, 118], crit: 30, gold: [6000, 9800], isBoss: true, type: 'demon' },
            
            // Tier 5 (Ï†ÑÏÑ§) - Í∑πÍ∞ï Ïä§ÌÉØ
            ancient_dragon: { name: 'üåü Í≥†ÎåÄÏö©', img: './img/monsters/ancient_dragon.png', tier: 5, hp: 1200, damage: [110, 180], crit: 28, gold: [15000, 30000], isBoss: true, type: 'dragon' },
            primordial_dragon: { name: 'üêâ ÌÉúÏ¥àÏùò Ïö©', img: './img/monsters/primordial_dragon.png', tier: 5, hp: 1150, damage: [120, 190], crit: 30, gold: [16000, 32000], isBoss: true, type: 'dragon' },
            demon_lord:     { name: 'üòà ÎßàÏôï',   img: './img/monsters/demon_lord.png',     tier: 5, hp: 1000, damage: [130, 200], crit: 35, gold: [18000, 35000], isBoss: true, type: 'demon' },
            demon_queen:    { name: 'üë∏ Ïó¨ÎßàÏôï', img: './img/monsters/demon_queen.png', tier: 5, hp: 980, damage: [125, 195], crit: 38, gold: [18500, 36000], isBoss: true, type: 'demon' },
            incubus:        { name: 'üñ§ Ïù∏ÌÅêÎ≤ÑÏä§', img: './img/monsters/incubus.png', tier: 5, hp: 920, damage: [140, 210], crit: 42, gold: [20000, 37000], isBoss: true, type: 'demon' },
            death_knight:   { name: '‚öîÔ∏è Ï£ΩÏùåÏùòÍ∏∞ÏÇ¨', img: './img/monsters/death_knight.png',  tier: 5, hp: 900, damage: [150, 220], crit: 40, gold: [22000, 40000], isBoss: true, type: 'undead' },
            
            // Tier 6 (Ïã†ÌôîÍ∏â Î≥¥Ïä§)
            valakas:    { name: 'üî• ÌôîÎ£° Î∞úÎùºÏπ¥Ïä§', img: './img/monsters/valakas.png',      tier: 6, hp: 2000, damage: [180, 280], crit: 30, gold: [50000, 80000], isBoss: true, type: 'dragon' },
            antharas:   { name: 'üåç ÏßÄÎ£° ÏïàÌÉÄÎùºÏä§', img: './img/monsters/antharas.png', tier: 6, hp: 2500, damage: [150, 250], crit: 20, gold: [45000, 75000], isBoss: true, type: 'dragon' },
            lindvior:   { name: 'üí® ÌíçÎ£° Î¶∞ÎìúÎπÑÏò§Î•¥', img: './img/monsters/lindvior.png',           tier: 6, hp: 1800, damage: [200, 300], crit: 40, gold: [55000, 90000], isBoss: true, type: 'dragon' },
            fafurion:   { name: 'üíß ÏàòÎ£° ÌååÌë∏Î¶¨Ïò®', img: './img/monsters/fafurion.png',              tier: 6, hp: 2200, damage: [160, 260], crit: 25, gold: [48000, 78000], isBoss: true, type: 'dragon' },
            succubus_queen: { name: 'üëë ÏÑúÌÅêÎ≤ÑÏä§ ÌÄ∏', img: './img/monsters/succubus_queen.png', tier: 6, hp: 1700, damage: [210, 290], crit: 45, gold: [52000, 88000], isBoss: true, type: 'demon' }
        };

        /*
        ===== Î¨¥Í∏∞ ÏÑ±Îä•Ìëú =====
        | Î¨¥Í∏∞     | Îç∞ÎØ∏ÏßÄ | ÌÅ¨Î¶¨Ìã∞Ïª¨ | ÌäπÏßï                    |
        |----------|--------|----------|-------------------------|
        | Í≤Ä       | 1.0x   | 1.0x     | Í∑†ÌòïÏû°Ìûå Í∏∞Î≥∏ Î¨¥Í∏∞      |
        | ÎèÑÎÅº     | 1.15x  | 0.9x     | ÎÜíÏùÄ Îç∞ÎØ∏ÏßÄ, ÎÇÆÏùÄ ÌÅ¨Î¶¨  |
        | Ï∞Ω       | 0.95x  | 1.1x     | ÏïΩÍ∞Ñ ÎÇÆÏùÄ ÎéÄ, ÎÜíÏùÄ ÌÅ¨Î¶¨ |
        | ÎßùÏπò     | 1.2x   | 0.85x    | ÏµúÍ≥† Îç∞ÎØ∏ÏßÄ, ÏµúÏ†Ä ÌÅ¨Î¶¨  |
        | Îã®Í≤Ä     | 0.85x  | 1.25x    | ÎÇÆÏùÄ ÎéÄ, ÏµúÍ≥† ÌÅ¨Î¶¨Ìã∞Ïª¨  |
        | ÏßÄÌå°Ïù¥   | 0.9x   | 1.0x     | ÎßàÎ≤ï ÌäπÏàòÌö®Í≥º           |
        | ÌÉúÎèÑ     | 1.05x  | 1.15x    | ÎÜíÏùÄ Í∑†Ìòï               |
        | ÎÇ´       | 1.1x   | 1.05x    | Ï¢ãÏùÄ Ïò¨ÎùºÏö¥Îçî           |
        */

        const GRADES = {
            common: { 
                name: 'ÏùºÎ∞ò', 
                color: '#9d9d9d', 
                multiplier: 1.0,
                dropRate: 49.2,
                durabilityMod: 2.0,  // ÎÇ¥Íµ¨ÎèÑ 2Î∞∞ Îπ®Î¶¨ ÏÜåÎ™®
                prefixes: ['ÎÇ°ÏùÄ', 'ÌèâÎ≤îÌïú', 'Í∏∞Î≥∏', 'Îã®ÏàúÌïú'],
                names: {
                    sword: 'ÎÇòÎ¨¥ÎßâÎåÄÍ∏∞',
                    axe: 'ÎÖπÏä® ÎèÑÎÅº',
                    spear: 'Îæ∞Ï°±Ìïú ÎßâÎåÄ',
                    hammer: 'ÎèåÎßùÏπò',
                    dagger: 'Ïù¥Ïë§ÏãúÍ∞ú',
                    staff: 'ÎÇòÎ≠áÍ∞ÄÏßÄ',
                    wand: 'Î∂ÄÎü¨ÏßÑ ÎßâÎåÄ',
                    katana: 'Ï£ΩÎèÑ',
                    scythe: 'ÎÜçÍ∏∞Íµ¨ ÎÇ´',
                    bow: 'ÏÉàÏ¥ù',  // ÌäπÏàò: ÌÅ¨Î¶¨ 100%, Îç∞ÎØ∏ÏßÄ 0-30 Í≥†Ï†ï!
                    crossbow: 'Ïû•ÎÇúÍ∞ê ÏÑùÍ∂Å',
                    knuckle: 'Îß®Ï£ºÎ®π'
                }
            },
            magic: { 
                name: 'Í≥†Í∏â', 
                color: '#5555ff', 
                multiplier: 1.3,
                dropRate: 29.5,
                durabilityMod: 1.5,  // ÎÇ¥Íµ¨ÎèÑ 1.5Î∞∞ Îπ®Î¶¨ ÏÜåÎ™®
                prefixes: ['Í∞ïÌôîÎêú', 'ÎßàÎ†•Ïùò', 'ÎπõÎÇòÎäî', 'Ï†ïÍµêÌïú'],
                names: {
                    sword: 'Ïú†Î¶¨Í≤Ä',  // ÌäπÏàò: Îä•Î†•Ïπò 2Î∞∞, ÌååÍ¥¥ÌôïÎ•† 30%!
                    wand: 'Í≤¨Ïäµ ÏôÑÎìú',
                    bow: 'ÎßàÎ†•Ïùò Ìôú',
                    crossbow: 'Ïó∞Î∞ú ÏÑùÍ∂Å',
                    knuckle: 'Í∞ïÏ≤† ÎÑàÌÅ¥'
                }
            },
            rare: { 
                name: 'Ìù¨Í∑Ä', 
                color: '#ffcc00', 
                multiplier: 1.7,
                dropRate: 13.5,
                durabilityMod: 1.0,  // Í∏∞Ï§Ä ÎÇ¥Íµ¨ÎèÑ ÏÜåÎ™®
                prefixes: ['Ï†ïÏòà', 'Î™ÖÏù∏Ïùò', 'Í≥†ÎåÄÏùò', 'Ï∂ïÎ≥µÎ∞õÏùÄ'],
                names: {
                    staff: 'ÌîºÎãâÏä§ ÏßÄÌå°Ïù¥',  // ÌäπÏàò: Ïó∞ÏÜç ÏÇ¨ÎÉ• Ïãú HP 100% ÌöåÎ≥µ!
                    wand: 'ÎßàÎ†• ÏôÑÎìú',
                    bow: 'Î™ÖÍ∂ÅÏùò Ìôú',
                    crossbow: 'Ï≤†Í∞ë ÏÑùÍ∂Å',
                    knuckle: 'Í≤©Ìà¨Í∞ÄÏùò Ï£ºÎ®π'
                }
            },
            legendary: { 
                name: 'Ï†ÑÏÑ§', 
                color: '#ff8000', 
                multiplier: 2.2,
                dropRate: 5.5,
                durabilityMod: 0.7,  // ÎÇ¥Íµ¨ÎèÑ 30% Îçú ÏÜåÎ™®
                prefixes: ['Ï†ÑÏÑ§Ïùò', 'ÏòÅÏõÖÏùò', 'Ïã†ÏÑ±Ìïú', 'Î∂àÎ©∏Ïùò'],
                names: {
                    sword: 'ÏóëÏä§ÏπºÎ¶¨Î≤Ñ',
                    axe: 'ÏõîÍ¥ëÎèÑÎÅº',
                    spear: 'Ïö©ÏÇ¥Ï∞Ω',
                    hammer: 'Ï≤úÎë•ÎßùÏπò',
                    dagger: 'Í∑∏Î¶ºÏûê Îã®Í≤Ä',
                    staff: 'ÎåÄÌòÑÏûêÏùò ÏßÄÌå°Ïù¥',
                    wand: 'ÎåÄÎßàÎ≤ïÏÇ¨Ïùò ÏôÑÎìú',
                    katana: 'Ï≤úÍ≤Ä',
                    scythe: 'Ï†ÄÏäπÏÇ¨ÏûêÏùò ÎÇ´',
                    bow: 'Ï≤úÏÉÅÏùò Ìôú',
                    crossbow: 'ÎìúÎûòÍ≥§ ÌÇ¨Îü¨',
                    knuckle: 'ÌÉÄÏù¥ÌÉÑ ÌîºÏä§Ìä∏'
                }
            },
            unique: { 
                name: 'Ïú†ÎãàÌÅ¨', 
                color: '#00ff80', 
                multiplier: 3.0,
                dropRate: 1,
                durabilityMod: 0.5,  // ÎÇ¥Íµ¨ÎèÑ 50% Îçú ÏÜåÎ™®
                prefixes: [''],
                names: {
                    sword: 'ÎùºÍ∑∏ÎÇòÎ°úÌÅ¨',
                    axe: 'Î†àÎπÑÏïÑÌÉÑ',
                    spear: 'Í≤åÏù¥Î≥ºÍ∑∏',
                    hammer: 'Î¨†ÎãàÎ•¥',
                    dagger: 'ÏïîÌùëÍ≤Ä ÏïÑÏ¶àÎùºÏóò',
                    staff: 'ÌòÑÏûêÏùò ÏßÄÌå°Ïù¥',
                    wand: 'ÏóòÎçîÏôÑÎìú',
                    katana: 'Î¨¥ÎùºÎßàÏÇ¨',
                    scythe: 'Ï£ΩÏùåÏùò ÎÇ´',
                    bow: 'ÏïÑÌè¥Î°†Ïùò Ìôú',
                    crossbow: 'Î∞úÎ¶¨Ïä§ÌÉÄ',
                    knuckle: 'Í∞ìÌï∏Îìú'
                }
            },
            mythic: {
                name: 'Ïã†Ìôî',
                color: '#ff00ff',
                multiplier: 4.0,
                dropRate: 0.3,  // 0.3% ÌôïÎ•†
                durabilityMod: 0.3,  // ÎÇ¥Íµ¨ÎèÑ 70% Îçú ÏÜåÎ™®
                prefixes: [''],
                names: {
                    sword: 'ÏóêÍ≥†ÏÜåÎìú',
                    axe: 'ÏÑ∏Í≥ÑÏàòÏùò ÎèÑÎÅº',
                    spear: 'Î°±Í∏∞ÎàÑÏä§',
                    hammer: 'Ï∞ΩÏÑ∏Ïùò ÎßùÏπò',
                    dagger: 'Ïπ¥Ïò§Ïä§ Î∏îÎ†àÏù¥Îìú',
                    staff: 'ÏïÑÏπ¥Ïãù Î†àÏΩîÎìú',
                    wand: 'ÏÑ∏Í≥ÑÏàòÏùò ÏôÑÎìú',
                    katana: 'ÏïÑÎßàÌÖåÎùºÏä§',
                    scythe: 'Ï¢ÖÏñ∏Ïùò ÎÇ´',
                    bow: 'ÏïÑÎ•¥ÌÖåÎØ∏Ïä§',
                    crossbow: 'Ïã†Î≤å',
                    knuckle: 'ÏõêÌéÄÏπò'
                }
            }
        };

        // Îçî Ïä§Î¶¥ÏûàÎäî ÌôïÎ•†! +4Î∂ÄÌÑ∞ ÌååÍ¥¥ ÏãúÏûë!
        const MAX_ENHANCE_LEVEL = 99;
        
        const ENHANCE_RATES = {
            0: { success: 100, destroy: 0, cost: 100 },      // +0‚Üí+1: 100%
            1: { success: 95, destroy: 0, cost: 200 },       // +1‚Üí+2: 95%
            2: { success: 90, destroy: 0, cost: 400 },       // +2‚Üí+3: 90%
            3: { success: 80, destroy: 0, cost: 800 },       // +3‚Üí+4: 80%
            4: { success: 72, destroy: 4, cost: 1500 },      // +4‚Üí+5: 72% ‚ö†Ô∏è ÌååÍ¥¥ ÏãúÏûë!
            5: { success: 64, destroy: 6, cost: 3000 },      // +5‚Üí+6: 64%
            6: { success: 56, destroy: 9, cost: 5000 },      // +6‚Üí+7: 56%
            7: { success: 50, destroy: 13, cost: 8000 },     // +7‚Üí+8: 50%
            8: { success: 45, destroy: 18, cost: 12000 },    // +8‚Üí+9: 45%
            9: { success: 40, destroy: 22, cost: 20000 },    // +9‚Üí+10: 40%
            10: { success: 38, destroy: 22, cost: 35000 },   // +10‚Üí+11: 38% üî•
            11: { success: 34, destroy: 26, cost: 50000 },   // +11‚Üí+12: 34%
            12: { success: 30, destroy: 30, cost: 80000 },   // +12‚Üí+13: 30%
            13: { success: 26, destroy: 34, cost: 120000 },  // +13‚Üí+14: 26% ‚ò†Ô∏è
            14: { success: 22, destroy: 38, cost: 200000 },  // +14‚Üí+15: 22%
            15: { success: 18, destroy: 42, cost: 350000 },  // +15‚Üí+16: 18% üíÄ
            16: { success: 14, destroy: 46, cost: 500000 },  // +16‚Üí+17: 14%
            17: { success: 11, destroy: 50, cost: 750000 },  // +17‚Üí+18: 11%
            18: { success: 8, destroy: 54, cost: 1000000 },  // +18‚Üí+19: 8%
            19: { success: 6, destroy: 58, cost: 1500000 },  // +19‚Üí+20: 6% üé∞
            20: { success: 4, destroy: 62, cost: 2000000 }   // +20‚Üí+21: 4%
        };
        
        // 21+ Î†àÎ≤® Í∞ïÌôî ÌôïÎ•† ÎèôÏ†Å Í≥ÑÏÇ∞
        function getBaseEnhanceRates(level) {
            if (level <= 20) return ENHANCE_RATES[level];
            // 21+: ÌõÑÎ∞ò ÏôÑÌôî (ÏÑ±Í≥µÎ•† ÏÉÅÌñ•, ÌååÍ¥¥Ïú® ÌïòÌñ•)
            const baseCost = 2000000;
            const costMultiplier = Math.pow(1.5, level - 20);
            return {
                success: 1.5,
                destroy: 75,
                cost: Math.floor(baseCost * costMultiplier)
            };
        }

        // ===== GAME STATE =====
        let state = {
            gold: 10000,
            weapon: null,
            protectionScrolls: 3,
            useProtection: true,
            protectionManuallyOff: false,
            destroyedWeapons: [],
            stats: { attempts: 0, successes: 0, fails: 0, destroys: 0, wins: 0, losses: 0 },
            mastery: { attacks: 0, kills: 0 },  // ÏàôÎ†®ÎèÑ ÏãúÏä§ÌÖú
            bossKills: 0,  // Î≥¥Ïä§ Ï≤òÏπò ÌöüÏàò (Í∞ïÌôîÌôïÎ•† +1% per kill)
            bossTypeKills: { dragon: 0, demon: 0, undead: 0, elemental: 0 },  // ÏÜçÏÑ±Î≥Ñ Î≥¥Ïä§ÌÇ¨
            // Ï†ÄÏ£º Ìä∏Î¶¨Í±∞ Ïπ¥Ïö¥ÌÑ∞
            consecutiveEnhanceFails: 0,  // +0ÏóêÏÑú Ïó∞ÏÜç Í∞ïÌôî Ïã§Ìå®
            consecutiveFlees: 0,         // Ïó∞ÏÜç ÎèÑÎßù
            consecutivePvpLosses: 0,     // Ïó∞ÏÜç PVP Ìå®Î∞∞
            consecutiveCritsTaken: 0     // Ïó∞ÏÜç ÌÅ¨Î¶¨Ìã∞Ïª¨ ÌîºÍ≤©
        };
        
        // ===== CLOUD SYNC =====
        let cloudSyncEnabled = false;
        let lastSyncTime = 0;
        const SYNC_DEBOUNCE_MS = 3000; // 3Ï¥àÎßàÎã§ ÏµúÎåÄ 1Ìöå ÎèôÍ∏∞Ìôî
        
        async function checkCloudSync() {
            // multiplayer.jsÏùò ensureAuth ÌÜµÌï¥ ÌÜ†ÌÅ∞ ÌôïÏù∏
            if (typeof MultiplayerClient === 'undefined') return;
            const token = localStorage.getItem('cocy_auth_token');
            if (!token) return;
            
            try {
                // ÌÜ†ÌÅ∞Ïù¥ ÏùµÎ™ÖÏù∏ÏßÄ ÌôïÏù∏ (sub ÌïÑÎìúÍ∞Ä ÏûàÏúºÎ©¥ Î°úÍ∑∏Ïù∏ Ïú†Ï†Ä)
                const parts = token.split('.');
                if (parts.length !== 3) return;
                const payload = JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));
                
                if (payload.sub) {
                    // Î°úÍ∑∏Ïù∏ Ïú†Ï†Ä! ÌÅ¥ÎùºÏö∞Îìú ÎèôÍ∏∞Ìôî ÌôúÏÑ±Ìôî
                    cloudSyncEnabled = true;
                    console.log('‚òÅÔ∏è Cloud sync enabled for logged-in user');
                    await loadFromCloud();
                }
            } catch (e) {
                console.log('Cloud sync check failed:', e);
            }
        }
        
        async function loadFromCloud() {
            if (!cloudSyncEnabled) return;
            const token = localStorage.getItem('cocy_auth_token');
            if (!token) return;
            
            try {
                const res = await fetch('https://relay.cocy.io/api/user/data', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) return;
                
                const data = await res.json();
                if (data.gold !== undefined) {
                    // ÏÑúÎ≤Ñ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥ Î≥ëÌï© (ÏÑúÎ≤Ñ Ïö∞ÏÑ†)
                    const serverData = data.data || {};
                    
                    // Î°úÏª¨Í≥º ÏÑúÎ≤Ñ Ï§ë Îçî ÏßÑÌñâÎêú Ï™Ω ÏÇ¨Ïö©
                    const localGold = state.gold;
                    const serverGold = data.gold;
                    
                    if (serverGold > 0 || serverData.weapon) {
                        // ÏÑúÎ≤ÑÏóê Îç∞Ïù¥ÌÑ∞ ÏûàÏùå - ÏÑúÎ≤Ñ Ïö∞ÏÑ†
                        state.gold = serverGold;
                        if (serverData.weapon) {
                            // Î¨¥Í∏∞ Îç∞Ïù¥ÌÑ∞ Í≤ÄÏ¶ù Î∞è Î≥µÍµ¨
                            const w = serverData.weapon;
                            
                            // ÌïÑÏàò ÌïÑÎìú Í≤ÄÏ¶ù
                            if (!w.type || !WEAPON_TYPES[w.type]) {
                                console.warn('‚òÅÔ∏è Invalid weapon type, fixing...', w.type);
                                w.type = 'sword';
                            }
                            if (!w.grade || !GRADES[w.grade]) {
                                console.warn('‚òÅÔ∏è Invalid weapon grade, fixing...', w.grade);
                                w.grade = 'common';
                            }
                            if (typeof w.level !== 'number') {
                                w.level = 0;
                            }
                            if (!w.name) {
                                w.name = WEAPON_TYPES[w.type].name;
                            }
                            if (!w.element) {
                                w.element = 'none';
                            }
                            if (typeof w.durability !== 'number') {
                                w.durability = 100;
                            }
                            if (!w.img) {
                                w.img = WEAPON_TYPES[w.type].img;
                            }
                            if (!w.weaponMastery) {
                                w.weaponMastery = { attacks: 0, crits: 0, kills: 0, killsByType: {} };
                            }
                            
                            state.weapon = w;
                            console.log('‚òÅÔ∏è Weapon loaded:', w.name, '+' + w.level, w.type, w.grade);
                        }
                        if (serverData.mastery) state.mastery = serverData.mastery;
                        if (serverData.stats) state.stats = serverData.stats;
                        if (serverData.protectionScrolls !== undefined) state.protectionScrolls = serverData.protectionScrolls;
                        
                        // Î°úÏª¨ÏóêÎèÑ Ï†ÄÏû•
                        localStorage.setItem('enhance_game_v3', JSON.stringify(state));
                        console.log('‚òÅÔ∏è Loaded from cloud:', state.gold, 'G');
                    } else if (localGold > 0) {
                        // ÏÑúÎ≤Ñ ÎπÑÏñ¥ÏûàÍ≥† Î°úÏª¨Ïóê Îç∞Ïù¥ÌÑ∞ ÏûàÏùå - ÏóÖÎ°úÎìú
                        await saveToCloud();
                    }
                }
            } catch (e) {
                console.log('Cloud load failed:', e);
            }
        }
        
        async function saveToCloud() {
            if (!cloudSyncEnabled) return;
            
            // ÎîîÎ∞îÏö¥Ïã±
            const now = Date.now();
            if (now - lastSyncTime < SYNC_DEBOUNCE_MS) return;
            lastSyncTime = now;
            
            const token = localStorage.getItem('cocy_auth_token');
            if (!token) return;
            
            try {
                await fetch('https://relay.cocy.io/api/user/data', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        gold: state.gold,
                        weapon: state.weapon,
                        mastery: state.mastery,
                        stats: state.stats,
                        protectionScrolls: state.protectionScrolls
                    })
                });
                console.log('‚òÅÔ∏è Saved to cloud');
            } catch (e) {
                console.log('Cloud save failed:', e);
            }
        }
        
        // ===== RANKING SYSTEM =====
        const RANKING_API = 'https://relay.cocy.io/api/rankings';
        let pendingKills = 0;  // Î∞∞ÏπòÎ°ú Î≥¥ÎÇº ÌÇ¨ Ïàò
        let pendingStreak = 0; // ÌòÑÏû¨ Ïó∞ÏÜç ÌÇ¨
        
        function getUserId() {
            // 1. Î®ºÏ†Ä Ï†ÄÏû•Îêú user_id ÌôïÏù∏
            let userId = localStorage.getItem('cocy_user_id');
            if (userId) return userId;
            
            // 2. JWT ÌÜ†ÌÅ∞ÏóêÏÑú Ï∂îÏ∂ú
            const token = localStorage.getItem('cocy_auth_token') || localStorage.getItem('accessToken');
            if (token) {
                try {
                    const parts = token.split('.');
                    if (parts.length === 3) {
                        const payload = JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));
                        userId = payload.sub || payload.userId || payload.user_id;
                        if (userId) {
                            localStorage.setItem('cocy_user_id', userId);  // Ï∫êÏãú
                            return userId;
                        }
                    }
                } catch (e) {
                    console.log('Token parse error:', e);
                }
            }
            
            // 3. ÏùµÎ™Ö ID ÏÉùÏÑ± (ÏóÜÏúºÎ©¥)
            userId = 'anon_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('cocy_user_id', userId);
            return userId;
        }
        
        // Î°úÍ∑∏Ïù∏ Ïú†Ï†Ä ÎãâÎÑ§ÏûÑ Í∞ÄÏ†∏Ïò§Í∏∞
        function getUserNickname() {
            // 1. relayÏóêÏÑú Ï†ÄÏû•Ìïú ÎãâÎÑ§ÏûÑ
            const relayNick = localStorage.getItem('relay_nickname');
            if (relayNick) return relayNick;
            
            // 2. JWT ÌÜ†ÌÅ∞ÏóêÏÑú Ï∂îÏ∂ú
            const token = localStorage.getItem('cocy_auth_token') || localStorage.getItem('accessToken');
            if (token) {
                try {
                    const parts = token.split('.');
                    if (parts.length === 3) {
                        const payload = JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));
                        return payload.nickname || null;
                    }
                } catch (e) {}
            }
            return null;
        }
        
        // Î¨¥Í∏∞ Îû≠ÌÇπ Í∞±Ïã† (Ïã†Í∏∞Î°ù Ïãú)
        async function syncWeaponRanking() {
            const userId = getUserId();
            const nickname = getUserNickname();
            console.log('üèÜ syncWeaponRanking called, userId:', userId, 'nickname:', nickname, 'weapon:', state.weapon?.level);
            if (!userId || !state.weapon) return;
            
            try {
                const res = await fetch(`${RANKING_API}/weapon`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: userId,
                        nickname: nickname,  // Î°úÍ∑∏Ïù∏ Ïú†Ï†ÄÎ©¥ ÎãâÎÑ§ÏûÑ Ìè¨Ìï®
                        level: state.weapon.level,
                        name: `${state.weapon.name}${isCursed(state.weapon) ? ' üëøÏ†ÄÏ£º' : ''}`,
                        grade: state.weapon.grade,
                        element: state.weapon.element || 'none'
                    })
                });
                const data = await res.json();
                console.log('üèÜ Weapon ranking response:', data);
            } catch (e) {
                console.error('üèÜ Weapon ranking sync failed:', e);
            }
        }
        
        // ÏÇ¨ÎÉ• Îû≠ÌÇπ Í∞±Ïã† (Î∞∞Ïπò)
        async function syncHuntingRanking() {
            const userId = getUserId();
            const nickname = getUserNickname();
            console.log('üêâ syncHuntingRanking called, userId:', userId, 'nickname:', nickname, 'kills:', pendingKills);
            if (!userId || pendingKills <= 0) return;
            
            const kills = pendingKills;
            const streak = pendingStreak;
            pendingKills = 0;  // Î¶¨ÏÖã
            
            try {
                const res = await fetch(`${RANKING_API}/hunting`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: userId,
                        nickname: nickname,
                        kills: kills,
                        killStreak: streak
                    })
                });
                const data = await res.json();
                console.log('üêâ Hunting ranking response:', data);
            } catch (e) {
                console.error('üêâ Hunting ranking sync failed:', e);
            }
        }
        
        // PvP Îû≠ÌÇπ Í∞±Ïã†
        async function syncPvPRanking(isWin, opponentRating = 1000) {
            const userId = getUserId();
            const nickname = getUserNickname();
            console.log('‚öîÔ∏è syncPvPRanking called, userId:', userId, 'nickname:', nickname, 'isWin:', isWin);
            if (!userId) return;
            
            try {
                const res = await fetch(`${RANKING_API}/pvp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: userId,
                        nickname: nickname,
                        isWin,
                        opponentRating
                    })
                });
                const data = await res.json();
                console.log('‚öîÔ∏è PvP ranking response:', data);
                return data;
            } catch (e) {
                console.error('‚öîÔ∏è PvP ranking sync failed:', e);
                return null;
            }
        }
        
        // Îû≠ÌÇπ Ï°∞Ìöå
        async function fetchRankings(type = 'weapons') {
            try {
                const res = await fetch(`${RANKING_API}/${type}?limit=50`);
                const data = await res.json();
                return data.success ? data.rankings : [];
            } catch (e) {
                console.log('Fetch rankings failed:', e);
                return [];
            }
        }
        
        // ÌéòÏù¥ÏßÄ Ï¢ÖÎ£å Ïãú ÎÇ®ÏùÄ ÌÇ¨ ÎèôÍ∏∞Ìôî
        window.addEventListener('beforeunload', () => {
            if (pendingKills > 0) {
                // sendBeaconÏúºÎ°ú ÎπÑÎèôÍ∏∞ Ï†ÑÏÜ°
                const userId = getUserId();
                if (userId) {
                    navigator.sendBeacon(`${RANKING_API}/hunting`, JSON.stringify({
                        kills: pendingKills,
                        killStreak: pendingStreak
                    }));
                }
            }
        });
        
        // Í∞ïÌôî Î†àÎ≤®Ïóê Îî∞Î•∏ Ïπ¥Îìú ÌÅ¥ÎûòÏä§
        function getLevelClass(level) {
            if (level >= 21) return 'level-21';
            if (level >= 19) return 'level-19-20';
            if (level >= 16) return 'level-16-18';
            if (level >= 13) return 'level-13-15';
            if (level >= 10) return 'level-10-12';
            if (level >= 8) return 'level-8-9';
            if (level >= 4) return 'level-4-7';
            return 'level-0-3';
        }
        
        // ÏàôÎ†®ÎèÑ Î≥¥ÎÑàÏä§ Í≥ÑÏÇ∞ (Í≥µÍ≤©Î†• %)
        function getMasteryBonus() {
            // Î∞©Ïñ¥ ÏΩîÎìú: mastery Í∞ùÏ≤¥ ÏóÜÍ±∞ÎÇò ÌïÑÎìú ÏóÜÏúºÎ©¥ 0
            const attacks = state.mastery?.attacks || 0;
            const kills = state.mastery?.kills || 0;
            const attackBonus = Math.min(20, Math.floor(attacks / 50)); // 50Î≤àÎãπ 1%, ÏµúÎåÄ 20%
            const killBonus = Math.min(30, Math.floor(kills / 10)); // 10ÌÇ¨Îãπ 1%, ÏµúÎåÄ 30%
            return attackBonus + killBonus; // ÏµúÎåÄ 50%
        }
        
        // Î¨¥Í∏∞ Î≥ÄÍ≤Ω Ïãú ÏàôÎ†®ÎèÑ Ï¥àÍ∏∞Ìôî
        function resetMastery() {
            state.mastery = { attacks: 0, kills: 0 };
        }

        function addDestroyedWeaponRecord(weapon, reason, streak = 0) {
            if (!weapon) return;
            if (!Array.isArray(state.destroyedWeapons)) state.destroyedWeapons = [];

            const reasonLabel = {
                enhance_destroy: 'Í∞ïÌôî ÌååÍ¥¥',
                monster_death: 'ÏÇ¨ÎÉ• ÏÇ¨Îßù',
                durability_break: 'ÎÇ¥Íµ¨ÎèÑ ÌååÍ¥¥',
                pvp_death: 'PvP Ìå®Î∞∞'
            }[reason] || 'ÌååÍ¥¥';

            const record = {
                at: Date.now(),
                reason,
                reasonLabel,
                name: weapon.name,
                grade: weapon.grade,
                level: weapon.level || 0,
                kills: weapon.weaponMastery?.kills || 0,
                streak: streak || 0,
                cursed: isCursed(weapon),
                image: getWeaponIcon(weapon)
            };

            state.destroyedWeapons.unshift(record);
            state.destroyedWeapons = state.destroyedWeapons.slice(0, 20);
        }
        
        // ÎÇ¥Íµ¨ÎèÑ ÏãúÏä§ÌÖú
        const MAX_DURABILITY = 100;
        
        // Îì±Í∏âÎ≥Ñ ÏàòÎ¶¨ÎπÑ Î∞∞Ïàò (Ïã†ÌôîÍ∞Ä ÎπÑÏåà)
        const REPAIR_COST_MULT = {
            common: 0.5,
            magic: 0.8,
            rare: 1.0,
            legendary: 1.5,
            unique: 2.0,
            mythic: 3.0
        };
        
        function getRepairCost(weapon) {
            if (!weapon) return 0;
            const missingDurability = MAX_DURABILITY - (weapon.durability || MAX_DURABILITY);
            const levelCost = getBaseEnhanceRates(Math.min(weapon.level, 20)).cost;
            const gradeMult = REPAIR_COST_MULT[weapon.grade] || 1.0;
            return Math.floor((missingDurability / 100) * (levelCost / 10) * gradeMult);
        }

        let mpUI = null;
        let battleState = null;
        let cachedMyId = null;  // Cache user ID for use after client is destroyed

        // ===== WEAPON GENERATION =====
        function generateWeapon(forceGrade = null) {
            // Pick grade
            let grade;
            if (forceGrade) {
                grade = forceGrade;
            } else {
                const roll = Math.random() * 100;
                let cumulative = 0;
                for (const [g, data] of Object.entries(GRADES)) {
                    cumulative += data.dropRate;
                    if (roll < cumulative) {
                        grade = g;
                        break;
                    }
                }
            }

            // Pick type
            const types = Object.keys(WEAPON_TYPES);
            const type = types[Math.floor(Math.random() * types.length)];
            const typeData = WEAPON_TYPES[type];
            const gradeData = GRADES[grade];

            // Generate name
            let name;
            // ÌäπÎ≥Ñ Ïù¥Î¶ÑÏù¥ ÏûàÎäî Îì±Í∏â (common, legendary, unique, mythic)
            if (gradeData.names && gradeData.names[type]) {
                name = gradeData.names[type];
            } else {
                const prefix = gradeData.prefixes[Math.floor(Math.random() * gradeData.prefixes.length)];
                name = prefix ? `${prefix} ${typeData.name}` : typeData.name;
            }

            // ÎûúÎç§ ÏÜçÏÑ± Î∂ÄÏó¨ (Îì±Í∏âÏóê Îî∞Îùº ÌôïÎ•† Ï¶ùÍ∞Ä)
            // üèÜ Ï†ÑÏÑ§ Î¨¥Í∏∞: Í≥†Ï†ï ÏÜçÏÑ± (Ïù¥ÎØ∏ÏßÄÏôÄ Îß§Ïπ≠)
            // üßô ÎßàÎ≤ï Î¨¥Í∏∞(ÏßÄÌå°Ïù¥, ÏôÑÎìú)Îäî Ìï≠ÏÉÅ ÎßàÎ≤ï ÏÜçÏÑ± Î≥¥Ïú†!
            const elementChance = { common: 0.1, magic: 0.3, rare: 0.5, legendary: 0.7, unique: 1.0, mythic: 1.0 };
            let element = 'none';
            if (grade === 'legendary' && LEGENDARY_ELEMENTS[type]) {
                element = LEGENDARY_ELEMENTS[type];
            } else if (typeData.isMagic) {
                element = MAGIC_ELEMENTS[Math.floor(Math.random() * MAGIC_ELEMENTS.length)];
            } else if (Math.random() < elementChance[grade]) {
                const elements = ['fire', 'ice', 'lightning', 'silver', 'poison', 'holy'];
                element = elements[Math.floor(Math.random() * elements.length)];
            }
            
            return {
                type,
                grade,
                name,
                level: 0,
                element,
                img: typeData.img,
                durability: MAX_DURABILITY,
                protectionScrolls: 2,  // Î¨¥Í∏∞Î≥Ñ ÌååÍ¥¥Î∞©ÏßÄ 2Ìöå Í∏∞Î≥∏ Ï†úÍ≥µ
                // ÏàôÎ†®ÎèÑ ÏãúÏä§ÌÖú (Î¨¥Í∏∞Î≥Ñ)
                weaponMastery: {
                    attacks: 0,
                    crits: 0,
                    kills: 0,
                    killsByType: {}  // { 'undead': 3, 'beast': 5, ... }
                }
            };
        }
        
        // Ï¢ÖÏ°±Ïùò Ï∑®ÏïΩ ÏÜçÏÑ± Í∞ÄÏ†∏Ïò§Í∏∞
        function getWeaknessElement(monsterType) {
            const typeData = MONSTER_TYPES[monsterType];
            if (!typeData || !typeData.weakness || typeData.weakness.length === 0) return 'none';
            return typeData.weakness[Math.floor(Math.random() * typeData.weakness.length)];
        }
        
        // ÏàôÎ†®ÎèÑ Í∏∞Î∞ò ÏÜçÏÑ± Î∂ÄÏó¨ (100ÎßàÎ¶¨ Ïù¥ÏÉÅ Ï≤òÏπòÌïú Ï¢ÖÏ°±Ïùò Ï∑®ÏïΩ ÏÜçÏÑ±)
        function getMasteryElement(weapon) {
            if (!weapon?.weaponMastery?.killsByType) return null;
            const kills = weapon.weaponMastery.killsByType;
            
            // 100ÎßàÎ¶¨ Ïù¥ÏÉÅ Ï≤òÏπòÌïú Ï¢ÖÏ°± Ï∞æÍ∏∞
            for (const [type, count] of Object.entries(kills)) {
                if (count >= 100) {
                    return getWeaknessElement(type);
                }
            }
            return null;
        }
        
        // Î¨¥Í∏∞ ÌöçÎìù (ÏÉÅÌô©Î≥Ñ Îì±Í∏â Î∞è ÏÜçÏÑ± Ï°∞Ï†à)
        // dropSource: 'sell', 'monster_death', 'pvp_death', 'enhance_destroy_high', 'enhance_destroy_low', 'durability_break'
        // context: { monsterType, opponentElement, weaponLevel }
        function generateWeaponBySource(dropSource, context = {}) {
            let gradeRoll = Math.random() * 100;
            let grade;
            let element = 'none';
            
            if (dropSource === 'sell') {
                // ÌåêÎß§: ÏùºÎ∞ò~Î†àÏñ¥, ÎûúÎç§ ÏÜçÏÑ±
                if (gradeRoll < 15) grade = 'rare';
                else if (gradeRoll < 45) grade = 'magic';
                else grade = 'common';
                // ÎûúÎç§ ÏÜçÏÑ± (generateWeaponÏóêÏÑú Ï≤òÎ¶¨)
                
            } else if (dropSource === 'monster_death' || dropSource === 'pvp_death') {
                // ÏÇ¨Îßù: Î†àÏñ¥~Ïú†ÎãàÌÅ¨, Ï∑®ÏïΩ ÏÜçÏÑ± Î∂ÄÏó¨
                if (gradeRoll < 15) grade = 'unique';
                else if (gradeRoll < 45) grade = 'legendary';
                else grade = 'rare';
                
                // ÏÜçÏÑ±: Î™¨Ïä§ÌÑ∞ Ï∑®ÏïΩ or ÏÉÅÎåÄ Î¨¥Í∏∞ ÏÜçÏÑ±
                if (dropSource === 'monster_death' && context.monsterType) {
                    // Ìù°Ìòà Î™¨Ïä§ÌÑ∞ÏóêÍ≤å Ï£ΩÏúºÎ©¥ Ìù°Ìòà ÏÜçÏÑ± Î¨¥Í∏∞!
                    if (LIFESTEAL_MONSTERS.includes(context.monsterType)) {
                        element = 'lifesteal';
                    } else {
                        element = getWeaknessElement(context.monsterType);
                    }
                } else if (dropSource === 'pvp_death' && context.opponentElement) {
                    element = context.opponentElement;
                }
                
            } else if (dropSource === 'enhance_destroy_high') {
                // +7 Ïù¥ÏÉÅ Í∞ïÌôî ÌååÍ¥¥: Ïú†ÎãàÌÅ¨~Ï†ÑÏÑ§, ÏÜçÏÑ± ÏóÜÏùå!
                if (gradeRoll < 40) grade = 'unique';
                else grade = 'legendary';
                element = 'none'; // ÏÜçÏÑ± ÏóÜÏùå Í≥†Ï†ï
                
            } else if (dropSource === 'enhance_destroy_low') {
                // +6 Ïù¥Ìïò Í∞ïÌôî ÌååÍ¥¥: ÏôÑÏ†Ñ ÎûúÎç§ Îì±Í∏â (Ï†ÑÏÑ§/Ïú†ÎãàÌÅ¨ÎèÑ Í∞ÄÎä•!)
                if (gradeRoll < 2) grade = 'unique';       // 2%
                else if (gradeRoll < 10) grade = 'legendary'; // 8%
                else if (gradeRoll < 30) grade = 'rare';    // 20%
                else if (gradeRoll < 60) grade = 'magic';   // 30%
                else grade = 'common';                      // 40%
                // ÎûúÎç§ ÏÜçÏÑ±
                
            } else if (dropSource === 'durability_break') {
                // ÎÇ¥Íµ¨ÎèÑ ÌååÍ¥¥: Ï†ÑÏÑ§ Ïù¥ÏÉÅ! Ïã†Ìôî 5%, Ïú†ÎãàÌÅ¨ 25%, Ï†ÑÏÑ§ 70%
                if (gradeRoll < 5) grade = 'mythic';
                else if (gradeRoll < 30) grade = 'unique';
                else grade = 'legendary';
                
                // ÏàôÎ†®ÎèÑ Í∏∞Î∞ò ÏÜçÏÑ± (100ÎßàÎ¶¨ Ïù¥ÏÉÅ Ï≤òÏπòÌïú Ï¢ÖÏ°± Ï∑®ÏïΩ)
                const masteryEl = getMasteryElement(state.weapon);
                if (masteryEl) {
                    element = masteryEl;
                }
                
            } else {
                // Í∏∞Î≥∏
                return generateWeapon();
            }
            
            // Î¨¥Í∏∞ ÏÉùÏÑ±
            const weapon = generateWeapon(grade);
            
            // ÏÜçÏÑ± ÎçÆÏñ¥Ïì∞Í∏∞ (Ï†ÑÏÑ§ Î¨¥Í∏∞Îäî Í≥†Ï†ï ÏÜçÏÑ± Ïú†ÏßÄ)
            if (weapon.grade === 'legendary' && LEGENDARY_ELEMENTS[weapon.type]) {
                weapon.element = LEGENDARY_ELEMENTS[weapon.type];
            } else if (element !== 'none' || dropSource === 'enhance_destroy_high') {
                weapon.element = element;
            }
            
            return weapon;
        }
        
        // PvP Ìå®Î∞∞ Ïãú Î¨¥Í∏∞ ÏßÄÍ∏â (ÏÉÅÎåÄ Îì±Í∏âÎ≥¥Îã§ Ï¢ãÏùÄ Î¨¥Í∏∞ + ÎûúÎç§ ÏÜçÏÑ±)
        function generateWeaponByPvPLoss(enemyGrade) {
            // Îì±Í∏â ÏàúÏÑú
            const gradeOrder = ['common', 'magic', 'rare', 'legendary', 'unique', 'mythic'];
            const enemyIndex = gradeOrder.indexOf(enemyGrade);
            
            // ÏÉÅÎåÄÎ≥¥Îã§ 1~2 Îì±Í∏â ÏúÑ (ÏµúÏÜå rare, ÏµúÎåÄ mythic)
            const minGradeIndex = Math.max(2, enemyIndex + 1);  // ÏµúÏÜå rare
            const maxGradeIndex = Math.min(5, enemyIndex + 2);  // ÏµúÎåÄ mythic
            
            // ÌôïÎ•† Î∂ÑÎ∞∞ (ÎÜíÏùÄ Îì±Í∏âÏùºÏàòÎ°ù ÎÇÆÏùå)
            let grade;
            const roll = Math.random() * 100;
            if (maxGradeIndex >= 5 && roll < 5) {
                grade = 'mythic';  // 5%
            } else if (maxGradeIndex >= 4 && roll < 20) {
                grade = 'unique';  // 15%
            } else if (maxGradeIndex >= 3 && roll < 50) {
                grade = 'legendary';  // 30%
            } else {
                grade = gradeOrder[minGradeIndex];  // ÎÇòÎ®∏ÏßÄ (rare)
            }
            
            // Î¨¥Í∏∞ ÏÉùÏÑ±
            const weapon = generateWeapon(grade);
            
            // 100% ÏÜçÏÑ± Î∂ÄÏó¨
            const elements = ['fire', 'ice', 'lightning', 'silver', 'poison', 'holy'];
            weapon.element = elements[Math.floor(Math.random() * elements.length)];
            
            return weapon;
        }
        
        // Îì±Í∏âÎ≥Ñ ÏàôÎ†®ÎèÑ ÏÉÅÏäπ Î∞∞Ïàò (ÏùºÎ∞ò=10Î∞∞ Îπ†Î¶Ñ, Ïã†Ìôî=Í∏∞Î≥∏)
        const MASTERY_MULTIPLIER = {
            common: 10,     // 10Í≥µÍ≤©Îãπ 1Î†àÎ≤®
            magic: 5,       // 20Í≥µÍ≤©Îãπ 1Î†àÎ≤®
            rare: 2.5,      // 40Í≥µÍ≤©Îãπ 1Î†àÎ≤®
            legendary: 1.5, // 67Í≥µÍ≤©Îãπ 1Î†àÎ≤®
            unique: 1.2,    // 83Í≥µÍ≤©Îãπ 1Î†àÎ≤®
            mythic: 1.0     // 100Í≥µÍ≤©Îãπ 1Î†àÎ≤®
        };
        
        // Î¨¥Í∏∞ ÏàôÎ†®ÎèÑ Î†àÎ≤® (Îì±Í∏âÎ≥Ñ Ï∞®Îì±, ÏµúÎåÄ 50)
        function getWeaponMasteryLevel(weapon) {
            if (!weapon?.weaponMastery) return 0;
            const mult = MASTERY_MULTIPLIER[weapon.grade] || 1.0;
            return Math.min(50, Math.floor(weapon.weaponMastery.attacks * mult / 100));
        }
        
        // ÏàôÎ†®ÎèÑ Î≥¥ÎÑàÏä§ (Î†àÎ≤®Îãπ 1%, ÏµúÎåÄ 50%)
        function getWeaponMasteryBonus(weapon) {
            return getWeaponMasteryLevel(weapon);
        }
        
        // ÌäπÏàò Î¨¥Í∏∞ ÏïÑÏù¥ÏΩò (ÎÇòÎ¨¥ÎßâÎåÄÍ∏∞ = ÎÇòÎ≠áÍ∞ÄÏßÄ ÏïÑÏù¥ÏΩò)
        // Ï†ÑÏÑ§ Î¨¥Í∏∞ Í≥†Ï†ï ÏÜçÏÑ± (Ïù¥ÎØ∏ÏßÄ ÎπÑÏ£ºÏñº Í∏∞Î∞ò)
        const LEGENDARY_ELEMENTS = {
            sword: 'holy',       // Í∏àÎπõ ÏÑ±Í≤Ä
            axe: 'fire',         // ÌôîÏóº ÎèÑÎÅº
            bow: 'holy',         // Í∏àÎπõ Ìôú
            spear: 'lightning',  // Î≤àÍ∞ú Ï∞Ω
            dagger: 'poison',    // ÎèÖ Îã®Í≤Ä
            staff: 'ice',        // ÏïÑÏºÄÏù∏ ÏßÄÌå°Ïù¥ ‚Üí ÏñºÏùå
            katana: 'fire',      // Î≤öÍΩÉ ÌÉúÎèÑ ‚Üí Î∂à
            scythe: 'poison',    // ÏòÅÌòº ÎÇ´ ‚Üí ÎèÖ
            knuckle: 'lightning', // Î≤àÍ∞ú ÎÑàÌÅ¥
            crossbow: 'fire',    // Ìè≠Î∞ú ÏÑùÍ∂Å
            hammer: 'lightning'  // Ï≤úÎë• Ìï¥Î®∏
        };

        const LEGENDARY_ICONS = {
            sword: 'icons/sword-legendary.png',
            axe: 'icons/axe-legendary.png',
            bow: 'icons/bow-legendary.png',
            spear: 'icons/spear-legendary.png',
            dagger: 'icons/dagger-legendary.png',
            staff: 'icons/staff-legendary.png',
            katana: 'icons/katana-legendary.png',
            scythe: 'icons/scythe-legendary.png',
            knuckle: 'icons/knuckle-legendary.png',
            crossbow: 'icons/crossbow-legendary.png',
            hammer: 'icons/hammer-legendary.png'
        };

        // Ïã†Ìôî: Ìô©Í∏àÎπõ (Ï†ÑÏÑ§ Ïù¥ÎØ∏ÏßÄ ÏÇ¨Ïö©)
        const MYTHIC_ICONS = {
            sword: 'icons/sword-legendary.png',
            axe: 'icons/axe-legendary.png',
            bow: 'icons/bow-legendary.png',
            spear: 'icons/spear-legendary.png',
            dagger: 'icons/dagger-legendary.png',
            staff: 'icons/staff-legendary.png',
            katana: 'icons/katana-legendary.png',
            scythe: 'icons/scythe-legendary.png',
            knuckle: 'icons/knuckle-legendary.png',
            crossbow: 'icons/crossbow-legendary.png',
            hammer: 'icons/hammer-legendary.png'
        };

        function getWeaponIcon(weapon) {
            if (weapon.name === 'ÎÇòÎ¨¥ÎßâÎåÄÍ∏∞') {
                return WEAPON_TYPES.staff.img;
            }
            // Ïã†Ìôî Îì±Í∏â: Ïª§Ïä§ÌÖÄ Ïª¨Îü¨ Ïù¥ÎØ∏ÏßÄ
            if (weapon.grade === 'mythic' && MYTHIC_ICONS[weapon.type]) {
                return MYTHIC_ICONS[weapon.type];
            }
            // Ï†ÑÏÑ§ Îì±Í∏â: Ïª§Ïä§ÌÖÄ Ïª¨Îü¨ Ïù¥ÎØ∏ÏßÄ
            if (weapon.grade === 'legendary' && LEGENDARY_ICONS[weapon.type]) {
                return LEGENDARY_ICONS[weapon.type];
            }
            return WEAPON_TYPES[weapon.type].img;
        }
        
        // Get weapon image HTML with proper coloring
        function getWeaponImgHtml(weapon, size = 80) {
            const gradeData = GRADES[weapon.grade];
            const iconUrl = getWeaponIcon(weapon);
            const isCustomImg = (weapon.grade === 'legendary' && LEGENDARY_ICONS[weapon.type]) || (weapon.grade === 'mythic' && MYTHIC_ICONS[weapon.type]);
            let filterStyle = `drop-shadow(0 0 15px ${gradeData.color})`;
            // üëø Ï†ÄÏ£ºÎ∞õÏùÄ Î¨¥Í∏∞: Î≥¥ÎùºÏÉâ Ìã¥Ìä∏ + Ïñ¥ÎëêÏö¥ Í∏ÄÎ°úÏö∞
            if (isCursed(weapon)) {
                filterStyle = isCustomImg
                    ? `drop-shadow(0 0 20px #8b00ff) drop-shadow(0 0 40px #5500aa) hue-rotate(270deg) saturate(2)`
                    : `drop-shadow(0 0 20px #8b00ff) drop-shadow(0 0 40px #5500aa)`;
            }
            // Ï†ÑÏÑ§: ÌöåÏÉâÎπõ ÌÜ§
            else if (weapon.grade === 'legendary' && isCustomImg) {
                filterStyle = `drop-shadow(0 0 15px #aaa) grayscale(0.6) brightness(1.2)`;
            }
            const extraClass = isCustomImg ? ' legendary-img' : '';
            return `<img src="${iconUrl}" 
                         class="weapon-icon${extraClass}" 
                         style="width:${size}px;height:${size}px;filter:${filterStyle};object-fit:contain;" 
                         alt="${weapon.name}">`;
        }

        function getWeaponStats(weapon, includeMastery = true) {
            if (!weapon) return { damageMin: 0, damageMax: 0, critChance: 0, critDamage: 150, hp: 100, masteryBonus: 0, weaponMasteryBonus: 0 };

            // Î∞©Ïñ¥ ÏΩîÎìú: type/grade ÏóÜÏúºÎ©¥ Í∏∞Î≥∏Í∞í
            const typeData = WEAPON_TYPES[weapon.type] || WEAPON_TYPES.sword;
            const gradeData = GRADES[weapon.grade] || GRADES.common;
            const mult = gradeData.multiplier || 1.0;
            const level = weapon.level || 0;
            const globalMasteryBonus = includeMastery ? getMasteryBonus() : 0;
            const weaponMasteryBonus = includeMastery ? getWeaponMasteryBonus(weapon) : 0;
            const totalMasteryBonus = globalMasteryBonus + weaponMasteryBonus;

            // Ïù¥Ïë§ÏãúÍ∞ú: Îç∞ÎØ∏ÏßÄ 1 Í≥†Ï†ï, ÌÅ¨Î¶¨Ìã∞Ïª¨ 50%+Í∞ïÌôîÎ†àÎ≤®, ÌÅ¨Î¶¨Ìã∞Ïª¨ Îç∞ÎØ∏ÏßÄ 1000! (ÌÅ¨Î¶¨Ìã∞Ïª¨ Ïãú ÎÇ¥Íµ¨ÎèÑ -50)
            if (isToothpick(weapon)) {
                return { 
                    damageMin: 1, 
                    damageMax: 1, 
                    critChance: 50 + level,  // Í∞ïÌôîÌï†ÏàòÎ°ù ÌÅ¨Î¶¨Ìã∞Ïª¨ Ï¶ùÍ∞Ä
                    critDamage: 1000, 
                    hp: Math.floor((100 + level * 20) * mult),
                    masteryBonus: globalMasteryBonus, 
                    weaponMasteryBonus 
                };
            }
            
            // ÏÉàÏ¥ù: ÌÅ¨Î¶¨ 100%, Îç∞ÎØ∏ÏßÄ 0~(1+Î†àÎ≤®*2, ÏµúÎåÄ30)
            if (isSlingshot(weapon)) {
                return { 
                    damageMin: 0, 
                    damageMax: Math.min(30, 1 + level * 2),  // +0=1, +15=31‚Üí30, Ïù¥ÌõÑ Í≥†Ï†ï
                    critChance: 100,  // 100% ÌÅ¨Î¶¨Ìã∞Ïª¨!
                    critDamage: 300,  // ÌÅ¨Î¶¨ Îç∞ÎØ∏ÏßÄ 300%
                    hp: Math.floor((100 + level * 20) * mult),
                    masteryBonus: globalMasteryBonus, 
                    weaponMasteryBonus 
                };
            }

            // Î¨¥Í∏∞ ÌÉÄÏûÖÎ≥Ñ Í∏∞Î≥∏ Îç∞ÎØ∏ÏßÄ Î≤îÏúÑ (ÎÇòÎ¨¥ÎßâÎåÄÍ∏∞Îäî 1 Í≥†Ï†ï)
            const isStick = isWoodenStick(weapon);
            const baseDmgMin = isStick ? 1 : (typeData.baseMin || 5);
            const baseDmgMax = isStick ? 1 : (typeData.baseMax || 8);
            const dmgPerLevel = 2.5;

            // ÏàôÎ†®ÎèÑ Î≥¥ÎÑàÏä§ Ï†ÅÏö© (Í∏ÄÎ°úÎ≤å + Î¨¥Í∏∞Î≥Ñ)
            const masteryMult = 1 + (totalMasteryBonus / 100);
            const typeBonus = typeData.bonus?.damage || 1.0;
            const critBonus = typeData.bonus?.crit || 1.0;
            const critDmgBonus = typeData.critDmgBonus || 0;
            let damageMin = Math.floor((baseDmgMin + level * dmgPerLevel) * mult * typeBonus * masteryMult);
            let damageMax = Math.floor((baseDmgMax + level * dmgPerLevel) * mult * typeBonus * masteryMult);
            // ÎÇòÎ≠áÍ∞ÄÏßÄ: 99% ÌÅ¨Î¶¨Ìã∞Ïª¨!
            let critChance = isTreeBranch(weapon) ? 99 : Math.min(60, Math.floor((5 + level * 2) * critBonus));
            // Î¨¥Í∏∞ ÌÉÄÏûÖÎ≥Ñ ÌÅ¨Î¶¨Ìã∞Ïª¨ Îç∞ÎØ∏ÏßÄ Î≥¥ÎÑàÏä§ Ï†ÅÏö©
            let critDamage = 150 + level * 5 + critDmgBonus;
            let hp = Math.floor((100 + level * 20) * mult);
            
            // Ïú†Î¶¨Í≤Ä: Î™®Îì† Îä•Î†•Ïπò 2Î∞∞! (Îã®, ÌååÍ¥¥ÌôïÎ•† 30%)
            if (isGlassSword(weapon)) {
                damageMin *= 2;
                damageMax *= 2;
                critChance = Math.min(80, critChance * 2);
                critDamage *= 2;
                hp *= 2;
            }
            
            // ÏõêÍ±∞Î¶¨ Î¨¥Í∏∞(Ìôú, ÏÑùÍ∂Å): ÏµúÏÜå Îç∞ÎØ∏ÏßÄ 0 Í≥†Ï†ï!
            if (weapon.type === 'bow' || weapon.type === 'crossbow') {
                damageMin = 0;
            }

            // üêâ Î≥¥Ïä§ ÏÜçÏÑ±Î≥Ñ Î≥¥ÎÑàÏä§
            const btk = state?.bossTypeKills || {};
            if (btk.dragon) { damageMin = Math.floor(damageMin * (1 + btk.dragon * 0.02)); damageMax = Math.floor(damageMax * (1 + btk.dragon * 0.02)); }
            if (btk.demon) { critChance = Math.min(80, critChance + btk.demon * 1); }
            if (btk.elemental) { hp = Math.floor(hp * (1 + btk.elemental * 0.03)); }

            return { damageMin, damageMax, critChance, critDamage, hp, masteryBonus: globalMasteryBonus, weaponMasteryBonus };
        }

        function getWeaponValue(weapon) {
            if (!weapon) return 0;
            
            // Ìà¨ÏûêÌïú Í∞ïÌôî ÎπÑÏö© Í≥ÑÏÇ∞
            let totalCost = 0;
            for (let i = 0; i < weapon.level; i++) {
                totalCost += getBaseEnhanceRates(i).cost;
            }
            
            // Îì±Í∏âÎ≥Ñ Í∏∞Î≥∏ Í∞ÄÏπò (Ïñ¥Î∑∞Ïßï Î∞©ÏßÄ: ÎÇÆÏùÄ Îì±Í∏âÏùÄ Í∏∞Î≥∏Í∞Ä ÎÇÆÏùå)
            const gradeBaseValue = {
                common: 0,      // ÏùºÎ∞ò: Í∏∞Î≥∏Í∞Ä 0
                magic: 100,     // Í≥†Í∏â: 100
                rare: 500,      // Ìù¨Í∑Ä: 500
                legendary: 2000, // Ï†ÑÏÑ§: 2000
                unique: 5000    // Ïú†ÎãàÌÅ¨: 5000
            };
            const baseValue = gradeBaseValue[weapon.grade] || 0;
            
            // Í∞ïÌôî Î†àÎ≤®Ïóê Îî∞Î•∏ ÌåêÎß§Í∞Ä ÎπÑÏú®
            // +5 Ïù¥Ìïò: Ìà¨ÏûêÎπÑÏö©Ïùò 20% (ÏÜêÌï¥)
            // +6~10: Ìà¨ÏûêÎπÑÏö©Ïùò 35%
            // +11+: Ìà¨ÏûêÎπÑÏö©Ïùò 50% + Î≥¥ÎÑàÏä§
            let sellRatio;
            if (weapon.level <= 5) {
                sellRatio = 0.2;
            } else if (weapon.level <= 10) {
                sellRatio = 0.35;
            } else {
                sellRatio = 0.5;
            }
            
            const levelValue = Math.floor(totalCost * sellRatio);
            
            // Í≥†Í∞ïÌôî Î≥¥ÎÑàÏä§ (+10 Ïù¥ÏÉÅÎ∂ÄÌÑ∞)
            const highEnhanceBonus = weapon.level >= 10 ? (weapon.level - 9) * 1000 : 0;
            
            return baseValue + levelValue + highEnhanceBonus;
        }

        // ===== STORAGE =====
        function loadState() {
            const saved = localStorage.getItem('enhance_game_v3');
            if (saved) {
                const parsed = JSON.parse(saved);
                state = { ...state, ...parsed };
            }
            if (!state.weapon) {
                state.weapon = generateWeapon('common');
            }
            // Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò
            if (!state.mastery) {
                state.mastery = { attacks: 0, kills: 0 };
            }
            if (state.weapon && state.weapon.durability === undefined) {
                state.weapon.durability = MAX_DURABILITY;
            }
            // Î¨¥Í∏∞Î≥Ñ ÌååÍ¥¥Î∞©ÏßÄ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò
            if (state.weapon && state.weapon.protectionScrolls === undefined) {
                state.weapon.protectionScrolls = 2;
            }
            if (state.protectionManuallyOff === undefined) {
                state.protectionManuallyOff = false;
            }
            if (!Array.isArray(state.destroyedWeapons)) {
                state.destroyedWeapons = [];
            }
        }

        function saveState() {
            localStorage.setItem('enhance_game_v3', JSON.stringify(state));
            // ÌÅ¥ÎùºÏö∞Îìú ÎèôÍ∏∞Ìôî (ÎπÑÎèôÍ∏∞, ÎîîÎ∞îÏö¥Ïã±Îê®)
            saveToCloud();
            // SharedWallet ÎèôÍ∏∞Ìôî
            if (typeof SharedWallet !== 'undefined') {
                SharedWallet.gold = state.gold;
                SharedWallet._updateUI();
            }
        }

        // ===== MAIN SCREEN =====
        function showMain() {
            const weapon = state.weapon;
            const stats = getWeaponStats(weapon);
            const gradeData = GRADES[weapon.grade];

            document.getElementById('app').innerHTML = `
                <div class="container">
                    <header>
                        <h1>‚öîÔ∏è Î¨¥Í∏∞ Í∞ïÌôî & Î∞∞ÌãÄ</h1>
                        <p class="subtitle">Í∞ïÌôîÌïòÍ≥† Ïã∏ÏõåÏÑú ÎèàÏùÑ Î≤åÏñ¥Îùº!</p>
                    </header>

                    <div class="gold-display">
                        <span class="gold-icon">üí∞</span>
                        <span class="gold-amount">${state.gold.toLocaleString()} G</span>
                        ${cloudSyncEnabled ? '<span style="margin-left:8px;color:#4ecca3;font-size:0.8rem;">‚òÅÔ∏è ÎèôÍ∏∞Ìôî</span>' : ''}
                    </div>

                    <div class="weapon-card ${weapon.grade} ${getLevelClass(weapon.level)}">
                        <div class="weapon-header">
                            <div class="weapon-info">
                                <div class="weapon-grade ${weapon.grade}">${gradeData.name}${isCursed(weapon) ? ' <span style="color:#8b00ff;">üëøÏ†ÄÏ£º</span>' : ''}</div>
                                <div class="weapon-name">${weapon.name} ${weapon.element && weapon.element !== 'none' ? ELEMENTS[weapon.element]?.icon || '' : ''}</div>
                                <div class="weapon-type">${WEAPON_TYPES[weapon.type].name}${weapon.element && weapon.element !== 'none' ? ` | ${ELEMENTS[weapon.element]?.name}` : ''}</div>
                            </div>
                            <div class="weapon-level">
                                <div class="weapon-level-number">+${weapon.level}</div>
                                <div class="weapon-level-label">Í∞ïÌôî</div>
                            </div>
                        </div>

                        <div class="weapon-icon-area">
                            <img src="${getWeaponIcon(weapon)}" 
                                 class="weapon-icon${(weapon.grade === 'legendary' && LEGENDARY_ICONS[weapon.type]) || (weapon.grade === 'mythic' && MYTHIC_ICONS[weapon.type]) ? ' legendary-img' : ''}${isCursed(weapon) ? ' cursed-weapon' : ''}" 
                                 style="width:100px;height:100px;filter:${isCursed(weapon) ? 'drop-shadow(0 0 20px #8b00ff) drop-shadow(0 0 40px #5500aa)' : `drop-shadow(0 0 20px ${gradeData.color})`}${weapon.grade === 'legendary' && LEGENDARY_ICONS[weapon.type] && !isCursed(weapon) ? ' grayscale(0.6) brightness(1.2)' : ''};"
                                 alt="${weapon.name}">
                        </div>

                        <div class="weapon-stats">
                            <div class="stat-item">
                                <span class="stat-icon">${weapon.type === 'knuckle' ? 'üëä' : '‚öîÔ∏è'}</span>
                                <div class="stat-info">
                                    <div class="stat-value damage">${stats.damageMin}-${stats.damageMax}${weapon.type === 'knuckle' ? ' <span style="color:#ff8c00;font-size:0.7em;">x2</span>' : ''}</div>
                                    <div class="stat-label">Í≥µÍ≤©Î†•</div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <span class="stat-icon">üí•</span>
                                <div class="stat-info">
                                    <div class="stat-value crit">${stats.critChance}%${weapon.type === 'knuckle' ? ' <span style="color:#ff8c00;font-size:0.7em;">x2</span>' : ''}</div>
                                    <div class="stat-label">ÌÅ¨Î¶¨Ìã∞Ïª¨</div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <span class="stat-icon">üîß</span>
                                <div class="stat-info">
                                    <div class="stat-value ${isCursed(weapon) ? 'danger' : (weapon.durability || 100) < 30 ? 'danger' : ''}">${weapon.durability || 100}%${isCursed(weapon) ? ' <span style="color:#8b00ff;font-size:0.7em;">üëø</span>' : ''}</div>
                                    <div class="stat-label">ÎÇ¥Íµ¨ÎèÑ</div>
                                </div>
                            </div>
                            <div class="stat-item" onclick="showMasteryDetail()" style="cursor:pointer;">
                                <span class="stat-icon">üìà</span>
                                <div class="stat-info">
                                    <div class="stat-value special">Lv.${getWeaponMasteryLevel(weapon)}</div>
                                    <div class="stat-label">ÏàôÎ†® <span style="color:var(--success);font-size:0.7rem;">+${getWeaponMasteryBonus(weapon)}%</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mode-grid" style="grid-template-columns: repeat(2, 1fr);">
                        <button class="mode-btn enhance" onclick="showEnhance()">
                            <span class="mode-icon">üî®</span>
                            <span class="mode-label">Í∞ïÌôî</span>
                        </button>
                        <button class="mode-btn" onclick="showBlacksmith()" style="background:linear-gradient(135deg,#555,#333);">
                            <span class="mode-icon">üõ†Ô∏è</span>
                            <span class="mode-label">ÎåÄÏû•Í∞Ñ</span>
                        </button>
                        <button class="mode-btn hunt" onclick="showHunt()">
                            <span class="mode-icon">üêâ</span>
                            <span class="mode-label">ÏÇ¨ÎÉ•</span>
                        </button>
                        <button class="mode-btn battle" onclick="showBattleLobby()">
                            <span class="mode-icon">‚öîÔ∏è</span>
                            <span class="mode-label">PvP</span>
                        </button>
                    </div>
                    
                    <button class="mode-btn" onclick="showRanking()" style="width:100%;margin-bottom:8px;background:linear-gradient(135deg,#ffd700,#ff8c00);padding:10px;">
                        <span class="mode-icon">üèÜ</span>
                        <span class="mode-label">Îû≠ÌÇπ</span>
                    </button>

                    <div class="stats-summary">
                        <div class="summary-item">
                            <span class="summary-value">${state.stats.attempts}</span>
                            <span class="summary-label">ÏãúÎèÑ</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-value" style="color:var(--success)">${state.stats.successes}</span>
                            <span class="summary-label">ÏÑ±Í≥µ</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-value" style="color:var(--fail)">${state.stats.fails}</span>
                            <span class="summary-label">Ïã§Ìå®</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-value">${state.stats.wins}Ïäπ ${state.stats.losses}Ìå®</span>
                            <span class="summary-label">Ï†ÑÏ†Å</span>
                        </div>
                    </div>

                    <footer>
                        ¬© 2026 <a href="https://game.cocy.io">game.cocy.io</a>
                    </footer>
                </div>
            `;
        }

        // ===== ENHANCE SCREEN =====
        function showEnhance() {
            const weapon = state.weapon;
            const stats = getWeaponStats(weapon);
            const gradeData = GRADES[weapon.grade];
            const rates = getEnhanceRates(weapon);
            const canEnhance = state.gold >= rates.cost && weapon.level < MAX_ENHANCE_LEVEL;
            const showProtection = rates.destroy > 0;
            const scrolls = weapon.protectionScrolls || 0;

            if (scrolls <= 0) {
                state.useProtection = false;
                state.protectionManuallyOff = false; // 0Í∞úÏòÄÎã§Í∞Ä Íµ¨Îß§ÌïòÎ©¥ Îã§Ïãú Í∏∞Î≥∏ ON
            } else if (showProtection && !state.protectionManuallyOff) {
                state.useProtection = true; // ÏàòÎèô OFF Ï†ÑÍπåÏßÄ Í∏∞Î≥∏ ON
            }

            document.getElementById('app').innerHTML = `
                <div class="container">
                    <div class="gold-display">
                        <span class="gold-icon">üí∞</span>
                        <span class="gold-amount">${state.gold.toLocaleString()} G</span>
                    </div>

                    <div class="weapon-card ${weapon.grade} ${getLevelClass(weapon.level)}">
                        <div class="weapon-header">
                            <div class="weapon-info">
                                <div class="weapon-grade ${weapon.grade}">${gradeData.name}${isCursed(weapon) ? ' <span style="color:#8b00ff;">üëøÏ†ÄÏ£º</span>' : ''}</div>
                                <div class="weapon-name">${weapon.name}</div>
                            </div>
                            <div class="weapon-level">
                                <div class="weapon-level-number">+${weapon.level}</div>
                                <div class="weapon-level-label">Í∞ïÌôî</div>
                            </div>
                        </div>

                        <div class="weapon-icon-area">
                            <img src="${getWeaponIcon(weapon)}" 
                                 class="weapon-icon${(weapon.grade === 'legendary' && LEGENDARY_ICONS[weapon.type]) || (weapon.grade === 'mythic' && MYTHIC_ICONS[weapon.type]) ? ' legendary-img' : ''}${isCursed(weapon) ? ' cursed-weapon' : ''}" 
                                 id="weaponIcon"
                                 style="width:120px;height:120px;filter:${isCursed(weapon) ? 'drop-shadow(0 0 20px #8b00ff) drop-shadow(0 0 40px #5500aa)' : `drop-shadow(0 0 20px ${gradeData.color})`}${isCursed(weapon) ? ' hue-rotate(270deg) saturate(2)' : ''};"
                                 alt="${weapon.name}">
                        </div>

                        <div class="weapon-stats">
                            <div class="stat-item">
                                <span class="stat-icon">${weapon.type === 'knuckle' ? 'üëä' : '‚öîÔ∏è'}</span>
                                <div class="stat-info">
                                    <div class="stat-value damage">${stats.damageMin}-${stats.damageMax}${weapon.type === 'knuckle' ? ' <span style="color:#ff8c00;font-size:0.7em;">x2</span>' : ''}</div>
                                    <div class="stat-label">Í≥µÍ≤©Î†•</div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <span class="stat-icon">üí•</span>
                                <div class="stat-info">
                                    <div class="stat-value crit">${stats.critChance}%${weapon.type === 'knuckle' ? ' <span style="color:#ff8c00;font-size:0.7em;">x2</span>' : ''}</div>
                                    <div class="stat-label">ÌÅ¨Î¶¨Ìã∞Ïª¨</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="enhance-panel">
                        <div class="enhance-row">
                            <span class="enhance-label">üéØ ÏÑ±Í≥µ</span>
                            <span class="enhance-value ${rates.success >= 50 ? 'safe' : rates.success >= 20 ? '' : 'danger'}">${rates.success}%${isCursed(weapon) ? ' <span style="color:#8b00ff;font-size:0.7em;">üëøx2</span>' : ''}${(state.bossKills || 0) > 0 ? ` <span style="color:#ff8c00;font-size:0.7em;">üêâ+${state.bossKills}%</span>` : ''}</span>
                        </div>
                        <div class="enhance-row">
                            <span class="enhance-label">${rates.destroy >= 50 ? 'üíÄ' : rates.destroy > 0 ? '‚ö†Ô∏è' : '‚úÖ'} ÌååÍ¥¥</span>
                            <span class="enhance-value ${rates.destroy >= 50 ? 'danger' : rates.destroy > 0 ? 'warning' : 'safe'}">${rates.destroy > 0 ? rates.destroy + '%' : 'ÏóÜÏùå'}</span>
                        </div>
                        <div class="enhance-row">
                            <span class="enhance-label">üí∞ ÎπÑÏö©</span>
                            <span class="enhance-value gold">${rates.cost.toLocaleString()} G</span>
                        </div>
                    </div>

                    ${(() => { const btk = state.bossTypeKills || {}; const any = (btk.dragon||0)+(btk.demon||0)+(btk.undead||0)+(btk.elemental||0); return any > 0 ? `
                    <div style="background:rgba(255,140,0,0.1);border:1px solid rgba(255,140,0,0.3);border-radius:10px;padding:8px 12px;margin:6px 0;font-size:0.8rem;">
                        <div style="color:#ff8c00;font-weight:600;margin-bottom:4px;">üèÜ Î≥¥Ïä§ÌÇ¨ Î≥¥ÎÑàÏä§</div>
                        ${btk.dragon ? `<div>üêâ ÎìúÎûòÍ≥§ x${btk.dragon} ‚Üí Í≥µÍ≤©Î†• +${btk.dragon*2}%</div>` : ''}
                        ${btk.demon ? `<div>üòà ÏïÖÎßà x${btk.demon} ‚Üí ÌÅ¨Î¶¨Ìã∞Ïª¨ +${btk.demon}%</div>` : ''}
                        ${btk.undead ? `<div>üíÄ Ïñ∏Îç∞Îìú x${btk.undead} ‚Üí Í≥®Îìú +${btk.undead*5}%</div>` : ''}
                        ${btk.elemental ? `<div>‚ö° Ï†ïÎ†π x${btk.elemental} ‚Üí Ï≤¥Î†• +${btk.elemental*3}%</div>` : ''}
                    </div>` : ''; })()}

                    ${showProtection ? `
                    <div class="protection-toggle">
                        <span>üõ°Ô∏è ÌååÍ¥¥ Î∞©ÏßÄ (${weapon.protectionScrolls || 0}Í∞ú)</span>
                        <div style="display:flex;gap:8px;align-items:center;">
                            <button class="toggle-btn ${state.useProtection ? 'on' : 'off'}" onclick="toggleProtection()" id="protectionBtn">
                                ${state.useProtection ? 'ON' : 'OFF'}
                            </button>
                            <button onclick="buyProtection()" style="padding:4px 10px;background:linear-gradient(135deg,#ffd700,#ff8c00);border:none;border-radius:8px;color:#000;font-size:0.75rem;font-weight:600;cursor:pointer;">
                                +Íµ¨Îß§ (10,000G)
                            </button>
                        </div>
                    </div>
                    ` : ''}

                    <div class="btn-row">
                        <button class="btn btn-secondary" onclick="sellWeapon()">üí∞ ÌåêÎß§</button>
                        <button class="btn btn-enhance" onclick="enhance()" ${!canEnhance ? 'disabled' : ''}>
                            ${weapon.level >= MAX_ENHANCE_LEVEL ? 'üèÜ MAX' : `‚ö° Í∞ïÌôî (${rates.cost.toLocaleString()}G)`}
                        </button>
                        <button class="btn btn-home" onclick="showMain()">ÌôàÏúºÎ°ú</button>
                    </div>
                </div>
            `;
        }

        function toggleProtection() {
            const scrolls = state.weapon?.protectionScrolls || 0;
            if (scrolls > 0) {
                state.useProtection = !state.useProtection;
                state.protectionManuallyOff = !state.useProtection;
                const btn = document.getElementById('protectionBtn');
                btn.textContent = state.useProtection ? 'ON' : 'OFF';
                btn.className = 'toggle-btn ' + (state.useProtection ? 'on' : 'off');
                saveState();
            }
        }
        
        function buyProtection() {
            const cost = 10000;
            if (state.gold < cost) {
                alert('Í≥®ÎìúÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§! (10,000G ÌïÑÏöî)');
                return;
            }
            const before = state.weapon.protectionScrolls || 0;
            state.gold -= cost;
            if (!state.weapon.protectionScrolls) state.weapon.protectionScrolls = 0;
            state.weapon.protectionScrolls++;

            // 0Í∞úÏóêÏÑú Íµ¨Îß§Ìïú Í≤ΩÏö∞ ÏûêÎèô ON
            if (before === 0) {
                state.useProtection = true;
                state.protectionManuallyOff = false;
            }

            saveState();
            playSound('success');
            showEnhance();
        }

        // ÎÇòÎ¨¥ÎßâÎåÄÍ∏∞ ÌäπÏàò Ï≤òÎ¶¨ (99% ÏÑ±Í≥µÎ•†)
        function isWoodenStick(weapon) {
            return weapon && weapon.name === 'ÎÇòÎ¨¥ÎßâÎåÄÍ∏∞';
        }
        
        // ÎÇòÎ≠áÍ∞ÄÏßÄ ÌäπÏàò Ï≤òÎ¶¨ (99% ÌÅ¨Î¶¨Ìã∞Ïª¨)
        function isTreeBranch(weapon) {
            return weapon && weapon.name === 'ÎÇòÎ≠áÍ∞ÄÏßÄ';
        }
        
        // Ïù¥Ïë§ÏãúÍ∞ú ÌäπÏàò Ï≤òÎ¶¨ (Îç∞ÎØ∏ÏßÄ 1, ÌÅ¨Î¶¨Ìã∞Ïª¨ 10%, ÌÅ¨Î¶¨Ìã∞Ïª¨ Îç∞ÎØ∏ÏßÄ 1000!)
        function isToothpick(weapon) {
            return weapon && weapon.name === 'Ïù¥Ïë§ÏãúÍ∞ú';
        }
        
        // Ïú†Î¶¨Í≤Ä ÌäπÏàò Ï≤òÎ¶¨ (Îä•Î†•Ïπò 2Î∞∞, ÌååÍ¥¥ÌôïÎ•† 30% ÏãúÏûë!)
        function isGlassSword(weapon) {
            return weapon && weapon.name === 'Ïú†Î¶¨Í≤Ä';
        }
        
        // ÌîºÎãâÏä§ ÏßÄÌå°Ïù¥ ÌäπÏàò Ï≤òÎ¶¨ (Ïó∞ÏÜç ÏÇ¨ÎÉ• Ïãú HP 100% ÌöåÎ≥µ!)
        function isPhoenixStaff(weapon) {
            return weapon && weapon.name === 'ÌîºÎãâÏä§ ÏßÄÌå°Ïù¥';
        }
        
        // ÏÉàÏ¥ù ÌäπÏàò Ï≤òÎ¶¨ (ÌÅ¨Î¶¨ 100%, Îç∞ÎØ∏ÏßÄ 0-30 Í≥†Ï†ï!)
        function isSlingshot(weapon) {
            return weapon && weapon.name === 'ÏÉàÏ¥ù';
        }
        
        // Ï†ÄÏ£ºÎ∞õÏùÄ Î¨¥Í∏∞ Ï≤¥ÌÅ¨
        function isCursed(weapon) {
            return weapon && weapon.cursed === true;
        }
        
        // Ï†ÄÏ£º Ï†ÅÏö©! Î¨¥Í∏∞Ïóê Ï†ÄÏ£º ÏòµÏÖò Ï∂îÍ∞Ä
        function applyCurse(weapon, reason) {
            if (!weapon || isCursed(weapon)) return false;
            if (isWoodenStick(weapon)) return false;  // ÎÇòÎ¨¥ÎßâÎåÄÍ∏∞Îäî Ï†ÄÏ£º Î©¥Ïó≠
            
            weapon.cursed = true;
            // ÎÇ¥Íµ¨ÎèÑ Ïú†ÏßÄ (ÏàòÎ¶¨ Î∂àÍ∞Ä, 1 ÍπéÏùº ÎïåÎßàÎã§ Ï†Å Ï¶âÏÇ¨)
            
            // Ï†ÄÏ£º Ïπ¥Ïö¥ÌÑ∞ Î¶¨ÏÖã
            state.consecutiveEnhanceFails = 0;
            state.consecutiveFlees = 0;
            state.consecutivePvpLosses = 0;
            state.consecutiveCritsTaken = 0;
            
            saveState();
            
            // Ï†ÄÏ£º Ïù¥ÌéôÌä∏!
            playSound('destroy');
            vibrate([200, 100, 200, 100, 200, 100, 300]);
            document.body.classList.add('screen-shake');
            setTimeout(() => document.body.classList.remove('screen-shake'), 800);
            
            const reasonText = {
                'enhance_fail': 'Ïó∞ÏÜç Í∞ïÌôî Ïã§Ìå®Ïùò Î∂ÑÎÖ∏Í∞Ä Î¨¥Í∏∞Ïóê Ïä§Î©∞Îì§ÏóàÎã§!',
                'flee': 'ÎπÑÍ≤ÅÌïú ÎèÑÏ£ºÍ∞Ä Î¨¥Í∏∞Î•º Ï†ÄÏ£ºÌñàÎã§!',
                'pvp_loss': 'Ïó∞Ïù¥ÏùÄ Ìå®Î∞∞Ïùò Íµ¥ÏöïÏù¥ Î¨¥Í∏∞Î•º Î¨ºÎì§ÏòÄÎã§!',
                'crit_taken': 'Ï≤òÏ†àÌïú Í≥†ÌÜµÏù¥ Î¨¥Í∏∞Ïóê ÏõêÌïúÏùÑ ÏÉàÍ≤ºÎã§!',
                'oneshot': 'ÏùºÍ≤©Ïùò Ï∂©Í≤©Ïù¥ Î¨¥Í∏∞Ïóê ÏÇ¨ÎÖêÏùÑ ÍπÉÎì§Í≤å ÌñàÎã§!'
            }[reason] || 'Ïñ¥Îë†Ïùò Í∏∞Ïö¥Ïù¥ Î¨¥Í∏∞Î•º Í∞êÏã∏Í≥† ÏûàÎã§...';
            
            // Ï†ÄÏ£º ÌåùÏóÖ
            const popup = document.getElementById('resultPopup');
            const overlay = document.getElementById('overlay');
            popup.className = 'result-popup destroy show';
            document.getElementById('resultIcon').textContent = 'üëø';
            document.getElementById('resultText').textContent = 'Ï†ÄÏ£ºÎ∞õÏùÄ Î¨¥Í∏∞!';
            document.getElementById('resultText').style.color = '#8b00ff';
            document.getElementById('resultDetail').innerHTML = `
                <div style="color:#bb77ff;margin-bottom:8px;">${reasonText}</div>
                <div style="font-size:0.85rem;color:#aaa;line-height:1.6;">
                    ‚ö° Í∞ïÌôî ÌôïÎ•† <span style="color:var(--success)">2Î∞∞</span><br>
                    üîß <span style="color:var(--fail)">ÏàòÎ¶¨ Î∂àÍ∞Ä</span><br>
                    üíÄ ÎÇ¥Íµ¨ÎèÑ 1 Í∞êÏÜåÎßàÎã§ <span style="color:#ff00ff">Ï†Å Ï¶âÏÇ¨</span>
                </div>
            `;
            document.getElementById('newWeaponPreview').style.display = 'none';
            document.getElementById('resultBtn').textContent = 'ÌôïÏù∏';
            document.getElementById('resultBtn').style.display = 'block';
            document.getElementById('resultBtn').onclick = () => {
                closeResult();
                // ÌòÑÏû¨ ÌôîÎ©¥ Í∞±Ïã†
                if (huntState) {
                    renderHunt();
                } else {
                    showMain();
                }
            };
            overlay.classList.add('show');
            
            return true;
        }
        
        // Ï†ÄÏ£º Ìä∏Î¶¨Í±∞ Ï≤¥ÌÅ¨ (Í∞Å Ïù¥Î≤§Ìä∏ ÌõÑ Ìò∏Ï∂ú)
        function checkCurseTrigger(reason) {
            if (!state.weapon || isCursed(state.weapon)) return false;
            if (isWoodenStick(state.weapon)) return false;
            
            let triggered = false;
            switch(reason) {
                case 'enhance_fail':
                    if (state.weapon.level === 0 && state.consecutiveEnhanceFails >= 3) triggered = true;
                    break;
                case 'flee':
                    if (state.consecutiveFlees >= 5) triggered = true;
                    break;
                case 'pvp_loss':
                    if (state.consecutivePvpLosses >= 3) triggered = true;
                    break;
                case 'crit_taken':
                    if (state.consecutiveCritsTaken >= 3) triggered = true;
                    break;
                case 'oneshot':
                    triggered = true;  // ÎßåÌîºÏóêÏÑú ÌïúÎ∞©Ïóê Ï£ΩÏúºÎ©¥ Ï¶âÏãú Ï†ÄÏ£º
                    break;
            }
            
            if (triggered) {
                return applyCurse(state.weapon, reason);
            }
            return false;
        }
        
        // Ïã†Ìôî Î¨¥Í∏∞ Ï≤¥ÌÅ¨
        function isMythicWeapon(weapon) {
            return weapon && weapon.grade === 'mythic';
        }
        
        // Ïã†Ìôî ÏäàÌçºÌÅ¨Î¶¨Ìã∞Ïª¨ Ï≤¥ÌÅ¨ (1% ÌôïÎ•†)
        function checkSuperCritical(weapon) {
            if (!isMythicWeapon(weapon)) return false;
            return Math.random() < 0.01;  // 1% ÌôïÎ•†
        }
        
        function getEnhanceRates(weapon) {
            const baseRates = getBaseEnhanceRates(weapon.level);
            if (isWoodenStick(weapon)) {
                // ÎÇòÎ¨¥ÎßâÎåÄÍ∏∞: 99% ÏÑ±Í≥µ, 1% Ïã§Ìå®, ÌååÍ¥¥ ÏóÜÏùå!
                return { success: 99, destroy: 0, cost: baseRates.cost };
            }
            if (isGlassSword(weapon)) {
                // Ïú†Î¶¨Í≤Ä: ÌååÍ¥¥ÌôïÎ•† 30% + Î†àÎ≤®*3% (ÏµúÎåÄ 90%)
                const destroyChance = Math.min(90, 30 + weapon.level * 3);
                return { success: baseRates.success, destroy: destroyChance, cost: baseRates.cost };
            }
            let successRate = baseRates.success;
            // üëø Ï†ÄÏ£ºÎ∞õÏùÄ Î¨¥Í∏∞: Í∞ïÌôîÌôïÎ•† 2Î∞∞!
            if (isCursed(weapon)) {
                successRate = Math.min(99, successRate * 2);
            }
            // üêâ Î≥¥Ïä§ÌÇ¨ Î≥¥ÎÑàÏä§: Î≥¥Ïä§ Ï≤òÏπòÎãπ Í∞ïÌôîÌôïÎ•† +1%
            const bossBonus = (state.bossKills || 0) * 1;
            if (bossBonus > 0) {
                successRate = Math.min(99, successRate + bossBonus);
            }
            if (successRate !== baseRates.success) {
                return { ...baseRates, success: successRate };
            }
            return baseRates;
        }
        
        function enhance() {
            const weapon = state.weapon;
            console.log('[enhance] Starting with weapon:', weapon.name, '+' + weapon.level);
            
            if (weapon.level >= MAX_ENHANCE_LEVEL) return;

            const rates = getEnhanceRates(weapon);
            if (state.gold < rates.cost) return;

            state.gold -= rates.cost;
            state.stats.attempts++;

            const weaponIcon = document.getElementById('weaponIcon');
            weaponIcon.classList.add('shake');
            playSound('enhance');
            vibrate(50);
            setTimeout(() => weaponIcon.classList.remove('shake'), 500);

            const roll = Math.random() * 100;
            const fromLevel = weapon.level;
            let toLevel = fromLevel;
            let result = 'fail';
            let newWeapon = null;

            if (roll < rates.success) {
                // Success! üéâ
                toLevel = fromLevel + 1;
                result = 'success';
                state.stats.successes++;
                setTimeout(() => {
                    playSound('success');
                    vibrate([50, 50, 100]);
                    weaponIcon.classList.add('glow-success');
                }, 300);
                setTimeout(() => weaponIcon.classList.remove('glow-success'), 1300);
                // üèÜ Î¨¥Í∏∞ Îû≠ÌÇπ ÎèôÍ∏∞Ìôî
                setTimeout(() => syncWeaponRanking(), 500);
            } else if (rates.destroy > 0 && roll < rates.success + rates.destroy) {
                // Destroy! üí•
                result = 'destroy';
                state.stats.destroys++;
                
                const scrolls = state.weapon?.protectionScrolls || 0;
                if (state.useProtection && scrolls > 0) {
                    state.weapon.protectionScrolls--;
                    state.useProtection = false;
                    toLevel = fromLevel;
                } else {
                    addDestroyedWeaponRecord(weapon, 'enhance_destroy', 0);
                    // Generate new weapon (+7 Ïù¥ÏÉÅ: Ïú†ÎãàÌÅ¨~Ï†ÑÏÑ§ Î¨¥ÏÜçÏÑ±, +6 Ïù¥Ìïò: ÎûúÎç§)
                    const destroySource = weapon.level >= 7 ? 'enhance_destroy_high' : 'enhance_destroy_low';
                    newWeapon = generateWeaponBySource(destroySource, { weaponLevel: weapon.level });
                    // Í∞ôÏùÄ Î¨¥Í∏∞ ÌÉÄÏûÖÏù¥Î©¥ Îã§Ïãú ÎΩëÍ∏∞
                    let retries = 0;
                    while (newWeapon.type === weapon.type && newWeapon.grade === weapon.grade && retries < 3) {
                        newWeapon = generateWeaponBySource(destroySource, { weaponLevel: weapon.level });
                        retries++;
                    }
                }
                
                setTimeout(() => {
                    playSound('destroy');
                    vibrate([100, 50, 100, 50, 200]);
                    weaponIcon.classList.add('glow-fail');
                    document.body.classList.add('screen-shake');
                }, 300);
                setTimeout(() => {
                    weaponIcon.classList.remove('glow-fail');
                    document.body.classList.remove('screen-shake');
                }, 1300);
            } else {
                // Fail - just stays the same (no downgrade!)
                result = 'fail';
                state.stats.fails++;
                // Ï†ÄÏ£º Ìä∏Î¶¨Í±∞: +0ÏóêÏÑú Ïó∞ÏÜç 3Ìöå Ïã§Ìå®
                if (weapon.level === 0) {
                    state.consecutiveEnhanceFails = (state.consecutiveEnhanceFails || 0) + 1;
                } else {
                    state.consecutiveEnhanceFails = 0;
                }
                setTimeout(() => {
                    playSound('fail');
                    vibrate(100);
                    weaponIcon.classList.add('glow-fail');
                }, 300);
                setTimeout(() => weaponIcon.classList.remove('glow-fail'), 1300);
            }

            const destroyedLevel = fromLevel; // Í∞ïÌôî ÌååÍ¥¥Îêú Î†àÎ≤® Ï†ÄÏû•
            
            if (newWeapon) {
                state.weapon = newWeapon;
                resetMastery();  // Î¨¥Í∏∞ Î≥ÄÍ≤Ω Ïãú ÏàôÎ†®ÎèÑ Ï¥àÍ∏∞Ìôî
                state.bossKills = 0;  // Î≥¥Ïä§ÌÇ¨ Î≥¥ÎÑàÏä§ Î¶¨ÏÖã
                state.bossTypeKills = { dragon: 0, demon: 0, undead: 0, elemental: 0 };
                state.consecutiveEnhanceFails = 0;  // Î¨¥Í∏∞ Î≥ÄÍ≤Ω Ïãú Î¶¨ÏÖã
            } else {
                state.weapon.level = toLevel;
                // ÏÑ±Í≥µ Ïãú Ïó∞ÏÜç Ïã§Ìå® Ïπ¥Ïö¥ÌÑ∞ Î¶¨ÏÖã
                if (result === 'success') {
                    state.consecutiveEnhanceFails = 0;
                }
            }
            
            saveState();
            
            // üëø Ï†ÄÏ£º Ìä∏Î¶¨Í±∞ Ï≤¥ÌÅ¨ (Í∞ïÌôî Ïã§Ìå® Ïãú)
            if (result === 'fail' && !newWeapon) {
                setTimeout(() => {
                    if (checkCurseTrigger('enhance_fail')) return;  // Ï†ÄÏ£º ÌåùÏóÖÏù¥ Îú®Î©¥ Í∞ïÌôîÍ≤∞Í≥º Ïä§ÌÇµ
                    showEnhanceResult(result, fromLevel, state.weapon.level, newWeapon);
                }, 300);
                return;
            }
            
            // Í∞ïÌôî ÌååÍ¥¥ Ïãú Î¨¥Í∏∞ ÌöçÎìù Ïù¥ÌéôÌä∏
            if (newWeapon && result === 'destroy') {
                setTimeout(() => {
                    showWeaponAcquireEffect(newWeapon, 'enhance_destroy', { weaponLevel: destroyedLevel });
                }, 1000);
            }

            setTimeout(() => {
                showEnhanceResult(result, fromLevel, state.weapon.level, newWeapon);
            }, 300);
        }

        function showEnhanceResult(type, from, to, newWeapon) {
            const popup = document.getElementById('resultPopup');
            const overlay = document.getElementById('overlay');
            const newWeaponPreview = document.getElementById('newWeaponPreview');
            
            // ÎîîÎ≤ÑÍπÖ: ÌòÑÏû¨ ÏÉÅÌÉú ÌôïÏù∏
            console.log('[showEnhanceResult]', type, 'from:', from, 'to:', to, 'currentWeapon:', state.weapon?.name, '+' + state.weapon?.level);

            let popupClass = 'result-popup';
            let icon = '‚ú®';
            let text = '';
            let detail = '';
            let textColor = 'var(--text)';

            if (type === 'success') {
                popupClass += ' success';
                icon = '‚ú®';
                text = 'Í∞ïÌôî ÏÑ±Í≥µ!';
                detail = `+${from} ‚Üí +${to}`;
                textColor = 'var(--success)';
                
                // Í∞ïÌôî ÏÑ±Í≥µ Ïù¥ÌéôÌä∏ (Î†àÎ≤®Î≥Ñ Ïä§ÏºÄÏùº)
                createEnhanceSuccessEffect(to);
            } else if (type === 'destroy') {
                if (newWeapon) {
                    popupClass += ' destroy';
                    icon = 'üí•';
                    text = 'Î¨¥Í∏∞ ÌååÍ¥¥!';
                    detail = 'ÏÉàÎ°úÏö¥ Î¨¥Í∏∞Î•º ÌöçÎìùÌñàÏäµÎãàÎã§';
                    textColor = 'var(--legendary)';
                    
                    newWeaponPreview.style.display = 'block';
                    const gradeData = GRADES[newWeapon.grade];
                    document.getElementById('newWeaponName').innerHTML = 
                        `<span style="color:${gradeData.color}">[${gradeData.name}] ${newWeapon.name}</span>`;
                } else {
                    popupClass += ' success';
                    icon = 'üõ°Ô∏è';
                    text = 'ÌååÍ¥¥ Î∞©ÏßÄ!';
                    detail = 'Î≥¥Ìò∏ Ï£ºÎ¨∏ÏÑúÍ∞Ä Î¨¥Í∏∞Î•º ÏßÄÏº∞ÏäµÎãàÎã§';
                    textColor = 'var(--gold)';
                }
            } else {
                // Fail - level stays same
                popupClass += ' fail';
                icon = 'üò¢';
                text = 'Í∞ïÌôî Ïã§Ìå®...';
                detail = 'Îã§ÏùåÏóî ÏÑ±Í≥µÌï†Í±∞Ïïº!';
                textColor = 'var(--fail)';
            }

            popup.className = popupClass + ' show';
            document.getElementById('resultIcon').textContent = icon;
            document.getElementById('resultText').textContent = text;
            document.getElementById('resultText').style.color = textColor;
            document.getElementById('resultDetail').textContent = detail;
            
            // ÌååÍ¥¥ Ïãú ÌôîÎ©¥ ÏôÑÏ†Ñ ÏÉàÎ°úÍ≥†Ïπ®
            if (type === 'destroy' && newWeapon) {
                document.getElementById('resultBtn').onclick = () => { 
                    closeResult(); 
                    // Í∞ïÏ†úÎ°ú ÌôîÎ©¥ ÏÉàÎ°úÍ≥†Ïπ®
                    setTimeout(() => showEnhance(), 50);
                };
            } else {
                document.getElementById('resultBtn').onclick = () => { closeResult(); showEnhance(); };
            }

            if (!newWeapon) {
                newWeaponPreview.style.display = 'none';
            }

            overlay.classList.add('show');

            // Confetti for big milestones
            if (type === 'success' && (to >= 10 || to === 7)) fireConfetti();
        }
        
        function createEnhanceSuccessEffect(level) {
            const cx = window.innerWidth / 2, cy = window.innerHeight / 2;

            // Ìã∞Ïñ¥Î≥Ñ Ïª¨Îü¨/Ïù¥Î™®ÏßÄ ÏÑ∏ÌåÖ
            const tiers = {
                low:  { colors: ['#00aaff','#00ffff','#4488ff'], emojis: ['‚ú®','üíé'], glow: '#00aaff' },
                mid:  { colors: ['#aa00ff','#ff00ff','#cc66ff'], emojis: ['üîÆ','üíú','‚ö°'], glow: '#aa00ff' },
                high: { colors: ['#ff3300','#ff6600','#ffcc00'], emojis: ['üî•','üí•','‚òÑÔ∏è'], glow: '#ff4400' },
                epic: { colors: ['#ffd700','#ffaa00','#fff000'], emojis: ['üëë','üåü','üí´','‚≠ê'], glow: '#ffd700' },
                myth: { colors: ['#ff0000','#00ff00','#0000ff','#ffff00','#ff00ff','#00ffff'], emojis: ['üåà','üíé','üëë','üî•','‚ö°','üåü'], glow: '#ffffff' }
            };
            const t = level >= 20 ? 'myth' : level >= 16 ? 'epic' : level >= 13 ? 'high' : level >= 10 ? 'mid' : 'low';
            const tier = tiers[t];
            const dur = 1200 + level * 80;

            // ‚ë† Î∞∞Í≤Ω Í∏ÄÎ°úÏö∞ ÌîåÎûòÏãú
            if (level >= 10) {
                const glow = document.createElement('div');
                const intensity = Math.min(0.6, 0.15 + (level - 10) * 0.04);
                glow.style.cssText = `position:fixed;inset:0;pointer-events:none;z-index:9990;
                    background:radial-gradient(circle at 50% 45%, ${tier.glow}${Math.round(intensity*255).toString(16).padStart(2,'0')}, transparent 70%);
                    animation: glowPulse ${level >= 15 ? '0.6' : '0.8'}s ease-out forwards;`;
                document.body.appendChild(glow);
                setTimeout(() => glow.remove(), 1000);
            }

            // ‚ë° Ïù¥Î™®ÏßÄ ÌååÌã∞ÌÅ¥ (10+ Î∂ÄÌÑ∞ ÌôîÎ†§Ìïú Ïù¥Î™®ÏßÄ, Ïù¥ÌïòÎäî Ïä§ÌååÌÅ¨)
            const count = level >= 20 ? 60 : level >= 15 ? 45 : level >= 10 ? 30 : Math.min(level * 4, 25);
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const el = document.createElement('div');
                    const angle = (Math.random() * 360) * Math.PI / 180;
                    const vel = 80 + Math.random() * level * 12;
                    const useEmoji = level >= 10 && Math.random() < 0.5;
                    const size = useEmoji ? (18 + Math.random() * 14) : (4 + Math.random() * 8);
                    const color = tier.colors[Math.floor(Math.random() * tier.colors.length)];

                    if (useEmoji) {
                        const emoji = tier.emojis[Math.floor(Math.random() * tier.emojis.length)];
                        el.textContent = emoji;
                        el.style.cssText = `position:fixed;left:${cx}px;top:${cy}px;font-size:${size}px;
                            pointer-events:none;z-index:10001;
                            animation: emojiExplode ${dur}ms cubic-bezier(0.25,0.46,0.45,0.94) forwards;
                            --tx:${Math.cos(angle)*vel}px;--ty:${Math.sin(angle)*vel - 60}px;`;
                    } else {
                        const shapes = ['50%', '2px', '0'];
                        el.style.cssText = `position:fixed;left:${cx}px;top:${cy}px;
                            width:${size}px;height:${size}px;background:${color};
                            border-radius:${shapes[Math.floor(Math.random()*shapes.length)]};
                            pointer-events:none;z-index:10000;box-shadow:0 0 ${size*3}px ${color};
                            animation: particleExplode ${dur}ms ease-out forwards;
                            --tx:${Math.cos(angle)*vel}px;--ty:${Math.sin(angle)*vel}px;`;
                    }
                    document.body.appendChild(el);
                    setTimeout(() => el.remove(), dur + 100);
                }, i * (level >= 15 ? 8 : 12));
            }

            // ‚ë¢ ÎßÅ ÌååÎèô (10+: 1Í∞ú, 15+: 2Í∞ú, 20+: 3Í∞ú)
            const rings = level >= 20 ? 3 : level >= 15 ? 2 : level >= 10 ? 1 : 0;
            for (let r = 0; r < rings; r++) {
                setTimeout(() => {
                    const ring = document.createElement('div');
                    ring.style.cssText = `position:fixed;width:60px;height:60px;
                        border:${2 + r}px solid ${tier.colors[r % tier.colors.length]};border-radius:50%;
                        left:50%;top:45%;transform:translate(-50%,-50%);
                        pointer-events:none;z-index:9995;
                        box-shadow:0 0 20px ${tier.colors[r % tier.colors.length]}40;
                        animation: ringExpand ${0.8 + r * 0.15}s ease-out forwards;`;
                    document.body.appendChild(ring);
                    setTimeout(() => ring.remove(), 1200);
                }, r * 150);
            }

            // ‚ë£ ÌôîÎ©¥ ÌùîÎì§Î¶º (10+)
            if (level >= 10) {
                const str = Math.min(8, 2 + (level - 10) * 0.5);
                document.body.style.animation = `enhanceShake ${0.3 + (level-10)*0.02}s ease-out`;
                document.body.style.setProperty('--shake-str', str + 'px');
                setTimeout(() => document.body.style.animation = '', 600);
            }

            // ‚ë§ 20+: Ï†ÑÏ≤¥ ÌôîÎ©¥ Î¨¥ÏßÄÍ∞ú Î≥¥Îçî + Î≤àÍ∞ú
            if (level >= 20) {
                const border = document.createElement('div');
                border.style.cssText = `position:fixed;inset:0;pointer-events:none;z-index:9992;
                    border:4px solid transparent;border-image:linear-gradient(45deg,red,orange,yellow,green,cyan,blue,violet) 1;
                    animation: rainbowBorder 1.5s linear forwards;`;
                document.body.appendChild(border);
                setTimeout(() => border.remove(), 1500);
                // Î≤àÍ∞ú
                for (let l = 0; l < 3; l++) {
                    setTimeout(() => {
                        const lightning = document.createElement('div');
                        const lx = Math.random() * window.innerWidth;
                        lightning.style.cssText = `position:fixed;left:${lx}px;top:0;width:3px;height:100vh;
                            background:linear-gradient(to bottom,transparent,#fff,${tier.colors[0]},transparent);
                            pointer-events:none;z-index:10002;opacity:0.8;
                            animation: lightningFlash 0.2s ease-out forwards;`;
                        document.body.appendChild(lightning);
                        setTimeout(() => lightning.remove(), 250);
                    }, l * 100 + 200);
                }
            }

            // ‚ë• 15+: ÌôîÎ©¥ ÏÉÅÎã®ÏóêÏÑú ÎÇ¥Î†§Ïò§Îäî Ïä§ÌååÌÅ¨ ÏÉ§Ïõå
            if (level >= 15) {
                for (let s = 0; s < 20; s++) {
                    setTimeout(() => {
                        const spark = document.createElement('div');
                        const sx = Math.random() * window.innerWidth;
                        const color = tier.colors[Math.floor(Math.random() * tier.colors.length)];
                        spark.style.cssText = `position:fixed;left:${sx}px;top:-10px;
                            width:3px;height:${15 + Math.random()*20}px;
                            background:linear-gradient(to bottom,${color},transparent);
                            pointer-events:none;z-index:10001;border-radius:2px;
                            animation: sparkFall ${0.6 + Math.random()*0.8}s ease-in forwards;`;
                        document.body.appendChild(spark);
                        setTimeout(() => spark.remove(), 1500);
                    }, s * 40);
                }
            }
        }

        function closeResult() {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('resultPopup').classList.remove('show');
            // ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎêú ÏÇ¨ÎÉ• Ï¢ÖÎ£å Î≤ÑÌäº Ï†úÍ±∞
            const exitBtn = document.getElementById('huntExitBtn');
            if (exitBtn) exitBtn.remove();
        }

        function sellWeapon() {
            const value = getWeaponValue(state.weapon);
            
            // ÌåêÎß§Í∞Ä 0Ïù¥Î©¥ ÌåêÎß§ Î∂àÍ∞Ä
            if (value <= 0) {
                alert('Ïù¥ Î¨¥Í∏∞Îäî ÌåêÎß§Ìï† Ïàò ÏóÜÏäµÎãàÎã§.\n(Í∞ïÌôîÌïòÍ±∞ÎÇò Îçî Ï¢ãÏùÄ Îì±Í∏âÏùò Î¨¥Í∏∞Î•º ÌöçÎìùÌïòÏÑ∏Ïöî)');
                return;
            }
            
            if (confirm(`${state.weapon.name}ÏùÑ(Î•º) ${value.toLocaleString()}GÏóê ÌåêÎß§ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÏÉàÎ°úÏö¥ Î¨¥Í∏∞Î•º Î∞õÍ≤å Îê©ÎãàÎã§. (ÏùºÎ∞ò~Î†àÏñ¥)`)) {
                state.gold += value;
                state.weapon = generateWeaponBySource('sell', {});
                resetMastery();  // Î¨¥Í∏∞ Î≥ÄÍ≤Ω Ïãú ÏàôÎ†®ÎèÑ Ï¥àÍ∏∞Ìôî
                state.bossKills = 0;
                state.bossTypeKills = { dragon: 0, demon: 0, undead: 0, elemental: 0 };
                saveState();
                showEnhance();
            }
        }

        // ===== BLACKSMITH =====
        function showBlacksmith() {
            const weapon = state.weapon;
            const durability = weapon.durability ?? MAX_DURABILITY;
            const repairCost = getRepairCost(weapon);
            const gradeData = GRADES[weapon.grade];
            const canRepair = !isCursed(weapon) && durability < MAX_DURABILITY && state.gold >= repairCost;
            
            document.getElementById('app').innerHTML = `
                <div class="container">
                    <button class="btn-back" onclick="showMain()">‚Üê Î©îÏù∏ÏúºÎ°ú</button>
                    
                    <header>
                        <h1>üõ†Ô∏è ÎåÄÏû•Í∞Ñ</h1>
                        <p class="subtitle">Î¨¥Í∏∞ ÏàòÎ¶¨ Î∞è Í¥ÄÎ¶¨</p>
                    </header>
                    
                    <div class="gold-display">
                        <span class="gold-icon">üí∞</span>
                        <span class="gold-amount">${state.gold.toLocaleString()} G</span>
                    </div>
                    
                    <div class="blacksmith-card">
                        <div class="weapon-header">
                            <div class="weapon-info">
                                <div class="weapon-grade ${weapon.grade}">${gradeData.name}</div>
                                <div class="weapon-name">${weapon.name} +${weapon.level}</div>
                            </div>
                            <img src="${getWeaponIcon(weapon)}" 
                                 style="width:50px;height:50px;filter:drop-shadow(0 0 10px ${gradeData.color});">
                        </div>
                        
                        <div style="margin-top:16px;">
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                <span>üîß ÎÇ¥Íµ¨ÎèÑ</span>
                                <span class="${durability < 30 ? 'danger' : ''}">${durability}%</span>
                            </div>
                            <div class="durability-bar">
                                <div class="durability-fill ${durability < 30 ? 'low' : durability < 60 ? 'mid' : 'high'}" 
                                     style="width:${durability}%"></div>
                            </div>
                        </div>
                        
                        ${isCursed(weapon) ? `
                        <div style="text-align:center;padding:20px;color:#8b00ff;">
                            üëø Ï†ÄÏ£ºÎ∞õÏùÄ Î¨¥Í∏∞Îäî ÏàòÎ¶¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§!<br>
                            <span style="font-size:0.85rem;color:#aaa;margin-top:8px;display:block;">
                                ÎÇ¥Íµ¨ÎèÑ ÌååÍ¥¥ Ïãú Ï†Å Ï¶âÏÇ¨ Ìö®Í≥º Î∞úÎèô
                            </span>
                        </div>
                        ` : durability < MAX_DURABILITY ? `
                        <div class="enhance-panel" style="margin-top:16px;">
                            <div class="enhance-row">
                                <span>ÏàòÎ¶¨ ÎπÑÏö©</span>
                                <span class="gold">${repairCost.toLocaleString()} G</span>
                            </div>
                            <div class="enhance-row">
                                <span>ÏàòÎ¶¨ ÌõÑ ÎÇ¥Íµ¨ÎèÑ</span>
                                <span style="color:var(--success)">100%</span>
                            </div>
                        </div>
                        
                        <button class="btn btn-enhance" onclick="repairWeapon()" ${!canRepair ? 'disabled' : ''} style="margin-top:16px;">
                            ${state.gold < repairCost ? 'üí∞ Í≥®Îìú Î∂ÄÏ°±' : 'üîß ÏàòÎ¶¨ÌïòÍ∏∞'}
                        </button>
                        ` : `
                        <div style="text-align:center;padding:20px;color:var(--success);">
                            ‚úÖ Î¨¥Í∏∞Í∞Ä ÏôÑÎ≤ΩÌïú ÏÉÅÌÉúÏûÖÎãàÎã§!
                        </div>
                        `}
                    </div>
                    
                    <div class="enhance-panel" style="color:#fff;">
                        <h3 style="margin-bottom:12px;color:#fff;">‚ö†Ô∏è ÎÇ¥Íµ¨ÎèÑ ÏïàÎÇ¥</h3>
                        <p style="color:#ccc;font-size:0.9rem;line-height:1.5;">
                            ‚Ä¢ Ï†ÑÌà¨ Ïãú ÎÇ¥Íµ¨ÎèÑÍ∞Ä Í∞êÏÜåÌï©ÎãàÎã§<br>
                            ‚Ä¢ ÎÇ¥Íµ¨ÎèÑ 0ÏóêÏÑú Ï†ÑÌà¨ Ïãú <span style="color:var(--fail)">Î¨¥Í∏∞ ÌååÍ¥¥ ÏúÑÌóò!</span><br>
                            ‚Ä¢ ÌååÍ¥¥ Ïãú ÏñëÏ™ΩÏóê ÌÅ∞ Îç∞ÎØ∏ÏßÄ
                        </p>
                    </div>
                    
                    <div class="enhance-panel" style="color:#fff;">
                        <h3 style="margin-bottom:12px;color:#fff;">‚≠ê ÏàôÎ†®ÎèÑ</h3>
                        <div class="enhance-row">
                            <span>Ï¥ù Í≥µÍ≤© ÌöüÏàò</span>
                            <span>${state.mastery.attacks}Ìöå</span>
                        </div>
                        <div class="enhance-row">
                            <span>Ï¥ù Ï≤òÏπò Ïàò</span>
                            <span>${state.mastery.kills}ÎßàÎ¶¨</span>
                        </div>
                        <div class="enhance-row">
                            <span>Í≥µÍ≤©Î†• Î≥¥ÎÑàÏä§</span>
                            <span style="color:var(--success)">+${getMasteryBonus()}%</span>
                        </div>
                    </div>
                    
                    <div class="btn-row" style="margin-top:16px;">
                        <button class="btn btn-secondary" style="flex:1;" onclick="showMain()">üè† Î©îÏù∏ÏúºÎ°ú</button>
                    </div>
                </div>
            `;
        }
        
        function repairWeapon() {
            const cost = getRepairCost(state.weapon);
            if (state.gold < cost) return;
            
            // ÏàòÎ¶¨ÎπÑ ÌôïÏù∏
            if (!confirm(`üîß ÏàòÎ¶¨ÎπÑ: ${cost.toLocaleString()}G\n\nÏàòÎ¶¨ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                return;
            }
            
            state.gold -= cost;
            state.weapon.durability = MAX_DURABILITY;
            saveState();
            
            playSound('success');
            vibrate([50, 50, 100]);
            
            showBlacksmith();
        }
        
        // ===== RANKING UI =====
        let currentRankingTab = 'weapons';
        let rankingCache = { weapons: [], hunting: [], pvp: [] };
        
        async function showRanking() {
            document.getElementById('app').innerHTML = `
                <div class="container">
                    <button class="btn-back" onclick="showMain()">‚Üê Î©îÏù∏ÏúºÎ°ú</button>
                    
                    <header>
                        <h1>üèÜ Îû≠ÌÇπ</h1>
                        <p class="subtitle">ÏµúÍ≥†Ïùò Ïö©ÏÇ¨Îì§</p>
                    </header>
                    
                    <div class="ranking-tabs">
                        <button class="ranking-tab ${currentRankingTab === 'weapons' ? 'active' : ''}" onclick="switchRankingTab('weapons')">
                            ‚öîÔ∏è Î¨¥Í∏∞
                        </button>
                        <button class="ranking-tab ${currentRankingTab === 'hunting' ? 'active' : ''}" onclick="switchRankingTab('hunting')">
                            üêâ ÏÇ¨ÎÉ•
                        </button>
                        <button class="ranking-tab ${currentRankingTab === 'pvp' ? 'active' : ''}" onclick="switchRankingTab('pvp')">
                            ‚öîÔ∏è PvP
                        </button>
                    </div>
                    
                    <div id="rankingContent" class="ranking-loading">
                        ‚è≥ Î°úÎî© Ï§ë...
                    </div>
                    
                    <div class="btn-row" style="margin-top:16px;">
                        <button class="btn btn-secondary" style="flex:1;" onclick="showMain()">üè† Î©îÏù∏ÏúºÎ°ú</button>
                    </div>
                </div>
            `;
            
            await loadRankingTab(currentRankingTab);
        }
        
        async function switchRankingTab(tab) {
            currentRankingTab = tab;
            await showRanking();
        }
        
        async function loadRankingTab(tab) {
            const contentEl = document.getElementById('rankingContent');
            if (!contentEl) return;
            
            contentEl.innerHTML = '<div class="ranking-loading">‚è≥ Î°úÎî© Ï§ë...</div>';
            
            const rankings = await fetchRankings(tab);
            rankingCache[tab] = rankings;
            
            renderRankings(tab, rankings);
        }
        
        function renderRankings(tab, rankings) {
            const contentEl = document.getElementById('rankingContent');
            if (!contentEl) return;
            
            const myId = getUserId();
            const myRankIdx = rankings.findIndex(r => r.user_id === myId);
            
            if (rankings.length === 0) {
                contentEl.innerHTML = '<div class="ranking-empty">üò¢ ÏïÑÏßÅ Îû≠ÌÇπ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</div>';
                return;
            }
            
            let html = '';
            
            // ÎÇ¥ Îû≠ÌÇπ ÌëúÏãú
            if (myRankIdx >= 0) {
                const myRank = rankings[myRankIdx];
                let myValue = '';
                if (tab === 'weapons') {
                    myValue = `+${myRank.best_weapon_level}`;
                } else if (tab === 'hunting') {
                    const masteryPercent = Math.min(30, Math.floor((myRank.total_kills || 0) / 10));
                    myValue = `ÏàôÎ†® +${masteryPercent}%`;
                } else if (tab === 'pvp') {
                    myValue = `${myRank.pvp_rating || 1000} ELO`;
                }
                html += `
                    <div class="my-ranking-box">
                        <div class="my-ranking-label">ÎÇ¥ ÏàúÏúÑ</div>
                        <div class="my-ranking-value">#${myRankIdx + 1} | ${myValue}</div>
                    </div>
                `;
            }
            
            if (tab === 'weapons' && Array.isArray(state.destroyedWeapons) && state.destroyedWeapons.length > 0) {
                const items = state.destroyedWeapons.slice(0, 5).map((w) => `
                    <div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.06);">
                        <img src="${w.image}" alt="${w.name}" style="width:34px;height:34px;object-fit:contain;border-radius:6px;background:rgba(255,255,255,0.04);">
                        <div style="flex:1;min-width:0;">
                            <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${w.name} +${w.level}${w.cursed ? ' <span style="color:#bb77ff;">üëø</span>' : ''}</div>
                            <div style="font-size:0.75rem;color:var(--muted);">${w.reasonLabel} | ${w.kills || 0}ÌÇ¨ | Ïó∞ÏÜç ${w.streak || 0}</div>
                        </div>
                    </div>
                `).join('');

                html += `
                    <div class="enhance-panel" style="margin-bottom:10px;">
                        <div style="font-weight:700;margin-bottom:6px;">ü™¶ ÏµúÍ∑º ÌååÍ¥¥ Î¨¥Í∏∞</div>
                        ${items}
                    </div>
                `;
            }

            html += '<div class="ranking-list">';
            
            rankings.forEach((rank, idx) => {
                const isMe = rank.user_id === myId;
                let rankClass = '';
                if (idx === 0) rankClass = 'gold';
                else if (idx === 1) rankClass = 'silver';
                else if (idx === 2) rankClass = 'bronze';
                
                let valueHtml = '';
                let detailHtml = '';
                
                if (tab === 'weapons') {
                    const gradeData = GRADES[rank.best_weapon_grade] || GRADES.common;
                    const weaponNameRaw = rank.best_weapon_name || 'Î¨¥Í∏∞';
                    const cursed = weaponNameRaw.includes('üëøÏ†ÄÏ£º');
                    const weaponName = weaponNameRaw.replace(' üëøÏ†ÄÏ£º', '');
                    valueHtml = `<span style="color:${gradeData.color}">+${rank.best_weapon_level}</span>`;
                    detailHtml = `${weaponName} | ${gradeData.name}${cursed ? ' <span style="color:#bb77ff;">üëøÏ†ÄÏ£º</span>' : ''}`;
                } else if (tab === 'hunting') {
                    const masteryPercent = Math.min(30, Math.floor((rank.total_kills || 0) / 10));
                    valueHtml = `<span class="ranking-value kills">+${masteryPercent}%</span>`;
                    detailHtml = `Ï≤òÏπò: ${rank.total_kills?.toLocaleString() || 0} | ÏµúÍ≥† Ïó∞ÏÜç: ${rank.max_kill_streak || 0}ÌÇ¨`;
                } else if (tab === 'pvp') {
                    const winRate = (rank.pvp_wins + rank.pvp_losses) > 0 
                        ? Math.round((rank.pvp_wins / (rank.pvp_wins + rank.pvp_losses)) * 100) 
                        : 0;
                    valueHtml = `<span class="ranking-value pvp">${rank.pvp_rating || 1000}</span>`;
                    detailHtml = `${rank.pvp_wins || 0}Ïäπ ${rank.pvp_losses || 0}Ìå® (${winRate}%)`;
                }
                
                html += `
                    <div class="ranking-item ${isMe ? 'me' : ''}">
                        <div class="ranking-rank ${rankClass}">${idx < 3 ? ['ü•á','ü•à','ü•â'][idx] : (idx + 1)}</div>
                        <div class="ranking-info">
                            <div class="ranking-name">${rank.nickname || 'ÏùµÎ™Ö'}</div>
                            <div class="ranking-detail">${detailHtml}</div>
                        </div>
                        <div class="ranking-value ${tab === 'weapons' ? 'weapon' : ''}">${valueHtml}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            contentEl.innerHTML = html;
        }

        // ===== BATTLE MODE (ÏÉà ÌÑ¥Ï†ú PvP) =====
        function showBattleLobby() {
            mpUI = new MultiplayerUI({
                gameType: 'pvp-battle',
                gameName: '‚öîÔ∏è ÌÑ¥Ï†ú Î∞∞ÌãÄ',
                container: document.getElementById('app'),
                maxPlayers: 2,
                supportsLocal: false,
                onGameStart: handleBattleStart,
                onGameEvent: handleBattleEvent,
                onLeave: () => { battleState = null; showMain(); },
                getPlayerData: () => {
                    // Î¨¥Í∏∞ Ïä§ÌÉØ Í≥ÑÏÇ∞Ìï¥ÏÑú Ìï®Íªò Ï†ÑÏÜ° (ÏÇ¨ÎÉ•Í≥º ÎèôÏùºÌïú Í≥µÏãù)
                    const weapon = state.weapon || { type: 'sword', grade: 'common', level: 0, name: 'Í∏∞Î≥∏ Î¨¥Í∏∞', element: 'none' };
                    const stats = getWeaponStats(weapon, true);
                    
                    // ÎîîÎ≤ÑÍ∑∏: NaN Ï≤¥ÌÅ¨
                    console.log('[getPlayerData] weapon:', weapon);
                    console.log('[getPlayerData] stats:', stats);
                    if (isNaN(stats.damageMin) || isNaN(stats.damageMax) || isNaN(stats.hp)) {
                        console.error('[getPlayerData] NaN detected! weapon:', JSON.stringify(weapon), 'stats:', JSON.stringify(stats));
                    }
                    
                    return {
                        weapon: {
                            ...weapon,
                            // Í≥ÑÏÇ∞Îêú Ïä§ÌÉØ Ï†ÑÏÜ° (ÏÑúÎ≤ÑÍ∞Ä Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©)
                            damageMin: isNaN(stats.damageMin) ? 5 : stats.damageMin,
                            damageMax: isNaN(stats.damageMax) ? 8 : stats.damageMax,
                            critChance: isNaN(stats.critChance) ? 5 : stats.critChance,
                            critDamage: isNaN(stats.critDamage) ? 150 : stats.critDamage,
                            hp: isNaN(stats.hp) ? 100 : stats.hp
                        },
                        gold: state.gold
                    };
                }
            });

            const roomCode = MultiplayerUI.checkUrlRoom();
            if (roomCode) {
                mpUI._renderLobby();
                setTimeout(() => {
                    document.getElementById('mp-room-code').value = roomCode;
                }, 100);
            } else {
                mpUI.show();
            }
        }

        function handleBattleStart(gameState) {
            battleState = gameState;
            battleActionPending = false;  // ÏÉà Î∞∞ÌãÄ ÏãúÏûë Ïãú Î¶¨ÏÖã
            battleResultShown = false;    // Í≤∞Í≥º ÌëúÏãú ÌîåÎûòÍ∑∏ Î¶¨ÏÖã
            // Cache user ID for use even after client is destroyed
            cachedMyId = mpUI?.getClient()?.getMyUserId() || null;
            console.log('[handleBattleStart] cachedMyId:', cachedMyId);
            renderBattle();
        }

        async function handleBattleEvent(type, data) {
            console.log('[BattleEvent]', type, JSON.stringify(data).slice(0, 500));
            
            // Normalize polled events: { seq, type, payload: {...} } ‚Üí extract payload
            const payload = data.payload || data;
            
            if (type === 'state_update') {
                const gs = payload.gameState || payload;
                const myId = cachedMyId || mpUI?.getClient()?.getMyUserId();
                
                // ÌÑ¥ Í≤∞Í≥º Ïï†ÎãàÎ©îÏù¥ÏÖò (Ìè¥ÎßÅÏúºÎ°ú Î∞õÏùÄ Í≤ΩÏö∞)
                if (gs.lastTurnResult && battleState?.gameState?.round !== gs.round) {
                    const tr = gs.lastTurnResult;
                    const isP1Me = gs.players[0]?.id === myId;
                    const myAction = isP1Me ? tr.p1Action : tr.p2Action;
                    const enemyAction = isP1Me ? tr.p2Action : tr.p1Action;
                    const myDamage = isP1Me ? tr.p1Damage : tr.p2Damage;
                    const enemyDamage = isP1Me ? tr.p2Damage : tr.p1Damage;
                    const myCrit = isP1Me ? tr.p1Crit : tr.p2Crit;
                    const enemyCrit = isP1Me ? tr.p2Crit : tr.p1Crit;
                    
                    let result = 'draw';
                    if (enemyDamage > myDamage) result = 'win';
                    else if (myDamage > enemyDamage) result = 'lose';
                    
                    await showTurnResult(myAction, enemyAction, result, myDamage, enemyDamage, myCrit, enemyCrit);
                }
                
                battleState = { gameState: gs };
                renderBattle();
            } else if (type === 'action') {
                // Action event from polling - may contain nested game events
                const actionData = payload;
                if (actionData.events && Array.isArray(actionData.events)) {
                    for (const evt of actionData.events) {
                        await handleBattleEvent(evt.type, evt.payload || evt);
                    }
                }
            } else if (type === 'game_end' || type === 'game_ended') {
                // Normalize winnerId from various structures:
                // Direct: { winnerId, prizeGold }
                // Polled game_ended: { result: { winnerId, reason } }
                // Polled action event: { winnerId, prizeGold, ... }
                const result = payload.result || payload;
                const winnerId = result.winnerId;
                const prizeGold = result.prizeGold || payload.prizeGold || 0;
                
                const normalizedData = { winnerId, prizeGold };
                
                if (winnerId === mpUI.getClient().getMyUserId()) {
                    playSound('success');
                    vibrate([100, 50, 100, 50, 200]);
                } else {
                    playSound('destroy');
                    vibrate([200, 100, 200]);
                }
                showBattleResult(normalizedData);
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Î¨¥Í∏∞ ÌÉÄÏûÖÏóêÏÑú Ïù¥Î™®ÏßÄ Ï∂îÏ∂ú
        function getWeaponEmoji(weaponName, weaponType) {
            // ÌäπÏàò Î¨¥Í∏∞
            if (weaponName === 'ÎÇòÎ¨¥ÎßâÎåÄÍ∏∞') return 'ü™µ';
            if (weaponName === 'ÎÇòÎ≠áÍ∞ÄÏßÄ') return 'üåø';
            if (weaponName === 'Ïù¥Ïë§ÏãúÍ∞ú') return 'ü™•';
            if (weaponName === 'Ïú†Î¶¨Í≤Ä') return 'üîÆ';
            if (weaponName === 'ÌîºÎãâÏä§ ÏßÄÌå°Ïù¥') return 'üî•';
            
            // ÏõêÍ±∞Î¶¨ Î¨¥Í∏∞
            if (weaponName === 'ÏÉàÏ¥ù') return 'ü™®';
            if (weaponType === 'bow') return 'üèπ';
            if (weaponType === 'crossbow') return 'üéØ';
            
            // ÎÑàÌÅ¥
            if (weaponType === 'knuckle') return 'üëä';
            
            // Î¨¥Í∏∞ ÌÉÄÏûÖ Í∏∞Ï§Ä (Ïö∞ÏÑ†)
            const typeEmojis = {
                sword: '‚öîÔ∏è',    // Í≤Ä
                axe: 'ü™ì',      // ÎèÑÎÅº
                spear: 'üî±',    // Ï∞Ω
                hammer: 'üî®',   // ÎßùÏπò
                dagger: 'üó°Ô∏è',   // Îã®Í≤Ä
                staff: 'ü™Ñ',    // ÏßÄÌå°Ïù¥
                katana: '‚öîÔ∏è',   // ÎèÑÍ≤Ä
                scythe: 'üåô'    // ÎÇ´
            };
            if (weaponType && typeEmojis[weaponType]) return typeEmojis[weaponType];
            
            // Ïù¥Î¶Ñ Í∏∞Î∞ò Ìè¥Î∞±
            const nameEmojis = {
                'Í≤Ä': '‚öîÔ∏è', 'ÏÜåÎìú': '‚öîÔ∏è', 'Î∏îÎ†àÏù¥Îìú': '‚öîÔ∏è',
                'ÎèÑÎÅº': 'ü™ì', 'Ïï°Ïä§': 'ü™ì',
                'Ï∞Ω': 'üî±', 'Ïä§ÌîºÏñ¥': 'üî±', 'ÎûúÏä§': 'üî±',
                'ÎßùÏπò': 'üî®', 'Ìï¥Î®∏': 'üî®', 'Ï≤†Ìá¥': 'üî®',
                'Îã®Í≤Ä': 'üó°Ô∏è', 'ÎåÄÍ±∞': 'üó°Ô∏è', 'ÎÇòÏù¥ÌîÑ': 'üó°Ô∏è',
                'ÏßÄÌå°Ïù¥': 'ü™Ñ', 'Ïä§ÌÉúÌîÑ': 'ü™Ñ', 'ÏôÑÎìú': 'ü™Ñ',
                'ÎèÑÍ≤Ä': '‚öîÔ∏è', 'Ïπ¥ÌÉÄÎÇò': '‚öîÔ∏è',
                'ÎÇ´': 'üåô', 'ÏÇ¨Ïù¥Îìú': 'üåô'
            };
            for (const [name, emoji] of Object.entries(nameEmojis)) {
                if (weaponName && weaponName.includes(name)) return emoji;
            }
            return '‚öîÔ∏è';
        }

        // Ïä§ÌÇ¨ Ïù¥ÌéôÌä∏ Ï¢ÖÎ•ò
        const SKILL_EFFECTS = ['üí•', '‚ú®', 'üåü', '‚ö°', 'üî•', '‚ùÑÔ∏è', 'üåÄ', 'üí´'];
        const SKILL_NAMES = ['Ïä§Îß§Ïãú!', 'Ï∞åÎ•¥Í∏∞!', 'Ïó∞ÏÜçÎ≤†Í∏∞!', 'ÌöåÏ†ÑÏ∞∏!', 'Í∞ïÌÉÄ!'];

        async function playBattleAnimation(anim, myId) {
            // This function is now handled by showTurnResult
        }

        // ÌÑ¥ Í≤∞Í≥º ÌëúÏãú Ïï†ÎãàÎ©îÏù¥ÏÖò (ÏÇ¨ÎÉ• Ïä§ÌÉÄÏùº)
        async function showTurnResult(myAction, enemyAction, result, myDamage, enemyDamage, myCrit = false, enemyCrit = false) {
            const actionEmoji = { 
                attack: '‚öîÔ∏è', defense: 'üõ°Ô∏è', skill: 'üîÆ',
                ultimate_burst: 'üî•', ultimate_lifedrain: 'üíö', ultimate_absolute: 'üõ°Ô∏è'
            };
            const actionName = { 
                attack: 'Í≥µÍ≤©', defense: 'Î∞©Ïñ¥', skill: 'Ïä§ÌÇ¨',
                ultimate_burst: 'ÌïÑÏÇ¥ÏùºÍ≤©', ultimate_lifedrain: 'ÏÉùÎ™ÖÌù°Ïàò', ultimate_absolute: 'Ï†àÎåÄÎ∞©Ïñ¥'
            };
            
            // Ïï°ÏÖò ÌëúÏãú Îã®Í≥Ñ
            const overlay = document.createElement('div');
            overlay.className = 'turn-result-overlay';
            overlay.innerHTML = `
                <div class="turn-result-actions" style="animation: actionReveal 0.5s ease-out;">
                    <div style="text-align:center;animation: slideInLeft 0.4s ease-out;">
                        <div style="font-size:0.9rem;color:#4ecca3;margin-bottom:8px;font-weight:bold;">üë§ ÎÇò</div>
                        <div style="font-size:4rem;animation: actionBounce 0.3s ease-out 0.2s both;">${actionEmoji[myAction] || '‚ùì'}</div>
                        <div style="font-size:1rem;margin-top:8px;">${actionName[myAction] || myAction}</div>
                    </div>
                    <div class="turn-result-vs" style="animation: vsPulse 0.6s ease-in-out infinite;">‚ö°VS‚ö°</div>
                    <div style="text-align:center;animation: slideInRight 0.4s ease-out;">
                        <div style="font-size:0.9rem;color:#ff6b6b;margin-bottom:8px;font-weight:bold;">üëæ ÏÉÅÎåÄ</div>
                        <div style="font-size:4rem;animation: actionBounce 0.3s ease-out 0.3s both;">${actionEmoji[enemyAction] || '‚ùì'}</div>
                        <div style="font-size:1rem;margin-top:8px;">${actionName[enemyAction] || enemyAction}</div>
                    </div>
                </div>
                <div class="turn-result-text" id="turnResultText" style="min-height:80px;"></div>
            `;
            document.body.appendChild(overlay);
            
            // CSS Ïï†ÎãàÎ©îÏù¥ÏÖò Ï£ºÏûÖ
            if (!document.getElementById('battle-anim-styles')) {
                const style = document.createElement('style');
                style.id = 'battle-anim-styles';
                style.textContent = `
                    @keyframes slideInLeft { from { transform: translateX(-100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
                    @keyframes slideInRight { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
                    @keyframes actionBounce { 0% { transform: scale(0); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
                    @keyframes vsPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
                    @keyframes resultAppear { from { transform: scale(0) rotate(-10deg); opacity: 0; } to { transform: scale(1) rotate(0); opacity: 1; } }
                    @keyframes damageShake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
                    @keyframes winGlow { 0%, 100% { text-shadow: 0 0 10px #4ecca3; } 50% { text-shadow: 0 0 30px #4ecca3, 0 0 50px #4ecca3; } }
                    @keyframes loseGlow { 0%, 100% { text-shadow: 0 0 10px #ff6b6b; } 50% { text-shadow: 0 0 30px #ff6b6b, 0 0 50px #ff6b6b; } }
                `;
                document.head.appendChild(style);
            }

            await sleep(800);

            // Í≤∞Í≥º ÌëúÏãú
            const resultText = overlay.querySelector('#turnResultText');
            
            if (result === 'win') {
                // ÏäπÎ¶¨ Ïù¥ÌéôÌä∏ (ÎÇ¥ ÌÅ¨Î¶¨Ìã∞Ïª¨Ïù¥Î©¥ Îçî Í∞ïÌïú Ìö®Í≥º)
                if (myCrit) {
                    playSound('crit');
                    vibrate([100, 50, 100, 50, 150, 50, 200]);
                } else {
                    playSound('crit');
                    vibrate([50, 30, 100, 30, 50]);
                }
                showBattleEffect(myAction, true, enemyDamage, myCrit);
                
                resultText.innerHTML = `
                    <div style="animation: resultAppear 0.4s ease-out, winGlow 1s ease-in-out infinite;">
                        <span style="font-size:2rem;color:#4ecca3;">‚ú® ÏäπÎ¶¨!</span>
                        ${myCrit ? '<span style="font-size:1.5rem;color:#ffd700;animation:actionBounce 0.3s ease-out infinite;"> üí•ÌÅ¨Î¶¨Ìã∞Ïª¨!</span>' : ''}
                    </div>
                    <div style="font-size:${myCrit ? '3.5rem' : '2.5rem'};font-weight:bold;margin-top:10px;color:${myCrit ? '#ff4500' : '#ffd700'};animation: actionBounce 0.3s ease-out 0.2s both;text-shadow:${myCrit ? '0 0 20px #ff4500' : 'none'};">
                        -${enemyDamage}
                    </div>
                    <div style="font-size:0.9rem;color:var(--muted);margin-top:5px;">ÏÉÅÎåÄÏóêÍ≤å Îç∞ÎØ∏ÏßÄ!</div>
                `;
                
                // ÌôîÎ©¥ Î≤àÏ©ç (ÌÅ¨Î¶¨Ìã∞Ïª¨Ïù¥Î©¥ Îçî Í∞ïÌïòÍ≤å)
                document.body.style.animation = 'none';
                setTimeout(() => {
                    const flashColor = myCrit ? 'rgba(255,69,0,0.4)' : 'rgba(78,204,163,0.3)';
                    document.body.style.background = `radial-gradient(circle, ${flashColor} 0%, transparent 70%)`;
                    setTimeout(() => { document.body.style.background = ''; }, myCrit ? 500 : 300);
                }, 100);
                
            } else if (result === 'lose') {
                // Ìå®Î∞∞ Ïù¥ÌéôÌä∏ (ÏÉÅÎåÄ ÌÅ¨Î¶¨Ìã∞Ïª¨Ïù¥Î©¥ Îçî Í∞ïÌïú Ìö®Í≥º)
                if (enemyCrit) {
                    playSound('destroy');
                    vibrate([200, 100, 200, 100, 300]);
                } else {
                    playSound('fail');
                    vibrate([100, 50, 100, 50, 200]);
                }
                showBattleEffect(enemyAction, false, myDamage, enemyCrit);
                
                resultText.innerHTML = `
                    <div style="animation: resultAppear 0.4s ease-out, loseGlow 1s ease-in-out infinite;">
                        <span style="font-size:2rem;color:#ff6b6b;">üíî Ìå®Î∞∞!</span>
                        ${enemyCrit ? '<span style="font-size:1.5rem;color:#ff4500;animation:actionBounce 0.3s ease-out infinite;"> üí•ÌÅ¨Î¶¨Ìã∞Ïª¨!</span>' : ''}
                    </div>
                    <div style="font-size:${enemyCrit ? '3.5rem' : '2.5rem'};font-weight:bold;margin-top:10px;color:${enemyCrit ? '#ff0000' : '#ff6b6b'};animation: damageShake 0.3s ease-in-out ${enemyCrit ? 5 : 3};text-shadow:${enemyCrit ? '0 0 20px #ff0000' : 'none'};">
                        -${myDamage}
                    </div>
                    <div style="font-size:0.9rem;color:var(--muted);margin-top:5px;">ÎÇòÏóêÍ≤å Îç∞ÎØ∏ÏßÄ!</div>
                `;
                
                // ÌôîÎ©¥ ÌùîÎì§Î¶º (ÌÅ¨Î¶¨Ìã∞Ïª¨Ïù¥Î©¥ Îçî Ïò§Îûò)
                document.body.classList.add('screen-shake');
                setTimeout(() => document.body.classList.remove('screen-shake'), enemyCrit ? 800 : 500);
                
            } else {
                // Î¨¥ÏäπÎ∂Ä - ÌñâÎèôÏóê Îî∞Îùº Îã§Î•∏ Í≤∞Í≥º
                if (myCrit && enemyCrit && myDamage > 0 && enemyDamage > 0) {
                    // Ïä§ÌÇ¨ vs Ïä§ÌÇ¨: ÏñëÏ™Ω ÌÅ¨Î¶¨Ìã∞Ïª¨!
                    playSound('crit');
                    vibrate([100, 50, 100, 50, 100, 50, 150]);
                    showBattleEffect('skill', true, myDamage, true);
                    showBattleEffect('skill', false, enemyDamage, true);
                    
                    // ÌôîÎ©¥ Î≤àÏ©ç
                    document.body.style.background = 'radial-gradient(circle, rgba(155,89,182,0.5) 0%, transparent 70%)';
                    setTimeout(() => { document.body.style.background = ''; }, 400);
                    
                    resultText.innerHTML = `
                        <div style="animation: resultAppear 0.4s ease-out;">
                            <span style="font-size:2rem;color:#9b59b6;">üîÆüí• Ïä§ÌÇ¨ Ï∂©Îèå! üí•üîÆ</span>
                        </div>
                        <div style="font-size:1.2rem;margin-top:8px;color:#ffd700;animation:actionBounce 0.3s ease-out infinite;">
                            ÏñëÏ™Ω ÌÅ¨Î¶¨Ìã∞Ïª¨!
                        </div>
                        <div style="display:flex;justify-content:center;gap:30px;margin-top:10px;">
                            <span style="font-size:2rem;color:#4ecca3;">-${enemyDamage}</span>
                            <span style="font-size:2rem;color:#ff6b6b;">-${myDamage}</span>
                        </div>
                    `;
                } else if (myDamage === 0 && enemyDamage === 0) {
                    // Î∞©Ïñ¥ vs Î∞©Ïñ¥: Îç∞ÎØ∏ÏßÄ ÏóÜÏùå
                    playSound('defense');
                    vibrate([20, 20]);
                    showBattleEffect('defense', true, 0, false);
                    
                    resultText.innerHTML = `
                        <div style="animation: resultAppear 0.4s ease-out;">
                            <span style="font-size:2rem;color:#3498db;">üõ°Ô∏è ÏôÑÎ≤ΩÌïú ÍµêÏ∞©! üõ°Ô∏è</span>
                        </div>
                        <div style="font-size:1.2rem;margin-top:10px;color:var(--muted);">
                            ÏñëÏ™Ω Î∞©Ïñ¥! Îç∞ÎØ∏ÏßÄ ÏóÜÏùå
                        </div>
                    `;
                } else {
                    // Í≥µÍ≤© vs Í≥µÍ≤©: Îç∞ÎØ∏ÏßÄ Ï∞®Ïù¥
                    playSound('attack');
                    vibrate([50, 30, 50]);
                    showBattleEffect('attack', myDamage < enemyDamage, Math.abs(myDamage - enemyDamage), false);
                    
                    const winner = myDamage < enemyDamage ? 'ÎÇò' : 'ÏÉÅÎåÄ';
                    const damageDiff = Math.abs(myDamage - enemyDamage);
                    
                    resultText.innerHTML = `
                        <div style="animation: resultAppear 0.4s ease-out;">
                            <span style="font-size:2rem;color:#e67e22;">‚öîÔ∏è Í≥µÍ≤© Ï∂©Îèå! ‚öîÔ∏è</span>
                        </div>
                        <div style="font-size:1.2rem;margin-top:10px;color:${myDamage < enemyDamage ? '#4ecca3' : '#ff6b6b'};">
                            ${damageDiff > 0 ? `${winner}Ïùò Î¨¥Í∏∞Í∞Ä Îçî Í∞ïÎ†•! -${damageDiff}` : 'ÏôÑÎ≤ΩÌïú Í∑†Ìòï!'}
                        </div>
                    `;
                }
            }

            await sleep(1500);
            overlay.remove();
        }

        // Î∞∞ÌãÄ Ïù¥ÌéôÌä∏ ÌëúÏãú (Í∞ïÌôî)
        function showBattleEffect(action, isMyAttack, damage, isCrit = false, weaponType = null) {
            const effect = document.createElement('div');
            effect.className = 'battle-effect';
            
            // ÎÇ¥ Î¨¥Í∏∞ ÌÉÄÏûÖ (Ìò∏Ï∂ú Ïãú Ï†ÑÎã¨ÎêòÏßÄ ÏïäÏúºÎ©¥ stateÏóêÏÑú Í∞ÄÏ†∏Ïò¥)
            const myWeaponType = weaponType || state.weapon?.type;
            const myWeaponElement = state.weapon?.element || 'none';
            
            // üßô ÎßàÎ≤ï Î¨¥Í∏∞ ÌÅ¨Î¶¨Ìã∞Ïª¨ Ïù¥ÌéôÌä∏
            if (isMyAttack && isCrit && isMagicWeapon(state.weapon) && ELEMENTS[myWeaponElement]?.magicEffect) {
                showMagicEffect(myWeaponElement);
            }
            
            // Ïó¨Îü¨ Ïù¥ÌéôÌä∏ ÎèôÏãúÏóê
            if (action === 'attack' || action.startsWith('ultimate_burst')) {
                // Î¨¥Í∏∞ ÌÉÄÏûÖÎ≥Ñ Ïù¥ÌéôÌä∏
                let effectHtml = '';
                if (isMyAttack && myWeaponType === 'knuckle') {
                    // üëä ÎÑàÌÅ¥: ÎçîÎ∏îÌéÄÏπò
                    effectHtml = `
                        <div class="slash-punch" style="${isCrit ? 'transform:scale(1.3);' : ''}"></div>
                        <div style="position:absolute;font-size:${isCrit ? '4rem' : '2.5rem'};animation:actionBounce 0.4s ease-out;">${isCrit ? 'üí•üí•' : 'üí™'}</div>
                    `;
                } else if (isMyAttack && (myWeaponType === 'bow' || myWeaponType === 'crossbow')) {
                    // üèπ ÏõêÍ±∞Î¶¨: ÌôîÏÇ¥
                    effectHtml = `
                        <div class="slash-arrow" style="${isCrit ? 'transform:scale(1.3);' : ''}"></div>
                        <div style="position:absolute;font-size:${isCrit ? '4rem' : '2.5rem'};animation:actionBounce 0.4s ease-out;">${isCrit ? 'üéØüí•' : 'üèπ'}</div>
                    `;
                } else if (isMyAttack && (myWeaponType === 'staff' || myWeaponType === 'wand')) {
                    // üßô ÎßàÎ≤ï Î¨¥Í∏∞: ÏÜçÏÑ± Ïù¥Î™®ÏßÄ
                    const elemIcon = ELEMENTS[myWeaponElement]?.icon || '‚ú®';
                    effectHtml = `
                        <div style="font-size:${isCrit ? '5rem' : '3.5rem'};animation:actionBounce 0.5s ease-out;text-shadow:0 0 30px ${ELEMENTS[myWeaponElement]?.color || '#fff'};">${elemIcon}</div>
                    `;
                } else {
                    // Í∏∞Î≥∏: Ïä¨ÎûòÏãú
                    effectHtml = `
                        <div class="slash-effect" style="${isCrit ? 'transform:scale(1.5);' : ''}"></div>
                        <div style="position:absolute;font-size:${isCrit ? '5rem' : '3rem'};animation:actionBounce 0.4s ease-out;">${isCrit ? 'üí•üí•üí•' : 'üí•'}</div>
                    `;
                }
                effect.innerHTML = effectHtml;
                
                // ÌååÌã∞ÌÅ¥ Ìö®Í≥º (ÌÅ¨Î¶¨Ìã∞Ïª¨Ïù¥Î©¥ Îçî ÎßéÏù¥, ÎßàÎ≤ï Î¨¥Í∏∞Îäî ÏÜçÏÑ±ÏÉâ)
                const particleCount = isCrit ? 15 : 5;
                let particleColor = isCrit ? '#ff4500' : (isMyAttack ? '#4ecca3' : '#ff6b6b');
                if (isMyAttack && (myWeaponType === 'staff' || myWeaponType === 'wand')) {
                    particleColor = ELEMENTS[myWeaponElement]?.color || particleColor;
                }
                for (let i = 0; i < particleCount; i++) {
                    setTimeout(() => showParticle(particleColor), i * 30);
                }
            } else if (action === 'defense' || action.startsWith('ultimate_absolute')) {
                effect.innerHTML = `
                    <div class="shield-effect"></div>
                    <div style="position:absolute;font-size:2rem;animation:actionBounce 0.4s ease-out;margin-top:-100px;">üõ°Ô∏è</div>
                `;
            } else if (action === 'skill') {
                const skillEmoji = SKILL_EFFECTS[Math.floor(Math.random() * SKILL_EFFECTS.length)];
                const skillName = SKILL_NAMES[Math.floor(Math.random() * SKILL_NAMES.length)];
                effect.innerHTML = `
                    <div class="skill-effect">${skillEmoji}</div>
                    <div style="position:absolute;font-size:1.5rem;font-weight:bold;color:#9b59b6;margin-top:100px;animation:resultAppear 0.3s ease-out;">${skillName}</div>
                `;
                // ÎßàÎ≤ï ÌååÌã∞ÌÅ¥
                for (let i = 0; i < 8; i++) {
                    setTimeout(() => showParticle('#9b59b6'), i * 30);
                }
            } else if (action.startsWith('ultimate_lifedrain')) {
                effect.innerHTML = `
                    <div style="font-size:4rem;animation:actionBounce 0.5s ease-out;">üíö</div>
                    <div style="position:absolute;font-size:1.2rem;color:#32cd32;margin-top:80px;">ÏÉùÎ™ÖÌù°Ïàò!</div>
                `;
            }
            
            document.body.appendChild(effect);
            setTimeout(() => effect.remove(), 1000);
        }
        
        // ÌååÌã∞ÌÅ¥ Ìö®Í≥º
        function showParticle(color) {
            const particle = document.createElement('div');
            const x = Math.random() * window.innerWidth;
            const y = Math.random() * window.innerHeight * 0.6 + window.innerHeight * 0.2;
            particle.style.cssText = `
                position: fixed;
                left: ${x}px;
                top: ${y}px;
                width: 8px;
                height: 8px;
                background: ${color};
                border-radius: 50%;
                pointer-events: none;
                z-index: 10000;
                animation: particleFade 0.6s ease-out forwards;
            `;
            if (!document.getElementById('particle-style')) {
                const style = document.createElement('style');
                style.id = 'particle-style';
                style.textContent = `@keyframes particleFade { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(0) translateY(-50px); opacity: 0; } }`;
                document.head.appendChild(style);
            }
            document.body.appendChild(particle);
            setTimeout(() => particle.remove(), 600);
        }

        // Îç∞ÎØ∏ÏßÄ Ïà´Ïûê ÌåùÏóÖ
        function showDamagePopup(damage, isEnemy, x, y) {
            const popup = document.createElement('div');
            popup.className = 'damage-popup';
            popup.style.left = x + 'px';
            popup.style.top = y + 'px';
            popup.style.color = isEnemy ? '#ff6b6b' : '#4ecca3';
            popup.textContent = `-${damage}`;
            document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 1000);
        }

        function renderBattle() {
            if (!battleState || !battleState.gameState) return;

            const gs = battleState.gameState;
            const myId = cachedMyId || mpUI?.getClient()?.getMyUserId();
            const me = gs.players.find(p => p.id === myId);
            const enemy = gs.players.find(p => p.id !== myId);
            
            if (!me || !enemy) {
                console.log('[renderBattle] Missing player data', { myId, players: gs.players });
                return;
            }
            
            const hasSelected = me?.hasSelected || me?.selectedAction;
            const enemyReady = enemy?.hasSelected;

            const myGrade = me?.weaponGrade ? GRADES[me.weaponGrade] : GRADES.common;
            const enemyGrade = enemy?.weaponGrade ? GRADES[enemy.weaponGrade] : GRADES.common;

            // ÏÜçÏÑ± Ïù¥Î™®ÏßÄ
            const elemEmoji = { fire: 'üî•', ice: '‚ùÑÔ∏è', lightning: '‚ö°', holy: '‚ú®', poison: '‚ò†Ô∏è', silver: 'üåô', lifesteal: 'ü©∏', none: '' };
            const myElem = elemEmoji[me?.weaponElement] || '';
            const enemyElem = elemEmoji[enemy?.weaponElement] || '';

            // ÌñâÎèô Í∏∞Î°ù Ïù¥Î™®ÏßÄ (ÏµúÍ∑º 3Í∞ú)
            const actionEmoji = { attack: '‚öîÔ∏è', defense: 'üõ°Ô∏è', skill: 'üîÆ' };
            const myHistory = (me?.actionHistory || []).slice(-3).map(a => actionEmoji[a] || '?').join(' ');
            const enemyHistory = (enemy?.actionHistory || []).slice(-3).map(a => actionEmoji[a] || '?').join(' ');

            // Í∞ÅÏÑ±/Î∂ÑÎÖ∏ ÏÉÅÌÉú
            const myAwakened = me?.isAwakened;
            const enemyAwakened = enemy?.isAwakened;
            const myRage = me?.rage || 0;
            const enemyRage = enemy?.rage || 0;
            const canUltimate = myRage >= 100;

            // Î¨¥Í∏∞ Ïù¥Î™®ÏßÄ
            const myWeaponEmoji = getWeaponEmoji(me?.weaponName, me?.weaponType);
            const enemyWeaponEmoji = getWeaponEmoji(enemy?.weaponName, enemy?.weaponType);

            // HP ÎπÑÏú®
            const myHpPercent = Math.max(0, ((me?.hp || 0) / (me?.maxHp || 100)) * 100);
            const enemyHpPercent = Math.max(0, ((enemy?.hp || 0) / (enemy?.maxHp || 100)) * 100);

            const phaseText = gs.phase === 'select' 
                ? (hasSelected ? '‚è≥ ÏÉÅÎåÄ ÎåÄÍ∏∞Ï§ë' : '‚ö° ÌñâÎèô ÏÑ†ÌÉù!')
                : 'Í≤∞Í≥º';

            document.getElementById('app').innerHTML = `
                <div class="battle-screen">
                    <div class="battle-header">
                        <div class="battle-title">‚öîÔ∏è Î¨¥Í∏∞ Î∞∞ÌãÄ</div>
                        <div class="battle-round">ÎùºÏö¥Îìú ${gs.round || 1} | ${phaseText}</div>
                        <div style="font-size:0.6rem;color:var(--muted);margin-top:4px;">
                            ‚öîÔ∏èÍ≥µÍ≤©‚ÜíüîÆÏä§ÌÇ¨ Ïù¥ÍπÄ | üîÆÏä§ÌÇ¨‚Üíüõ°Ô∏èÎ∞©Ïñ¥ Ïù¥ÍπÄ | üõ°Ô∏èÎ∞©Ïñ¥‚Üí‚öîÔ∏èÍ≥µÍ≤© Ïù¥ÍπÄ
                        </div>
                    </div>

                    <div class="battle-arena">
                        <div class="battle-vs">VS</div>
                        
                        <!-- ÏÉÅÎåÄ (ÏúÑÏ™Ω, Îπ®Í∞ÑÏÉâ) -->
                        <div class="fighter enemy ${enemyAwakened ? 'awakened' : ''}">
                            <div class="fighter-content">
                                <div class="fighter-weapon-icon" style="border-color:${enemyGrade.color};">
                                    ${enemyWeaponEmoji}
                                    <span class="weapon-level" style="background:${enemyGrade.color};">+${enemy?.weaponLevel || 0}</span>
                                </div>
                                <div class="fighter-info">
                                    <div class="fighter-header">
                                        <span class="fighter-name">${enemy?.nickname || 'ÏÉÅÎåÄ'} ${enemyReady ? '‚úÖ' : '‚è≥'}</span>
                                    </div>
                                    <div class="fighter-weapon-name" style="color:${enemyGrade.color};">
                                        ${enemy?.weaponName || 'Î¨¥Í∏∞'} [${enemyGrade.name}]
                                        ${enemyAwakened ? '<span style="color:#ffd700;">‚ö°Í∞ÅÏÑ±</span>' : ''}
                                    </div>
                                    <div style="font-size:0.7rem;margin-bottom:4px;">
                                        ${enemyElem ? `<span style="background:rgba(255,255,255,0.1);padding:2px 6px;border-radius:4px;">${enemyElem} ÏÜçÏÑ±</span>` : ''}
                                    </div>
                                    <div class="hp-bar-container">
                                        <div class="hp-bar ${enemyHpPercent <= 30 ? 'low' : ''}" style="width:${enemyHpPercent}%">
                                            ‚ù§Ô∏è ${enemy?.hp || 0} / ${enemy?.maxHp || 100}
                                        </div>
                                    </div>
                                    <div class="rage-bar-container">
                                        <div class="rage-bar ${enemyRage >= 100 ? 'full' : ''}" style="width:${enemyRage}%"></div>
                                    </div>
                                    <div class="fighter-stats">
                                        <span>‚öîÔ∏è ${enemy?.damageMin || 5}-${enemy?.damageMax || 8}</span>
                                        <span>üí• ${enemy?.weaponCritChance || 5}%</span>
                                        <span>üî• ${enemyRage}%</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ÎÇò (ÏïÑÎûòÏ™Ω, Ï¥àÎ°ùÏÉâ) -->
                        <div class="fighter me ${myAwakened ? 'awakened' : ''}">
                            <div class="fighter-content">
                                <div class="fighter-weapon-icon" style="border-color:${myGrade.color};">
                                    ${myWeaponEmoji}
                                    <span class="weapon-level" style="background:${myGrade.color};">+${me?.weaponLevel || 0}</span>
                                </div>
                                <div class="fighter-info">
                                    <div class="fighter-header">
                                        <span class="fighter-name">${me?.nickname || 'ÎÇò'} ${hasSelected ? '‚úÖ' : ''}</span>
                                    </div>
                                    <div class="fighter-weapon-name" style="color:${myGrade.color};">
                                        ${me?.weaponName || 'Î¨¥Í∏∞'} [${myGrade.name}]
                                        ${myAwakened ? '<span style="color:#ffd700;">‚ö°Í∞ÅÏÑ±</span>' : ''}
                                    </div>
                                    <div style="font-size:0.7rem;margin-bottom:4px;">
                                        ${myElem ? `<span style="background:rgba(78,204,163,0.2);padding:2px 6px;border-radius:4px;">${myElem} ÏÜçÏÑ±</span>` : ''}
                                    </div>
                                    <div class="hp-bar-container">
                                        <div class="hp-bar ${myHpPercent <= 30 ? 'low' : ''}" style="width:${myHpPercent}%">
                                            ‚ù§Ô∏è ${me?.hp || 0} / ${me?.maxHp || 100}
                                        </div>
                                    </div>
                                    <div class="rage-bar-container">
                                        <div class="rage-bar ${myRage >= 100 ? 'full' : ''}" style="width:${myRage}%"></div>
                                    </div>
                                    <div class="fighter-stats">
                                        <span>‚öîÔ∏è ${me?.damageMin || 5}-${me?.damageMax || 8}</span>
                                        <span>üí• ${me?.weaponCritChance || 5}%</span>
                                        <span>üî• ${myRage}%</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="battle-log" id="battleLog">
                            ${(gs.log || []).slice(-5).reverse().map(entry => `
                                <div class="log-entry ${entry.type || ''}">${entry.text}</div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="battle-actions">
                        ${hasSelected ? `
                            <div style="text-align:center;padding:20px;color:var(--muted);font-size:1.1rem;">
                                ‚è≥ ÏÉÅÎåÄ ÌñâÎèô ÎåÄÍ∏∞Ï§ë...
                            </div>
                        ` : `
                            <div class="action-grid">
                                <button class="action-btn attack" onclick="battleAction('attack')">
                                    <span class="action-icon">‚öîÔ∏è</span>
                                    Í≥µÍ≤©
                                    <span class="action-hint">Ïä§ÌÇ¨Ïóê Ïú†Î¶¨</span>
                                </button>
                                <button class="action-btn defense" onclick="battleAction('defense')">
                                    <span class="action-icon">üõ°Ô∏è</span>
                                    Î∞©Ïñ¥
                                    <span class="action-hint">Í≥µÍ≤©Ïóê Ïú†Î¶¨</span>
                                </button>
                                <button class="action-btn skill" onclick="battleAction('skill')">
                                    <span class="action-icon">üîÆ</span>
                                    Ïä§ÌÇ¨
                                    <span class="action-hint">Î∞©Ïñ¥ Í¥ÄÌÜµ</span>
                                </button>
                            </div>
                            ${canUltimate ? `
                                <div class="ultimate-grid">
                                    <button class="ultimate-btn burst" onclick="battleUltimate('burst')">
                                        üî• ÌïÑÏÇ¥<br><span style="font-size:0.55rem;">2Î∞∞ Îç∞ÎØ∏ÏßÄ</span>
                                    </button>
                                    <button class="ultimate-btn drain" onclick="battleUltimate('lifedrain')">
                                        üíö Ìù°Ïàò<br><span style="font-size:0.55rem;">Îç∞ÎØ∏ÏßÄ=ÌöåÎ≥µ</span>
                                    </button>
                                    <button class="ultimate-btn shield" onclick="battleUltimate('absolute')">
                                        üõ°Ô∏è Ï†àÎåÄÎ∞©Ïñ¥<br><span style="font-size:0.55rem;">Î¨¥Ìö®+1.5Î∞∞</span>
                                    </button>
                                </div>
                            ` : ''}
                        `}
                        <button class="btn btn-secondary" onclick="battleSurrender()" style="width:100%;background:rgba(255,100,100,0.15);margin-top:8px;">
                            üè≥Ô∏è Ìï≠Î≥µ
                        </button>
                    </div>
                </div>
            `;
        }

        function battleSurrender() {
            if (!confirm('Ìï≠Î≥µÌïòÎ©¥ Ìå®Î∞∞ Ï≤òÎ¶¨Îê©ÎãàÎã§.\nÏ†ïÎßê Ìï≠Î≥µÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            
            // Leave room (counts as loss)
            if (mpUI && mpUI.getClient()) {
                mpUI.getClient().leaveRoom().catch(() => {});
                mpUI.getClient()._clearRoom();
                MultiplayerClient.resetInstance();
            }
            
            state.stats.losses++;
            saveState();
            
            playSound('fail');
            
            mpUI = null;
            battleState = null;
            showMain();
        }

        let battleActionPending = false;  // Ï§ëÎ≥µ ÌÅ¥Î¶≠ Î∞©ÏßÄ
        
        async function battleUltimate(ultType) {
            if (!mpUI || !mpUI.getClient()) return;
            if (battleActionPending) return;
            
            battleActionPending = true;
            try {
                const response = await mpUI.sendAction({ type: 'ultimate', payload: { ultimate: ultType } });
                console.log('Ultimate response:', response);
                if (response.newState) {
                    battleState = { gameState: response.newState };
                    renderBattle();
                }
            } catch (e) {
                console.error('Ultimate error:', e);
            } finally {
                battleActionPending = false;
            }
        }
        
        async function battleAction(action) {
            if (!mpUI || !mpUI.getClient()) return;
            if (battleActionPending) return;
            
            battleActionPending = true;
            try {
                const response = await mpUI.sendAction({ type: action });
                console.log('Action response:', response);
                
                // newState Íµ¨Ï°∞Î°ú Î≥ÄÍ≤ΩÎê®
                if (response.newState) {
                    const prevState = battleState?.gameState;
                    const newState = response.newState;
                    battleState = { gameState: newState };
                    
                    // ÌÑ¥ Í≤∞Í≥ºÍ∞Ä ÏûàÏúºÎ©¥ Ïï†ÎãàÎ©îÏù¥ÏÖò ÌëúÏãú
                    if (newState.lastTurnResult) {
                        const tr = newState.lastTurnResult;
                        const myId = cachedMyId || mpUI.getClient().getMyUserId();
                        const me = newState.players.find(p => p.id === myId);
                        const enemy = newState.players.find(p => p.id !== myId);
                        
                        // ÌîåÎ†àÏù¥Ïñ¥ ÏàúÏÑú ÌôïÏù∏ (p1Ïù¥ ÎÇòÏù∏ÏßÄ ÏÉÅÎåÄÏù∏ÏßÄ)
                        const isP1Me = newState.players[0]?.id === myId;
                        const myAction = isP1Me ? tr.p1Action : tr.p2Action;
                        const enemyAction = isP1Me ? tr.p2Action : tr.p1Action;
                        const myDamage = isP1Me ? tr.p1Damage : tr.p2Damage;
                        const enemyDamage = isP1Me ? tr.p2Damage : tr.p1Damage;
                        const myCrit = isP1Me ? tr.p1Crit : tr.p2Crit;
                        const enemyCrit = isP1Me ? tr.p2Crit : tr.p1Crit;
                        
                        // Í≤∞Í≥º: ÎÇ¥Í∞Ä Ïù¥Í≤ºÎäîÏßÄ
                        let result = 'draw';
                        if (enemyDamage > myDamage) result = 'win';
                        else if (myDamage > enemyDamage) result = 'lose';
                        
                        await showTurnResult(myAction, enemyAction, result, myDamage, enemyDamage, myCrit, enemyCrit);
                    }
                    
                    // Í≤åÏûÑ Ï¢ÖÎ£å Ï≤¥ÌÅ¨
                    if (newState.winnerId || newState.phase === 'ended') {
                        const myId = mpUI.getClient().getMyUserId();
                        handleBattleEvent('game_end', { winnerId: newState.winnerId });
                        return;
                    }
                    
                    renderBattle();
                } else if (response.gameState) {
                    battleState = { gameState: response.gameState };
                    renderBattle();
                }
            } catch (e) {
                console.error('Battle action error:', e);
            } finally {
                battleActionPending = false;  // ÏôÑÎ£å ÌõÑ Îã§Ïãú Ïï°ÏÖò Í∞ÄÎä•
            }
        }

        let battleResultShown = false;  // Ï§ëÎ≥µ Ìò∏Ï∂ú Î∞©ÏßÄ
        
        function showBattleResult(data) {
            console.log('[showBattleResult] called with:', data);
            
            // Ï§ëÎ≥µ Ìò∏Ï∂ú Î∞©ÏßÄ
            if (battleResultShown) {
                console.log('[showBattleResult] Already shown, skipping');
                return;
            }
            battleResultShown = true;
            
            const client = mpUI?.getClient();
            const myId = client?.getMyUserId() || cachedMyId;
            
            if (!myId) {
                console.error('[showBattleResult] No user ID available!');
                return;
            }
            
            const isWin = data.winnerId === myId;
            const gs = battleState?.gameState;
            const rounds = gs?.round || 1;
            
            let weaponBroke = false;
            let canRematch = true;

            if (isWin) {
                // ÏäπÎ¶¨: ÏÉÅÎåÄ Î¨¥Í∏∞ Î†àÎ≤® * 1000 Í≥®Îìú (Ï†ÄÎ†àÎ≤®Ïù¥ Í≥†Î†àÎ≤® Ïù¥Í∏∞Î©¥ ÎßéÏù¥ Î∞õÏùå)
                const enemy = gs?.players?.find(p => p.id !== myId);
                const enemyLevel = enemy?.weaponLevel || 0;
                const goldReward = Math.max(1000, enemyLevel * 1000);  // ÏµúÏÜå 1000Í≥®Îìú
                state.gold += goldReward;
                state.stats.wins++;
                state.consecutivePvpLosses = 0;  // PVP ÏäπÎ¶¨ Ïãú Ïó∞Ìå® Ïπ¥Ïö¥ÌÑ∞ Î¶¨ÏÖã
                saveState();
                syncPvPRanking(true);
                
                mpUI.showResult({
                    title: 'üèÜ ÏäπÎ¶¨!',
                    detail: `${rounds} ÎùºÏö¥Îìú Ï†ÑÌà¨ ÏäπÎ¶¨!\nüí∞ +${goldReward.toLocaleString()} Í≥®Îìú\n(ÏÉÅÎåÄ +${enemyLevel} Î¨¥Í∏∞ Í≤©Ìåå Î≥¥ÏÉÅ)`,
                    isWin: true,
                    showRematch: true
                });
                
                fireConfetti();
            } else {
                // Ìå®Î∞∞: ÎÇ¥Íµ¨ÎèÑ 20% ÌïòÎùΩ
                state.stats.losses++;
                // Ï†ÄÏ£º Ìä∏Î¶¨Í±∞: PVP Ïó∞ÏÜç 3Ìöå Ìå®Î∞∞
                state.consecutivePvpLosses = (state.consecutivePvpLosses || 0) + 1;
                
                // ÎÇòÎ¨¥ÎßâÎåÄÍ∏∞Í∞Ä ÏïÑÎãàÎ©¥ ÎÇ¥Íµ¨ÎèÑ Í∞êÏÜå
                if (!isWoodenStick()) {
                    const currentDurability = state.weapon.durability ?? MAX_DURABILITY;
                    const durabilityLoss = Math.ceil(MAX_DURABILITY * 0.2);  // 20 Í≥†Ï†ï
                    state.weapon.durability = Math.max(0, currentDurability - durabilityLoss);
                    
                    // ÎÇ¥Íµ¨ÎèÑ 0Ïù¥Î©¥ Î¨¥Í∏∞ ÌååÍ¥¥
                    if (state.weapon.durability <= 0) {
                        weaponBroke = true;
                        canRematch = false;
                        
                        // üëø Ï†ÄÏ£ºÎ∞õÏùÄ Î¨¥Í∏∞: PVPÏóêÏÑú ÎÇ¥Íµ¨ÎèÑ ÌååÍ¥¥ = ÏÉÅÎåÄÎèÑ Ï¶âÏÇ¨! (Î¨¥ÏäπÎ∂Ä)
                        const wasCursed = isCursed(state.weapon);
                        
                        // Î¨¥Í∏∞ ÌååÍ¥¥ Ï≤òÎ¶¨
                        const brokenWeaponName = state.weapon.name;
                        const brokenWeaponLevel = state.weapon.level;
                        addDestroyedWeaponRecord(state.weapon, 'pvp_death', 0);
                        
                        // ÏÉÅÎåÄ Î¨¥Í∏∞ Îì±Í∏â ÌôïÏù∏Ìï¥ÏÑú Îçî Ï¢ãÏùÄ Î¨¥Í∏∞ ÏßÄÍ∏â
                        const enemy = gs?.players?.find(p => p.id !== myId);
                        const enemyGrade = enemy?.weaponGrade || 'common';
                        const newWeapon = generateWeaponByPvPLoss(enemyGrade);
                        state.weapon = newWeapon;
                        state.mastery = {};  // ÏàôÎ†®ÎèÑ Î¶¨ÏÖã
                        state.bossKills = 0;
                        state.bossTypeKills = { dragon: 0, demon: 0, undead: 0, elemental: 0 };
                        
                        playSound('destroy');
                        vibrate([200, 100, 200, 100, 300]);
                        
                        if (wasCursed) {
                            fireConfetti();
                            // Ï†ÄÏ£º Ìè≠Î∞ú: Ìå®Î∞∞Î•º Î¨¥ÏäπÎ∂ÄÎ°ú
                            mpUI.showResult({
                                title: 'üëøüí• Ï†ÄÏ£º Ìè≠Î∞ú!',
                                detail: `${brokenWeaponName} +${brokenWeaponLevel}Ïùò Ï†ÄÏ£ºÍ∞Ä Ìè≠Î∞ú!\nÏÉÅÎåÄÎ∞©ÎèÑ Ìï®Íªò Ïì∞Îü¨Ï°åÎã§!`,
                                isWin: false,
                                showRematch: false
                            });
                        } else {
                            // Í≤∞Í≥ºÏ∞Ω Î®ºÏ†Ä ÌëúÏãú
                            mpUI.showResult({
                                title: 'üíÄ Ìå®Î∞∞... Î¨¥Í∏∞ ÌååÍ¥¥!',
                                detail: `${brokenWeaponName} +${brokenWeaponLevel} ÌååÍ¥¥Îê®!`,
                                isWin: false,
                                showRematch: false
                            });
                        }
                        
                        // ÏÉà Î¨¥Í∏∞ ÌöçÎìù Ïù¥ÌéôÌä∏ ÌëúÏãú
                        setTimeout(() => {
                            showWeaponAcquireEffect(newWeapon, 'pvp_loss', { 
                                enemyGrade,
                                brokenWeaponName,
                                brokenWeaponLevel
                            });
                        }, 1000);
                    } else {
                        mpUI.showResult({
                            title: 'üíÄ Ìå®Î∞∞...',
                            detail: `${rounds} ÎùºÏö¥Îìú Ï†ÑÌà¨ Ìå®Î∞∞.\nüîß ÎÇ¥Íµ¨ÎèÑ -${durabilityLoss} (${state.weapon.durability}/${MAX_DURABILITY})`,
                            isWin: false,
                            showRematch: true
                        });
                    }
                } else {
                    // ÎÇòÎ¨¥ÎßâÎåÄÍ∏∞Îäî ÎÇ¥Íµ¨ÎèÑ Í∞êÏÜå ÏóÜÏùå
                    mpUI.showResult({
                        title: 'üíÄ Ìå®Î∞∞...',
                        detail: `${rounds} ÎùºÏö¥Îìú Ï†ÑÌà¨ Ìå®Î∞∞.\n(ÎÇòÎ¨¥ÎßâÎåÄÍ∏∞Îäî ÎÇ¥Íµ¨ÎèÑ Í∞êÏÜå ÏóÜÏùå)`,
                        isWin: false,
                        showRematch: true
                    });
                }
                
                saveState();
                syncPvPRanking(false);
                
                // üëø PVP Ìå®Î∞∞ ÌõÑ Ï†ÄÏ£º Ï≤¥ÌÅ¨
                setTimeout(() => checkCurseTrigger('pvp_loss'), 1500);
            }
        }

        // ===== HUNT MODE (Single Player) =====
        let huntState = null;

        function getRecommendedTier(weaponLevel) {
            // Í∏∞Î≥∏ Î†àÎ≤® Í∏∞Î∞ò (Ìè¥Î∞±)
            if (weaponLevel <= 2) return 1;
            if (weaponLevel <= 5) return 2;
            if (weaponLevel <= 9) return 3;
            if (weaponLevel <= 14) return 4;
            return 5;
        }
        
        // Îç∞ÎØ∏ÏßÄ Í∏∞Î∞ò Ìã∞Ïñ¥ Ï∂îÏ≤ú
        function getRecommendedTierByDamage() {
            const stats = getWeaponStats(state.weapon);
            const avgDamage = (stats.damageMin + stats.damageMax) / 2;
            
            // ÌèâÍ∑† Îç∞ÎØ∏ÏßÄ Í∏∞Ï§Ä (50% ÎÑàÌîÑ Î∞òÏòÅ)
            // Tier 1: HP 30-55, Ï†ÅÏ†ï Îç∞ÎØ∏ÏßÄ 5-10
            // Tier 2: HP 70-120, Ï†ÅÏ†ï Îç∞ÎØ∏ÏßÄ 10-20
            // Tier 3: HP 150-250, Ï†ÅÏ†ï Îç∞ÎØ∏ÏßÄ 20-40
            // Tier 4: HP 280-450, Ï†ÅÏ†ï Îç∞ÎØ∏ÏßÄ 40-80
            // Tier 5: HP 600-800, Ï†ÅÏ†ï Îç∞ÎØ∏ÏßÄ 80+
            
            if (avgDamage < 10) return 1;
            if (avgDamage < 22) return 2;
            if (avgDamage < 45) return 3;
            if (avgDamage < 80) return 4;
            return 5;
        }

        function applyBossScaling(monster) {
            const kills = state.bossKills || 0;
            if (kills <= 0) return monster;
            const scale = 1 + kills * 0.05; // Î≥¥Ïä§ÌÇ¨Îãπ +5%
            return {
                ...monster,
                hp: Math.floor(monster.hp * scale),
                currentHp: Math.floor(monster.currentHp * scale),
                maxHp: Math.floor(monster.maxHp * scale),
                damage: [Math.floor(monster.damage[0] * scale), Math.floor(monster.damage[1] * scale)]
            };
        }

        function spawnMonster(forceType = null) {
            if (forceType && MONSTERS[forceType]) {
                const m = MONSTERS[forceType];
                return applyBossScaling({
                    type: forceType,
                    ...m,
                    currentHp: m.hp,
                    maxHp: m.hp
                });
            }

            // Îç∞ÎØ∏ÏßÄ Í∏∞Î∞ò Ìã∞Ïñ¥ (Î†àÎ≤®Î≥¥Îã§ Ï†ïÌôïÌï®)
            const recommendedTier = getRecommendedTierByDamage();
            
            // Î≥¥Ïä§ Ï∂úÌòÑ ÌôïÎ•† (ÏùºÎ∞ò Î™π 5ÎßàÎ¶¨ Ïù¥ÏÉÅ Ï≤òÏπò ÌõÑÎ∂ÄÌÑ∞, Ìã∞Ïñ¥Ïóê Îî∞Îùº Ï¶ùÍ∞Ä)
            const killsSinceLastBoss = huntState ? huntState.monstersKilled - (huntState.lastBossKill || 0) : 0;
            const bossChance = killsSinceLastBoss >= 5
                ? (recommendedTier >= 5 ? 0.15 : (recommendedTier >= 4 ? 0.1 : (recommendedTier >= 3 ? 0.05 : 0)))
                : 0;
            if (bossChance > 0 && Math.random() < bossChance) {
                // Î≥¥Ïä§Îäî ÌòÑÏû¨ Ìã∞Ïñ¥Ïóê ÎßûÍ≤å
                const bossTier = Math.max(4, recommendedTier);
                const bosses = Object.entries(MONSTERS).filter(([k, v]) => v.isBoss && v.tier <= bossTier);
                if (bosses.length > 0) {
                    const [type, m] = bosses[Math.floor(Math.random() * bosses.length)];
                    return applyBossScaling({ type, ...m, currentHp: m.hp, maxHp: m.hp });
                }
            }
            
            // ÏùºÎ∞ò Î™¨Ïä§ÌÑ∞: Ìã∞Ïñ¥ Î∂ÑÎ∞∞
            // ÌòÑÏû¨ Ìã∞Ïñ¥ 50%, ÌïúÎã®Í≥Ñ ÏïÑÎûò 30%, ÎëêÎã®Í≥Ñ ÏïÑÎûò 15%, ÌïúÎã®Í≥Ñ ÏúÑ 5%
            const roll = Math.random();
            let targetTier = recommendedTier;
            if (roll < 0.30 && recommendedTier > 1) {
                targetTier = recommendedTier - 1; // 30% ÌôïÎ•†Î°ú ÏïΩÌïú Î™¨Ïä§ÌÑ∞
            } else if (roll < 0.45 && recommendedTier > 2) {
                targetTier = recommendedTier - 2; // 15% ÌôïÎ•†Î°ú Îçî ÏïΩÌïú Î™¨Ïä§ÌÑ∞
            } else if (roll < 0.50 && recommendedTier < 5) {
                targetTier = recommendedTier + 1; // 5% ÌôïÎ•†Î°ú Í∞ïÌïú Î™¨Ïä§ÌÑ∞
            }
            
            const eligibleMonsters = Object.entries(MONSTERS)
                .filter(([k, v]) => v.tier === targetTier && !v.isBoss);
            
            if (eligibleMonsters.length === 0) {
                // Ìï¥Îãπ Ìã∞Ïñ¥ Î™¨Ïä§ÌÑ∞ ÏóÜÏúºÎ©¥ Í∞ÄÏû• Í∞ÄÍπåÏö¥ Ìã∞Ïñ¥
                const allMonsters = Object.entries(MONSTERS).filter(([k, v]) => !v.isBoss);
                const [type, m] = allMonsters[Math.floor(Math.random() * allMonsters.length)];
                return applyBossScaling({ type, ...m, currentHp: m.hp, maxHp: m.hp });
            }
            
            const [type, m] = eligibleMonsters[Math.floor(Math.random() * eligibleMonsters.length)];
            return applyBossScaling({ type, ...m, currentHp: m.hp, maxHp: m.hp });
        }

        // RELAY_URL is already declared in /lib/multiplayer.js

        function getPlayerId() {
            let id = localStorage.getItem('enhance_player_id');
            if (!id) { id = 'p_' + Math.random().toString(36).substr(2, 9); localStorage.setItem('enhance_player_id', id); }
            return id;
        }

        async function fetchBossDialogue(monster) {
            try {
                const res = await fetch(`${RELAY_URL}/api/llm/boss`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        playerId: getPlayerId(),
                        bossId: monster.type,
                        bossName: monster.name.replace(/[üî•üëπüíÄüëªüêç‚ùÑÔ∏èü¶Öüåüüòà‚öîÔ∏èüíßüåçüí®]/g, '').trim(),
                        bossTier: monster.tier,
                        playerWeapon: state.weapon.name,
                        playerLevel: state.weapon.level,
                        playerGrade: state.weapon.grade,
                        playerGold: state.gold,
                        playerElement: state.weapon.element || 'none',
                        playerWeaponType: state.weapon.type || 'sword',
                        bossType: monster.type || 'unknown',
                        gameId: 'enhance'
                    })
                });
                if (!res.ok) throw new Error('API error');
                return await res.json();
            } catch (e) {
                console.error('Boss dialogue fetch failed:', e);
                return null;
            }
        }

        function showBossDialogue(bossData) {
            if (!bossData || !bossData.dialogue) return;

            // "dialogue:" Ï†ëÎëêÏÇ¨ Ï†úÍ±∞
            let dialogue = bossData.dialogue.replace(/^dialogue:\s*/i, '').trim();
            if (!dialogue) return;

            const emotionEmoji = { angry: 'üò§', amused: 'üòè', scared: 'üò®', bored: 'ü•±', excited: 'ü§©' };
            const emoji = emotionEmoji[bossData.emotion] || 'üí¨';

            // Í∏∞Ï°¥ Ïò§Î≤ÑÎ†àÏù¥ Ï†úÍ±∞
            const old = document.getElementById('bossDialogueOverlay');
            if (old) old.remove();

            // Ïò§Î≤ÑÎ†àÏù¥ Î†àÏù¥Ïñ¥ ÏÉùÏÑ±
            const overlay = document.createElement('div');
            overlay.id = 'bossDialogueOverlay';
            overlay.style.cssText = `position:fixed;top:60px;left:50%;transform:translateX(-50%);
                width:90%;max-width:360px;z-index:9000;pointer-events:none;
                animation:bossDialogueIn 0.4s ease-out;`;
            const bubble = document.createElement('div');
            bubble.style.cssText = `background:rgba(20,0,0,0.9);border:2px solid rgba(255,60,60,0.6);
                border-radius:14px;padding:12px 16px;font-size:14px;line-height:1.6;
                color:#ffaaaa;text-align:center;pointer-events:auto;
                box-shadow:0 4px 20px rgba(255,0,0,0.3),inset 0 0 20px rgba(255,0,0,0.05);
                backdrop-filter:blur(8px);`;
            overlay.appendChild(bubble);
            document.body.appendChild(overlay);

            // ÌÉÄÏù¥Ìïë Ìö®Í≥º
            const text = `${emoji} ${dialogue}`;
            let i = 0;
            const typing = setInterval(() => {
                if (i < text.length) {
                    bubble.textContent += text[i];
                    i++;
                } else {
                    clearInterval(typing);
                    // ÌäπÏàò Ïä§ÌÇ¨ ÌëúÏãú
                    if (bossData.action === 'special_skill' && bossData.skillName) {
                        setTimeout(() => {
                            bubble.innerHTML += `<br><span style="color:#ff6600;font-weight:bold;">‚ö° ${bossData.skillName}!</span>`;
                            if (bossData.skillEffect) bubble.innerHTML += `<br><span style="color:#999;font-size:11px;">${bossData.skillEffect}</span>`;
                        }, 500);
                    }
                    // Í≥®Îìú ÏÑ†Î¨º
                    if (bossData.action === 'gift' && bossData.goldGift) {
                        setTimeout(() => {
                            state.gold += bossData.goldGift;
                            saveState();
                            bubble.innerHTML += `<br><span style="color:#ffd700;font-weight:bold;">üí∞ +${bossData.goldGift.toLocaleString()} G ÌöçÎìù!</span>`;
                            const goldEl = document.querySelector('.gold-amount');
                            if (goldEl) goldEl.textContent = state.gold.toLocaleString() + ' G';
                        }, 800);
                    }
                    // 5Ï¥à ÌõÑ ÌéòÏù¥ÎìúÏïÑÏõÉ
                    setTimeout(() => {
                        overlay.style.animation = 'bossDialogueOut 0.5s ease-in forwards';
                        setTimeout(() => overlay.remove(), 500);
                    }, 5000);
                }
            }, 30);

            // Î≥¥Ïä§ ÌäπÏàò Ïä§ÌÇ¨Ïù¥Î©¥ huntStateÏóê Í∏∞Î°ù
            if (bossData.action === 'special_skill') {
                huntState.bossSpecialSkill = { name: bossData.skillName, effect: bossData.skillEffect };
            }
        }

        function showHunt() {
            // Initialize hunt state
            const playerStats = getWeaponStats(state.weapon);
            huntState = {
                monster: spawnMonster(),
                player: {
                    hp: playerStats.hp,
                    maxHp: playerStats.hp,
                    ...playerStats
                },
                log: [],
                monstersKilled: 0,
                totalGoldEarned: 0
            };
            renderHunt();

            // Î≥¥Ïä§ Îì±Ïû• Ïãú AI ÎåÄÏÇ¨ Ìò∏Ï∂ú
            if (huntState.monster.isBoss) {
                fetchBossDialogue(huntState.monster).then(data => {
                    if (data) showBossDialogue(data);
                });
            }
        }

        function renderHunt() {
            if (!huntState) return;
            
            const monster = huntState.monster;
            const player = huntState.player;
            const weapon = state.weapon;
            const gradeData = GRADES[weapon.grade];

            document.getElementById('app').innerHTML = `
                <div class="container hunt-screen">
                    <div class="gold-display">
                        <span class="gold-icon">üí∞</span>
                        <span class="gold-amount">${state.gold.toLocaleString()} G</span>
                        <span style="margin-left:10px;color:var(--muted)">| Ï≤òÏπò: ${huntState.monstersKilled}</span>
                    </div>

                    <div class="monster-card ${monster.isBoss ? 'boss' : ''} ${getElementMultiplier(weapon.element, monster.type) > 1 ? 'weak' : ''}">
                        <div class="monster-tier">
                            ${monster.isBoss ? '‚ö†Ô∏è BOSS' : `Tier ${monster.tier}`}
                            ${monster.type ? ` | ${MONSTER_TYPES[monster.type]?.icon || ''} ${MONSTER_TYPES[monster.type]?.name || ''}` : ''}
                        </div>
                        <img src="${monster.img}" class="monster-img" alt="${monster.name}">
                        <div class="monster-name ${monster.isBoss ? 'boss' : ''}">${monster.name}</div>
                        
                        <div class="hp-bar-container" style="margin-top:12px;">
                            <div class="hp-bar ${monster.currentHp < monster.maxHp * 0.3 ? 'low' : ''}" 
                                 style="width: ${(monster.currentHp / monster.maxHp) * 100}%">
                                ${monster.currentHp} / ${monster.maxHp}
                            </div>
                        </div>
                        <div class="fighter-stats" style="justify-content:center;margin-top:8px;">
                            <span>‚öîÔ∏è ${monster.damage[0]}-${monster.damage[1]}</span>
                            <span>üí• ${monster.crit}%</span>
                            <span>üí∞ ${monster.gold[0]}-${monster.gold[1]}</span>
                        </div>
                    </div>

<!-- boss dialogue is now overlay -->

                    <div class="hunt-vs">‚öîÔ∏è VS ‚öîÔ∏è</div>

                    <div class="player-mini">
                        <div class="fighter-header">
                            <span class="fighter-name" style="color:${gradeData.color}">
                                <img src="${getWeaponIcon(weapon)}" style="width:24px;height:24px;vertical-align:middle;">
                                ${weapon.name} +${weapon.level}
                                ${weapon.element && weapon.element !== 'none' ? `<span style="margin-left:4px;">${ELEMENTS[weapon.element]?.icon || ''}</span>` : ''}
                            </span>
                        </div>
                        <div class="hp-bar-container" style="margin-top:8px;">
                            <div class="hp-bar ${player.hp < player.maxHp * 0.3 ? 'low' : ''}" 
                                 style="width: ${(player.hp / player.maxHp) * 100}%">
                                ${player.hp} / ${player.maxHp}
                            </div>
                        </div>
                        <div class="fighter-stats" style="margin-top:8px;">
                            <span>${weapon.type === 'knuckle' ? 'üëä' : '‚öîÔ∏è'} ${player.damageMin}-${player.damageMax}${weapon.type === 'knuckle' ? ' <span style="color:#ff8c00;">x2</span>' : ''}</span>
                            <span>üí• ${player.critChance}%${weapon.type === 'knuckle' ? ' <span style="color:#ff8c00;">x2</span>' : ''}</span>
                        </div>
                    </div>

                    <div class="battle-log" id="huntLog" style="height:120px;max-height:120px;overflow:hidden;">
                        ${huntState.log.slice(-3).reverse().map(entry => `
                            <div class="log-entry ${entry.type}">${entry.text}</div>
                        `).join('')}
                    </div>

                    <div class="hunt-actions">
                        <button class="btn btn-enhance" onclick="huntAttack()">‚öîÔ∏è Í≥µÍ≤©!</button>
                        <button class="btn btn-secondary" onclick="huntRunAway()" style="background:rgba(255,100,100,0.2);border:1px solid var(--fail);">
                            üèÉ ÎèÑÎßù (-${getRunPenaltyPercent(monster.tier)}%)
                        </button>
                    </div>
                </div>
            `;
        }

        function getRunPenaltyPercent(tier) {
            // Boss: 10%, Tier 3: 7%, Tier 2: 4%, Tier 1: 2%
            const penalties = { 1: 2, 2: 4, 3: 7, 4: 10 };
            return penalties[tier] || 5;
        }

        function huntRunAway() {
            if (!huntState) return;
            
            const monster = huntState.monster;
            const penaltyPercent = getRunPenaltyPercent(monster.tier);
            // ÏÇ¨ÎÉ• ÌöçÎìùÎ∂Ñ Ìè¨Ìï® ÌõÑ Í∏∞Ï§ÄÏúºÎ°ú ÌéòÎÑêÌã∞ Í≥ÑÏÇ∞
            const totalGoldAfterEarned = state.gold + huntState.totalGoldEarned;
            const goldLoss = Math.floor(totalGoldAfterEarned * penaltyPercent / 100);
            const netResult = huntState.totalGoldEarned - goldLoss;
            
            const warningMsg = monster.isBoss 
                ? `‚ö†Ô∏è Î≥¥Ïä§ÏóêÍ≤åÏÑú ÎèÑÎßùÏπòÎ©¥ Í≥®ÎìúÏùò ${penaltyPercent}%Î•º ÏûÉÏäµÎãàÎã§!\n\nüí∞ ÏÇ¨ÎÉ• ÌöçÎìù: +${huntState.totalGoldEarned.toLocaleString()}G\nüí∏ ÎèÑÎßù Ìå®ÎÑêÌã∞: -${goldLoss.toLocaleString()}G\n${netResult >= 0 ? 'üìà' : 'üìâ'} ÏµúÏ¢Ö: ${netResult >= 0 ? '+' : ''}${netResult.toLocaleString()}G\n\nÏ†ïÎßê ÎèÑÎßùÏπòÏãúÍ≤†ÏäµÎãàÍπå?`
                : `ÎèÑÎßùÏπòÎ©¥ Í≥®ÎìúÏùò ${penaltyPercent}%Î•º ÏûÉÏäµÎãàÎã§.\n\nüí∞ ÏÇ¨ÎÉ• ÌöçÎìù: +${huntState.totalGoldEarned.toLocaleString()}G\nüí∏ ÎèÑÎßù Ìå®ÎÑêÌã∞: -${goldLoss.toLocaleString()}G\n${netResult >= 0 ? 'üìà' : ''}ÏµúÏ¢Ö: ${netResult >= 0 ? '+' : ''}${netResult.toLocaleString()}G\n\nÏ†ïÎßê ÎèÑÎßùÏπòÏãúÍ≤†ÏäµÎãàÍπå?`;
            
            if (!confirm(warningMsg)) return;
            
            // ÏÇ¨ÎÉ• Í≥®Îìú Ï†ïÏÇ∞ ÌõÑ ÌéòÎÑêÌã∞ Ï†ÅÏö©
            state.gold = Math.max(0, totalGoldAfterEarned - goldLoss);
            // Ï†ÄÏ£º Ìä∏Î¶¨Í±∞: Ïó∞ÏÜç ÎèÑÎßù 5Ìöå
            state.consecutiveFlees = (state.consecutiveFlees || 0) + 1;
            saveState();
            
            playSound('fail');
            vibrate(100);
            
            // Show result and exit
            const popup = document.getElementById('resultPopup');
            const overlay = document.getElementById('overlay');
            
            popup.className = 'result-popup fail show';
            document.getElementById('resultIcon').textContent = 'üèÉ';
            document.getElementById('resultText').textContent = 'ÎèÑÎßù ÏÑ±Í≥µ!';
            document.getElementById('resultText').style.color = 'var(--muted)';
            const netGold = huntState.totalGoldEarned - goldLoss;
            document.getElementById('resultDetail').innerHTML = `
                ${huntState.totalGoldEarned > 0 ? `üí∞ ÏÇ¨ÎÉ• ÌöçÎìù: +${huntState.totalGoldEarned.toLocaleString()}G<br>` : ''}
                üí∏ ÎèÑÎßù Ìå®ÎÑêÌã∞: -${goldLoss.toLocaleString()}G<br>
                <span style="color:${netGold >= 0 ? 'var(--success)' : 'var(--fail)'};font-weight:bold;">
                    ${netGold >= 0 ? 'üìà' : 'üìâ'} ÏµúÏ¢Ö: ${netGold >= 0 ? '+' : ''}${netGold.toLocaleString()}G
                </span><br>
                <span style="color:var(--muted);font-size:0.9em">
                    Ï≤òÏπò: ${huntState.monstersKilled}ÎßàÎ¶¨
                </span>
            `;
            document.getElementById('newWeaponPreview').style.display = 'none';
            document.getElementById('resultBtn').textContent = 'Î©îÏù∏ÏúºÎ°ú';
            document.getElementById('resultBtn').onclick = () => {
                closeResult();
                huntState = null;
                // üëø ÎèÑÎßù ÌõÑ Ï†ÄÏ£º Ï≤¥ÌÅ¨ (ÌåùÏóÖ Ï†ÑÌôò ÎîúÎ†àÏù¥)
                setTimeout(() => {
                    if (checkCurseTrigger('flee')) return;
                    showMain();
                }, 350);
            };
            
            overlay.classList.add('show');
        }

        function showCritEffect() {
            const crit = document.createElement('div');
            crit.className = 'crit-text';
            crit.textContent = 'üí• CRITICAL!';
            document.body.appendChild(crit);
            setTimeout(() => crit.remove(), 800);
        }
        
        // Ïä¨ÎûòÏãú Ìö®Í≥º ÌëúÏãú (target: 'monster' = Î™¨Ïä§ÌÑ∞ ÏòÅÏó≠, 'player' = ÌîåÎ†àÏù¥Ïñ¥ ÏòÅÏó≠)
        function showSlashEffect(type = 'single', target = 'monster') {
            const container = document.createElement('div');
            container.className = 'slash-container';
            
            // ÌÉÄÍ≤üÏóê Îî∞Îùº ÏúÑÏπò Ï°∞Ï†ï
            if (target === 'monster') {
                container.style.top = '28%';  // ÌôîÎ©¥ ÏÉÅÎã® (Î™¨Ïä§ÌÑ∞ ÏòÅÏó≠)
            } else if (target === 'player') {
                container.style.top = '68%';  // ÌôîÎ©¥ ÌïòÎã® (ÌîåÎ†àÏù¥Ïñ¥ ÏòÅÏó≠)
            }
            
            const slash = document.createElement('div');
            if (type === 'crit') {
                slash.className = 'slash-crit';
            } else if (type === 'claw') {
                slash.className = 'slash-claw';
            } else if (type === 'punch') {
                slash.className = 'slash-punch';
            } else if (type === 'arrow') {
                slash.className = 'slash-arrow';
            } else if (type === 'magic') {
                // üßô ÎßàÎ≤ï Î¨¥Í∏∞: ÏÜçÏÑ± Ïù¥ÌéôÌä∏
                const elem = state.weapon?.element || 'none';
                const elemData = ELEMENTS[elem] || ELEMENTS.none;
                slash.innerHTML = `<span style="font-size:4rem;text-shadow:0 0 30px ${elemData.color};">${elemData.icon}</span>`;
                slash.style.cssText = 'display:flex;justify-content:center;align-items:center;width:100%;height:100%;animation:magicAttack 0.5s ease-out forwards;';
            } else {
                slash.className = 'slash-single';
            }
            
            container.appendChild(slash);
            document.body.appendChild(container);
            
            // ÌéÄÏπòÎäî Îëê Î≤à ÏπòÎãàÍπå Îçî Ïò§Îûò
            const duration = (type === 'punch') ? 600 : (type === 'magic' ? 700 : 500);
            setTimeout(() => container.remove(), duration);
        }
        
        // üßô ÎßàÎ≤ï Ïù¥ÌéôÌä∏ ÌëúÏãú
        function showMagicEffect(element) {
            const elementData = ELEMENTS[element];
            if (!elementData) return;
            
            const effect = document.createElement('div');
            effect.className = `magic-effect ${element}`;
            effect.textContent = elementData.icon;
            effect.style.textShadow = `0 0 30px ${elementData.color}, 0 0 60px ${elementData.color}`;
            document.body.appendChild(effect);
            
            setTimeout(() => effect.remove(), 1000);
        }
        
        // üßô ÎßàÎ≤ï ÌÅ¨Î¶¨Ìã∞Ïª¨ Ìö®Í≥º Ï≤òÎ¶¨ (ÏÇ¨ÎÉ•Ïö©)
        // Î∞òÌôò: { extraDamage, healAmount, statusEffect, instantKill }
        function applyMagicCritEffect(element, damage, monster, player) {
            const result = { extraDamage: 0, healAmount: 0, statusEffect: null, instantKill: false, logText: '' };
            
            if (!isMagicWeapon(state.weapon)) return result;
            
            const elementData = ELEMENTS[element];
            if (!elementData?.magicEffect) return result;
            
            showMagicEffect(element);
            
            switch (elementData.magicEffect) {
                case 'explosion':  // üî• Î∂à: Ìè≠Î∞ú Îç∞ÎØ∏ÏßÄ (+50%)
                    result.extraDamage = Math.floor(damage * 0.5);
                    result.logText = `üî• Ìè≠Î∞ú! +${result.extraDamage} Ï∂îÍ∞Ä Îç∞ÎØ∏ÏßÄ!`;
                    break;
                    
                case 'freeze':  // ‚ùÑÔ∏è ÏñºÏùå: ÎπôÍ≤∞ (Ï†Å ÌÑ¥ Ïä§ÌÇµ)
                    result.statusEffect = 'frozen';
                    huntState.monsterFrozen = true;  // Îã§Ïùå ÌÑ¥ Ïä§ÌÇµ
                    result.logText = `‚ùÑÔ∏è ÎπôÍ≤∞! Ï†Å Í≥µÍ≤© Î¨¥Ìö®Ìôî!`;
                    break;
                    
                case 'shock':  // ‚ö° Î≤àÍ∞ú: Í∞êÏ†Ñ Îç∞ÎØ∏ÏßÄ (+30%)
                    result.extraDamage = Math.floor(damage * 0.3);
                    result.logText = `‚ö° Í∞êÏ†Ñ! +${result.extraDamage} Ï∂îÍ∞Ä Îç∞ÎØ∏ÏßÄ!`;
                    break;
                    
                case 'heal':  // üíß Î¨º: ÌöåÎ≥µ (20% HP)
                    result.healAmount = Math.floor(player.maxHp * 0.2);
                    result.logText = `üíß ÏπòÏú†! +${result.healAmount} HP ÌöåÎ≥µ!`;
                    break;
                    
                case 'dot':  // ‚ò†Ô∏è ÎèÖ: ÏßÄÏÜç Îç∞ÎØ∏ÏßÄ
                    huntState.monsterPoisoned = 3;  // 3ÌÑ¥ ÏßÄÏÜç
                    huntState.poisonDamage = Math.floor(damage * 0.2);  // ÌÑ¥Îãπ 20%
                    result.logText = `‚ò†Ô∏è ÎßπÎèÖ! 3ÌÑ¥Í∞Ñ ${huntState.poisonDamage} ÏßÄÏÜç Îç∞ÎØ∏ÏßÄ!`;
                    break;
                    
                case 'smite':  // ‚ú® Ïã†ÏÑ±: Ïñ∏Îç∞Îìú Ï¶âÏÇ¨
                    if (monster.type === 'undead') {
                        result.instantKill = true;
                        result.logText = `‚ú® Ïã†ÏÑ±Ìïú Ïã¨Ìåê! Ïñ∏Îç∞Îìú Ï¶âÏÇ¨!`;
                    } else {
                        result.extraDamage = Math.floor(damage * 0.25);
                        result.logText = `‚ú® Ïã†ÏÑ± Îç∞ÎØ∏ÏßÄ! +${result.extraDamage}!`;
                    }
                    break;
            }
            
            return result;
        }
        
        // Î¨¥Í∏∞ ÌöçÎìù Ïù¥ÌéôÌä∏
        // reason: 'monster_death', 'durability_break', 'enhance_destroy'
        // context: { monsterName, monsterType, weaponLevel }
        function showWeaponAcquireEffect(newWeapon, reason, context = {}) {
            const gradeData = GRADES[newWeapon.grade];
            const elementData = ELEMENTS[newWeapon.element] || ELEMENTS.none;
            
            // ÌöçÎìù Ïù¥Ïú† ÌÖçÏä§Ìä∏
            let reasonText = '';
            if (reason === 'monster_death') {
                const typeData = MONSTER_TYPES[context.monsterType];
                reasonText = `üíÄ ${context.monsterName || 'Î™¨Ïä§ÌÑ∞'}ÏóêÍ≤å Ìå®Î∞∞<br>`;
                if (newWeapon.element === 'lifesteal') {
                    reasonText += `${elementData.icon} <span style="color:${elementData.color}">${elementData.name}</span> ÏÜçÏÑ± Ìù°Ïàò!<br><span style="font-size:0.85rem;opacity:0.8;">Í≥µÍ≤© Îç∞ÎØ∏ÏßÄÏùò 15% HP ÌöåÎ≥µ</span>`;
                } else if (newWeapon.element && newWeapon.element !== 'none' && typeData) {
                    reasonText += `${typeData.icon} ${typeData.name}Ïùò Ï∑®ÏïΩ ÏÜçÏÑ± ${elementData.icon} <span style="color:${elementData.color}">${elementData.name}</span> Î∂ÄÏó¨!`;
                }
            } else if (reason === 'durability_break') {
                reasonText = `üîß ÎÇ¥Íµ¨ÎèÑ ÌååÍ¥¥!<br>`;
                if (newWeapon.element && newWeapon.element !== 'none') {
                    reasonText += `ÏàôÎ†®ÎèÑ Î≥¥ÏÉÅÏúºÎ°ú ${elementData.icon} <span style="color:${elementData.color}">${elementData.name}</span> ÏÜçÏÑ±!`;
                } else {
                    reasonText += `ÏµúÍ≥†Í∏â Î¨¥Í∏∞ Î≥¥ÏÉÅ!`;
                }
            } else if (reason === 'enhance_destroy') {
                if (context.weaponLevel >= 7) {
                    reasonText = `üí• +${context.weaponLevel} Í∞ïÌôî ÌååÍ¥¥!<br>Í≥†Í∞ïÌôî Î≥¥ÏÉÅÏúºÎ°ú Í≥†Í∏â Î¨¥Í∏∞ ÌöçÎìù!`;
                } else {
                    reasonText = `üí• +${context.weaponLevel} Í∞ïÌôî ÌååÍ¥¥`;
                }
            } else if (reason === 'pvp_loss') {
                const enemyGradeData = GRADES[context.enemyGrade] || GRADES.common;
                reasonText = `‚öîÔ∏è PvP Ìå®Î∞∞! Î¨¥Í∏∞ ÌååÍ¥¥<br>`;
                reasonText += `ÏÉÅÎåÄ [${enemyGradeData.name}] Îì±Í∏âÎ≥¥Îã§ Ï¢ãÏùÄ Î¨¥Í∏∞ Î≥¥ÏÉÅ!<br>`;
                if (newWeapon.element && newWeapon.element !== 'none') {
                    reasonText += `${elementData.icon} <span style="color:${elementData.color}">${elementData.name}</span> ÏÜçÏÑ± Î∂ÄÏó¨!`;
                }
            }
            
            // Ïò§Î≤ÑÎ†àÏù¥ ÏÉùÏÑ±
            const overlay = document.createElement('div');
            overlay.className = 'weapon-acquire-overlay';
            overlay.innerHTML = `
                <div class="weapon-acquire-title">${reason === 'enhance_destroy' ? 'ÏÉàÎ°úÏö¥ Î¨¥Í∏∞!' : 'Î¨¥Í∏∞ ÌöçÎìù!'}</div>
                <div class="weapon-acquire-card ${newWeapon.grade}">
                    <div style="font-size:0.8rem;color:${gradeData.color};text-transform:uppercase;letter-spacing:2px;margin-bottom:8px;">${gradeData.name}</div>
                    <img src="${getWeaponIcon(newWeapon)}" style="width:100px;height:100px;filter:drop-shadow(0 0 20px ${gradeData.color});">
                    <div style="font-size:1.3rem;font-weight:700;margin-top:12px;">
                        ${newWeapon.name}
                        ${newWeapon.element && newWeapon.element !== 'none' ? `<span style="margin-left:6px;">${elementData.icon}</span>` : ''}
                    </div>
                    <div style="color:var(--muted);font-size:0.9rem;margin-top:4px;">${WEAPON_TYPES[newWeapon.type].name}</div>
                    ${newWeapon.element && newWeapon.element !== 'none' ? `
                        <div style="margin-top:12px;padding:8px 16px;background:rgba(255,255,255,0.1);border-radius:20px;display:inline-block;">
                            ${elementData.icon} <span style="color:${elementData.color}">${elementData.name}</span> ÏÜçÏÑ±
                        </div>
                    ` : ''}
                </div>
                <div class="weapon-acquire-reason">${reasonText}</div>
                <button class="weapon-acquire-btn" onclick="this.parentElement.remove(); showEnhance();">ÌôïÏù∏</button>
            `;
            
            document.body.appendChild(overlay);
            
            // Ï†ÑÏÑ§/Ïú†ÎãàÌÅ¨Îäî Ïª®ÌéòÌã∞
            if (newWeapon.grade === 'legendary' || newWeapon.grade === 'unique') {
                setTimeout(() => fireConfetti(), 300);
            }
            
            playSound('success');
            vibrate([50, 50, 100]);
        }
        
        function showMasteryDetail() {
            const weapon = state.weapon;
            const mastery = weapon.weaponMastery || { attacks: 0, crits: 0, kills: 0, killsByType: {} };
            const level = getWeaponMasteryLevel(weapon);
            const bonus = getWeaponMasteryBonus(weapon);
            const nextLevelAt = (level + 1) * 100;
            const progress = mastery.attacks % 100;
            
            // Ï≤òÏπò Ï†ïÎ≥¥
            let killsHtml = '';
            if (Object.keys(mastery.killsByType).length > 0) {
                killsHtml = '<div style="margin-top:12px;"><strong>Ï≤òÏπò Í∏∞Î°ù:</strong><div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;">';
                for (const [type, count] of Object.entries(mastery.killsByType)) {
                    const typeData = MONSTER_TYPES[type];
                    if (typeData && count > 0) {
                        killsHtml += `<span style="background:rgba(255,255,255,0.1);padding:4px 8px;border-radius:6px;">${typeData.icon} ${typeData.name}: ${count}</span>`;
                    }
                }
                killsHtml += '</div></div>';
            }
            
            const popup = document.getElementById('resultPopup');
            const overlay = document.getElementById('overlay');
            
            popup.className = 'result-popup show';
            popup.style.border = '2px solid var(--success)';
            document.getElementById('resultIcon').textContent = 'üìà';
            document.getElementById('resultText').textContent = `ÏàôÎ†®ÎèÑ Lv.${level}`;
            document.getElementById('resultText').style.color = 'var(--success)';
            document.getElementById('resultDetail').innerHTML = `
                <div style="text-align:left;font-size:0.9rem;">
                    <div style="margin-bottom:8px;">
                        <strong>Í≥µÍ≤©Î†• Î≥¥ÎÑàÏä§:</strong> <span style="color:var(--success)">+${bonus}%</span>
                    </div>
                    <div style="background:rgba(255,255,255,0.1);border-radius:8px;height:12px;margin:8px 0;overflow:hidden;">
                        <div style="width:${progress}%;height:100%;background:var(--success);transition:width 0.3s;"></div>
                    </div>
                    <div style="font-size:0.8rem;color:var(--muted);">Îã§Ïùå Î†àÎ≤®ÍπåÏßÄ: ${progress}/100 Í≥µÍ≤©</div>
                    <hr style="border:none;border-top:1px solid rgba(255,255,255,0.1);margin:12px 0;">
                    <div><strong>Ï¥ù Í≥µÍ≤©:</strong> ${mastery.attacks.toLocaleString()}Ìöå</div>
                    <div><strong>ÌÅ¨Î¶¨Ìã∞Ïª¨:</strong> ${mastery.crits.toLocaleString()}Ìöå (${mastery.attacks > 0 ? ((mastery.crits / mastery.attacks) * 100).toFixed(1) : 0}%)</div>
                    <div><strong>Ï¥ù Ï≤òÏπò:</strong> ${mastery.kills.toLocaleString()}ÎßàÎ¶¨</div>
                    ${killsHtml}
                </div>
            `;
            document.getElementById('newWeaponPreview').style.display = 'none';
            document.getElementById('resultBtn').onclick = () => {
                closeResult();
                popup.style.border = '';
            };
            
            overlay.classList.add('show');
        }
        
        function showLuckyDrawEffect(goldAmount) {
            // Ìô©Í∏àÎπõ ÌîåÎûòÏãú
            const flash = document.createElement('div');
            flash.className = 'lucky-flash';
            document.body.appendChild(flash);
            setTimeout(() => flash.remove(), 500);
            
            // Îü≠ÌÇ§ÎìúÎ°úÏö∞ ÌÖçÏä§Ìä∏
            const luckyText = document.createElement('div');
            luckyText.className = 'lucky-text-big';
            luckyText.innerHTML = 'üé∞ LUCKY DRAW! üé∞';
            document.body.appendChild(luckyText);
            
            // Í≥®Îìú ÌëúÏãú
            const goldText = document.createElement('div');
            goldText.className = 'lucky-gold-amount';
            goldText.innerHTML = `üí∞ +${goldAmount.toLocaleString()}G`;
            document.body.appendChild(goldText);
            
            // Ìô©Í∏à ÏΩîÏù∏ ÏÉ§Ïõå
            const shower = document.createElement('div');
            shower.className = 'gold-shower';
            for (let i = 0; i < 30; i++) {
                const coin = document.createElement('div');
                coin.className = 'gold-coin';
                coin.style.left = Math.random() * 100 + '%';
                coin.style.animationDelay = Math.random() * 0.5 + 's';
                coin.textContent = Math.random() > 0.5 ? 'üí∞' : 'ü™ô';
                shower.appendChild(coin);
            }
            document.body.appendChild(shower);
            
            // Ï†ïÎ¶¨
            setTimeout(() => {
                luckyText.remove();
                goldText.remove();
                shower.remove();
            }, 2500);
        }

        let huntAttackCooldown = false;
        
        function huntAttack() {
            if (!huntState) return;
            if (huntAttackCooldown) return;  // Îî∞Îã• Î∞©ÏßÄ
            
            huntAttackCooldown = true;
            setTimeout(() => { huntAttackCooldown = false; }, 400);  // 0.4Ï¥à Ïø®Îã§Ïö¥
            
            const player = huntState.player;
            const monster = huntState.monster;
            
            // ÎÇ¥Íµ¨ÎèÑ Ï≤¥ÌÅ¨ - 0Ïù¥Î©¥ Î¨¥Í∏∞ ÌååÍ¥¥!
            if ((state.weapon.durability ?? 100) <= 0) {
                if (true) {  // ÎÇ¥Íµ¨ÎèÑ 0 = Î¨¥Ï°∞Í±¥ ÌååÍ¥¥
                    // üëø Ï†ÄÏ£ºÎ∞õÏùÄ Î¨¥Í∏∞: Ï†Å Ï¶âÏÇ¨!
                    if (isCursed(state.weapon)) {
                        monster.currentHp = 0;
                        
                        playSound('crit');
                        vibrate([100, 50, 100, 50, 100, 50, 200]);
                        document.body.classList.add('screen-shake');
                        setTimeout(() => document.body.classList.remove('screen-shake'), 800);
                        showCritEffect();
                        fireConfetti();
                        
                        huntState.log.push({ type: 'crit', text: `üëøüí• Ï†ÄÏ£ºÏùò Ìè≠Î∞ú!! ${monster.name} Ï¶âÏÇ¨!!` });
                        
                        // Ï†ÄÏ£º Ìï¥Ï†ú + ÏÉà Î¨¥Í∏∞
                        const oldWeapon = state.weapon;
                        addDestroyedWeaponRecord(oldWeapon, 'durability_break', huntState?.monstersKilled || 0);
                        state.weapon = generateWeaponBySource('durability_break', {});
                        resetMastery();
                        state.bossKills = 0;
                        state.bossTypeKills = { dragon: 0, demon: 0, undead: 0, elemental: 0 };
                        saveState();
                        
                        setTimeout(() => {
                            showWeaponAcquireEffect(state.weapon, 'durability_break', {});
                        }, 500);
                        
                        huntMonsterKilled(false);
                        return;
                    }
                    
                    // Î¨¥Í∏∞ ÌååÍ¥¥! ÏñëÏ™Ω Îç∞ÎØ∏ÏßÄ
                    const breakDamage = Math.floor(player.maxHp * 0.3);
                    player.hp = Math.max(0, player.hp - breakDamage);
                    monster.currentHp = Math.max(0, monster.currentHp - breakDamage);
                    
                    playSound('destroy');
                    vibrate([200, 100, 200, 100, 300]);
                    document.body.classList.add('screen-shake');
                    setTimeout(() => document.body.classList.remove('screen-shake'), 500);
                    
                    huntState.log.push({ type: 'crit', text: `üí• Î¨¥Í∏∞Í∞Ä Ï†ÑÌà¨ Ï§ë ÌååÍ¥¥ÎêòÏóàÏäµÎãàÎã§! ÏñëÏ™Ω ${breakDamage} Îç∞ÎØ∏ÏßÄ!` });
                    
                    // ÏÉà Î¨¥Í∏∞ ÏßÄÍ∏â (ÎÇ¥Íµ¨ÎèÑ ÌååÍ¥¥ = ÏàôÎ†®ÎèÑ Í∏∞Î∞ò ÏÜçÏÑ±!)
                    const oldWeapon = state.weapon;
                    addDestroyedWeaponRecord(oldWeapon, 'durability_break', huntState?.monstersKilled || 0);
                    state.weapon = generateWeaponBySource('durability_break', {});
                    resetMastery();  // Î¨¥Í∏∞ Î≥ÄÍ≤Ω Ïãú ÏàôÎ†®ÎèÑ Ï¥àÍ∏∞Ìôî
                    state.bossKills = 0;
                    state.bossTypeKills = { dragon: 0, demon: 0, undead: 0, elemental: 0 };
                    const newStats = getWeaponStats(state.weapon, false);
                    // ÏÉà Î¨¥Í∏∞ Ïä§ÌÉØÏúºÎ°ú Ï†ÑÏ≤¥ ÏóÖÎç∞Ïù¥Ìä∏
                    player.damageMin = newStats.damageMin;
                    player.damageMax = newStats.damageMax;
                    player.critChance = newStats.critChance;
                    player.critDamage = newStats.critDamage;
                    player.maxHp = newStats.hp;
                    player.hp = Math.min(player.hp, player.maxHp);  // HPÎäî ÏµúÎåÄÏπò Ï¥àÍ≥º Î∞©ÏßÄ
                    saveState();
                    
                    // Î¨¥Í∏∞ ÌöçÎìù Ïù¥ÌéôÌä∏
                    setTimeout(() => {
                        showWeaponAcquireEffect(state.weapon, 'durability_break', {});
                    }, 500);
                    
                    if (player.hp <= 0) {
                        huntPlayerDied();
                        return;
                    }
                    if (monster.currentHp <= 0) {
                        huntMonsterKilled();
                        return;
                    }
                    renderHunt();
                    return;
                }
            }
            
            // üëä ÎÑàÌÅ¥ Ï≤¥ÌÅ¨ (2Ìöå Í≥µÍ≤©, ÏàôÎ†®ÎèÑ 2Î∞∞)
            const isKnuckle = state.weapon.type === 'knuckle';
            
            // Í∏ÄÎ°úÎ≤å ÏàôÎ†®ÎèÑ Ï¶ùÍ∞Ä (ÎÑàÌÅ¥ÏùÄ 2Ìöå Í≥µÍ≤©Ïù¥Îùº 2Î∞∞!)
            const masteryGain = isKnuckle ? 2 : 1;
            state.mastery.attacks += masteryGain;
            
            // Î¨¥Í∏∞Î≥Ñ ÏàôÎ†®ÎèÑ Ï¶ùÍ∞Ä
            if (!state.weapon.weaponMastery) {
                state.weapon.weaponMastery = { attacks: 0, crits: 0, kills: 0, killsByType: {} };
            }
            state.weapon.weaponMastery.attacks += masteryGain;
            
            // ÎÇ¥Íµ¨ÎèÑ Í∞êÏÜå (Îì±Í∏âÎ≥Ñ Ï∞®Îì± Ï†ÅÏö©)
            // Í∏∞Ï§Ä: Ìù¨Í∑Ä(rare) = 10ÌÉÄÎãπ 1% Í∞êÏÜå (2Î∞∞ Îπ†Î•¥Í≤å Ï°∞Ï†ï)
            // ÏùºÎ∞ò: 5ÌÉÄÎãπ 1%, Í≥†Í∏â: 7ÌÉÄÎãπ 1%, Ï†ÑÏÑ§: 14ÌÉÄÎãπ 1%, Ïú†ÎãàÌÅ¨: 20ÌÉÄÎãπ 1%, Ïã†Ìôî: 33ÌÉÄÎãπ 1%
            if (!state.weapon._durabilityCounter) state.weapon._durabilityCounter = 0;
            state.weapon._durabilityCounter++;
            const gradeData = GRADES[state.weapon.grade] || GRADES.rare;
            let durabilityMod = gradeData.durabilityMod || 1.0;
            // Ïú†Î¶¨Í≤Ä: ÎÇ¥Íµ¨ÎèÑ 3Î∞∞ Îπ†Î•¥Í≤å Í∞êÏÜå!
            if (isGlassSword(state.weapon)) durabilityMod *= 3;
            const durabilityThreshold = Math.floor(10 / durabilityMod);  // ÎÇÆÏùÑÏàòÎ°ù Îπ®Î¶¨ Í∞êÏÜå
            if (state.weapon._durabilityCounter >= durabilityThreshold) {
                state.weapon._durabilityCounter = 0;
                state.weapon.durability = Math.max(0, (state.weapon.durability || 100) - 1);
                
                // üëø Ï†ÄÏ£ºÎ∞õÏùÄ Î¨¥Í∏∞: ÎÇ¥Íµ¨ÎèÑ 1 Í∞êÏÜåÎßàÎã§ Ï†Å Ï¶âÏÇ¨!
                if (isCursed(state.weapon) && monster.currentHp > 0) {
                    monster.currentHp = 0;
                    playSound('crit');
                    vibrate([100, 50, 100]);
                    showCritEffect();
                    huntState.log.push({ type: 'crit', text: `üëø Ï†ÄÏ£ºÏùò Ìûò! ÎÇ¥Íµ¨ÎèÑ ÏÜåÎ™® ‚Üí ${monster.name} Ï¶âÏÇ¨!` });
                    saveState();
                    huntMonsterKilled(false);
                    return;
                }
            }
            
            // ÏÜçÏÑ± Î∞∞Ïú® Í≥ÑÏÇ∞
            const weaponElement = state.weapon.element || 'none';
            const elementMult = getElementMultiplier(weaponElement, monster.type);
            const superCrit = checkSuperCritical(state.weapon);  // Ïã†Ìôî Î¨¥Í∏∞ 1% Ï¶âÏÇ¨Í∏∞
            
            // üëä ÎÑàÌÅ¥: 2Ìöå ÎèÖÎ¶Ω Í≥µÍ≤© (Í∞ÅÍ∞Å ÌÅ¨Î¶¨Ìã∞Ïª¨ ÌåêÏ†ï)
            let finalPlayerDamage = 0;
            let playerCrit = false;
            let knuckleCrits = 0;  // ÎÑàÌÅ¥ ÌÅ¨Î¶¨ ÌöüÏàò
            
            if (isKnuckle) {
                // 2Ìöå ÎèÖÎ¶Ω Í≥µÍ≤©
                for (let hit = 0; hit < 2; hit++) {
                    const hitDamage = Math.floor(Math.random() * (player.damageMax - player.damageMin + 1)) + player.damageMin;
                    const hitCrit = window.debugCritMode || (Math.random() * 100 < player.critChance);
                    let hitFinal = hitCrit ? Math.floor(hitDamage * player.critDamage / 100) : hitDamage;
                    hitFinal = Math.floor(hitFinal * elementMult);
                    finalPlayerDamage += hitFinal;
                    if (hitCrit) {
                        knuckleCrits++;
                        playerCrit = true;  // ÌïòÎÇòÎùºÎèÑ ÌÅ¨Î¶¨Î©¥ ÌÅ¨Î¶¨ Ï≤òÎ¶¨
                        state.weapon.weaponMastery.crits++;
                    }
                }
            } else {
                // ÏùºÎ∞ò Î¨¥Í∏∞: 1Ìöå Í≥µÍ≤©
                const playerDamage = Math.floor(Math.random() * (player.damageMax - player.damageMin + 1)) + player.damageMin;
                playerCrit = window.debugCritMode || (Math.random() * 100 < player.critChance);
                let baseDamage = playerCrit ? Math.floor(playerDamage * player.critDamage / 100) : playerDamage;
                
                // ÏäàÌçºÌÅ¨Î¶¨Ìã∞Ïª¨: Ï¶âÏÇ¨!
                if (superCrit) {
                    baseDamage = monster.currentHp;
                }
                
                finalPlayerDamage = Math.floor(baseDamage * elementMult);
            }
            
            // Îü≠ÌÇ§ÎìúÎ°úÏö∞Ïö©: Í≥µÍ≤© Ï†Ñ ÌíÄÌîºÏòÄÎäîÏßÄ Ï†ÄÏû•
            const wasAtFullHp = (monster.currentHp === monster.maxHp);
            
            monster.currentHp = Math.max(0, monster.currentHp - finalPlayerDamage);
            
            // Ìù°Ìòà ÏÜçÏÑ± Ìö®Í≥º - Îç∞ÎØ∏ÏßÄÏùò 15% ÌöåÎ≥µ
            let lifestealHeal = 0;
            if (weaponElement === 'lifesteal') {
                lifestealHeal = Math.floor(finalPlayerDamage * 0.15);
                const oldHp = player.hp;
                player.hp = Math.min(player.maxHp, player.hp + lifestealHeal);
                lifestealHeal = player.hp - oldHp;  // Ïã§Ï†ú ÌöåÎ≥µÎüâ
            }
            
            playSound(playerCrit ? 'crit' : 'attack');
            vibrate(playerCrit ? [50, 30, 100] : 50);
            
            // ÏÜçÏÑ± Ìö®Í≥º ÌÖçÏä§Ìä∏
            const lifestealText = lifestealHeal > 0 ? ` ü©∏+${lifestealHeal} Ìù°Ìòà!` : '';
            const elementText = (elementMult > 1 ? ` üéØÌö®Í≥ºÏ†Å!` : (elementMult < 1 ? ` üõ°Ô∏èÏ†ÄÌï≠...` : '')) + lifestealText;
            
            // Î¨¥Í∏∞ ÌÉÄÏûÖÎ≥Ñ Í≥µÍ≤© Ïù¥ÌéôÌä∏ Í≤∞Ï†ï
            const weaponType = state.weapon.type;
            const getAttackEffect = (isCrit) => {
                if (isKnuckle) return 'punch';  // üëä ÎçîÎ∏îÌéÄÏπò
                if (weaponType === 'bow' || weaponType === 'crossbow') return 'arrow';  // üèπ ÌôîÏÇ¥
                if (weaponType === 'staff' || weaponType === 'wand') return 'magic';  // üßô ÎßàÎ≤ï
                return isCrit ? 'crit' : 'single';
            };
            
            if (superCrit) {
                // üåü ÏäàÌçºÌÅ¨Î¶¨Ìã∞Ïª¨! Ïã†Ìôî Î¨¥Í∏∞ Ï¶âÏÇ¨Í∏∞!
                state.weapon.weaponMastery.crits++;
                state.weapon.durability = Math.max(0, (state.weapon.durability || 100) - 50);
                
                playSound('crit');
                vibrate([100, 50, 100, 50, 100, 50, 200]);
                showSlashEffect(getAttackEffect(true), 'monster');
                showCritEffect();
                fireConfetti();  // Ï∂ïÌïò Ìö®Í≥º!
                document.body.classList.add('screen-shake');
                setTimeout(() => document.body.classList.remove('screen-shake'), 500);
                
                huntState.log.push({ type: 'crit', text: `üåü ÏäàÌçºÌÅ¨Î¶¨Ìã∞Ïª¨!! ${monster.name} Ï¶âÏÇ¨! (ÎÇ¥Íµ¨ÎèÑ -50)` });
                
            } else if (playerCrit) {
                // ÌÅ¨Î¶¨ Í∏∞Î°ù (ÎÑàÌÅ¥ÏùÄ Ïù¥ÎØ∏ Î£®ÌîÑÏóêÏÑú Í∏∞Î°ùÌï®)
                if (!isKnuckle) {
                    state.weapon.weaponMastery.crits++;
                }
                
                // Ïù¥Ïë§ÏãúÍ∞ú: ÌÅ¨Î¶¨Ìã∞Ïª¨ ÌÑ∞ÏßÄÎ©¥ ÎÇ¥Íµ¨ÎèÑ -50!
                if (isToothpick(state.weapon)) {
                    state.weapon.durability = Math.max(0, (state.weapon.durability || 100) - 50);
                    huntState.log.push({ type: 'warning', text: `ü™• Ïù¥Ïë§ÏãúÍ∞úÍ∞Ä Î∂ÄÎü¨Ïßà Í≤É Í∞ôÎã§! (ÎÇ¥Íµ¨ÎèÑ -50)` });
                }
                
                // üßô ÎßàÎ≤ï Î¨¥Í∏∞ ÌÅ¨Î¶¨Ìã∞Ïª¨ Ìö®Í≥º!
                const magicEffect = applyMagicCritEffect(weaponElement, finalPlayerDamage, monster, player);
                if (magicEffect.extraDamage > 0) {
                    monster.currentHp = Math.max(0, monster.currentHp - magicEffect.extraDamage);
                }
                if (magicEffect.healAmount > 0) {
                    player.hp = Math.min(player.maxHp, player.hp + magicEffect.healAmount);
                }
                if (magicEffect.instantKill) {
                    monster.currentHp = 0;
                }
                if (magicEffect.logText) {
                    huntState.log.push({ type: 'crit', text: magicEffect.logText });
                }
                
                showSlashEffect(getAttackEffect(true), 'monster');
                showCritEffect();
                document.body.classList.add('screen-shake');
                setTimeout(() => document.body.classList.remove('screen-shake'), 300);
                
                // üëä ÎÑàÌÅ¥: ÎçîÎ∏î/Ïã±Í∏Ä ÌÅ¨Î¶¨Ìã∞Ïª¨ ÌëúÏãú
                if (isKnuckle) {
                    const critText = knuckleCrits === 2 ? 'üí•üí• ÎçîÎ∏î ÌÅ¨Î¶¨Ìã∞Ïª¨!' : 'üí• ÌÅ¨Î¶¨Ìã∞Ïª¨!';
                    huntState.log.push({ type: 'crit', text: `${critText} ${finalPlayerDamage} Îç∞ÎØ∏ÏßÄ! (2Ìöå ÌÉÄÍ≤©)${elementText}` });
                } else {
                    huntState.log.push({ type: 'crit', text: `üí• ÌÅ¨Î¶¨Ìã∞Ïª¨! ${finalPlayerDamage} Îç∞ÎØ∏ÏßÄ!${elementText}` });
                }
            } else {
                showSlashEffect(getAttackEffect(false), 'monster');
                const hitSuffix = isKnuckle ? ' (2Ìöå ÌÉÄÍ≤©)' : '';
                if (elementMult > 1) {
                    huntState.log.push({ type: 'crit', text: `${ELEMENTS[weaponElement]?.icon || '‚öîÔ∏è'} ${finalPlayerDamage} Îç∞ÎØ∏ÏßÄ! Ìö®Í≥ºÏ†Å!${hitSuffix}` });
                } else if (elementMult < 1) {
                    huntState.log.push({ type: 'damage', text: `‚öîÔ∏è ${finalPlayerDamage} Îç∞ÎØ∏ÏßÄ... (Ï†ÄÌï≠)${hitSuffix}` });
                } else {
                    huntState.log.push({ type: 'damage', text: `${isKnuckle ? 'üëä' : '‚öîÔ∏è'} ${finalPlayerDamage} Îç∞ÎØ∏ÏßÄ!${hitSuffix}` });
                }
            }
            
            saveState(); // ÏàôÎ†®ÎèÑ, ÎÇ¥Íµ¨ÎèÑ Ï†ÄÏû•
            
            // Check if monster is dead
            if (monster.currentHp <= 0) {
                // Îü≠ÌÇ§ÎìúÎ°úÏö∞ Ï°∞Í±¥: ÌíÄÌîº ÏÉÅÌÉúÏóêÏÑú ÌÅ¨Î¶¨Ìã∞Ïª¨ ÌïúÎ∞©ÌÇ¨!
                const isLuckyEligible = wasAtFullHp && playerCrit;
                huntMonsterKilled(isLuckyEligible);
                return;
            }
            
            // Monster attacks back
            setTimeout(() => {
                // ‚ò†Ô∏è ÎèÖ ÏßÄÏÜç Îç∞ÎØ∏ÏßÄ Ï≤òÎ¶¨
                if (huntState.monsterPoisoned > 0) {
                    const poisonDmg = huntState.poisonDamage || 0;
                    monster.currentHp = Math.max(0, monster.currentHp - poisonDmg);
                    huntState.monsterPoisoned--;
                    huntState.log.push({ type: 'crit', text: `‚ò†Ô∏è ÎèÖ Îç∞ÎØ∏ÏßÄ! ${poisonDmg} (ÎÇ®ÏùÄ ${huntState.monsterPoisoned}ÌÑ¥)` });
                    
                    // ÎèÖÏúºÎ°ú Ï£ΩÏùå
                    if (monster.currentHp <= 0) {
                        huntMonsterKilled(false);
                        return;
                    }
                }
                
                // ‚ùÑÔ∏è ÎπôÍ≤∞ ÏÉÅÌÉúÎ©¥ Í≥µÍ≤© Ïä§ÌÇµ
                if (huntState.monsterFrozen) {
                    huntState.monsterFrozen = false;
                    huntState.log.push({ type: 'info', text: `‚ùÑÔ∏è ${monster.name}Ïù¥(Í∞Ä) ÏñºÏñ¥Î∂ôÏñ¥ Í≥µÍ≤©ÌïòÏßÄ Î™ªÌñàÎã§!` });
                    renderHunt();
                    return;
                }
                
                const monsterDamage = Math.floor(Math.random() * (monster.damage[1] - monster.damage[0] + 1)) + monster.damage[0];
                const monsterCrit = Math.random() * 100 < monster.crit;
                let finalMonsterDamage = monsterCrit ? Math.floor(monsterDamage * 1.5) : monsterDamage;
                
                // Î≥¥Ïä§ ÌäπÏàò Ïä§ÌÇ¨ Ï∂îÍ∞Ä Îç∞ÎØ∏ÏßÄ (30% Ï¶ùÍ∞Ä)
                if (huntState.bossSpecialSkill && monster.isBoss) {
                    finalMonsterDamage = Math.floor(finalMonsterDamage * 1.3);
                    huntState.log.push({ type: 'crit', text: `‚ö° ${huntState.bossSpecialSkill.name}! (+30% Îç∞ÎØ∏ÏßÄ)` });
                    huntState.bossSpecialSkill = null; // 1ÌöåÏÑ±
                }

                // üõ°Ô∏è Î¨¥Ï†ÅÎ™®Îìú
                if (window.debugGodMode) finalMonsterDamage = 0;
                
                // üëø Ï†ÄÏ£º Ìä∏Î¶¨Í±∞: ÎßåÌîºÏóêÏÑú ÌïúÎ∞© ÏÇ¨Îßù or ÌÅ¨Î¶¨ Ïó∞ÏÜç 3Ìöå
                const wasFullHp = player.hp === player.maxHp;
                
                player.hp = Math.max(0, player.hp - finalMonsterDamage);
                
                // ÌÅ¨Î¶¨Ìã∞Ïª¨ Ïó∞ÏÜç ÌîºÍ≤© Ïπ¥Ïö¥ÌÑ∞
                if (monsterCrit) {
                    state.consecutiveCritsTaken = (state.consecutiveCritsTaken || 0) + 1;
                } else {
                    state.consecutiveCritsTaken = 0;
                }
                
                showSlashEffect('claw', 'player');  // ÌÅ¥Î°ú Í≥µÍ≤©! ÌîåÎ†àÏù¥Ïñ¥ ÏòÅÏó≠Ïóê
                playSound(monsterCrit ? 'crit' : 'attack');
                vibrate(monsterCrit ? [100, 50, 100] : 100);
                document.body.classList.add('screen-shake');
                setTimeout(() => document.body.classList.remove('screen-shake'), 300);
                
                if (monsterCrit) {
                    showCritEffect();  // Î™¨Ïä§ÌÑ∞ ÌÅ¨Î¶¨Ìã∞Ïª¨ÎèÑ ÌëúÏãú
                    huntState.log.push({ type: 'crit', text: `üí• ${monster.name}Ïùò ÌÅ¨Î¶¨Ìã∞Ïª¨! ${finalMonsterDamage} Îç∞ÎØ∏ÏßÄ!` });
                } else {
                    huntState.log.push({ type: 'damage', text: `üî• ${monster.name}Ïùò Î∞òÍ≤©! ${finalMonsterDamage} Îç∞ÎØ∏ÏßÄ!` });
                }
                
                // Check if player is dead
                if (player.hp <= 0) {
                    // üëø ÏÇ¨Îßù Ïãú Ï†ÄÏ£º Ï≤¥ÌÅ¨ (ÌåùÏóÖÏùÄ ÏÇ¨Îßù ÌõÑ ÎîúÎ†àÏù¥Î°ú)
                    let cursed = false;
                    if (wasFullHp) cursed = checkCurseTrigger('oneshot');
                    if (!cursed) cursed = checkCurseTrigger('crit_taken');
                    if (cursed) {
                        // Ï†ÄÏ£º ÌåùÏóÖ ÌôïÏù∏ ÌõÑ ÏÇ¨Îßù Ï≤òÎ¶¨
                        setTimeout(() => huntPlayerDied(), 2000);
                    } else {
                        huntPlayerDied();
                    }
                    return;
                }
                
                // ÌÅ¨Î¶¨ Ïó∞ÏÜç 3Ìöå ÌîºÍ≤© (ÏÇ¥ÏïÑÏûàÏñ¥ÎèÑ Ï†ÄÏ£º)
                if (checkCurseTrigger('crit_taken')) {
                    renderHunt();
                    return;
                }
                
                renderHunt();
            }, 300);
            
            renderHunt();
        }

        function huntMonsterKilled(isOneShot = false) {
            const monster = huntState.monster;
            let goldReward = Math.floor(Math.random() * (monster.gold[1] - monster.gold[0] + 1)) + monster.gold[0];
            
            // ÏÇ¨ÎÉ• ÏÑ±Í≥µ Ïãú Ïó∞ÏÜç ÎèÑÎßù Ïπ¥Ïö¥ÌÑ∞ Î¶¨ÏÖã
            state.consecutiveFlees = 0;
            
            // üíÄ Ïñ∏Îç∞Îìú Î≥¥Ïä§ÌÇ¨ Î≥¥ÎÑàÏä§: Í≥®Îìú +5% per kill
            const undeadKills = (state.bossTypeKills || {}).undead || 0;
            if (undeadKills > 0) goldReward = Math.floor(goldReward * (1 + undeadKills * 0.05));
            
            // üé∞ ÌïúÎ∞©ÌÇ¨ Îü≠ÌÇ§ÎìúÎ°úÏö∞! 10Î∞∞ Î≥¥ÏÉÅ!
            const isLuckyDraw = isOneShot && Math.random() < 1.0; // ÌïúÎ∞©ÌÇ¨Ïù¥Î©¥ Î¨¥Ï°∞Í±¥ Îü≠ÌÇ§ÎìúÎ°úÏö∞
            if (isLuckyDraw) {
                goldReward *= 10;
            }
            
            // Í≥®ÎìúÎäî ÏÇ¨ÎÉ• ÏôÑÎ£å Ïãú ÏßÄÍ∏â (ÏÉàÎ°úÍ≥†Ïπ® Î∞©ÏßÄ)
            state.mastery.kills++;
            huntState.monstersKilled++;
            huntState.totalGoldEarned += goldReward;
            // Î≥¥Ïä§ Ï≤òÏπò Ïãú Ïπ¥Ïö¥ÌÑ∞ Í∏∞Î°ù (Îã§Ïùå Î≥¥Ïä§ÍπåÏßÄ ÏµúÏÜå 5ÌÇ¨ ÌïÑÏöî)
            if (monster.isBoss) {
                huntState.lastBossKill = huntState.monstersKilled;
                state.bossKills = (state.bossKills || 0) + 1;
                if (!state.bossTypeKills) state.bossTypeKills = { dragon: 0, demon: 0, undead: 0, elemental: 0 };
                const bType = monster.type || 'dragon';
                if (state.bossTypeKills[bType] !== undefined) state.bossTypeKills[bType]++;
            }
            
            // üî• ÌîºÎãâÏä§ ÏßÄÌå°Ïù¥: Ïó∞ÏÜç ÏÇ¨ÎÉ• Ïãú HP 100% ÌöåÎ≥µ!
            if (isPhoenixStaff(state.weapon)) {
                const healAmount = huntState.player.maxHp - huntState.player.hp;
                if (healAmount > 0) {
                    huntState.player.hp = huntState.player.maxHp;
                    huntState.log.push({ type: 'heal', text: `üî• ÌîºÎãâÏä§Ïùò Ï∂ïÎ≥µ! HP 100% ÌöåÎ≥µ! (+${healAmount})` });
                }
            }
            
            // üèπ ÏõêÍ±∞Î¶¨ Î¨¥Í∏∞: Î™¨Ïä§ÌÑ∞ Ï≤òÏπò Ïãú 20% ÌöåÎ≥µ
            if (state.weapon.type === 'bow' || state.weapon.type === 'crossbow') {
                const healAmount = Math.floor(huntState.player.maxHp * 0.2);
                const oldHp = huntState.player.hp;
                huntState.player.hp = Math.min(huntState.player.maxHp, huntState.player.hp + healAmount);
                const actualHeal = huntState.player.hp - oldHp;
                if (actualHeal > 0) {
                    huntState.log.push({ type: 'heal', text: `üèπ ÏÇ¨ÎÉ• ÏôÑÎ£å ÌöåÎ≥µ! +${actualHeal} HP` });
                }
            }
            
            // üëä ÎÑàÌÅ¥: Î™¨Ïä§ÌÑ∞ Ï≤òÏπò Ïãú 5% Î∂ÄÏÉÅ (Îß®ÏÜê ÎåÄÎØ∏ÏßÄ)
            if (state.weapon.type === 'knuckle') {
                const injuryAmount = Math.floor(huntState.player.maxHp * 0.05);
                huntState.player.hp = Math.max(1, huntState.player.hp - injuryAmount);  // ÏµúÏÜå 1 HP Ïú†ÏßÄ
                huntState.log.push({ type: 'damage', text: `üëä Îß®ÏÜê Î∂ÄÏÉÅ! -${injuryAmount} HP` });
            }
            huntState._lastKillWasLucky = isLuckyDraw;
            huntState._lastGoldReward = goldReward;
            
            // üêâ ÏÇ¨ÎÉ• Îû≠ÌÇπ ÎèôÍ∏∞Ìôî (Î∞∞Ïπò)
            pendingKills++;
            pendingStreak = Math.max(pendingStreak, huntState.monstersKilled);
            if (pendingKills >= 10) {
                syncHuntingRanking();  // 10ÌÇ¨ÎßàÎã§ ÎèôÍ∏∞Ìôî
            }
            
            // Î¨¥Í∏∞Î≥Ñ Ï≤òÏπò Í∏∞Î°ù
            if (!state.weapon.weaponMastery) {
                state.weapon.weaponMastery = { attacks: 0, crits: 0, kills: 0, killsByType: {} };
            }
            state.weapon.weaponMastery.kills++;
            const mType = monster.type || 'unknown';
            state.weapon.weaponMastery.killsByType[mType] = (state.weapon.weaponMastery.killsByType[mType] || 0) + 1;
            
            playSound('success');
            vibrate(isLuckyDraw ? [100, 50, 100, 50, 100, 50, 200] : [50, 50, 100]);
            if (isLuckyDraw) {
                showLuckyDrawEffect(goldReward);
                fireConfetti();
            } else if (monster.isBoss) {
                fireConfetti();
            }
            
            saveState();
            
            // Show victory and spawn next monster
            const popup = document.getElementById('resultPopup');
            const overlay = document.getElementById('overlay');
            
            const isLucky = huntState._lastKillWasLucky;
            const finalGold = huntState._lastGoldReward;
            
            popup.className = 'result-popup success show';
            document.getElementById('resultIcon').textContent = isLucky ? 'üé∞' : (monster.isBoss ? 'üèÜ' : '‚ú®');
            document.getElementById('resultText').textContent = isLucky ? 'üé∞ Îü≠ÌÇ§ÎìúÎ°úÏö∞!' : `${monster.name} Ï≤òÏπò!`;
            document.getElementById('resultText').style.color = isLucky ? 'var(--gold)' : 'var(--success)';
            const bossTypeBonusMap = { dragon: 'üêâ Í≥µÍ≤©Î†• +2%', demon: 'üòà ÌÅ¨Î¶¨Ìã∞Ïª¨ +1%', undead: 'üíÄ Í≥®Îìú +5%', elemental: '‚ö° Ï≤¥Î†• +3%' };
            const bossBonusHtml = monster.isBoss ? `<div style="color:#ff8c00;margin:4px 0;">üèÜ Í∞ïÌôîÌôïÎ•† +1% (ÎàÑÏ†Å ${state.bossKills}%)</div><div style="color:#aaf;margin:2px 0;font-size:0.85em;">${bossTypeBonusMap[monster.type] || ''} (ÎàÑÏ†Å ${(state.bossTypeKills || {})[monster.type] || 0}Ìöå)</div>` : '';
            document.getElementById('resultDetail').innerHTML = isLucky ? `
                <div style="font-size:1.5rem;color:var(--gold);animation:pulse 0.5s infinite alternate;">
                    üí∞ +${finalGold.toLocaleString()}G
                </div>
                <div style="color:var(--success);margin:8px 0;">‚ö° ÌïúÎ∞©ÌÇ¨ 10Î∞∞ Î≥¥ÎÑàÏä§!</div>
                ${bossBonusHtml}
                <span style="color:var(--muted);font-size:0.85em">
                    üîß ÎÇ¥Íµ¨ÎèÑ: ${state.weapon.durability || 100}% | ‚≠ê Ï≤òÏπò: ${huntState.monstersKilled}
                </span>
            ` : `
                üí∞ +${finalGold.toLocaleString()}G<br>
                ${bossBonusHtml}
                <span style="color:var(--muted);font-size:0.85em">
                    üîß ÎÇ¥Íµ¨ÎèÑ: ${state.weapon.durability || 100}% | ‚≠ê Ï≤òÏπò: ${huntState.monstersKilled}
                </span>
            `;
            document.getElementById('newWeaponPreview').style.display = 'block';
            document.getElementById('newWeaponPreview').innerHTML = `
                <div style="display:flex;gap:10px;margin-top:10px;">
                    <button class="btn btn-enhance" style="flex:1;" onclick="huntContinue()">üêâ Îã§Ïùå Î™¨Ïä§ÌÑ∞</button>
                    <button class="btn btn-secondary" style="flex:1;" onclick="huntStop()">üè† ÏÇ¨ÎÉ• Ï¢ÖÎ£å</button>
                </div>
            `;
            document.getElementById('resultBtn').style.display = 'none';
            
            overlay.classList.add('show');
        }
        
        // ===== Î≥¥Î¨ºÏÉÅÏûê ÏãúÏä§ÌÖú =====
        function rollTreasureChest(killStreak = 0) {
            // Í∏∞Î≥∏ 5% + Ïó∞ÏÜç ÏÇ¨ÎÉ• Î≥¥ÎÑàÏä§ (10ÎßàÎ¶¨Îãπ +2%, ÏµúÎåÄ +20%)
            const streakBonus = Math.min(0.20, Math.floor(killStreak / 10) * 0.02);
            const baseChance = 0.05 + streakBonus;
            
            if (Math.random() > baseChance) return null;
            
            // Î≥¥ÏÉÅ Ìã∞Ïñ¥ Í≤∞Ï†ï (ÎÇÆÏùÄ ÌôïÎ•†ÏùºÏàòÎ°ù ÎÜíÏùÄ Î≥¥ÏÉÅ)
            const roll = Math.random();
            let gold, tier;
            
            if (roll < 0.50) {
                // 50%: ÏÜåÌòï ÏÉÅÏûê (1-100G)
                gold = Math.floor(Math.random() * 100) + 1;
                tier = 'small';
            } else if (roll < 0.80) {
                // 30%: Ï§ëÌòï ÏÉÅÏûê (100-1,000G)
                gold = Math.floor(Math.random() * 900) + 100;
                tier = 'medium';
            } else if (roll < 0.95) {
                // 15%: ÎåÄÌòï ÏÉÅÏûê (1,000-5,000G)
                gold = Math.floor(Math.random() * 4000) + 1000;
                tier = 'large';
            } else if (roll < 0.99) {
                // 4%: Ìù¨Í∑Ä ÏÉÅÏûê (5,000-20,000G)
                gold = Math.floor(Math.random() * 15000) + 5000;
                tier = 'rare';
            } else {
                // 1%: Ï†ÑÏÑ§ ÏÉÅÏûê (20,000-50,000G)
                gold = Math.floor(Math.random() * 30000) + 20000;
                tier = 'legendary';
            }
            
            return { gold, tier };
        }
        
        // üí∞ Îèà ÌÑ∞ÏßÄÎäî Ïï†ÎãàÎ©îÏù¥ÏÖò
        function showGoldExplosion(amount) {
            const container = document.createElement('div');
            container.style.cssText = `
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                pointer-events: none;
                z-index: 10000;
                overflow: hidden;
            `;
            document.body.appendChild(container);
            
            // ÎèôÏ†Ñ Ïù¥Î™®ÏßÄÎì§
            const emojis = ['üí∞', 'ü™ô', 'üíµ', '‚ú®', 'üíé'];
            const particleCount = Math.min(50, Math.max(15, Math.floor(amount / 1000)));
            
            for (let i = 0; i < particleCount; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    const emoji = emojis[Math.floor(Math.random() * emojis.length)];
                    const startX = 40 + Math.random() * 20; // ÌôîÎ©¥ Ï§ëÏïô Í∑ºÏ≤ò
                    const startY = 40 + Math.random() * 20;
                    const endX = Math.random() * 100;
                    const endY = Math.random() * 100;
                    const duration = 1 + Math.random() * 0.5;
                    const size = 1.2 + Math.random() * 1;
                    
                    particle.textContent = emoji;
                    particle.style.cssText = `
                        position: absolute;
                        left: ${startX}%;
                        top: ${startY}%;
                        font-size: ${size}rem;
                        animation: goldExplode ${duration}s ease-out forwards;
                        --endX: ${endX - startX}vw;
                        --endY: ${endY - startY}vh;
                    `;
                    container.appendChild(particle);
                }, i * 30);
            }
            
            // Ï§ëÏïôÏóê Í∏àÏï° ÌëúÏãú
            const amountDiv = document.createElement('div');
            amountDiv.innerHTML = `üí∞ +${amount.toLocaleString()}G`;
            amountDiv.style.cssText = `
                position: absolute;
                left: 50%; top: 50%;
                transform: translate(-50%, -50%);
                font-size: 2.5rem;
                font-weight: bold;
                color: #ffd700;
                text-shadow: 0 0 20px #ffd700, 0 0 40px #ff8c00, 2px 2px 4px rgba(0,0,0,0.8);
                animation: goldAmount 2s ease-out forwards;
            `;
            container.appendChild(amountDiv);
            
            setTimeout(() => container.remove(), 3000);
        }
        
        function showTreasureChest(treasure) {
            const tierNames = {
                small: { name: 'ÎÇòÎ¨¥ ÏÉÅÏûê', icon: 'üì¶', color: 'var(--common)' },
                medium: { name: 'Ï≤†Ï†ú ÏÉÅÏûê', icon: 'üéÅ', color: 'var(--magic)' },
                large: { name: 'Ìô©Í∏à ÏÉÅÏûê', icon: 'üß∞', color: 'var(--rare)' },
                rare: { name: 'Î≥¥ÏÑù ÏÉÅÏûê', icon: 'üíé', color: 'var(--legendary)' },
                legendary: { name: 'Ïö©Ïùò Î≥¥Î¨º', icon: 'üëë', color: 'var(--unique)' }
            };
            
            const tierInfo = tierNames[treasure.tier];
            
            playSound('win');
            vibrate(treasure.tier === 'legendary' ? [100, 50, 100, 50, 200, 100, 300] : [50, 30, 100]);
            
            // üí∞ ÎåÄÌòï Ïù¥ÏÉÅ ÏÉÅÏûêÎäî Îèà ÌÑ∞ÏßÄÎäî Ïï†ÎãàÎ©îÏù¥ÏÖò!
            if (treasure.tier === 'large' || treasure.tier === 'rare' || treasure.tier === 'legendary') {
                showGoldExplosion(treasure.gold);
                fireConfetti();
            }
            
            // Í≥®ÎìúÎäî ÏÇ¨ÎÉ• ÏôÑÎ£å Ïãú ÏßÄÍ∏â (ÏÉàÎ°úÍ≥†Ïπ® Î∞©ÏßÄ)
            huntState.totalGoldEarned += treasure.gold;
            saveState();  // Î¨¥Í∏∞ ÏàôÎ†®ÎèÑ Îì±Îßå Ï†ÄÏû•
            
            const popup = document.getElementById('resultPopup');
            const overlay = document.getElementById('overlay');
            
            popup.className = 'result-popup success show';
            document.getElementById('resultIcon').textContent = tierInfo.icon;
            document.getElementById('resultText').textContent = `${tierInfo.name} Î∞úÍ≤¨!`;
            document.getElementById('resultText').style.color = tierInfo.color;
            document.getElementById('resultDetail').innerHTML = `
                <div style="font-size:1.5rem;color:var(--gold);animation:pulse 0.5s infinite alternate;">
                    üí∞ +${treasure.gold.toLocaleString()}G
                </div>
                <div style="color:var(--muted);margin-top:8px;font-size:0.85em;">
                    ÏÇ¨ÎÉ• Ï§ë Î≥¥Î¨ºÏùÑ Î∞úÍ≤¨ÌñàÏäµÎãàÎã§!
                </div>
            `;
            document.getElementById('newWeaponPreview').style.display = 'block';
            document.getElementById('newWeaponPreview').innerHTML = `
                <div style="display:flex;gap:10px;margin-top:10px;">
                    <button class="btn btn-enhance" style="flex:1;" onclick="huntContinueAfterTreasure()">üêâ Í≥ÑÏÜç ÏÇ¨ÎÉ•</button>
                    <button class="btn btn-secondary" style="flex:1;" onclick="huntStop()">üè† ÏÇ¨ÎÉ• Ï¢ÖÎ£å</button>
                </div>
            `;
            document.getElementById('resultBtn').style.display = 'none';
            
            overlay.classList.add('show');
        }
        
        function huntContinueAfterTreasure() {
            closeResult();
            document.getElementById('resultBtn').style.display = '';
            // Î≥¥Î¨ºÏÉÅÏûê ÌõÑÏóêÎäî HP ÌöåÎ≥µ ÏóÜÏù¥ Î∞îÎ°ú Î™¨Ïä§ÌÑ∞ Ïä§Ìè∞
            huntState.monster = spawnMonster();
            huntState.log = [{ type: 'info', text: `üëÄ ÏÉàÎ°úÏö¥ Î™¨Ïä§ÌÑ∞ Î∞úÍ≤¨!` }];
            renderHunt();
            if (huntState.monster.isBoss) fetchBossDialogue(huntState.monster).then(d => d && showBossDialogue(d));
        }
        
        // ÏÇ¨Îßù ÌõÑ Îã§Ïãú ÏÇ¨ÎÉ• (ÏÉà Î¨¥Í∏∞, ÎßåÌîº, Í≥®Îìú 0)
        function huntRestart() {
            closeResult();
            document.getElementById('resultBtn').style.display = '';
            huntState = null;
            showHunt();
        }
        
        // ÏÇ¨Îßù ÌõÑ ÏÇ¨ÎÉ• Ï¢ÖÎ£å
        function huntExitAfterDeath() {
            closeResult();
            document.getElementById('resultBtn').style.display = '';
            huntState = null;
            showMain();
        }
        
        function huntContinue() {
            closeResult();
            document.getElementById('resultBtn').style.display = '';
            
            // Î≥¥Î¨ºÏÉÅÏûê Î∞úÍ≤¨ Ï≤¥ÌÅ¨ (Ïó∞ÏÜç ÏÇ¨ÎÉ• ÌöüÏàòÏóê Îî∞Îùº ÌôïÎ•† Ï¶ùÍ∞Ä)
            const treasure = rollTreasureChest(huntState.monstersKilled);
            if (treasure) {
                showTreasureChest(treasure);
                return;
            }
            
            // Spawn next monster, heal a bit (10% ÌöåÎ≥µ)
            huntState.monster = spawnMonster();
            huntState.player.hp = Math.min(huntState.player.maxHp, huntState.player.hp + Math.floor(huntState.player.maxHp * 0.1));
            huntState.log = [{ type: 'info', text: `‚ù§Ô∏è HP 10% ÌöåÎ≥µ!` }];
            renderHunt();
            if (huntState.monster.isBoss) fetchBossDialogue(huntState.monster).then(d => d && showBossDialogue(d));
        }
        
        function huntStop() {
            closeResult();
            document.getElementById('resultBtn').style.display = '';
            
            // üêâ ÏÇ¨ÎÉ• Ï¢ÖÎ£å Ïãú ÎÇ®ÏùÄ ÌÇ¨ ÎèôÍ∏∞Ìôî
            if (pendingKills > 0) {
                syncHuntingRanking();
            }
            
            // üí∞ ÏÇ¨ÎÉ• ÏôÑÎ£å Ïãú Í≥®Îìú ÏßÄÍ∏â! (ÏÉàÎ°úÍ≥†Ïπ®ÌïòÎ©¥ Î™ª Î∞õÏùå)
            if (huntState && huntState.totalGoldEarned > 0) {
                state.gold += huntState.totalGoldEarned;
                saveState();
            }
            
            // Show final results
            const popup = document.getElementById('resultPopup');
            const overlay = document.getElementById('overlay');
            
            popup.className = 'result-popup success show';
            document.getElementById('resultIcon').textContent = 'üèÜ';
            document.getElementById('resultText').textContent = 'ÏÇ¨ÎÉ• ÏôÑÎ£å!';
            document.getElementById('resultText').style.color = 'var(--success)';
            document.getElementById('resultDetail').innerHTML = `
                <div style="font-size:1.2rem;color:var(--gold);margin-bottom:10px;">
                    üí∞ Ï¥ù ${huntState.totalGoldEarned.toLocaleString()}G ÌöçÎìù!
                </div>
                Ï≤òÏπò: ${huntState.monstersKilled}ÎßàÎ¶¨<br>
                ÏàôÎ†®ÎèÑ Î≥¥ÎÑàÏä§: +${getMasteryBonus()}%
            `;
            document.getElementById('newWeaponPreview').style.display = 'none';
            document.getElementById('resultBtn').textContent = 'Î©îÏù∏ÏúºÎ°ú';
            document.getElementById('resultBtn').onclick = () => {
                closeResult();
                huntState = null;
                showMain();
            };
            
            overlay.classList.add('show');
            fireConfetti();
        }

        function huntPlayerDied() {
            playSound('destroy');
            vibrate([200, 100, 200, 100, 300]);
            
            // Lose weapon! Î™¨Ïä§ÌÑ∞ Ï¢ÖÏ°± Í∏∞Î∞ò ÏÜçÏÑ± Î∂ÄÏó¨
            const lostWeapon = state.weapon;
            const monsterType = huntState.monster?.type || 'beast';
            const monsterName = huntState.monster?.name || 'Î™¨Ïä§ÌÑ∞';
            addDestroyedWeaponRecord(lostWeapon, 'monster_death', huntState?.monstersKilled || 0);
            const inheritCurse = isCursed(lostWeapon); // Ï†ÄÏ£º ÏÉÅÌÉúÎ©¥ Îã§Ïùå Î¨¥Í∏∞Ïóê ÏäπÍ≥Ñ
            state.weapon = generateWeaponBySource('monster_death', { monsterType });
            if (inheritCurse) {
                state.weapon.cursed = true;
            }
            resetMastery();  // Î¨¥Í∏∞ Î≥ÄÍ≤Ω Ïãú ÏàôÎ†®ÎèÑ Ï¥àÍ∏∞Ìôî
            state.bossKills = 0;
            state.bossTypeKills = { dragon: 0, demon: 0, undead: 0, elemental: 0 };
            state.stats.losses++;
            saveState();
            
            // Î¨¥Í∏∞ ÌöçÎìù Ïù¥ÌéôÌä∏
            setTimeout(() => {
                showWeaponAcquireEffect(state.weapon, 'monster_death', { monsterName, monsterType });
            }, 500);
            
            const popup = document.getElementById('resultPopup');
            const overlay = document.getElementById('overlay');
            
            popup.className = 'result-popup fail show';
            document.getElementById('resultIcon').textContent = 'üíÄ';
            document.getElementById('resultText').textContent = 'ÏÇ¨Îßù...';
            document.getElementById('resultText').style.color = 'var(--fail)';
            document.getElementById('resultDetail').innerHTML = `
                Î¨¥Í∏∞Î•º ÏûÉÏóàÏäµÎãàÎã§!${inheritCurse ? '<br><span style="color:#bb77ff;">üëø Ï†ÄÏ£ºÍ∞Ä ÏÉà Î¨¥Í∏∞Î°ú ÏäπÍ≥ÑÎê®</span>' : ''}<br>
                <span style="color:var(--muted);font-size:0.9em">
                    Ï≤òÏπò: ${huntState.monstersKilled}ÎßàÎ¶¨ | ÌöçÎìù: ${huntState.totalGoldEarned.toLocaleString()}G
                </span>
            `;
            
            // newWeaponPreviewÏóê Î≤ÑÌäº ÏßÅÏ†ë ÏÇΩÏûÖ (huntMonsterKilledÏôÄ ÎèôÏùºÌïú Ìå®ÌÑ¥)
            const newGradeData = GRADES[state.weapon.grade];
            document.getElementById('newWeaponPreview').style.display = 'block';
            document.getElementById('newWeaponPreview').innerHTML = `
                <div class="new-weapon-title">ÏÉàÎ°úÏö¥ Î¨¥Í∏∞ ÌöçÎìù!</div>
                <div class="new-weapon-name">
                    <span style="color:${newGradeData.color}">[${newGradeData.name}] ${state.weapon.name}</span>
                </div>
                <div style="display:flex;gap:10px;margin-top:10px;">
                    <button class="btn btn-enhance" style="flex:1;" onclick="huntRestart()">üîÑ Îã§Ïãú ÏÇ¨ÎÉ•</button>
                    <button class="btn btn-secondary" style="flex:1;" onclick="huntExitAfterDeath()">üè† ÏÇ¨ÎÉ• Ï¢ÖÎ£å</button>
                </div>
            `;
            document.getElementById('resultBtn').style.display = 'none';
            
            overlay.classList.add('show');
        }

        function exitHunt() {
            // Use the same run away logic
            if (huntState && huntState.monster) {
                huntRunAway();
            } else {
                huntState = null;
                showMain();
            }
        }

        // ===== CONFETTI =====
        function fireConfetti() {
            const canvas = document.getElementById('confetti');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const pieces = [];
            const colors = ['#e94560', '#ffd700', '#4ecca3', '#00d9ff', '#ff6b6b', '#ff8000', '#00ff80'];

            for (let i = 0; i < 100; i++) {
                pieces.push({
                    x: canvas.width / 2,
                    y: canvas.height / 2,
                    vx: (Math.random() - 0.5) * 20,
                    vy: (Math.random() - 0.5) * 20 - 10,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    size: Math.random() * 8 + 4,
                    rotation: Math.random() * 360
                });
            }

            let frame = 0;
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                pieces.forEach(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.5;
                    p.rotation += 5;
                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.rotation * Math.PI / 180);
                    ctx.fillStyle = p.color;
                    ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
                    ctx.restore();
                });
                frame++;
                if (frame < 100) requestAnimationFrame(animate);
                else ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            animate();
        }

        // ===== DEBUG MODE =====
        const DEBUG_MODE = new URLSearchParams(window.location.search).get('debug') === '1';
        
        function renderDebugPanel() {
            if (!DEBUG_MODE) return '';
            const w = state.weapon;
            const stats = getWeaponStats(w);
            
            // Î¨¥Í∏∞ Î¶¨Ïä§Ìä∏ ÏÉùÏÑ±
            const weaponOptions = [];
            for (const [grade, gData] of Object.entries(GRADES)) {
                for (const [type, tData] of Object.entries(WEAPON_TYPES)) {
                    let name;
                    if (gData.names && gData.names[type]) {
                        name = gData.names[type];
                    } else {
                        const prefix = gData.prefixes?.[0] || '';
                        name = prefix ? `${prefix} ${tData.name}` : tData.name;
                    }
                    weaponOptions.push({ grade, type, name, display: `[${gData.name}] ${name}` });
                }
            }
            
            const masteryLevel = getWeaponMasteryLevel(w);
            const elemData = ELEMENTS[w?.element] || ELEMENTS.none;
            const elemDisplay = w?.element && w.element !== 'none' ? `${elemData.icon} ${elemData.name}` : 'Î¨¥ÏÜçÏÑ±';
            
            return `
                <div id="debugPanel" style="background:rgba(0,0,0,0.95);color:#0f0;font-family:monospace;font-size:11px;padding:12px;margin-top:20px;border-radius:8px;">
                    <div style="color:#ff0;font-weight:bold;margin-bottom:8px;">üîß DEBUG MODE</div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
                        <button onclick="debugAddGold()" style="background:#ffd700;color:#000;border:none;padding:4px 8px;cursor:pointer;border-radius:4px;">üí∞ Î¨¥Ìïú Í≥®Îìú</button>
                        <button onclick="debugSetDurability0()" style="background:#ff6b6b;color:#fff;border:none;padding:4px 8px;cursor:pointer;border-radius:4px;">üîß ÎÇ¥Íµ¨ÎèÑ 0</button>
                        <button onclick="debugFullDurability()" style="background:#4ecca3;color:#000;border:none;padding:4px 8px;cursor:pointer;border-radius:4px;">üîß ÎÇ¥Íµ¨ÎèÑ 100</button>
                        <button onclick="debugAddMastery()" style="background:#9b59b6;color:#fff;border:none;padding:4px 8px;cursor:pointer;border-radius:4px;">‚≠ê ÏàôÎ†®ÎèÑ +1</button>
                        <button onclick="debugToggleGodMode()" style="background:${window.debugGodMode ? '#00ff00' : '#333'};color:${window.debugGodMode ? '#000' : '#fff'};border:1px solid #0f0;padding:4px 8px;cursor:pointer;border-radius:4px;">üõ°Ô∏è Î¨¥Ï†Å ${window.debugGodMode ? 'ON' : 'OFF'}</button>
                        <button onclick="debugToggleCritMode()" style="background:${window.debugCritMode ? '#ff4500' : '#333'};color:#fff;border:1px solid #f50;padding:4px 8px;cursor:pointer;border-radius:4px;">üíØ ÌÅ¨Î¶¨100% ${window.debugCritMode ? 'ON' : 'OFF'}</button>
                        <button onclick="debugApplyCurse()" style="background:${isCursed(state.weapon) ? '#8b00ff' : '#333'};color:#fff;border:1px solid #8b00ff;padding:4px 8px;cursor:pointer;border-radius:4px;">üëø Ï†ÄÏ£º ${isCursed(state.weapon) ? 'ON' : 'OFF'}</button>
                        <button onclick="debugRemoveCurse()" style="background:#333;color:#fff;border:1px solid #4ecca3;padding:4px 8px;cursor:pointer;border-radius:4px;">‚ú® Ï†ÄÏ£ºÌï¥Ï†ú</button>
                    </div>
                    <div style="margin-bottom:8px;">
                        <label style="color:#ff0;">Î¨¥Í∏∞ ÏÑ†ÌÉù: </label>
                        <select id="debugWeaponSelect" onchange="debugSelectWeapon()" style="background:#333;color:#0f0;border:1px solid #0f0;padding:4px;border-radius:4px;">
                            ${weaponOptions.map(opt => `<option value="${opt.grade}|${opt.type}" ${w?.grade === opt.grade && w?.type === opt.type ? 'selected' : ''}>${opt.display}</option>`).join('')}
                        </select>
                    </div>
                    <div><b>ÌòÑÏû¨:</b> ${w?.name} +${w?.level} (${w?.grade}/${w?.type}) | <span style="color:${elemData.color}">${elemDisplay}</span> | ÎÇ¥Íµ¨ÎèÑ: ${w?.durability}%${isCursed(w) ? ' <span style="color:#8b00ff;">üëøÏ†ÄÏ£º</span>' : ''}</div>
                    <div><b>stats:</b> dmg ${stats.damageMin}-${stats.damageMax} | crit ${stats.critChance}% | critDmg ${stats.critDamage}% | hp ${stats.hp}</div>
                    <div><b>Ï†ÄÏ£ºÏπ¥Ïö¥ÌÑ∞:</b> Í∞ïÌôîÏã§Ìå®:${state.consecutiveEnhanceFails||0}/3 | ÎèÑÎßù:${state.consecutiveFlees||0}/5 | PVPÌå®:${state.consecutivePvpLosses||0}/3 | ÌÅ¨Î¶¨ÌîºÍ≤©:${state.consecutiveCritsTaken||0}/3</div>
                </div>
            `;
        }
        
        function debugAddGold() {
            state.gold = 999999999999;  // Î¨¥Ìïú Í≥®Îìú
            saveState();
            showMain();
        }
        
        function debugSetDurability0() {
            if (state.weapon) {
                state.weapon.durability = 0;
                saveState();
                showMain();
            }
        }
        
        function debugFullDurability() {
            if (state.weapon) {
                state.weapon.durability = 100;
                saveState();
                showMain();
            }
        }
        
        function debugApplyCurse() {
            if (state.weapon && !isCursed(state.weapon)) {
                applyCurse(state.weapon, 'enhance_fail');
            }
        }
        
        function debugRemoveCurse() {
            if (state.weapon && isCursed(state.weapon)) {
                state.weapon.cursed = false;
                saveState();
                showMain();
            }
        }
        
        function debugAddMastery() {
            if (state.weapon && state.weapon.weaponMastery) {
                // ÏàôÎ†®ÎèÑ Î†àÎ≤® 1 = 100 Í≥µÍ≤© ‚Üí 100 Ï∂îÍ∞Ä
                state.weapon.weaponMastery.attacks += 100;
                saveState();
                showMain();
            }
        }
        
        // Î¨¥Ï†ÅÎ™®Îìú
        window.debugGodMode = false;
        function debugToggleGodMode() {
            window.debugGodMode = !window.debugGodMode;
            showMain();
        }
        
        function debugSelectWeapon() {
            const select = document.getElementById('debugWeaponSelect');
            if (!select) return;
            const [grade, type] = select.value.split('|');
            const gData = GRADES[grade];
            const tData = WEAPON_TYPES[type];
            
            // Ïù¥Î¶Ñ ÏÉùÏÑ±
            let name;
            if (gData.names && gData.names[type]) {
                name = gData.names[type];
            } else {
                const prefix = gData.prefixes?.[Math.floor(Math.random() * gData.prefixes.length)] || '';
                name = prefix ? `${prefix} ${tData.name}` : tData.name;
            }
            
            // üßô ÎßàÎ≤ï Î¨¥Í∏∞Îäî Ìï≠ÏÉÅ ÎßàÎ≤ï ÏÜçÏÑ± Î∂ÄÏó¨!
            let element = 'none';
            if (tData.isMagic) {
                element = MAGIC_ELEMENTS[Math.floor(Math.random() * MAGIC_ELEMENTS.length)];
            }
            
            // ÏÉà Î¨¥Í∏∞ ÏßÅÏ†ë ÏÉùÏÑ±
            state.weapon = {
                type,
                grade,
                name,
                level: 0,
                element,
                img: tData.img,
                durability: 100,
                protectionScrolls: 2,
                weaponMastery: { attacks: 0, crits: 0, kills: 0, killsByType: {} }
            };
            
            saveState();
            // Í∞ïÏ†ú ÏÉàÎ°úÍ≥†Ïπ®ÏúºÎ°ú ÌôïÏã§Ìûà Î∞òÏòÅ
            location.reload();
        }
        
        // üíØ ÌÅ¨Î¶¨Ìã∞Ïª¨ 100% Î™®Îìú ÌÜ†Í∏Ä
        function debugToggleCritMode() {
            window.debugCritMode = !window.debugCritMode;
            showMain();
        }
        
        // showMain ÏõêÎ≥∏ Ï†ÄÏû• ÌõÑ ÎûòÌïë
        const _originalShowMain = showMain;
        showMain = function() {
            _originalShowMain();
            if (DEBUG_MODE) {
                // Í∏∞Ï°¥ ÎîîÎ≤ÑÍ∑∏ Ìå®ÎÑê Ï†úÍ±∞ ÌõÑ Ïï± Ïª®ÌÖåÏù¥ÎÑà ÏïÑÎûòÏóê Ï∂îÍ∞Ä
                const existing = document.getElementById('debugPanel');
                if (existing) existing.remove();
                const app = document.getElementById('app');
                if (app) {
                    app.insertAdjacentHTML('beforeend', renderDebugPanel());
                }
            }
        };

        // ===== HISTORY NAVIGATION =====
        let currentScreen = 'main';
        
        function navigateTo(screen, showFn) {
            if (currentScreen !== screen) {
                history.pushState({ screen }, '', `#${screen}`);
            }
            currentScreen = screen;
            showFn();
        }
        
        // Wrap show functions for history
        const _showMain = showMain;
        const _showEnhance = showEnhance;
        const _showBlacksmith = showBlacksmith;
        const _showRanking = showRanking;
        const _showBattleLobby = showBattleLobby;
        const _showHunt = showHunt;
        const _showMasteryDetail = showMasteryDetail;
        
        showMain = function() { currentScreen = 'main'; _showMain(); };
        showEnhance = function() { navigateTo('enhance', _showEnhance); };
        showBlacksmith = function() { navigateTo('blacksmith', _showBlacksmith); };
        showRanking = function() { navigateTo('ranking', _showRanking); };
        showBattleLobby = function() { navigateTo('battle', _showBattleLobby); };
        showHunt = function() { navigateTo('hunt', _showHunt); };
        showMasteryDetail = function() { navigateTo('mastery', _showMasteryDetail); };
        
        window.addEventListener('popstate', (e) => {
            const screen = e.state?.screen || 'main';
            currentScreen = screen;
            switch (screen) {
                case 'enhance': _showEnhance(); break;
                case 'blacksmith': _showBlacksmith(); break;
                case 'ranking': _showRanking(); break;
                case 'battle': _showBattleLobby(); break;
                case 'hunt': _showHunt(); break;
                case 'mastery': _showMasteryDetail(); break;
                default: _showMain(); break;
            }
        });
        
        // Set initial state
        history.replaceState({ screen: 'main' }, '', '#main');

        // ===== INIT =====
        try {
            loadState();
            showMain();
        } catch(e) {
            console.error('INIT ERROR:', e);
            document.getElementById('app').innerHTML = '<div style="padding:20px;color:red;">Ï¥àÍ∏∞Ìôî ÏóêÎü¨: ' + e.message + '</div>';
        }
        // ÌÅ¥ÎùºÏö∞Îìú ÎèôÍ∏∞Ìôî Ï≤¥ÌÅ¨ (ÎπÑÎèôÍ∏∞)
        checkCloudSync().then(() => {
            // ÎèôÍ∏∞Ìôî ÌõÑ ÌôîÎ©¥ Í∞±Ïã†
            showMain();
            // SharedWallet ÎèôÍ∏∞Ìôî
            if (typeof SharedWallet !== 'undefined') {
                SharedWallet.gold = state.gold;
                SharedWallet._updateUI();
            }
        });

        // Îπà ÌôîÎ©¥ ÏûêÎèô Î≥µÍµ¨ (ÏÜêÏÉÅÎêú Î°úÏª¨ ÏÉÅÌÉú ÎåÄÏùë)
        setTimeout(() => {
            const appEl = document.getElementById('app');
            if (appEl && appEl.innerHTML.trim() === '') {
                console.warn('Empty app detected. Resetting local state...');
                localStorage.removeItem('enhance_game_v3');
                state = {
                    gold: 10000,
                    weapon: null,
                    protectionScrolls: 3,
                    useProtection: false,
                    stats: { attempts: 0, successes: 0, fails: 0, destroys: 0, wins: 0, losses: 0 },
                    mastery: { attacks: 0, kills: 0 },
                    bossKills: 0,
                    bossTypeKills: { dragon: 0, demon: 0, undead: 0, elemental: 0 },
                    consecutiveEnhanceFails: 0,
                    consecutiveFlees: 0,
                    consecutivePvpLosses: 0,
                    consecutiveCritsTaken: 0
                };
                loadState();
                showMain();
            }
        }, 300);
    </script>
</body>
</html>
