class Tetris{constructor(){this.canvas=document.getElementById('gameCanvas');this.ctx=this.canvas.getContext('2d');this.nextCanvas=document.getElementById('nextCanvas');this.nextCtx=this.nextCanvas.getContext('2d');this.ROWS=20;this.COLS=10;this.BLOCK_SIZE=30;this.board=this.createBoard();this.score=0;this.level=1;this.lines=0;this.gameOver=false;this.paused=false;this.gameStarted=false;this.currentPiece=null;this.nextPiece=null;this.dropCounter=0;this.dropInterval=1000;this.lastTime=0;this.colors={'I':'#00f0f0','O':'#f0f000','T':'#a000f0','S':'#00f000','Z':'#f00000','J':'#0000f0','L':'#f0a000'};this.pieces={'I':[[1,1,1,1]],'O':[[1,1],[1,1]],'T':[[0,1,0],[1,1,1]],'S':[[0,1,1],[1,1,0]],'Z':[[1,1,0],[0,1,1]],'J':[[1,0,0],[1,1,1]],'L':[[0,0,1],[1,1,1]]};this.init()}init(){this.attachEventListeners();this.updateDisplay()}createBoard(){return Array(this.ROWS).fill(null).map(()=>Array(this.COLS).fill(0))}attachEventListeners(){document.getElementById('startBtn').addEventListener('click',()=>this.start());document.getElementById('pauseBtn').addEventListener('click',()=>this.togglePause());document.getElementById('restartBtn').addEventListener('click',()=>this.restart());document.addEventListener('keydown',(e)=>{if(!this.gameStarted||this.gameOver||this.paused)return;switch(e.key){case'ArrowLeft':this.move(-1);break;case'ArrowRight':this.move(1);break;case'ArrowDown':this.drop();break;case'ArrowUp':case'z':case'Z':this.rotate();break;case' ':this.hardDrop();break;case'p':case'P':this.togglePause();break}})}start(){if(this.gameStarted)return;this.gameStarted=true;this.gameOver=false;this.paused=false;this.board=this.createBoard();this.score=0;this.level=1;this.lines=0;this.nextPiece=this.randomPiece();this.spawnPiece();this.updateDisplay();this.lastTime=performance.now();this.gameLoop();document.getElementById('startBtn').disabled=true}restart(){document.getElementById('gameOver').classList.remove('show');document.getElementById('startBtn').disabled=false;this.gameStarted=false;this.start()}togglePause(){if(!this.gameStarted||this.gameOver)return;this.paused=!this.paused;if(!this.paused){this.lastTime=performance.now();this.gameLoop()}}randomPiece(){const pieces=Object.keys(this.pieces);const type=pieces[Math.floor(Math.random()*pieces.length)];return{type:type,shape:this.pieces[type],color:this.colors[type],x:Math.floor(this.COLS/2)-Math.floor(this.pieces[type][0].length/2),y:0}}spawnPiece(){this.currentPiece=this.nextPiece;this.nextPiece=this.randomPiece();if(this.collision()){this.endGame()}this.drawNext()}collision(piece=this.currentPiece,offsetX=0,offsetY=0){for(let y=0;y<piece.shape.length;y++){for(let x=0;x<piece.shape[y].length;x++){if(piece.shape[y][x]){const newX=piece.x+x+offsetX;const newY=piece.y+y+offsetY;if(newX<0||newX>=this.COLS||newY>=this.ROWS)return true;if(newY>=0&&this.board[newY][newX])return true}}}return false}merge(){for(let y=0;y<this.currentPiece.shape.length;y++){for(let x=0;x<this.currentPiece.shape[y].length;x++){if(this.currentPiece.shape[y][x]){const boardY=this.currentPiece.y+y;const boardX=this.currentPiece.x+x;if(boardY>=0){this.board[boardY][boardX]=this.currentPiece.color}}}}}move(dir){if(!this.collision(this.currentPiece,dir,0)){this.currentPiece.x+=dir}}drop(){if(!this.collision(this.currentPiece,0,1)){this.currentPiece.y++;this.dropCounter=0}else{this.merge();this.clearLines();this.spawnPiece()}}hardDrop(){while(!this.collision(this.currentPiece,0,1)){this.currentPiece.y++}this.merge();this.clearLines();this.spawnPiece()}rotate(){const rotated=this.currentPiece.shape[0].map((_,i)=>this.currentPiece.shape.map(row=>row[i]).reverse());const previousShape=this.currentPiece.shape;this.currentPiece.shape=rotated;if(this.collision()){this.currentPiece.shape=previousShape}}clearLines(){let linesCleared=0;for(let y=this.ROWS-1;y>=0;y--){if(this.board[y].every(cell=>cell!==0)){this.board.splice(y,1);this.board.unshift(Array(this.COLS).fill(0));linesCleared++;y++}}if(linesCleared>0){this.lines+=linesCleared;this.score+=[0,100,300,500,800][linesCleared]*this.level;this.level=Math.floor(this.lines/10)+1;this.dropInterval=Math.max(100,1000-(this.level-1)*100);this.updateDisplay()}}gameLoop(time=0){if(this.gameOver||this.paused)return;const deltaTime=time-this.lastTime;this.lastTime=time;this.dropCounter+=deltaTime;if(this.dropCounter>this.dropInterval){this.drop()}this.draw();requestAnimationFrame((t)=>this.gameLoop(t))}draw(){this.ctx.fillStyle='rgba(0, 0, 0, 0.8)';this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);for(let y=0;y<this.ROWS;y++){for(let x=0;x<this.COLS;x++){if(this.board[y][x]){this.drawBlock(x,y,this.board[y][x])}}}if(this.currentPiece){for(let y=0;y<this.currentPiece.shape.length;y++){for(let x=0;x<this.currentPiece.shape[y].length;x++){if(this.currentPiece.shape[y][x]){this.drawBlock(this.currentPiece.x+x,this.currentPiece.y+y,this.currentPiece.color)}}}}this.ctx.strokeStyle='rgba(255, 255, 255, 0.1)';this.ctx.lineWidth=1;for(let y=0;y<=this.ROWS;y++){this.ctx.beginPath();this.ctx.moveTo(0,y*this.BLOCK_SIZE);this.ctx.lineTo(this.canvas.width,y*this.BLOCK_SIZE);this.ctx.stroke()}for(let x=0;x<=this.COLS;x++){this.ctx.beginPath();this.ctx.moveTo(x*this.BLOCK_SIZE,0);this.ctx.lineTo(x*this.BLOCK_SIZE,this.canvas.height);this.ctx.stroke()}}drawBlock(x,y,color){this.ctx.fillStyle=color;this.ctx.fillRect(x*this.BLOCK_SIZE+1,y*this.BLOCK_SIZE+1,this.BLOCK_SIZE-2,this.BLOCK_SIZE-2);this.ctx.fillStyle='rgba(255, 255, 255, 0.3)';this.ctx.fillRect(x*this.BLOCK_SIZE+1,y*this.BLOCK_SIZE+1,this.BLOCK_SIZE-2,this.BLOCK_SIZE/3)}drawNext(){this.nextCtx.fillStyle='rgba(0, 0, 0, 0.8)';this.nextCtx.fillRect(0,0,this.nextCanvas.width,this.nextCanvas.height);const blockSize=24;const offsetX=(this.nextCanvas.width-this.nextPiece.shape[0].length*blockSize)/2;const offsetY=(this.nextCanvas.height-this.nextPiece.shape.length*blockSize)/2;for(let y=0;y<this.nextPiece.shape.length;y++){for(let x=0;x<this.nextPiece.shape[y].length;x++){if(this.nextPiece.shape[y][x]){this.nextCtx.fillStyle=this.nextPiece.color;this.nextCtx.fillRect(offsetX+x*blockSize+1,offsetY+y*blockSize+1,blockSize-2,blockSize-2);this.nextCtx.fillStyle='rgba(255, 255, 255, 0.3)';this.nextCtx.fillRect(offsetX+x*blockSize+1,offsetY+y*blockSize+1,blockSize-2,blockSize/3)}}}}updateDisplay(){document.getElementById('score').textContent=this.score;document.getElementById('level').textContent=this.level;document.getElementById('lines').textContent=this.lines}endGame(){this.gameOver=true;this.gameStarted=false;document.getElementById('finalScore').textContent=this.score;document.getElementById('gameOver').classList.add('show');document.getElementById('startBtn').disabled=false}}document.addEventListener('DOMContentLoaded',()=>{new Tetris()});
